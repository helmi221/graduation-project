<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªÙ†Ø³ÙŠÙ‚ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
      #order-confirm-modal .modal-content {
        max-width: 500px;
        text-align: center;
        padding: 40px 30px;
        flex-direction: column;
      }
      #order-confirm-modal h2 {
        font-size: 2rem;
        color: var(--dark-color);
        margin-bottom: 1rem;
      }
      #order-confirm-modal .confirm-icon {
        font-size: 4rem;
        color: var(--success-color);
        margin-bottom: 1.5rem;
        line-height: 1;
      }
      #order-confirm-modal p {
        font-size: 1.1rem;
        color: #555;
        margin-bottom: 1.5rem;
        line-height: 1.7;
      }
      #order-confirm-modal .tracking-id-display {
        display: none;
      }
      #order-confirm-modal .modal-close {
        color: #aaa;
        top: 15px;
        right: 15px;
        font-size: 2.5rem;
      }
      .modal-content .modal-close {
        z-index: 10;
      }
      /* ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¥ØµÙ„Ø§Ø­ ØªÙ…Ø±ÙŠØ± Ù†Ø§ÙØ°Ø© Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ */
      #checkout-modal .modal-content {
        max-width: 550px;
      }
      #checkout-modal .modal-body {
        padding: 20px 30px;
        overflow-y: auto; /* ğŸ’¡ (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ) */
      }
      /* ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ù†Ù…Ø· Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· */
      #email[readonly] {
        background-color: #f0f0f0;
        color: #555;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">Ù…Ù†Ø¬Ø±Ø©</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </li>
            <li>
              <a href="products.html" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
            </li>
            <li><a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a></li>
            <li>
              <a href="recommendation.html" class="nav-link">Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</a>
            </li>
            <li><a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a></li>
          </ul>

          <div class="auth-nav">
            <a href="cart.html" class="cart-icon-wrapper">
              <i class="fa-solid fa-bag-shopping" id="cart-icon"></i>
              <span id="cart-count-badge">0</span>
            </a>
            <div class="profile-dropdown" id="profile-dropdown">
              <div class="profile-icon">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="dropdown-menu">
                <div class="dropdown-header">
                  <span id="user-display-name">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</span>
                  <p id="user-email">Ø²Ø§Ø¦Ø±</p>
                </div>
                <a href="login.html" id="auth-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                <a href="#" id="logout-link" style="display: none"
                  >ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
                >
              </div>
            </div>
          </div>

          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="products.html" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
      <a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a>
      <a href="recommendation.html" class="nav-link">Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</a>
      <a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a>
    </div>

    <main>
      <section class="section container">
        <div class="section-title-wrapper"><h2>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2></div>
        <div class="cart-container" id="cart-container">
          <div class="cart-items-list" id="cart-items-list"></div>
          <div class="cart-summary" id="cart-summary">
            <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
            <div class="summary-row">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span
              ><span id="summary-subtotal">0 Ø´ÙŠÙƒÙ„</span>
            </div>
            <div class="summary-row">
              <span>Ø§Ù„Ø´Ø­Ù†</span><span>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹</span>
            </div>
            <div class="summary-row summary-total">
              <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span id="summary-total">0 Ø´ÙŠÙƒÙ„</span>
            </div>
            <button class="btn checkout-btn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
          </div>
        </div>
      </section>
    </main>

    <div id="checkout-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="checkout">&times;</span>
        <div class="modal-body">
          <div class="checkout-form-container">
            <h2>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</h2>
            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø³ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ ÙˆÙ…Ø±Ø§Ø¬Ø¹ØªÙ‡.</p>
            <form id="checkout-form">
              <div class="form-group">
                <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label
                ><input type="text" id="name" name="name" required />
              </div>
              <div class="form-group">
                <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  pattern="^(05[69][0-9]{7})$"
                  title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 056 Ø£Ùˆ 059 ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù… (ØµÙŠØºØ© Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ)."
                  required
                />
              </div>

              <div class="form-group">
                <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨)</label>
                <input type="email" id="email" name="email" required readonly />
              </div>

              <div class="form-group">
                <label for="city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                <select id="city" name="city" required>
                  <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="street-address"
                  >Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§ÙŠØ©)<span
                    class="required-field"
                    >*</span
                  ></label
                >
                <input
                  type="text"
                  id="street-address"
                  name="street-address"
                  required
                />
              </div>

              <div class="form-group">
                <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea
                  id="notes"
                  name="notes"
                  rows="2"
                  placeholder="Ù…Ø«Ø§Ù„: Ø§ØªØ±Ùƒ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø§Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„..."
                ></textarea>
              </div>

              <button
                type="submit"
                class="btn checkout-btn"
                id="confirm-order-btn"
              >
                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="order-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="order-confirm">&times;</span>
        <div class="confirm-icon">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <h2>Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!</h2>
        <p>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.</p>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø©
          <a
            href="order-status.html"
            style="color: var(--primary-color); font-weight: 600"
            >Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a
          >
          ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.
        </p>
      </div>
    </div>

    <footer>
      <div class="container footer-content">
        <div class="footer-col">
          <a href="index.html" class="footer-logo">Ù…Ù†Ø¬Ø±Ø©</a>
          <p>Ù†ØµÙ†Ø¹ Ø£Ø«Ø§Ø«Ø§Ù‹ ÙŠØ±ÙˆÙŠ Ù‚ØµØ©ØŒ Ù…ØµÙ…Ù… Ù„ÙŠØ¨Ø¹Ø« Ø§Ù„Ø¯ÙØ¡ ÙˆØ§Ù„Ø£Ù†Ø§Ù‚Ø© ÙÙŠ Ø£Ø±Ø¬Ø§Ø¡ Ù…Ù†Ø²Ù„Ùƒ.</p>
        </div>
        <div class="footer-col">
          <h4>Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h4>
          <ul class="footer-links">
            <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="products.html">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a></li>
            <li><a href="design.html">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h4>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
          <ul class="footer-links">
            <li><a href="order-status.html">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ</a></li>
            <li><a href="recommendation.html">Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</a></li>
            <li><a href="#">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a></li>
          </ul>
        </div>
      </div>
      <div class="copyright">&copy; 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        addDoc,
        collection,
        doc,
        updateDoc,
        getDoc,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      const FORMSPREE_ENDPOINT = "https://formspree.io/f/movkowpy";

      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      let cart = [];

      // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      const userDisplayName = document.getElementById("user-display-name");
      const userEmailDisplay = document.getElementById("user-email");
      const authLink = document.getElementById("auth-link");
      const logoutLink = document.getElementById("logout-link");

      const palestinianCities = [
        "Ø§Ù„Ù‚Ø¯Ø³",
        "Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ ÙˆØ§Ù„Ø¨ÙŠØ±Ø©",
        "Ø§Ù„Ø®Ù„ÙŠÙ„",
        "Ù†Ø§Ø¨Ù„Ø³",
        "Ø¬Ù†ÙŠÙ†",
        "Ø·ÙˆÙ„ÙƒØ±Ù…",
        "Ù‚Ù„Ù‚ÙŠÙ„ÙŠØ©",
        "Ø£Ø±ÙŠØ­Ø§",
        "Ø¨ÙŠØª Ù„Ø­Ù…",
        "Ø·ÙˆØ¨Ø§Ø³",
      ];

      function fillCityDropdown() {
        const citySelect = document.getElementById("city");
        palestinianCities.forEach((city) => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }

      function saveCart() {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
      }
      function loadCart() {
        const storedCart = localStorage.getItem("shoppingCart");
        cart = storedCart ? JSON.parse(storedCart) : [];
      }
      function changeQuantity(index, change) {
        if (cart[index]) {
          cart[index].quantity += change;
          if (cart[index].quantity < 1) {
            cart.splice(index, 1);
          }
          saveCart();
          updateCartUI();
        }
      }
      function removeItem(index) {
        if (cart[index]) {
          cart.splice(index, 1);
          saveCart();
          updateCartUI();
        }
      }
      function updateCartBadge() {
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (!cartCountBadge) return;
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.toggle("visible", totalItems > 0);
      }
      function updateCartUI() {
        const cartItemsList = document.getElementById("cart-items-list");
        const summarySubtotal = document.getElementById("summary-subtotal");
        const summaryTotal = document.getElementById("summary-total");
        const cartContainer = document.getElementById("cart-container");
        updateCartBadge();
        if (!cart || cart.length === 0) {
          cartContainer.innerHTML = `<div class="cart-empty-msg"><h2>Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©!</h2><p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</p><a href="products.html" class="btn back-to-shop">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a></div>`;
          return;
        }
        cartItemsList.innerHTML = "";
        let subtotal = 0;
        cart.forEach((item, index) => {
          const itemPrice = parseFloat(item.price);
          subtotal += itemPrice * item.quantity;
          const itemEl = document.createElement("div");
          itemEl.className = "cart-item";
          let itemImage = `https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80`;
          let itemDetails = `<h4>${item.name}</h4>`;
          let priceDisplay = `<p class="cart-item-price">${itemPrice.toFixed(
            0
          )} Ø´ÙŠÙƒÙ„</p>`;

          if (item.isCustom) {
            itemImage = `https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80`;
            priceDisplay = `<p class="cart-item-price">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${itemPrice.toFixed(
              0
            )} Ø´ÙŠÙƒÙ„</p>`;
            itemDetails += `<p class="cart-item-color">Ø§Ù„Ù†ÙˆØ¹: ${item.details.type}</p>`;
            itemDetails += `<p class="cart-item-color">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${
              item.details.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"
            }</p>`;
          } else {
            itemImage = item.image;
            const colorInfo = item.color
              ? `<p class="cart-item-color">Ø§Ù„Ù„ÙˆÙ†: ${item.color}</p>`
              : "";
            priceDisplay = item.originalPrice
              ? `<div><p class="cart-item-price" style="text-decoration: line-through; color: #999;">${
                  item.originalPrice
                } Ø´ÙŠÙƒÙ„</p><p class="cart-item-price" style="color: var(--success-color);">${itemPrice.toFixed(
                  0
                )} Ø´ÙŠÙƒÙ„</p></div>`
              : `<p class="cart-item-price">${itemPrice.toFixed(0)} Ø´ÙŠÙƒÙ„</p>`;
            itemDetails += colorInfo;
          }

          itemEl.innerHTML = `
              <img src="${itemImage}" alt="${item.name}" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80';">
              <div class="cart-item-details">
                  ${itemDetails}
                  ${priceDisplay}
                  <div class="cart-item-actions">
                      <div class="quantity-controls">
                          <button class="quantity-btn" data-index="${index}" data-change="-1">-</button>
                          <input type="number" value="${item.quantity}" min="1" readonly>
                          <button class="quantity-btn" data-index="${index}" data-change="1">+</button>
                      </div>
                      <button class="remove-item-btn" data-index="${index}">&times;</button>
                  </div>
              </div>`;
          cartItemsList.appendChild(itemEl);
        });
        summarySubtotal.textContent = subtotal.toFixed(0) + " Ø´ÙŠÙƒÙ„";
        summaryTotal.textContent = subtotal.toFixed(0) + " Ø´ÙŠÙƒÙ„";
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove("active");
          document.body.classList.remove("scroll-lock");
        }
      }

      async function sendOrderConfirmationEmail(
        customerData,
        readyItems,
        customItems
      ) {
        if (!customerData.email) return;
        const totalReady = readyItems
          .reduce(
            (sum, item) => sum + parseFloat(item.price) * item.quantity,
            0
          )
          .toFixed(0);
        let itemsList = "";
        if (readyItems.length > 0) {
          itemsList += "### Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©:\n";
          readyItems.forEach((item) => {
            const price = item.originalPrice
              ? `${item.originalPrice} -> ${parseFloat(item.price).toFixed(0)}`
              : parseFloat(item.price).toFixed(0);
            itemsList += `- Ø§Ù„Ù…Ù†ØªØ¬: ${item.name} | Ø§Ù„Ø¹Ø¯Ø¯: ${
              item.quantity
            } | Ø§Ù„Ø³Ø¹Ø±: ${price} Ø´ÙŠÙƒÙ„ ${
              item.color ? `| Ø§Ù„Ù„ÙˆÙ†: ${item.color}` : ""
            }\n`;
          });
        }
        if (customItems.length > 0) {
          itemsList += "\n### Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµ:\n";
          itemsList +=
            "ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….\n";
          customItems.forEach((item) => {
            itemsList += `- Ø§Ù„Ù†ÙˆØ¹: ${item.details.type || "---"} | Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${
              item.details.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"
            }\n`;
          });
        }
        const finalTotalDisplay =
          customItems.length > 0
            ? "Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„Ù…Ø®ØµØµ)"
            : `${totalReady} Ø´ÙŠÙƒÙ„`;
        const emailData = {
          _replyto: customerData.email,
          Ø§Ù„Ø¨Ø±ÙŠØ¯_Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ_Ù„Ù„Ø¹Ù…ÙŠÙ„: customerData.email,
          _subject: `âœ… Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… ${customerData.order_uid} (ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„)`,
          Ø§Ù„Ø§Ø³Ù…_Ø§Ù„ÙƒØ§Ù…Ù„: customerData.name,
          Ø±Ù‚Ù…_Ø§Ù„Ù‡Ø§ØªÙ: customerData.phone,
          Ø§Ù„Ø¹Ù†ÙˆØ§Ù†_Ø§Ù„ÙƒØ§Ù…Ù„: customerData.address,
          Ù…Ù„Ø§Ø­Ø¸Ø§Øª_Ø§Ù„ØªÙˆØµÙŠÙ„: customerData.notes,
          __Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ__: finalTotalDisplay,
          __ØªÙØ§ØµÙŠÙ„_Ø§Ù„Ø·Ù„Ø¨Ø§Øª__: itemsList,
        };
        try {
          const response = await fetch(FORMSPREE_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(emailData),
          });
          if (response.ok) {
            console.log("Order confirmation sent via Formspree successfully.");
          } else {
            console.error(
              "Formspree submission failed (Check Formspree dashboard for errors)."
            );
          }
        } catch (error) {
          console.error("Fetch error (Formspree):", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        updateCartUI();
        fillCityDropdown();

        // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            let userName = "Ù…Ø³ØªØ®Ø¯Ù…";
            if (userDocSnap.exists()) {
              userName = userDocSnap.data().name || userName;
            }
            userDisplayName.textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + userName;
            userEmailDisplay.textContent = user.email;
            authLink.style.display = "none";
            logoutLink.style.display = "block";
            logoutLink.onclick = async (e) => {
              e.preventDefault();
              await signOut(auth);
              window.location.href = "index.html";
            };
          } else {
            userDisplayName.textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ";
            userEmailDisplay.textContent = "Ø²Ø§Ø¦Ø±";
            authLink.style.display = "block";
            logoutLink.style.display = "none";
          }
        });

        // (Ø¨Ù‚ÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚ ÙƒÙ…Ø§ Ù‡Ùˆ)
        const checkoutBtn = document.querySelector(".checkout-btn");
        const checkoutModal = document.getElementById("checkout-modal");
        const orderConfirmModal = document.getElementById(
          "order-confirm-modal"
        );
        const checkoutForm = document.getElementById("checkout-form");
        const modalCloseBtns = document.querySelectorAll(".modal-close");
        const cartItemsList = document.getElementById("cart-items-list");

        if (cartItemsList) {
          cartItemsList.addEventListener("click", (event) => {
            const target = event.target;
            if (target.classList.contains("quantity-btn")) {
              changeQuantity(
                parseInt(target.dataset.index),
                parseInt(target.dataset.change)
              );
            } else if (target.classList.contains("remove-item-btn")) {
              removeItem(parseInt(target.dataset.index));
            }
          });
        }

        if (checkoutBtn) {
          checkoutBtn.addEventListener("click", () => {
            if (cart.length === 0) {
              alert("Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©.");
              return;
            }
            onAuthStateChanged(auth, async (user) => {
              if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                const emailInput = document.getElementById("email"); // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯)

                // ğŸ’¡ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„) ØªØ¹Ø¨Ø¦Ø© Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¬Ø¹Ù„Ù‡ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
                emailInput.value = user.email;

                if (userDocSnap.exists()) {
                  const userData = userDocSnap.data();
                  document.getElementById("name").value = userData.name || "";
                  document.getElementById("phone").value = userData.phone || "";

                  // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ù…Ù†Ø·Ù‚ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
                  const userAddress = userData.address || "";
                  const cityMatch = palestinianCities.find((c) =>
                    userAddress.startsWith(c)
                  );
                  if (cityMatch) {
                    document.getElementById("city").value = cityMatch;
                    const streetOnly = userAddress
                      .replace(cityMatch, "")
                      .replace(",", "")
                      .trim();
                    document.getElementById("street-address").value =
                      streetOnly;
                  } else {
                    document.getElementById("street-address").value =
                      userAddress;
                  }
                  // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                  document.getElementById("notes").value = userData.notes || "";
                }
                checkoutModal.classList.add("active");
                document.body.classList.add("scroll-lock");
              } else {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡.");
                window.location.href = "login.html";
              }
            });
          });
        }

        modalCloseBtns.forEach((btn) => {
          btn.addEventListener("click", () =>
            closeModal(btn.closest(".modal-overlay").id)
          );
        });

        checkoutForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const phoneInput = document.getElementById("phone");
          const emailInput = document.getElementById("email");
          const phonePattern = /^(05[69][0-9]{7})$/;
          if (!phonePattern.test(phoneInput.value)) {
            alert(
              "ØµÙŠØºØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 056 Ø£Ùˆ 059 ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù…."
            );
            return;
          }
          // ğŸ’¡ (Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø¶Ù…ÙˆÙ† Ø§Ù„Ø¢Ù† Ù„Ø£Ù†Ù‡ readonly)
          if (!emailInput.value) {
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
            return;
          }

          onAuthStateChanged(auth, async (user) => {
            if (user) {
              const selectedCity = document.getElementById("city").value;
              const streetAddress =
                document.getElementById("street-address").value;
              const notes = document.getElementById("notes").value;
              const fullAddress = `${selectedCity}, ${streetAddress}`;

              const customerData = {
                customer_uid: user.uid,
                order_uid: "ORD-" + Date.now(),
                name: document.getElementById("name").value,
                phone: phoneInput.value,
                email: emailInput.value, // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡ÙŠ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†
                address: fullAddress,
                city: selectedCity,
                notes: notes,
                order_date: new Date().toISOString(),
                status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
              };

              try {
                // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                const userDocRef = doc(db, "users", user.uid);
                await updateDoc(userDocRef, {
                  name: customerData.name,
                  phone: customerData.phone,
                  address: customerData.address,
                  city: customerData.city,
                  // ğŸ’¡ Ù„Ø§ Ù†Ø­Ø¯Ø« Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡ Ø«Ø§Ø¨Øª
                  notes: customerData.notes,
                });

                const batch = writeBatch(db);
                const ordersCollection = collection(db, "orders");
                const customDesignsCollection = collection(
                  db,
                  "custom_designs"
                );
                const readyItems = cart.filter((item) => !item.isCustom);
                const customItems = cart.filter((item) => item.isCustom);

                if (readyItems.length > 0) {
                  const readyOrder = {
                    ...customerData,
                    items: readyItems,
                    total: readyItems.reduce(
                      (sum, item) =>
                        sum + parseFloat(item.price) * item.quantity,
                      0
                    ),
                  };
                  batch.set(doc(ordersCollection), readyOrder);
                }

                if (customItems.length > 0) {
                  customItems.forEach((item) => {
                    const customOrder = {
                      ...customerData,
                      ...item.details,
                      price: item.price,
                      status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                    };
                    batch.set(doc(customDesignsCollection), customOrder);
                  });
                }

                await batch.commit();
                sendOrderConfirmationEmail(
                  customerData,
                  readyItems,
                  customItems
                );
                closeModal("checkout-modal");
                orderConfirmModal.classList.add("active");
                document.body.classList.add("scroll-lock");
                cart = [];
                saveCart();
                updateCartUI();
              } catch (e) {
                console.error("Error adding document: ", e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.");
              }
            } else {
              alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.");
            }
          });
        });

        // (Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ)
        const menuToggle = document.getElementById("menu-toggle");
        const mobileMenu = document.getElementById("mobile-menu");
        const body = document.body;
        menuToggle.addEventListener("click", () => {
          mobileMenu.classList.toggle("active");
          body.classList.toggle("scroll-lock");
        });
      });
    </script>
  </body>
</html>
