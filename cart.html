<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      #order-confirm-modal .modal-content {
        max-width: 550px;
        text-align: center;
        padding: 50px 30px;
        background: linear-gradient(
          135deg,
          var(--white-color) 0%,
          #fefcfb 100%
        );
        border: 2px solid var(--primary-color);
      }
      #order-confirm-modal h2 {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        position: relative;
      }
      #order-confirm-modal h2::after {
        content: "âœ”";
        display: block;
        font-size: 3.5rem;
        color: var(--primary-color);
        margin-top: -1rem;
        margin-bottom: 1rem;
        line-height: 1;
      }
      #order-confirm-modal p {
        font-size: 1.2rem;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
        line-height: 1.6;
      }
      /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±Ø¶ Ø±Ù…Ø² Ø§Ù„ØªØªØ¨Ø¹ Ù„Ø¹Ø¯Ù… Ø§Ù„Ø­Ø§Ø¬Ø© Ø¥Ù„ÙŠÙ‡ */
      #order-confirm-modal .tracking-id-display {
        display: none;
      }
      #order-confirm-modal .modal-close {
        color: #aaa;
        top: 20px;
        right: 20px;
        font-size: 2rem;
        transition: color 0.2s;
      }
      #order-confirm-modal .modal-close:hover {
        color: var(--dark-color);
      }
      .modal-content .modal-close {
        z-index: 10;
      }
      .modal-body {
        display: block;
        text-align: right;
      }
      .cart-item-color {
        font-size: 0.9rem;
        color: #777;
        margin-top: -5px;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">Ù…Ù†Ø¬Ø±Ø©</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li><a href="index.html" class="nav-link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a></li>
            <li><a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a></li>
            <li><a href="recommendation.html" class="nav-link">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</a></li>
            <li><a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a></li>
          </ul>
          <a href="cart.html" class="cart-icon-wrapper">
            <svg
              id="cart-icon"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
              />
            </svg>
            <span id="cart-count-badge">0</span>
          </a>
        </div>
      </nav>
    </header>

    <main>
      <section class="section container">
        <div class="section-title-wrapper"><h2>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2></div>
        <div class="cart-container" id="cart-container">
          <div class="cart-items-list" id="cart-items-list"></div>
          <div class="cart-summary" id="cart-summary">
            <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
            <div class="summary-row">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span
              ><span id="summary-subtotal">0 Ø´ÙŠÙƒÙ„</span>
            </div>
            <div class="summary-row">
              <span>Ø§Ù„Ø´Ø­Ù†</span><span>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹</span>
            </div>
            <div class="summary-row summary-total">
              <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span id="summary-total">0 Ø´ÙŠÙƒÙ„</span>
            </div>
            <button class="btn checkout-btn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
          </div>
        </div>
      </section>
    </main>

    <div id="checkout-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="checkout">&times;</span>
        <div class="modal-body">
          <div class="checkout-form-container">
            <h2>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</h2>
            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø³ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
            <form id="checkout-form">
              <div class="form-group">
                <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label
                ><input type="text" id="name" name="name" required />
              </div>
              <div class="form-group">
                <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  pattern="^(05[69][0-9]{7})$"
                  title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 056 Ø£Ùˆ 059 ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù… (ØµÙŠØºØ© Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ)."
                  required
                />
              </div>
              <div class="form-group">
                <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label
                ><input type="email" id="email" name="email" />
              </div>

              <div class="form-group">
                <label for="city"
                  >Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                  <span style="font-weight: normal"
                    >(ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</span
                  ></label
                >
                <select id="city" name="city" required>
                  <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="notes"
                  >Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø³Ù… Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ù…Ø¹Ù„Ù… Ù…Ø¹ÙŠÙ†)</label
                >
                <textarea id="notes" name="notes" rows="3"></textarea>
              </div>

              <button
                type="submit"
                class="btn checkout-btn"
                id="confirm-order-btn"
              >
                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="order-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="order-confirm">&times;</span>
        <h2>Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!</h2>
        <p>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.</p>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡). ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø©
          Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø©
          <a href="order-status.html">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a> ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.
        </p>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        addDoc,
        collection,
        doc,
        updateDoc,
        getDoc,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      const FORMSPREE_ENDPOINT = "https://formspree.io/f/movkowpy";

      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      let cart = [];

      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù† Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ© (Ø§Ù„Ø¶ÙØ© Ø§Ù„ØºØ±Ø¨ÙŠØ©)
      const palestinianCities = [
        "Ø§Ù„Ù‚Ø¯Ø³",
        "Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ ÙˆØ§Ù„Ø¨ÙŠØ±Ø©",
        "Ø§Ù„Ø®Ù„ÙŠÙ„",
        "Ù†Ø§Ø¨Ù„Ø³",
        "Ø¬Ù†ÙŠÙ†",
        "Ø·ÙˆÙ„ÙƒØ±Ù…",
        "Ù‚Ù„Ù‚ÙŠÙ„ÙŠØ©",
        "Ø£Ø±ÙŠØ­Ø§",
        "Ø¨ÙŠØª Ù„Ø­Ù…",
        "Ø·ÙˆØ¨Ø§Ø³",
      ];

      function fillCityDropdown() {
        const citySelect = document.getElementById("city");
        palestinianCities.forEach((city) => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }

      function saveCart() {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
      }
      function loadCart() {
        const storedCart = localStorage.getItem("shoppingCart");
        cart = storedCart ? JSON.parse(storedCart) : [];
      }
      function changeQuantity(index, change) {
        if (cart[index]) {
          cart[index].quantity += change;
          if (cart[index].quantity < 1) {
            cart.splice(index, 1);
          }
          saveCart();
          updateCartUI();
        }
      }
      function removeItem(index) {
        if (cart[index]) {
          cart.splice(index, 1);
          saveCart();
          updateCartUI();
        }
      }
      function updateCartBadge() {
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (!cartCountBadge) return;
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.toggle("visible", totalItems > 0);
      }
      function updateCartUI() {
        const cartItemsList = document.getElementById("cart-items-list");
        const summarySubtotal = document.getElementById("summary-subtotal");
        const summaryTotal = document.getElementById("summary-total");
        const cartContainer = document.getElementById("cart-container");
        updateCartBadge();
        if (!cart || cart.length === 0) {
          cartContainer.innerHTML = `<div class="cart-empty-msg"><h2>Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©!</h2><p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</p><a href="index.html" class="btn back-to-shop">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a></div>`;
          return;
        }
        cartItemsList.innerHTML = "";
        let subtotal = 0;
        cart.forEach((item, index) => {
          // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³Ø¹Ø± Ø±Ù‚Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨
          const itemPrice = parseFloat(item.price);
          subtotal += itemPrice * item.quantity;

          const itemEl = document.createElement("div");
          itemEl.className = "cart-item";

          let itemImage = `https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80`;
          let itemDetails = `<h4>${item.name}</h4>`;
          let priceDisplay = `<p class="cart-item-price">${itemPrice.toFixed(
            0
          )} Ø´ÙŠÙƒÙ„</p>`;

          if (item.isCustom) {
            itemImage = `https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80`;
            priceDisplay = `<p class="cart-item-price">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${itemPrice.toFixed(
              0
            )} Ø´ÙŠÙƒÙ„</p>`;
            itemDetails += `<p class="cart-item-color">Ø§Ù„Ù†ÙˆØ¹: ${item.details.type}</p>`;
            itemDetails += `<p class="cart-item-color">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${
              item.details.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"
            }</p>`;
          } else {
            itemImage = item.image;
            const colorInfo = item.color
              ? `<p class="cart-item-color">Ø§Ù„Ù„ÙˆÙ†: ${item.color}</p>`
              : "";
            priceDisplay = item.originalPrice
              ? `<div><p class="cart-item-price old-price">${
                  item.originalPrice
                } Ø´ÙŠÙƒÙ„</p><p class="cart-item-price new-price">${itemPrice.toFixed(
                  0
                )} Ø´ÙŠÙƒÙ„</p></div>`
              : `<p class="cart-item-price">${itemPrice.toFixed(0)} Ø´ÙŠÙƒÙ„</p>`;
            itemDetails += colorInfo;
          }

          itemEl.innerHTML = `
              <img src="${itemImage}" alt="${item.name}" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80';">
              <div class="cart-item-details">
                  ${itemDetails}
                  ${priceDisplay}
                  <div class="cart-item-actions">
                      <div class="quantity-controls">
                          <button class="quantity-btn" data-index="${index}" data-change="-1">-</button>
                          <input type="number" value="${item.quantity}" min="1" readonly>
                          <button class="quantity-btn" data-index="${index}" data-change="1">+</button>
                      </div>
                      <button class="remove-item-btn" data-index="${index}">&times;</button>
                  </div>
              </div>`;
          cartItemsList.appendChild(itemEl);
        });
        summarySubtotal.textContent = subtotal.toFixed(0) + " Ø´ÙŠÙƒÙ„";
        summaryTotal.textContent = subtotal.toFixed(0) + " Ø´ÙŠÙƒÙ„";
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove("active");
          document.body.classList.remove("scroll-lock");
        }
      }

      // ------------------------------------------------
      // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Formspree (ØªÙ†Ø³ÙŠÙ‚ Ù†ØµÙŠ Ù…Ø­Ø³Ù†)
      // ------------------------------------------------
      async function sendOrderConfirmationEmail(
        customerData,
        readyItems,
        customItems
      ) {
        // Formspree ÙŠØªØ·Ù„Ø¨ Ø­Ù‚Ù„ _replyto Ø£Ùˆ Ø£Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        if (!customerData.email) return;

        const totalReady = readyItems
          .reduce(
            (sum, item) => sum + parseFloat(item.price) * item.quantity,
            0
          )
          .toFixed(0);

        let itemsList = "";

        // ØªØ¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©
        if (readyItems.length > 0) {
          itemsList += "### Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©:\n";
          readyItems.forEach((item) => {
            const price = item.originalPrice
              ? `${item.originalPrice} -> ${parseFloat(item.price).toFixed(0)}`
              : parseFloat(item.price).toFixed(0);
            itemsList += `- Ø§Ù„Ù…Ù†ØªØ¬: ${item.name} | Ø§Ù„Ø¹Ø¯Ø¯: ${
              item.quantity
            } | Ø§Ù„Ø³Ø¹Ø±: ${price} Ø´ÙŠÙƒÙ„ ${
              item.color ? `| Ø§Ù„Ù„ÙˆÙ†: ${item.color}` : ""
            }\n`;
          });
        }

        // ØªØ¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©
        if (customItems.length > 0) {
          itemsList += "\n### Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµ:\n";
          itemsList +=
            "ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….\n";
          customItems.forEach((item) => {
            itemsList += `- Ø§Ù„Ù†ÙˆØ¹: ${item.details.type || "---"} | Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${
              item.details.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"
            }\n`;
          });
        }

        const finalTotalDisplay =
          customItems.length > 0
            ? "Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„Ù…Ø®ØµØµ)"
            : `${totalReady} Ø´ÙŠÙƒÙ„`;

        const emailData = {
          _replyto: customerData.email,
          _subject: `ğŸ†• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ${customerData.name} - Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${finalTotalDisplay}`, // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¶ÙˆØ¹ ÙˆØ§Ø¶Ø­

          Ø§Ù„Ø¹Ù…ÙŠÙ„: customerData.name,
          Ø§Ù„Ù‡Ø§ØªÙ: customerData.phone,
          Ø§Ù„Ø¨Ø±ÙŠØ¯_Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: customerData.email,
          Ø§Ù„Ø¹Ù†ÙˆØ§Ù†_Ø§Ù„ÙƒØ§Ù…Ù„: customerData.address,
          Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
            document.getElementById("notes").value || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
          __Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ__: finalTotalDisplay,

          // Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙƒØ³Ù„Ø³Ù„Ø© Ù†ØµÙŠØ© Ø·ÙˆÙŠÙ„Ø©
          __ØªÙØ§ØµÙŠÙ„_Ø§Ù„Ø·Ù„Ø¨Ø§Øª__: itemsList,
        };

        try {
          const response = await fetch(FORMSPREE_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(emailData),
          });

          if (response.ok) {
            console.log("Order confirmation sent via Formspree successfully.");
          } else {
            console.error(
              "Formspree submission failed (Check Formspree dashboard for errors)."
            );
          }
        } catch (error) {
          console.error("Fetch error (Formspree):", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        updateCartUI();
        fillCityDropdown();

        const checkoutBtn = document.querySelector(".checkout-btn");
        const checkoutModal = document.getElementById("checkout-modal");
        const orderConfirmModal = document.getElementById(
          "order-confirm-modal"
        );
        const checkoutForm = document.getElementById("checkout-form");
        const modalCloseBtns = document.querySelectorAll(".modal-close");
        const cartItemsList = document.getElementById("cart-items-list");

        if (cartItemsList) {
          cartItemsList.addEventListener("click", (event) => {
            const target = event.target;
            if (target.classList.contains("quantity-btn")) {
              changeQuantity(
                parseInt(target.dataset.index),
                parseInt(target.dataset.change)
              );
            } else if (target.classList.contains("remove-item-btn")) {
              removeItem(parseInt(target.dataset.index));
            }
          });
        }

        if (checkoutBtn) {
          checkoutBtn.addEventListener("click", () => {
            if (cart.length === 0) {
              alert("Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©.");
              return;
            }
            onAuthStateChanged(auth, async (user) => {
              if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                  const userData = userDocSnap.data();
                  document.getElementById("name").value = userData.name || "";
                  document.getElementById("phone").value = userData.phone || "";
                  document.getElementById("email").value = userData.email || "";

                  // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®Ø²Ù†Ø©
                  const userAddress = userData.address || "";
                  const cityMatch = palestinianCities.find((c) =>
                    userAddress.includes(c)
                  );
                  if (cityMatch) {
                    document.getElementById("city").value = cityMatch;
                    // ÙˆØ¶Ø¹ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                    document.getElementById("notes").value = userAddress
                      .replace(cityMatch, "")
                      .replace(",", "")
                      .trim();
                  } else {
                    document.getElementById("notes").value = userAddress;
                  }
                }
                checkoutModal.classList.add("active");
                document.body.classList.add("scroll-lock");
              } else {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡.");
                window.location.href = "login.html";
              }
            });
          });
        }

        modalCloseBtns.forEach((btn) => {
          btn.addEventListener("click", () =>
            closeModal(btn.closest(".modal-overlay").id)
          );
        });

        checkoutForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const phoneInput = document.getElementById("phone");
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ù†Ù…Ø· Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ
          const phonePattern = /^(05[69][0-9]{7})$/;
          if (!phonePattern.test(phoneInput.value)) {
            alert(
              "ØµÙŠØºØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 056 Ø£Ùˆ 059 ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù…."
            );
            return;
          }

          onAuthStateChanged(auth, async (user) => {
            if (user) {
              const selectedCity = document.getElementById("city").value;
              const notes = document.getElementById("notes").value;
              const fullAddress = `${selectedCity}, ${notes}`
                .replace(", ,", ",")
                .trim();

              const customerData = {
                customer_uid: user.uid,
                name: document.getElementById("name").value,
                phone: phoneInput.value,
                email: document.getElementById("email").value,
                address: fullAddress,
                city: selectedCity,
                notes: notes,
                order_date: new Date().toISOString(),
                status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
              };

              try {
                // 1. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                const userDocRef = doc(db, "users", user.uid);
                await updateDoc(userDocRef, {
                  name: customerData.name,
                  phone: customerData.phone,
                  address: customerData.address,
                  city: customerData.city,
                });

                const batch = writeBatch(db);
                const ordersCollection = collection(db, "orders");
                const customDesignsCollection = collection(
                  db,
                  "custom_designs"
                );
                const readyItems = cart.filter((item) => !item.isCustom);
                const customItems = cart.filter((item) => item.isCustom);

                if (readyItems.length > 0) {
                  const readyOrder = {
                    ...customerData,
                    items: readyItems,
                    total: readyItems.reduce(
                      (sum, item) =>
                        sum + parseFloat(item.price) * item.quantity,
                      0
                    ),
                  };
                  batch.set(doc(ordersCollection), readyOrder);
                }

                if (customItems.length > 0) {
                  customItems.forEach((item) => {
                    const customOrder = {
                      ...customerData,
                      ...item.details,
                      price: item.price,
                      status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                    };
                    batch.set(doc(customDesignsCollection), customOrder);
                  });
                }

                // 2. ØªÙ†ÙÙŠØ° Ø§Ù„Ø­ÙØ¸
                await batch.commit();

                // 3. ğŸ’¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¹Ø¨Ø± Formspree
                sendOrderConfirmationEmail(
                  customerData,
                  readyItems,
                  customItems
                );

                closeModal("checkout-modal");

                // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
                orderConfirmModal.classList.add("active");
                document.body.classList.add("scroll-lock");

                cart = [];
                saveCart();
                updateCartUI();
              } catch (e) {
                console.error("Error adding document: ", e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.");
              }
            } else {
              alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.");
            }
          });
        });
      });
    </script>
  </body>
</html>
