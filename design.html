<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .design-page-section {
        max-width: 900px;
        margin: 5rem auto;
        padding: 40px;
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: right;
      }
      .design-form {
        margin-top: 2rem;
      }
      .design-form .form-group {
        margin-bottom: 1.5rem;
      }
      .design-form .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }
      .design-form .form-group input,
      .design-form .form-group select,
      .design-form .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Cairo", sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .design-form .form-group input:focus,
      .design-form .form-group select:focus,
      .design-form .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(121, 85, 72, 0.2);
      }
      .design-form .btn {
        display: block;
        width: 100%;
        margin-top: 2.5rem;
      }
      .required-field {
        color: var(--danger-color);
        margin-right: 5px;
      }
      .loading-msg {
        text-align: center;
        font-size: 1.1rem;
        color: #999;
        padding: 40px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .design-result-section.show {
        display: block;
      }

      /* ğŸ’¡ Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
      #material-preview-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 2rem;
        padding-top: 15px;
      }
      .preview-card {
        text-align: center;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 15px;
        background-color: var(--light-color);
      }
      .preview-box {
        height: 120px;
        border-radius: 8px;
        margin-top: 10px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        transition: background-image 0.5s;
        border: 1px solid #ddd;
      }
      .preview-card p {
        font-weight: 600;
        color: var(--primary-color);
        margin-top: 10px;
      }
      /* ğŸ’¡ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª */
      #addons-list {
        list-style: none;
        padding: 0;
        margin-top: 10px;
        border: 1px solid #eee;
        border-radius: 8px;
        max-height: 150px;
        overflow-y: auto;
      }
      #addons-list li {
        padding: 8px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
      }
      #addons-list li:last-child {
        border-bottom: none;
      }

      /* ğŸ’¡ Ù†Ù…Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© */
      #material-select option[disabled] {
        color: #aaa;
        background-color: #f7f7f7;
      }
      /* ğŸ’¡ Ù†Ù…Ø· Ø®Ø§Øµ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶ */
      #material-select .low-stock-option {
        color: #f39c12; /* Ù„ÙˆÙ† ØªØ­Ø°ÙŠØ±ÙŠ (Ø£ØµÙØ±/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ) */
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">Ù…Ù†Ø¬Ø±Ø©</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </li>
            <li>
              <a href="index.html#products-page" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
            </li>
            <li>
              <a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a>
            </li>
            <li>
              <a href="recommendation.html" class="nav-link">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</a>
            </li>
            <li>
              <a href="design.html" class="nav-link active">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a>
            </li>
          </ul>
          <a href="cart.html" class="cart-icon-wrapper">
            <svg
              id="cart-icon"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
              />
            </svg>
            <span id="cart-count-badge">0</span>
          </a>
          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="index.html#products-page" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
      <a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a>
      <a href="recommendation.html" class="nav-link">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</a>
      <a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a>
    </div>

    <main>
      <section class="section container design-page-section">
        <div class="section-title-wrapper">
          <h2>ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ Ø§Ù„Ø®Ø§Øµ</h2>
        </div>
        <p style="text-align: center; color: #777">
          ØµÙ Ù„Ù†Ø§ ÙÙƒØ±ØªÙƒ ÙÙŠ Ø®Ø·ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© ÙˆØ³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ ØªØµÙ…ÙŠÙ… Ù…Ù‚ØªØ±Ø­.
        </p>

        <form id="design-form" class="design-form">
          <div class="form-step active" data-step="1">
            <div class="form-group">
              <label for="product-type"
                ><span class="required-field">*</span> Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label
              >
              <select id="product-type" name="product-type" required>
                <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ --</option>
                <option value="Ø·Ø§ÙˆÙ„Ø© Ø³ÙØ±Ø©">Ø·Ø§ÙˆÙ„Ø© Ø³ÙØ±Ø©</option>
                <option value="ÙƒØ±Ø³ÙŠ">ÙƒØ±Ø³ÙŠ</option>
                <option value="Ø·Ù‚Ù… ÙƒÙ†Ø¨">Ø·Ù‚Ù… ÙƒÙ†Ø¨</option>
                <option value="ØºØ±ÙØ© Ù†ÙˆÙ…">ØºØ±ÙØ© Ù†ÙˆÙ…</option>
                <option value="Ù…Ø·Ø¨Ø®">Ù…Ø·Ø¨Ø®</option>
                <option value="Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·">Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·</option>
                <option value="Ø®Ø²Ø§Ù†Ø©">Ø®Ø²Ø§Ù†Ø©</option>
                <option value="Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ§Ø²">Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ§Ø²</option>
                <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±...</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dimensions"
                  ><span class="required-field">*</span> Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
                  Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©</label
                >
                <select id="dimensions" name="dimensions" required>
                  <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹ --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="room-placement"
                  ><span class="required-field">*</span> Ù…ÙƒØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù†ØªØ¬</label
                >
                <select id="room-placement" name="room-placement" required>
                  <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† --</option>
                  <option value="ØºØ±ÙØ© Ø§Ù„Ù…Ø¹ÙŠØ´Ø©">ØºØ±ÙØ© Ø§Ù„Ù…Ø¹ÙŠØ´Ø©</option>
                  <option value="ØºØ±ÙØ© Ø§Ù„Ø·Ø¹Ø§Ù…">ØºØ±ÙØ© Ø§Ù„Ø·Ø¹Ø§Ù…</option>
                  <option value="ØºØ±ÙØ© Ø§Ù„Ù†ÙˆÙ…">ØºØ±ÙØ© Ø§Ù„Ù†ÙˆÙ…</option>
                  <option value="Ø§Ù„Ù…Ø·Ø¨Ø®">Ø§Ù„Ù…Ø·Ø¨Ø®</option>
                  <option value="Ø§Ù„Ù…ÙƒØªØ¨">Ø§Ù„Ù…ÙƒØªØ¨</option>
                  <option value="ØºØ±ÙØ© Ø§Ù„Ø£Ø·ÙØ§Ù„">ØºØ±ÙØ© Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
                  <option value="Ø®Ø§Ø±Ø¬ÙŠ">Ø®Ø§Ø±Ø¬ÙŠ</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="material"
                  ><span class="required-field">*</span> Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ÙØ¶Ù„Ø©
                  (Ù†ÙˆØ¹ Ø§Ù„Ø®Ø´Ø¨)</label
                >
                <select id="material" name="material" required>
                  <option value="">-- Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="color"
                  ><span class="required-field">*</span> Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„ØªØ´Ø·ÙŠØ¨
                  Ø§Ù„Ù…ÙØ¶Ù‘Ù„</label
                >
                <select id="color" name="color" required>
                  <option value="">-- Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ --</option>
                </select>
              </div>
            </div>

            <div id="material-preview-container">
              <div class="preview-card">
                <label>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø´Ø¨ (Ø§Ù„ØªÙƒØ³ØªØ´Ø±)</label>
                <div id="preview-material-box" class="preview-box"></div>
                <p id="material-label">Ø§Ù„Ø®Ø´Ø¨: Ù„Ù… ÙŠÙØ®ØªØ±</p>
              </div>
              <div class="preview-card">
                <label>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„ÙˆÙ†</label>
                <div id="preview-color-box" class="preview-box"></div>
                <p id="color-label">Ø§Ù„Ù„ÙˆÙ†: Ù„Ù… ÙŠÙØ®ØªØ±</p>
              </div>
            </div>

            <h3
              style="
                margin-top: 1.5rem;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
              "
            >
              <i class="fa-solid fa-layer-group"></i> Ø¥Ø¶Ø§ÙØ§Øª ÙˆØªÙØ§ØµÙŠÙ„ Ù…Ù…ÙŠØ²Ø©
            </h3>
            <div class="form-row" style="grid-template-columns: 3fr 1fr">
              <div class="form-group" style="margin-bottom: 0">
                <label
                  for="addon-input"
                  style="font-size: 1rem; margin-bottom: 0"
                  >Ø£Ø¶Ù Ù…ÙŠØ²Ø© (Ù…Ø«Ù„: Ø£Ø¯Ø±Ø§Ø¬ Ù…Ø®ÙÙŠØ©ØŒ Ø­Ø§Ù…Ù„ Ø£ÙƒÙˆØ§Ø¨ØŒ Ø¥Ø¶Ø§Ø¡Ø©)</label
                >
                <input
                  type="text"
                  id="addon-input"
                  placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙŠØ²Ø© Ù‡Ù†Ø§..."
                />
              </div>
              <div class="form-group" style="align-self: end; margin-bottom: 0">
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  id="add-addon-btn"
                >
                  <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                </button>
              </div>
            </div>

            <div class="form-group">
              <ul id="addons-list">
                <li style="text-align: center; color: #777">
                  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª Ø¨Ø¹Ø¯
                </li>
              </ul>
            </div>

            <div class="form-group" id="notes-group">
              <label for="notes"
                ><span class="required-field">*</span> ÙˆØµÙ ÙÙƒØ±ØªÙƒ ÙˆØªÙØ§ØµÙŠÙ„
                Ø§Ù„ØªØµÙ…ÙŠÙ…</label
              >
              <textarea
                id="notes"
                name="notes"
                rows="4"
                required
                placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­ØªØ§Ø¬ Ø·Ø§ÙˆÙ„Ø© Ø·Ø¹Ø§Ù… Ø¨Ù†Ù…Ø· Ø±ÙŠÙÙŠØŒ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© 3000-4000 Ø´ÙŠÙƒÙ„ØŒ Ø£Ø±ÙŠØ¯ Ø£Ø¯Ø±Ø§Ø¬Ø§Ù‹ Ù…Ø®ÙÙŠØ©."
              ></textarea>
            </div>
          </div>

          <button type="submit" class="btn" id="submit-form-btn">
            <i class="fa-solid fa-robot"></i> Ø§Ù‚ØªØ±Ø§Ø­ ØªØµÙ…ÙŠÙ…
          </button>
        </form>

        <div id="processing-message" class="loading-bar-container">
          <div class="loading-bar"></div>
          <p style="text-align: center; font-weight: bold; padding-top: 5px">
            Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ...
          </p>
        </div>

        <div
          id="design-result"
          class="design-result-section"
          style="display: none"
        >
          <h2 style="margin-bottom: 1.5rem">Ø§Ù‚ØªØ±Ø§Ø­Ù†Ø§ Ù„Ùƒ</h2>
          <div class="design-result-text" id="result-content"></div>
          <div class="design-result-actions">
            <button class="btn" id="submit-design-btn">
              <i class="fa-solid fa-cart-plus"></i> Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            </button>
            <button
              class="btn"
              id="regenerate-design-btn"
              style="background-color: var(--accent-color)"
            >
              Ø§Ù‚ØªØ±Ø§Ø­ Ø¢Ø®Ø±
            </button>
          </div>
          <div
            style="
              margin-top: 2rem;
              text-align: center;
              font-size: 0.9rem;
              color: #888;
            "
          >
            <p>
              Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù‡Ùˆ Ù†Ø·Ø§Ù‚ Ø£ÙˆÙ„ÙŠ Ù…Ù‚ØªØ±Ø­. Ø³ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡ Ø¨Ø¹Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙØ±ÙŠÙ‚.
              ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© ÙˆØ¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ.
            </p>
          </div>
        </div>
      </section>
    </main>

    <div id="design-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-confirm">&times;</span>
        <h2>Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!</h2>
        <p>
          ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ù„Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø®Ù„Ø§Ù„
          ÙŠÙˆÙ…ÙŠ Ø¹Ù…Ù„.
        </p>
        <p>Ø±Ù…Ø² Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ø·Ù„Ø¨Ùƒ Ù‡Ùˆ:</p>
        <span id="design-tracking-id" class="tracking-id-display"></span>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ ÙˆÙ‚Ø¨ÙˆÙ„ Ø£Ùˆ Ø±ÙØ¶ Ø§Ù„Ø³Ø¹Ø±
          Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.
        </p>
      </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <div id="design-checkout-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-checkout">&times;</span>
        <div class="modal-body">
          <div class="checkout-form-container">
            <h2>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…</h2>
            <p>
              Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…. Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ
              Ù„Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡.
            </p>
            <form id="design-checkout-form">
              <div class="form-group">
                <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input type="text" id="design-name" name="name" required />
              </div>
              <div class="form-group">
                <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="tel" id="design-phone" name="phone" required />
              </div>
              <div class="form-group">
                <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="email" id="design-email" name="email" />
              </div>
              <div class="form-group">
                <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <textarea
                  id="design-address"
                  name="address"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn" id="confirm-design-btn">
                ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // ******* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ùˆ Gemini *******
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const textModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // Ù…ØªØºÙŠØ±Ø§Øª ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      let allProducts = [];
      let allRawMaterials = [];
      let currentUser = null;
      let currentDesign = null;
      let currentAddons = [];

      // ğŸ’¡ Ø®Ø±ÙŠØ·Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙŠ Ù…Ø¬Ù„Ø¯ 'colers'
      const colorFileMap = {
        Ø£Ø¨ÙŠØ¶: "white.png",
        Ø£Ø³ÙˆØ¯: "black.png",
        "Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­": "gray.png",
        "Ø£Ø²Ø±Ù‚ Ù†ÙŠÙ„ÙŠ": "blue.png",
        "Ø£Ø®Ø¶Ø± Ø²Ù…Ø±Ø¯ÙŠ": "green.png",
        "Ø¨ÙŠØ¬ Ù…Ø·ÙÙŠ": "offwhite.png",
        "Ø¨Ù†ÙŠ ØºØ§Ù…Ù‚": "braw.png",
        "Ø£Ø­Ù…Ø± Ø³Ø§Ø·Ø¹": "red.png",
        "Ø¨Ù†ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ": "normal.png",
      };

      // ğŸ’¡ Ø®Ø±ÙŠØ·Ø© Ù„Ø±Ø¨Ø· Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø®Ø´Ø§Ø¨ Ø¨Ù…Ø³Ø§Ø±Ø§Øª ØµÙˆØ± Ø§Ù„ØªÙƒØ³ØªØ´Ø± Ø§Ù„Ù…Ø­Ù„ÙŠØ© (wood/)
      const woodTextureMap = {
        "Ø®Ø´Ø¨ Ø²Ø§Ù†": "wood/Beech Wood.jpg",
        "Ø®Ø´Ø¨ Ø¨Ù„ÙˆØ·": "wood/Oak Wood.webp",
        "Ø®Ø´Ø¨ Ø³Ù†Ø¯ÙŠØ§Ù†": "wood/white-oak.jpg",
        "Ø®Ø´Ø¨ Ø¬ÙˆØ²": "wood/Walnut Wood.webp",
        "Ø®Ø´Ø¨ ØµÙ†ÙˆØ¨Ø±": "wood/Pine Wood.webp",
        "Ø®Ø´Ø¨ ØµÙˆØ±": "colers/braw.png",
      };

      const standardColors = [
        "Ø£Ø¨ÙŠØ¶",
        "Ø£Ø³ÙˆØ¯",
        "Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­",
        "Ø£Ø²Ø±Ù‚ Ù†ÙŠÙ„ÙŠ",
        "Ø£Ø®Ø¶Ø± Ø²Ù…Ø±Ø¯ÙŠ",
        "Ø¨ÙŠØ¬ Ù…Ø·ÙÙŠ",
        "Ø¨Ù†ÙŠ ØºØ§Ù…Ù‚",
        "Ø£Ø­Ù…Ø± Ø³Ø§Ø·Ø¹",
      ];

      const productDimensions = {
        "Ø·Ø§ÙˆÙ„Ø© Ø³ÙØ±Ø©": [
          "Ù…Ù‚Ø§Ø³ ØµØºÙŠØ± (2-4 Ø£Ø´Ø®Ø§Øµ)",
          "Ù…Ù‚Ø§Ø³ Ù…ØªÙˆØ³Ø· (4-6 Ø£Ø´Ø®Ø§Øµ)",
          "Ù…Ù‚Ø§Ø³ ÙƒØ¨ÙŠØ± (6-8 Ø£Ø´Ø®Ø§Øµ)",
        ],
        ÙƒØ±Ø³ÙŠ: ["Ù…Ù‚Ø§Ø³ Ù‚ÙŠØ§Ø³ÙŠ", "Ù…Ù‚Ø§Ø³ ÙƒØ¨ÙŠØ± ÙˆÙ…Ø±ÙŠØ­"],
        "Ø·Ù‚Ù… ÙƒÙ†Ø¨": ["Ù…Ù‚Ø¹Ø¯ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø© Ù…Ù‚Ø§Ø¹Ø¯", "ÙƒÙ†Ø¨Ø© Ø²Ø§ÙˆÙŠØ© (Ø­Ø±Ù L)"],
        "ØºØ±ÙØ© Ù†ÙˆÙ…": ["Ø³Ø±ÙŠØ± Ù…Ø²Ø¯ÙˆØ¬ Ù‚ÙŠØ§Ø³ÙŠ", "Ø³Ø±ÙŠØ± Ù…ÙØ±Ø¯", "Ù…Ø¬Ù…ÙˆØ¹Ø© ØªØ³Ø±ÙŠØ­Ø© ÙˆØ®Ø²Ø§Ù†Ø©"],
        Ù…Ø·Ø¨Ø®: ["ÙˆØ­Ø¯Ø© Ø¹Ù„ÙˆÙŠØ© Ù‚ÙŠØ§Ø³ÙŠØ©", "ÙˆØ­Ø¯Ø© Ø³ÙÙ„ÙŠØ© Ù‚ÙŠØ§Ø³ÙŠØ©", "Ø¬Ø²ÙŠØ±Ø© Ù…Ø·Ø¨Ø®"],
        "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·": ["Ù…Ù‚Ø§Ø³ Ù‚ÙŠØ§Ø³ÙŠ (ØµØºÙŠØ±Ø©)", "Ù…Ù‚Ø§Ø³ ÙƒØ¨ÙŠØ±"],
        Ø®Ø²Ø§Ù†Ø©: [
          "ØµØºÙŠØ±Ø© (Ø¨Ø§Ø¨ÙŠÙ†)",
          "Ù…ØªÙˆØ³Ø·Ø© (3-4 Ø£Ø¨ÙˆØ§Ø¨)",
          "ÙƒØ¨ÙŠØ±Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 4 Ø£Ø¨ÙˆØ§Ø¨)",
        ],
        "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ§Ø²": ["ØµØºÙŠØ±Ø© (Ø£Ù‚Ù„ Ù…Ù† 120 Ø³Ù…)", "ÙƒØ¨ÙŠØ±Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 150 Ø³Ù…)"],
        Ø¢Ø®Ø±: ["Ù…Ù‚Ø§Ø³ ØµØºÙŠØ±", "Ù…Ù‚Ø§Ø³ Ù…ØªÙˆØ³Ø·", "Ù…Ù‚Ø§Ø³ ÙƒØ¨ÙŠØ±"],
      };

      // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      const productTypeSelect = document.getElementById("product-type");
      const colorSelect = document.getElementById("color");
      const materialSelect = document.getElementById("material");
      const dimensionsSelect = document.getElementById("dimensions");
      const toast = document.getElementById("toast-notification");
      const processMessage = document.getElementById("processing-message");
      const designResultSection = document.getElementById("design-result");
      const designForm = document.getElementById("design-form");

      // ğŸ’¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
      const previewMaterialBox = document.getElementById(
        "preview-material-box"
      );
      const previewColorBox = document.getElementById("preview-color-box");
      const materialLabel = document.getElementById("material-label");
      const colorLabel = document.getElementById("color-label");

      // ğŸ’¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª
      const addonInput = document.getElementById("addon-input");
      const addAddonBtn = document.getElementById("add-addon-btn");
      const addonsList = document.getElementById("addons-list");

      // ====================================================================
      // 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      // ====================================================================

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.className = `toast show ${isError ? "error" : "success"}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function loadCartAndUpdateBadge() {
        const storedCart = localStorage.getItem("shoppingCart") || "[]";
        const cart = JSON.parse(storedCart);
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (cartCountBadge) {
          const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          cartCountBadge.textContent = totalItems;
          cartCountBadge.classList.toggle("visible", totalItems > 0);
        }
        return cart;
      }

      function saveCart(cart) {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        loadCartAndUpdateBadge();
      }

      async function initializeData() {
        processMessage.style.display = "block";
        try {
          const [productsSnapshot, materialsSnapshot] = await Promise.all([
            getDocs(collection(db, "products")),
            getDocs(collection(db, "raw_materials")),
          ]);

          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          allRawMaterials = materialsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0),
            reorder_point: parseFloat(doc.data().reorder_point || 0), // ğŸ’¡ Ø¬Ù„Ø¨ Ù†Ù‚Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨
            type: doc.data().type || "Ø£Ø®Ø±Ù‰",
            name_ar: doc.data().name_ar,
          }));

          fillDropdowns();
        } catch (e) {
          console.error("Initialization Error: ", e);
          showToast("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Firebase.", true);
          designForm.style.opacity = 0.5;
        } finally {
          processMessage.style.display = "none";
        }
      }

      // ğŸ’¡ Ø¯Ø§Ù„Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø£Ø®Ø´Ø§Ø¨ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶
      function fillMaterialsDropdown() {
        const woodMaterials = allRawMaterials.filter((m) => m.type === "Ø®Ø´Ø¨");
        let materialOptions = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© --</option>';

        woodMaterials.forEach((m) => {
          const isLowStock =
            m.current_stock > 0 && m.current_stock <= m.reorder_point;
          const isOutOfStock = m.current_stock <= 0;

          let disabledAttr = "";
          let availabilityText = "";
          let customClass = "";

          if (isOutOfStock) {
            disabledAttr = "disabled";
            availabilityText = " (Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)";
          } else if (isLowStock) {
            // ğŸ’¡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶: ÙŠØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ ÙˆØ¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ù„Ù„Ø¹Ø±Ø¶ Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù
            disabledAttr = "disabled";
            availabilityText = " (Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶ - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±)";
            customClass = "low-stock-option";
          }
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…ØªÙˆÙØ±Ø§Ù‹ (isAvailable = true): Ù„Ø§ ÙŠÙˆØ¬Ø¯ disabled

          materialOptions += `<option value="${m.name_ar}" ${disabledAttr} class="${customClass}">${m.name_ar}${availabilityText}</option>`;
        });
        materialSelect.innerHTML = materialOptions;
      }

      function fillDropdowns() {
        // 1. ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø®Ø´Ø§Ø¨ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ±
        fillMaterialsDropdown();

        // 2. ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ù…Ø­Ø¯Ø«Ø©)
        let colorOptions = `<option value="">-- Ø§Ø®ØªØ± Ù„ÙˆÙ† --</option>`;
        colorOptions += `<option value="Ø¨Ù†ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ (ÙˆØ±Ù†ÙŠØ´)">Ø¨Ù†ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ (ÙˆØ±Ù†ÙŠØ´/normal)</option>`;
        standardColors.forEach((color) => {
          const colorName = color.trim();
          if (colorFileMap[colorName]) {
            colorOptions += `<option value="${colorName} (Ø¯Ù‡Ø§Ù†)">${colorName} (Ø¯Ù‡Ø§Ù†)</option>`;
          }
        });
        colorSelect.innerHTML = colorOptions;

        // 3. Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        productTypeSelect.addEventListener("change", updateDimensionsOptions);
        materialSelect.addEventListener("change", updateMaterialPreview);
        colorSelect.addEventListener("change", updateMaterialPreview);

        updateDimensionsOptions();
        updateMaterialPreview();
      }

      function updateDimensionsOptions() {
        const selectedType = productTypeSelect.value;
        const options =
          productDimensions[selectedType] || productDimensions["Ø¢Ø®Ø±"];

        let optionsHTML = `<option value="">-- Ø§Ø®ØªØ± Ù…Ù‚Ø§Ø³Ø§Ù‹ ØªÙ‚Ø±ÙŠØ¨ÙŠØ§Ù‹ --</option>`;
        options.forEach((dim) => {
          optionsHTML += `<option value="${dim}">${dim}</option>`;
        });
        dimensionsSelect.innerHTML = optionsHTML;
      }

      // ğŸ’¡ ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙˆØ§Ù„Ù…ÙØµØ­Ø­Ø©
      function updateMaterialPreview() {
        const selectedMaterial = materialSelect.value.trim();
        const selectedColorOption = colorSelect.value.split("(")[0].trim(); // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ† ÙÙ‚Ø·

        // 1. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø´Ø¨ (Ø§Ù„ØªÙƒØ³ØªØ´Ø±)
        const woodTexturePath = woodTextureMap[selectedMaterial];

        if (woodTexturePath) {
          previewMaterialBox.style.backgroundImage = `url('${woodTexturePath}')`;
          previewMaterialBox.style.backgroundColor = "transparent";
          materialLabel.textContent = `Ø§Ù„Ø®Ø´Ø¨: ${selectedMaterial}`;
        } else if (selectedMaterial) {
          // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… ØµÙˆØ±Ø© Ø¨Ù€ 'colers/braw.png' ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
          previewMaterialBox.style.backgroundImage = `url('colers/braw.png')`;
          previewMaterialBox.style.backgroundColor = "transparent";
          materialLabel.textContent = `Ø§Ù„Ø®Ø´Ø¨: ${selectedMaterial}`;
        } else {
          // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙŠØ§Ø±
          previewMaterialBox.style.backgroundImage = "none";
          previewMaterialBox.style.backgroundColor = "var(--light-color)";
          materialLabel.textContent = "Ø§Ù„Ø®Ø´Ø¨: Ù„Ù… ÙŠÙØ®ØªØ±";
        }

        // 2. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„ÙˆÙ†
        if (selectedColorOption) {
          const fileName = colorFileMap[selectedColorOption];
          if (fileName) {
            previewColorBox.style.backgroundImage = `url('colers/${fileName}')`;
            previewColorBox.style.backgroundColor = "transparent";
          } else {
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„ÙØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡
            previewColorBox.style.backgroundImage = "none";
            previewColorBox.style.backgroundColor = "var(--white-color)";
          }
          colorLabel.textContent = `Ø§Ù„Ù„ÙˆÙ†: ${selectedColorOption}`;
        } else {
          // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙŠØ§Ø±
          previewColorBox.style.backgroundImage = "none";
          previewColorBox.style.backgroundColor = "var(--white-color)";
          colorLabel.textContent = "Ø§Ù„Ù„ÙˆÙ†: Ù„Ù… ÙŠÙØ®ØªØ±";
        }
      }

      function calculateEstimatedCost(
        materialName,
        color,
        productType,
        addons
      ) {
        let baseCost = 0;
        let woodVolumeFactor = 1;
        let paintVolumeFactor = 1;
        let accessoryCost = 150;

        const woodMaterial = allRawMaterials.find(
          (m) => m.name_ar === materialName && m.type === "Ø®Ø´Ø¨"
        );
        const paintMaterial = allRawMaterials.find((m) =>
          m.type.includes("Ø·Ù„Ø§Ø¡")
        );
        const varnishMaterial = allRawMaterials.find((m) =>
          m.name_ar.includes("ÙˆØ±Ù†ÙŠØ´")
        );

        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø§Ù…Ù„ Ø­Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
        if (productType.includes("Ø·Ø§ÙˆÙ„Ø©")) woodVolumeFactor = 0.75;
        else if (productType.includes("ÙƒÙ†Ø¨")) woodVolumeFactor = 1.0;
        else if (productType.includes("Ø®Ø²Ø§Ù†Ø©")) woodVolumeFactor = 1.2;
        else woodVolumeFactor = 0.5;

        if (woodMaterial) {
          baseCost += (woodMaterial.cost_per_unit || 0) * woodVolumeFactor;
        } else {
          baseCost += 1500 * woodVolumeFactor;
        }

        // ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´Ø·ÙŠØ¨
        if (color.includes("ÙˆØ±Ù†ÙŠØ´") && varnishMaterial) {
          baseCost +=
            (varnishMaterial.cost_per_unit || 200) * paintVolumeFactor;
        } else if (paintMaterial) {
          baseCost += (paintMaterial.cost_per_unit || 500) * paintVolumeFactor;
        } else {
          baseCost += 300;
        }

        baseCost += accessoryCost;

        // ğŸ’¡ Ø¥Ø¶Ø§ÙØ© ØªÙƒÙ„ÙØ© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ø¥Ø¶Ø§ÙØ§Øª
        baseCost += addons.length * 100;

        return Math.round(baseCost);
      }

      function addToCartAsCustom(design) {
        let cart = loadCartAndUpdateBadge();

        const tempId = `CUSTOM-${Date.now()}`;

        const newItem = {
          id: tempId,
          name: design.title,
          price: design.price_value,
          quantity: 1,
          isCustom: true,
          // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ 'details'
          details: {
            type: design.type,
            dimensions: design.dimensions,
            material: design.material,
            color: design.color,
            notes: design.notes,
            addons: design.addons,
            estimatedCOGS: design.estimatedCOGS,
            description: design.description,
            initial_price: design.price_value,
            price_range: design.price_range,
            title: design.title,
          },
        };

        cart.push(newItem);
        saveCart(cart);
        showToast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ…ÙŠÙ… (${design.title}) Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!`);
      }

      // ====================================================================
      // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª (Add-ons)
      // ====================================================================

      function renderAddonsList() {
        addonsList.innerHTML = "";
        if (currentAddons.length === 0) {
          addonsList.innerHTML =
            '<li style="text-align: center; color: #777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª Ø¨Ø¹Ø¯</li>';
          return;
        }

        currentAddons.forEach((addon, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
                  <span>${addon}</span>
                  <button type="button" class="btn-danger btn-sm" data-index="${index}" style="background: none; border: none; color: var(--danger-color); font-size: 1.2rem; cursor: pointer;">
                      &times;
                  </button>
              `;
          addonsList.appendChild(li);
        });

        document.querySelectorAll("#addons-list button").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            currentAddons.splice(index, 1);
            renderAddonsList();
            updateNotesWithAddons();
          });
        });

        updateNotesWithAddons();
      }

      function updateNotesWithAddons() {
        const notesTextarea = document.getElementById("notes");
        let currentNotes = notesTextarea.value.split("\n");

        currentNotes = currentNotes.filter(
          (line) => !line.startsWith("Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:")
        );

        if (currentAddons.length > 0) {
          const addonsString = `Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${currentAddons.join("ØŒ ")}`;
          currentNotes.push(addonsString);
        }

        notesTextarea.value = currentNotes
          .filter((line) => line.trim() !== "")
          .join("\n");
      }

      addAddonBtn.addEventListener("click", () => {
        const addonText = addonInput.value.trim();
        if (addonText && currentAddons.length < 5) {
          currentAddons.push(addonText);
          addonInput.value = "";
          renderAddonsList();
        } else if (currentAddons.length >= 5) {
          showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø¥Ø¶Ø§ÙØ§Øª.", true);
        }
      });

      // ====================================================================
      // 3. Ù…Ù†Ø·Ù‚ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ… (Gemini Logic) - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±
      // ====================================================================

      designForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // ğŸ’¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø´Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± Ù…Ø¹Ø·Ù„ (Ù„Ø¶Ù…Ø§Ù† ØªÙˆÙØ±Ù‡)
        if (materialSelect.selectedOptions[0]?.disabled) {
          alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØµÙ…ÙŠÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø§Ø¯Ø© Ø®Ø§Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.");
          return;
        }

        if (!designForm.checkValidity()) {
          showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.", true);
          designForm.reportValidity();
          return;
        }

        const productType = productTypeSelect.value;
        const dimensions = dimensionsSelect.value;
        const color = colorSelect.value;
        const material = materialSelect.value;
        const notes = document.getElementById("notes")?.value;
        const roomPlacement = document.getElementById("room-placement")?.value;

        const estimatedCOGS = calculateEstimatedCost(
          material,
          color,
          productType,
          currentAddons
        );

        const minMargin = 1.3;
        const maxMargin = 1.6;

        const priceRangeMin = Math.round(estimatedCOGS * minMargin);
        const priceRangeMax = Math.round(estimatedCOGS * maxMargin);

        processMessage.style.display = "block";
        designResultSection.style.display = "none";

        const filteredProducts = allProducts.filter(
          (p) => p.category === productType && p.is_available !== false
        );

        const productOptionsForAI = filteredProducts
          .map((p) => `- ${p.name} (Price: ${p.price} ISK)`)
          .join(", ");

        const promptText = `
          Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø«Ø§Ø«. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ:
          1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù‚ØªØ±Ø§Ø­ ØªØµÙ…ÙŠÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„.
          2. Ø§Ù‚ØªØ±Ø§Ø­ Ù†Ø·Ø§Ù‚ Ø³Ø¹Ø±ÙŠ Ù†Ù‡Ø§Ø¦ÙŠ Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø©.
          
          Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø¯Ø§Ø¹Ù…Ø©:
          - Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ù…ÙˆØ§Ø¯ (COGS): ${estimatedCOGS} Ø´ÙŠÙƒÙ„.
          - Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…Ø§Ø«Ù„Ø©: ${productOptionsForAI || "Ù„Ø§ ÙŠÙˆØ¬Ø¯."}
          - **Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡:** ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ±Ø§ÙˆØ­ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø¨ÙŠÙ† ${priceRangeMin} Ø´ÙŠÙƒÙ„ Ùˆ ${priceRangeMax} Ø´ÙŠÙƒÙ„.

          Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„:
          - Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬: ${productType}
          - Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª: ${dimensions}
          - Ø§Ù„Ù…Ø§Ø¯Ø©: ${material}
          - Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„ØªØ´Ø·ÙŠØ¨: ${color}
          - Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}
          
          Ø£Ø¹Ø·Ù†ÙŠ Ø¥Ø®Ø±Ø§Ø¬Ø§Ù‹ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¯Ù‚Ø©ØŒ ÙˆÙ„Ø§ ØªØ¶Ù Ø£ÙŠ Ø´Ø±Ø­ Ø£Ùˆ Ù…Ù‚Ø¯Ù…Ø§Øª:
          Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…ÙˆØ¬Ø²>
          Ø§Ù„ÙˆØµÙ: <ÙˆØµÙ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ù…Ù†ØªØ¬>
          Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: <Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø±Ù‚Ù…ÙŠØ§Ù‹> - <Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ù‚ØµÙ‰ Ø±Ù‚Ù…ÙŠØ§Ù‹> Ø´ÙŠÙƒÙ„
        `;

        try {
          const textResult = await textModel.generateContent(promptText);
          const textResponse = result.response.text();

          const titleMatch = textResponse.match(/Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:\s*(.*)/);
          const descriptionMatch = textResponse.match(/Ø§Ù„ÙˆØµÙ:\s*(.*)/);
          const priceRangeMatch = textResponse.match(
            /Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­:\s*([\d\.\,\s]+)\s*-\s*([\d\.\,\s]+)\s*Ø´ÙŠÙƒÙ„/
          );

          let title = titleMatch ? titleMatch[1].trim() : "ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ ÙØ±ÙŠØ¯";
          let description = descriptionMatch
            ? descriptionMatch[1].trim()
            : "ÙˆØµÙ Ù…Ù‚ØªØ±Ø­ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯.";

          let finalPriceMin = priceRangeMin;
          let finalPriceMax = priceRangeMax;

          if (priceRangeMatch && priceRangeMatch[1] && priceRangeMatch[2]) {
            finalPriceMin = parseFloat(
              priceRangeMatch[1].replace(/[^0-9\.]/g, "")
            );
            finalPriceMax = parseFloat(
              priceRangeMatch[2].replace(/[^0-9\.]/g, "")
            );
          }

          if (
            finalPriceMin < priceRangeMin ||
            finalPriceMax > priceRangeMax ||
            finalPriceMin >= finalPriceMax ||
            isNaN(finalPriceMin) ||
            isNaN(finalPriceMax)
          ) {
            finalPriceMin = priceRangeMin;
            finalPriceMax = priceRangeMax;
          }

          const initialDesignPrice = finalPriceMin;

          currentDesign = {
            title: title,
            description: description,
            price: initialDesignPrice,
            price_value: initialDesignPrice,
            price_range: `${finalPriceMin.toFixed(0)} - ${finalPriceMax.toFixed(
              0
            )}`,
            type: productType,
            dimensions,
            material,
            color,
            notes,
            addons: currentAddons,
            quantity: 1,
            estimatedCOGS: estimatedCOGS,
          };

          processMessage.style.display = "none";

          document.getElementById("result-content").innerHTML = `
                <h3 id="result-title">${currentDesign.title}</h3>
                <p><strong>Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${currentDesign.description}</p>
                <p><strong>Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</strong> ${currentDesign.material}ØŒ ${currentDesign.color}ØŒ ${currentDesign.dimensions}</p>
                <p id="result-price" style="font-size: 1.4rem; font-weight: bold; color: var(--primary-color);">
                    Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ: ${currentDesign.price_range} Ø´ÙŠÙƒÙ„
                </p>
                <p style="font-size: 0.9rem; color: #888; margin-top: 10px">
                    Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù„ÙŠØ³ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø³ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡ Ø¨Ø¹Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙØ±ÙŠÙ‚.
                </p>`;
          designResultSection.classList.add("show");
          designResultSection.style.display = "block";
        } catch (error) {
          console.error("Error generating design:", error);
          processMessage.style.display = "none";
          showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", true);
        }
      });

      // ====================================================================
      // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©)
      // ====================================================================

      document
        .getElementById("submit-design-btn")
        .addEventListener("click", () => {
          if (!currentDesign) return;

          addToCartAsCustom(currentDesign);
          designResultSection.style.display = "none";
          designForm.reset();
          updateDimensionsOptions();
          currentAddons = [];
          renderAddonsList();
          updateMaterialPreview();
        });

      // ====================================================================
      // 5. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
      // ====================================================================
      document.addEventListener("DOMContentLoaded", () => {
        loadCartAndUpdateBadge();
        initializeData();

        onAuthStateChanged(auth, (user) => {
          currentUser = user;
        });

        document
          .gØ³etElementById("regenerate-design-btn")
          .addEventListener("click", () => {
            designForm.dispatchEvent(
              new Event("submit", { cancelable: true, bubbles: true })
            );
          });

        renderAddonsList();
      });
    </script>
  </body>
</html>
