<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | صمم منتجك</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .design-page-section {
        max-width: 900px;
        margin: 5rem auto;
        padding: 40px;
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: right;
      }
      .design-form {
        margin-top: 2rem;
      }
      .design-form .form-group {
        margin-bottom: 1.5rem;
      }
      .design-form .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }
      .design-form .form-group input,
      .design-form .form-group select,
      .design-form .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Cairo", sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .design-form .form-group input:focus,
      .design-form .form-group select:focus,
      .design-form .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(121, 85, 72, 0.2);
      }
      .design-form .btn {
        display: block;
        width: 100%;
        margin-top: 2.5rem;
      }
      .required-field {
        color: var(--danger-color);
        margin-right: 5px;
      }
      .loading-msg {
        text-align: center;
        font-size: 1.1rem;
        color: #999;
        padding: 40px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .design-result-section.show {
        display: block;
      }

      /* 💡 أنماط عرض المعاينة */
      #material-preview-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 2rem;
        padding-top: 15px;
      }
      .preview-card {
        text-align: center;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 15px;
        background-color: var(--light-color);
      }
      .preview-box {
        height: 120px;
        border-radius: 8px;
        margin-top: 10px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        transition: background-image 0.5s;
        border: 1px solid #ddd;
      }
      .preview-card p {
        font-weight: 600;
        color: var(--primary-color);
        margin-top: 10px;
      }
      /* 💡 أنماط الإضافات */
      #addons-list {
        list-style: none;
        padding: 0;
        margin-top: 10px;
        border: 1px solid #eee;
        border-radius: 8px;
        max-height: 150px;
        overflow-y: auto;
      }
      #addons-list li {
        padding: 8px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
      }
      #addons-list li:last-child {
        border-bottom: none;
      }

      /* 💡 نمط الخيارات غير المتوفرة أو المنخفضة */
      #material-select option[disabled] {
        color: #aaa;
        background-color: #f7f7f7;
      }
      /* 💡 نمط خاص للمخزون المنخفض */
      #material-select .low-stock-option {
        color: #f39c12; /* لون تحذيري (أصفر/برتقالي) */
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">منجرة</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">الرئيسية</a>
            </li>
            <li>
              <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
            </li>
            <li>
              <a href="order-status.html" class="nav-link">حالة الطلب</a>
            </li>
            <li>
              <a href="recommendation.html" class="nav-link">المساعد</a>
            </li>
            <li>
              <a href="design.html" class="nav-link active">صمم منتجك</a>
            </li>
          </ul>
          <a href="cart.html" class="cart-icon-wrapper">
            <svg
              id="cart-icon"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
              />
            </svg>
            <span id="cart-count-badge">0</span>
          </a>
          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">الرئيسية</a>
      <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
      <a href="order-status.html" class="nav-link">حالة الطلب</a>
      <a href="recommendation.html" class="nav-link">المساعد</a>
      <a href="design.html" class="nav-link">صمم منتجك</a>
    </div>

    <main>
      <section class="section container design-page-section">
        <div class="section-title-wrapper">
          <h2>صمم منتجك الخاص</h2>
        </div>
        <p style="text-align: center; color: #777">
          صف لنا فكرتك في خطوات بسيطة وسنقوم بتحويلها إلى تصميم مقترح.
        </p>

        <form id="design-form" class="design-form">
          <div class="form-step active" data-step="1">
            <div class="form-group">
              <label for="product-type"
                ><span class="required-field">*</span> نوع المنتج المطلوب</label
              >
              <select id="product-type" name="product-type" required>
                <option value="">-- اختر نوع المنتج --</option>
                <option value="طاولة سفرة">طاولة سفرة</option>
                <option value="كرسي">كرسي</option>
                <option value="طقم كنب">طقم كنب</option>
                <option value="غرفة نوم">غرفة نوم</option>
                <option value="مطبخ">مطبخ</option>
                <option value="طاولة وسط">طاولة وسط</option>
                <option value="خزانة">خزانة</option>
                <option value="طاولة تلفاز">طاولة تلفاز</option>
                <option value="آخر">آخر...</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dimensions"
                  ><span class="required-field">*</span> المقاسات
                  التقريبية</label
                >
                <select id="dimensions" name="dimensions" required>
                  <option value="">-- اختر نوع المنتج أولاً --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="room-placement"
                  ><span class="required-field">*</span> مكان وضع المنتج</label
                >
                <select id="room-placement" name="room-placement" required>
                  <option value="">-- اختر المكان --</option>
                  <option value="غرفة المعيشة">غرفة المعيشة</option>
                  <option value="غرفة الطعام">غرفة الطعام</option>
                  <option value="غرفة النوم">غرفة النوم</option>
                  <option value="المطبخ">المطبخ</option>
                  <option value="المكتب">المكتب</option>
                  <option value="غرفة الأطفال">غرفة الأطفال</option>
                  <option value="خارجي">خارجي</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="material"
                  ><span class="required-field">*</span> المادة الرئيسية المفضلة
                  (نوع الخشب)</label
                >
                <select id="material" name="material" required>
                  <option value="">-- جارٍ التحميل --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="color"
                  ><span class="required-field">*</span> اللون والتشطيب
                  المفضّل</label
                >
                <select id="color" name="color" required>
                  <option value="">-- جارٍ التحميل --</option>
                </select>
              </div>
            </div>

            <div id="material-preview-container">
              <div class="preview-card">
                <label>معاينة الخشب (التكستشر)</label>
                <div id="preview-material-box" class="preview-box"></div>
                <p id="material-label">الخشب: لم يُختر</p>
              </div>
              <div class="preview-card">
                <label>معاينة اللون</label>
                <div id="preview-color-box" class="preview-box"></div>
                <p id="color-label">اللون: لم يُختر</p>
              </div>
            </div>

            <h3
              style="
                margin-top: 1.5rem;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
              "
            >
              <i class="fa-solid fa-layer-group"></i> إضافات وتفاصيل مميزة
            </h3>
            <div class="form-row" style="grid-template-columns: 3fr 1fr">
              <div class="form-group" style="margin-bottom: 0">
                <label
                  for="addon-input"
                  style="font-size: 1rem; margin-bottom: 0"
                  >أضف ميزة (مثل: أدراج مخفية، حامل أكواب، إضاءة)</label
                >
                <input
                  type="text"
                  id="addon-input"
                  placeholder="اكتب الميزة هنا..."
                />
              </div>
              <div class="form-group" style="align-self: end; margin-bottom: 0">
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  id="add-addon-btn"
                >
                  <i class="fa-solid fa-plus"></i> إضافة
                </button>
              </div>
            </div>

            <div class="form-group">
              <ul id="addons-list">
                <li style="text-align: center; color: #777">
                  لا توجد إضافات بعد
                </li>
              </ul>
            </div>

            <div class="form-group" id="notes-group">
              <label for="notes"
                ><span class="required-field">*</span> وصف فكرتك وتفاصيل
                التصميم</label
              >
              <textarea
                id="notes"
                name="notes"
                rows="4"
                required
                placeholder="مثال: أحتاج طاولة طعام بنمط ريفي، الميزانية 3000-4000 شيكل، أريد أدراجاً مخفية."
              ></textarea>
            </div>
          </div>

          <button type="submit" class="btn" id="submit-form-btn">
            <i class="fa-solid fa-robot"></i> اقتراح تصميم
          </button>
        </form>

        <div id="processing-message" class="loading-bar-container">
          <div class="loading-bar"></div>
          <p style="text-align: center; font-weight: bold; padding-top: 5px">
            جارٍ معالجة طلبك...
          </p>
        </div>

        <div
          id="design-result"
          class="design-result-section"
          style="display: none"
        >
          <h2 style="margin-bottom: 1.5rem">اقتراحنا لك</h2>
          <div class="design-result-text" id="result-content"></div>
          <div class="design-result-actions">
            <button class="btn" id="submit-design-btn">
              <i class="fa-solid fa-cart-plus"></i> أضف إلى السلة للمراجعة
            </button>
            <button
              class="btn"
              id="regenerate-design-btn"
              style="background-color: var(--accent-color)"
            >
              اقتراح آخر
            </button>
          </div>
          <div
            style="
              margin-top: 2rem;
              text-align: center;
              font-size: 0.9rem;
              color: #888;
            "
          >
            <p>
              السعر المعروض هو نطاق أولي مقترح. سيتم تأكيده بعد مراجعة الفريق.
              يمكنك الآن إضافته إلى السلة وإكمال طلبك.
            </p>
          </div>
        </div>
      </section>
    </main>

    <div id="design-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-confirm">&times;</span>
        <h2>شكراً لك!</h2>
        <p>
          تم استلام طلبك للتصميم المخصص بنجاح. سنقوم بمراجعته والرد عليك خلال
          يومي عمل.
        </p>
        <p>رمز التتبع الخاص بطلبك هو:</p>
        <span id="design-tracking-id" class="tracking-id-display"></span>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          الرجاء حفظ هذا الرمز لتتمكن من متابعة حالة طلبك وقبول أو رفض السعر
          النهائي.
        </p>
      </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <div id="design-checkout-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-checkout">&times;</span>
        <div class="modal-body">
          <div class="checkout-form-container">
            <h2>إرسال طلب التصميم</h2>
            <p>
              الرجاء إدخال بياناتك لإرسال طلب التصميم. سيتم التواصل معك
              لمراجعته.
            </p>
            <form id="design-checkout-form">
              <div class="form-group">
                <label for="name">الاسم الكامل</label>
                <input type="text" id="design-name" name="name" required />
              </div>
              <div class="form-group">
                <label for="phone">رقم الهاتف</label>
                <input type="tel" id="design-phone" name="phone" required />
              </div>
              <div class="form-group">
                <label for="email">البريد الإلكتروني (اختياري)</label>
                <input type="email" id="design-email" name="email" />
              </div>
              <div class="form-group">
                <label for="address">العنوان</label>
                <textarea
                  id="design-address"
                  name="address"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn" id="confirm-design-btn">
                تأكيد طلب التصميم
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // ******* إعدادات Firebase و Gemini *******
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const textModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // متغيرات تخزين البيانات
      let allProducts = [];
      let allRawMaterials = [];
      let currentUser = null;
      let currentDesign = null;
      let currentAddons = [];

      // 💡 خريطة لربط الألوان العربية بأسماء ملفات الصور الإنجليزية في مجلد 'colers'
      const colorFileMap = {
        أبيض: "white.png",
        أسود: "black.png",
        "رمادي فاتح": "gray.png",
        "أزرق نيلي": "blue.png",
        "أخضر زمردي": "green.png",
        "بيج مطفي": "offwhite.png",
        "بني غامق": "braw.png",
        "أحمر ساطع": "red.png",
        "بني طبيعي": "normal.png",
      };

      // 💡 خريطة لربط أنواع الأخشاب بمسارات صور التكستشر المحلية (wood/)
      const woodTextureMap = {
        "خشب زان": "wood/Beech Wood.jpg",
        "خشب بلوط": "wood/Oak Wood.webp",
        "خشب سنديان": "wood/white-oak.jpg",
        "خشب جوز": "wood/Walnut Wood.webp",
        "خشب صنوبر": "wood/Pine Wood.webp",
        "خشب صور": "colers/braw.png",
      };

      const standardColors = [
        "أبيض",
        "أسود",
        "رمادي فاتح",
        "أزرق نيلي",
        "أخضر زمردي",
        "بيج مطفي",
        "بني غامق",
        "أحمر ساطع",
      ];

      const productDimensions = {
        "طاولة سفرة": [
          "مقاس صغير (2-4 أشخاص)",
          "مقاس متوسط (4-6 أشخاص)",
          "مقاس كبير (6-8 أشخاص)",
        ],
        كرسي: ["مقاس قياسي", "مقاس كبير ومريح"],
        "طقم كنب": ["مقعدين", "ثلاثة مقاعد", "كنبة زاوية (حرف L)"],
        "غرفة نوم": ["سرير مزدوج قياسي", "سرير مفرد", "مجموعة تسريحة وخزانة"],
        مطبخ: ["وحدة علوية قياسية", "وحدة سفلية قياسية", "جزيرة مطبخ"],
        "طاولة وسط": ["مقاس قياسي (صغيرة)", "مقاس كبير"],
        خزانة: [
          "صغيرة (بابين)",
          "متوسطة (3-4 أبواب)",
          "كبيرة (أكثر من 4 أبواب)",
        ],
        "طاولة تلفاز": ["صغيرة (أقل من 120 سم)", "كبيرة (أكثر من 150 سم)"],
        آخر: ["مقاس صغير", "مقاس متوسط", "مقاس كبير"],
      };

      // عناصر الواجهة
      const productTypeSelect = document.getElementById("product-type");
      const colorSelect = document.getElementById("color");
      const materialSelect = document.getElementById("material");
      const dimensionsSelect = document.getElementById("dimensions");
      const toast = document.getElementById("toast-notification");
      const processMessage = document.getElementById("processing-message");
      const designResultSection = document.getElementById("design-result");
      const designForm = document.getElementById("design-form");

      // 💡 عناصر المعاينة
      const previewMaterialBox = document.getElementById(
        "preview-material-box"
      );
      const previewColorBox = document.getElementById("preview-color-box");
      const materialLabel = document.getElementById("material-label");
      const colorLabel = document.getElementById("color-label");

      // 💡 عناصر الإضافات
      const addonInput = document.getElementById("addon-input");
      const addAddonBtn = document.getElementById("add-addon-btn");
      const addonsList = document.getElementById("addons-list");

      // ====================================================================
      // 1. وظائف المساعدة العامة وتهيئة البيانات
      // ====================================================================

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.className = `toast show ${isError ? "error" : "success"}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function loadCartAndUpdateBadge() {
        const storedCart = localStorage.getItem("shoppingCart") || "[]";
        const cart = JSON.parse(storedCart);
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (cartCountBadge) {
          const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          cartCountBadge.textContent = totalItems;
          cartCountBadge.classList.toggle("visible", totalItems > 0);
        }
        return cart;
      }

      function saveCart(cart) {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        loadCartAndUpdateBadge();
      }

      async function initializeData() {
        processMessage.style.display = "block";
        try {
          const [productsSnapshot, materialsSnapshot] = await Promise.all([
            getDocs(collection(db, "products")),
            getDocs(collection(db, "raw_materials")),
          ]);

          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          allRawMaterials = materialsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0),
            reorder_point: parseFloat(doc.data().reorder_point || 0), // 💡 جلب نقطة إعادة الطلب
            type: doc.data().type || "أخرى",
            name_ar: doc.data().name_ar,
          }));

          fillDropdowns();
        } catch (e) {
          console.error("Initialization Error: ", e);
          showToast("❌ فشل تحميل بيانات المخزون. يرجى مراجعة Firebase.", true);
          designForm.style.opacity = 0.5;
        } finally {
          processMessage.style.display = "none";
        }
      }

      // 💡 دالة لملء القائمة المنسدلة للأخشاب مع التحقق من التوفر والمخزون المنخفض
      function fillMaterialsDropdown() {
        const woodMaterials = allRawMaterials.filter((m) => m.type === "خشب");
        let materialOptions = '<option value="">-- اختر مادة --</option>';

        woodMaterials.forEach((m) => {
          const isLowStock =
            m.current_stock > 0 && m.current_stock <= m.reorder_point;
          const isOutOfStock = m.current_stock <= 0;

          let disabledAttr = "";
          let availabilityText = "";
          let customClass = "";

          if (isOutOfStock) {
            disabledAttr = "disabled";
            availabilityText = " (نفذ المخزون)";
          } else if (isLowStock) {
            // 💡 المخزون منخفض: يتم تعطيله وإضافة كلاس للعرض بلون مختلف
            disabledAttr = "disabled";
            availabilityText = " (مخزون منخفض - يرجى الانتظار)";
            customClass = "low-stock-option";
          }
          // إذا كان المخزون متوفراً (isAvailable = true): لا يوجد disabled

          materialOptions += `<option value="${m.name_ar}" ${disabledAttr} class="${customClass}">${m.name_ar}${availabilityText}</option>`;
        });
        materialSelect.innerHTML = materialOptions;
      }

      function fillDropdowns() {
        // 1. تعبئة الأخشاب مع التحقق من التوفر
        fillMaterialsDropdown();

        // 2. تعبئة الألوان (محدثة)
        let colorOptions = `<option value="">-- اختر لون --</option>`;
        colorOptions += `<option value="بني طبيعي (ورنيش)">بني طبيعي (ورنيش/normal)</option>`;
        standardColors.forEach((color) => {
          const colorName = color.trim();
          if (colorFileMap[colorName]) {
            colorOptions += `<option value="${colorName} (دهان)">${colorName} (دهان)</option>`;
          }
        });
        colorSelect.innerHTML = colorOptions;

        // 3. ربط الأحداث
        productTypeSelect.addEventListener("change", updateDimensionsOptions);
        materialSelect.addEventListener("change", updateMaterialPreview);
        colorSelect.addEventListener("change", updateMaterialPreview);

        updateDimensionsOptions();
        updateMaterialPreview();
      }

      function updateDimensionsOptions() {
        const selectedType = productTypeSelect.value;
        const options =
          productDimensions[selectedType] || productDimensions["آخر"];

        let optionsHTML = `<option value="">-- اختر مقاساً تقريبياً --</option>`;
        options.forEach((dim) => {
          optionsHTML += `<option value="${dim}">${dim}</option>`;
        });
        dimensionsSelect.innerHTML = optionsHTML;
      }

      // 💡 وظيفة تحديث معاينة الصورة المحدثة والمُصححة
      function updateMaterialPreview() {
        const selectedMaterial = materialSelect.value.trim();
        const selectedColorOption = colorSelect.value.split("(")[0].trim(); // جلب اسم اللون فقط

        // 1. تحديث معاينة الخشب (التكستشر)
        const woodTexturePath = woodTextureMap[selectedMaterial];

        if (woodTexturePath) {
          previewMaterialBox.style.backgroundImage = `url('${woodTexturePath}')`;
          previewMaterialBox.style.backgroundColor = "transparent";
          materialLabel.textContent = `الخشب: ${selectedMaterial}`;
        } else if (selectedMaterial) {
          // إذا لم نجد المسار في الخريطة، نستخدم صورة بـ 'colers/braw.png' كافتراضي
          previewMaterialBox.style.backgroundImage = `url('colers/braw.png')`;
          previewMaterialBox.style.backgroundColor = "transparent";
          materialLabel.textContent = `الخشب: ${selectedMaterial}`;
        } else {
          // لا يوجد اختيار
          previewMaterialBox.style.backgroundImage = "none";
          previewMaterialBox.style.backgroundColor = "var(--light-color)";
          materialLabel.textContent = "الخشب: لم يُختر";
        }

        // 2. تحديث معاينة اللون
        if (selectedColorOption) {
          const fileName = colorFileMap[selectedColorOption];
          if (fileName) {
            previewColorBox.style.backgroundImage = `url('colers/${fileName}')`;
            previewColorBox.style.backgroundColor = "transparent";
          } else {
            // إذا لم نجد اسم الملف، نستخدم خلفية بيضاء
            previewColorBox.style.backgroundImage = "none";
            previewColorBox.style.backgroundColor = "var(--white-color)";
          }
          colorLabel.textContent = `اللون: ${selectedColorOption}`;
        } else {
          // لا يوجد اختيار
          previewColorBox.style.backgroundImage = "none";
          previewColorBox.style.backgroundColor = "var(--white-color)";
          colorLabel.textContent = "اللون: لم يُختر";
        }
      }

      function calculateEstimatedCost(
        materialName,
        color,
        productType,
        addons
      ) {
        let baseCost = 0;
        let woodVolumeFactor = 1;
        let paintVolumeFactor = 1;
        let accessoryCost = 150;

        const woodMaterial = allRawMaterials.find(
          (m) => m.name_ar === materialName && m.type === "خشب"
        );
        const paintMaterial = allRawMaterials.find((m) =>
          m.type.includes("طلاء")
        );
        const varnishMaterial = allRawMaterials.find((m) =>
          m.name_ar.includes("ورنيش")
        );

        // تحديد معامل حجم الخشب التقريبي
        if (productType.includes("طاولة")) woodVolumeFactor = 0.75;
        else if (productType.includes("كنب")) woodVolumeFactor = 1.0;
        else if (productType.includes("خزانة")) woodVolumeFactor = 1.2;
        else woodVolumeFactor = 0.5;

        if (woodMaterial) {
          baseCost += (woodMaterial.cost_per_unit || 0) * woodVolumeFactor;
        } else {
          baseCost += 1500 * woodVolumeFactor;
        }

        // تكلفة التشطيب
        if (color.includes("ورنيش") && varnishMaterial) {
          baseCost +=
            (varnishMaterial.cost_per_unit || 200) * paintVolumeFactor;
        } else if (paintMaterial) {
          baseCost += (paintMaterial.cost_per_unit || 500) * paintVolumeFactor;
        } else {
          baseCost += 300;
        }

        baseCost += accessoryCost;

        // 💡 إضافة تكلفة تقديرية للإضافات
        baseCost += addons.length * 100;

        return Math.round(baseCost);
      }

      function addToCartAsCustom(design) {
        let cart = loadCartAndUpdateBadge();

        const tempId = `CUSTOM-${Date.now()}`;

        const newItem = {
          id: tempId,
          name: design.title,
          price: design.price_value,
          quantity: 1,
          isCustom: true,
          // حفظ جميع تفاصيل التصميم داخل حقل 'details'
          details: {
            type: design.type,
            dimensions: design.dimensions,
            material: design.material,
            color: design.color,
            notes: design.notes,
            addons: design.addons,
            estimatedCOGS: design.estimatedCOGS,
            description: design.description,
            initial_price: design.price_value,
            price_range: design.price_range,
            title: design.title,
          },
        };

        cart.push(newItem);
        saveCart(cart);
        showToast(`✅ تمت إضافة التصميم (${design.title}) إلى السلة للمراجعة!`);
      }

      // ====================================================================
      // 2. منطق الإضافات (Add-ons)
      // ====================================================================

      function renderAddonsList() {
        addonsList.innerHTML = "";
        if (currentAddons.length === 0) {
          addonsList.innerHTML =
            '<li style="text-align: center; color: #777;">لا توجد إضافات بعد</li>';
          return;
        }

        currentAddons.forEach((addon, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
                  <span>${addon}</span>
                  <button type="button" class="btn-danger btn-sm" data-index="${index}" style="background: none; border: none; color: var(--danger-color); font-size: 1.2rem; cursor: pointer;">
                      &times;
                  </button>
              `;
          addonsList.appendChild(li);
        });

        document.querySelectorAll("#addons-list button").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            currentAddons.splice(index, 1);
            renderAddonsList();
            updateNotesWithAddons();
          });
        });

        updateNotesWithAddons();
      }

      function updateNotesWithAddons() {
        const notesTextarea = document.getElementById("notes");
        let currentNotes = notesTextarea.value.split("\n");

        currentNotes = currentNotes.filter(
          (line) => !line.startsWith("الإضافات المطلوبة:")
        );

        if (currentAddons.length > 0) {
          const addonsString = `الإضافات المطلوبة: ${currentAddons.join("، ")}`;
          currentNotes.push(addonsString);
        }

        notesTextarea.value = currentNotes
          .filter((line) => line.trim() !== "")
          .join("\n");
      }

      addAddonBtn.addEventListener("click", () => {
        const addonText = addonInput.value.trim();
        if (addonText && currentAddons.length < 5) {
          currentAddons.push(addonText);
          addonInput.value = "";
          renderAddonsList();
        } else if (currentAddons.length >= 5) {
          showToast("لا يمكن إضافة أكثر من 5 إضافات.", true);
        }
      });

      // ====================================================================
      // 3. منطق توليد التصميم (Gemini Logic) - تم التعديل لنطاق السعر
      // ====================================================================

      designForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 💡 التحقق من أن الخشب المختار غير معطل (لضمان توفره)
        if (materialSelect.selectedOptions[0]?.disabled) {
          alert("لا يمكن إرسال طلب تصميم باستخدام مادة خام غير متوفرة حالياً.");
          return;
        }

        if (!designForm.checkValidity()) {
          showToast("الرجاء ملء جميع الحقول المطلوبة بشكل صحيح.", true);
          designForm.reportValidity();
          return;
        }

        const productType = productTypeSelect.value;
        const dimensions = dimensionsSelect.value;
        const color = colorSelect.value;
        const material = materialSelect.value;
        const notes = document.getElementById("notes")?.value;
        const roomPlacement = document.getElementById("room-placement")?.value;

        const estimatedCOGS = calculateEstimatedCost(
          material,
          color,
          productType,
          currentAddons
        );

        const minMargin = 1.3;
        const maxMargin = 1.6;

        const priceRangeMin = Math.round(estimatedCOGS * minMargin);
        const priceRangeMax = Math.round(estimatedCOGS * maxMargin);

        processMessage.style.display = "block";
        designResultSection.style.display = "none";

        const filteredProducts = allProducts.filter(
          (p) => p.category === productType && p.is_available !== false
        );

        const productOptionsForAI = filteredProducts
          .map((p) => `- ${p.name} (Price: ${p.price} ISK)`)
          .join(", ");

        const promptText = `
          أنت خبير في تصميم الأثاث. مهمتك هي:
          1. إنشاء اقتراح تصميم بناءً على طلب العميل.
          2. اقتراح نطاق سعري نهائي ضمن الحدود المتاحة.
          
          بيانات التسعير الداعمة:
          - التكلفة التقديرية للمواد (COGS): ${estimatedCOGS} شيكل.
          - المنتجات المماثلة: ${productOptionsForAI || "لا يوجد."}
          - **نطاق السعر المسموح به:** يجب أن يتراوح النطاق المقترح بين ${priceRangeMin} شيكل و ${priceRangeMax} شيكل.

          طلب العميل:
          - نوع المنتج: ${productType}
          - المقاسات: ${dimensions}
          - المادة: ${material}
          - اللون والتشطيب: ${color}
          - التفاصيل الإضافية والملاحظات: ${notes}
          
          أعطني إخراجاً بالتنسيق التالي بدقة، ولا تضف أي شرح أو مقدمات:
          العنوان: <عنوان المنتج الموجز>
          الوصف: <وصف احترافي للمنتج>
          نطاق السعر المقترح: <السعر الأدنى رقمياً> - <السعر الأقصى رقمياً> شيكل
        `;

        try {
          const textResult = await textModel.generateContent(promptText);
          const textResponse = result.response.text();

          const titleMatch = textResponse.match(/العنوان:\s*(.*)/);
          const descriptionMatch = textResponse.match(/الوصف:\s*(.*)/);
          const priceRangeMatch = textResponse.match(
            /نطاق السعر المقترح:\s*([\d\.\,\s]+)\s*-\s*([\d\.\,\s]+)\s*شيكل/
          );

          let title = titleMatch ? titleMatch[1].trim() : "تصميم مخصص فريد";
          let description = descriptionMatch
            ? descriptionMatch[1].trim()
            : "وصف مقترح من المساعد.";

          let finalPriceMin = priceRangeMin;
          let finalPriceMax = priceRangeMax;

          if (priceRangeMatch && priceRangeMatch[1] && priceRangeMatch[2]) {
            finalPriceMin = parseFloat(
              priceRangeMatch[1].replace(/[^0-9\.]/g, "")
            );
            finalPriceMax = parseFloat(
              priceRangeMatch[2].replace(/[^0-9\.]/g, "")
            );
          }

          if (
            finalPriceMin < priceRangeMin ||
            finalPriceMax > priceRangeMax ||
            finalPriceMin >= finalPriceMax ||
            isNaN(finalPriceMin) ||
            isNaN(finalPriceMax)
          ) {
            finalPriceMin = priceRangeMin;
            finalPriceMax = priceRangeMax;
          }

          const initialDesignPrice = finalPriceMin;

          currentDesign = {
            title: title,
            description: description,
            price: initialDesignPrice,
            price_value: initialDesignPrice,
            price_range: `${finalPriceMin.toFixed(0)} - ${finalPriceMax.toFixed(
              0
            )}`,
            type: productType,
            dimensions,
            material,
            color,
            notes,
            addons: currentAddons,
            quantity: 1,
            estimatedCOGS: estimatedCOGS,
          };

          processMessage.style.display = "none";

          document.getElementById("result-content").innerHTML = `
                <h3 id="result-title">${currentDesign.title}</h3>
                <p><strong>الوصف المقترح:</strong> ${currentDesign.description}</p>
                <p><strong>المواصفات الرئيسية:</strong> ${currentDesign.material}، ${currentDesign.color}، ${currentDesign.dimensions}</p>
                <p id="result-price" style="font-size: 1.4rem; font-weight: bold; color: var(--primary-color);">
                    نطاق السعر الأولي: ${currentDesign.price_range} شيكل
                </p>
                <p style="font-size: 0.9rem; color: #888; margin-top: 10px">
                    السعر المقترح ليس نهائياً، سيتم تأكيده بعد مراجعة الفريق.
                </p>`;
          designResultSection.classList.add("show");
          designResultSection.style.display = "block";
        } catch (error) {
          console.error("Error generating design:", error);
          processMessage.style.display = "none";
          showToast("❌ حدث خطأ أثناء إنشاء التصميم. حاول مرة أخرى.", true);
        }
      });

      // ====================================================================
      // 4. منطق الإرسال (إضافة للسلة)
      // ====================================================================

      document
        .getElementById("submit-design-btn")
        .addEventListener("click", () => {
          if (!currentDesign) return;

          addToCartAsCustom(currentDesign);
          designResultSection.style.display = "none";
          designForm.reset();
          updateDimensionsOptions();
          currentAddons = [];
          renderAddonsList();
          updateMaterialPreview();
        });

      // ====================================================================
      // 5. بدء التشغيل
      // ====================================================================
      document.addEventListener("DOMContentLoaded", () => {
        loadCartAndUpdateBadge();
        initializeData();

        onAuthStateChanged(auth, (user) => {
          currentUser = user;
        });

        document
          .gسetElementById("regenerate-design-btn")
          .addEventListener("click", () => {
            designForm.dispatchEvent(
              new Event("submit", { cancelable: true, bubbles: true })
            );
          });

        renderAddonsList();
      });
    </script>
  </body>
</html>
