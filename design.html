<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ููุฌุฑุฉ | ุตูู ููุชุฌู</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .design-page-section {
        max-width: 800px;
        margin: 5rem auto;
        padding: 40px;
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: right;
      }
      .design-form {
        margin-top: 2rem;
      }
      .design-form .form-group {
        margin-bottom: 2rem;
      }
      .design-form .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }
      .design-form .form-group input,
      .design-form .form-group select,
      .design-form .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Cairo", sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .design-form .form-group input:focus,
      .design-form .form-group select:focus,
      .design-form .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(121, 85, 72, 0.2);
      }
      .design-form .btn {
        display: block;
        width: 100%;
        margin-top: 2rem;
      }
      /* General styles */
      .required-field {
        color: var(--danger-color);
        margin-right: 5px;
      }
      .loading-bar-container {
        display: none;
        text-align: center;
        padding: 20px;
        color: var(--primary-color);
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .design-result-section.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">ููุฌุฑุฉ</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a>
            </li>
            <li>
              <a href="index.html#products-page" class="nav-link">ููุชุฌุงุชูุง</a>
            </li>
            <li>
              <a href="order-status.html" class="nav-link">ุญุงูุฉ ุงูุทูุจ</a>
            </li>
            <li>
              <a href="recommendation.html" class="nav-link">ุงููุณุงุนุฏ</a>
            </li>
            <li>
              <a href="design.html" class="nav-link active">ุตูู ููุชุฌู</a>
            </li>
          </ul>
          <a href="cart.html" class="cart-icon-wrapper">
            <svg
              id="cart-icon"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
              />
            </svg>
            <span id="cart-count-badge">0</span>
          </a>
          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a>
      <a href="index.html#products-page" class="nav-link">ููุชุฌุงุชูุง</a>
      <a href="order-status.html" class="nav-link">ุญุงูุฉ ุงูุทูุจ</a>
      <a href="recommendation.html" class="nav-link">ุงููุณุงุนุฏ</a>
      <a href="design.html" class="nav-link">ุตูู ููุชุฌู</a>
    </div>

    <main>
      <section class="section container design-page-section">
        <div class="section-title-wrapper">
          <h2>ุตูู ููุชุฌู ุงูุฎุงุต</h2>
        </div>
        <p style="text-align: center; color: #777">
          ุตู ููุง ููุฑุชู ูู ุฃุฑุจุน ุฎุทูุงุช ุจุณูุทุฉ ูุณูููู ุจุชุญููููุง ุฅูู ุชุตููู ููุชุฑุญ.
        </p>

        <form id="design-form" class="design-form">
          <div class="form-step active" data-step="1">
            <div class="form-group">
              <label for="product-type"
                ><span class="required-field">*</span> ููุน ุงูููุชุฌ ุงููุทููุจ</label
              >
              <select id="product-type" name="product-type" required>
                <option value="">-- ุงุฎุชุฑ ููุน ุงูููุชุฌ --</option>
                <option value="ุทุงููุฉ ุณูุฑุฉ">ุทุงููุฉ ุณูุฑุฉ</option>
                <option value="ูุฑุณู">ูุฑุณู</option>
                <option value="ุทูู ููุจ">ุทูู ููุจ</option>
                <option value="ุบุฑูุฉ ููู">ุบุฑูุฉ ููู</option>
                <option value="ูุทุจุฎ">ูุทุจุฎ</option>
                <option value="ุทุงููุฉ ูุณุท">ุทุงููุฉ ูุณุท</option>
                <option value="ุฎุฒุงูุฉ">ุฎุฒุงูุฉ</option>
                <option value="ุทุงููุฉ ุชููุงุฒ">ุทุงููุฉ ุชููุงุฒ</option>
                <option value="ุขุฎุฑ">ุขุฎุฑ...</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dimensions"
                  ><span class="required-field">*</span> ุงูููุงุณุงุช
                  ุงูุชูุฑูุจูุฉ</label
                >
                <select id="dimensions" name="dimensions" required>
                  <option value="">-- ุงุฎุชุฑ ููุน ุงูููุชุฌ ุฃููุงู --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="room-placement"
                  ><span class="required-field">*</span> ููุงู ูุถุน ุงูููุชุฌ</label
                >
                <select id="room-placement" name="room-placement" required>
                  <option value="">-- ุงุฎุชุฑ ุงูููุงู --</option>
                  <option value="ุบุฑูุฉ ุงููุนูุดุฉ">ุบุฑูุฉ ุงููุนูุดุฉ</option>
                  <option value="ุบุฑูุฉ ุงูุทุนุงู">ุบุฑูุฉ ุงูุทุนุงู</option>
                  <option value="ุบุฑูุฉ ุงูููู">ุบุฑูุฉ ุงูููู</option>
                  <option value="ุงููุทุจุฎ">ุงููุทุจุฎ</option>
                  <option value="ุงูููุชุจ">ุงูููุชุจ</option>
                  <option value="ุบุฑูุฉ ุงูุฃุทูุงู">ุบุฑูุฉ ุงูุฃุทูุงู</option>
                  <option value="ุฎุงุฑุฌู">ุฎุงุฑุฌู</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="color"
                  ><span class="required-field">*</span> ุงูููู ูุงูุชุดุทูุจ
                  ุงูููุถูู</label
                >
                <select id="color" name="color" required>
                  <option value="">-- ุฌุงุฑู ุงูุชุญููู --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="material"
                  ><span class="required-field">*</span> ุงููุงุฏุฉ ุงูุฑุฆูุณูุฉ ุงูููุถูุฉ
                  (ููุน ุงูุฎุดุจ)</label
                >
                <select id="material" name="material" required>
                  <option value="">-- ุฌุงุฑู ุงูุชุญููู --</option>
                </select>
              </div>
            </div>

            <div class="form-group" id="notes-group">
              <label for="notes"
                ><span class="required-field">*</span> ูุตู ููุฑุชู ูุชูุงุตูู
                ุงูุชุตููู</label
              >
              <textarea
                id="notes"
                name="notes"
                rows="4"
                required
                placeholder="ูุซุงู: ุฃุญุชุงุฌ ุทุงููุฉ ุทุนุงู ุจููุท ุฑูููุ ุชุชุณุน ูู 6 ุฃุดุฎุงุตุ ุงูููุฒุงููุฉ 2500 ุดูููุ ุฃุฑูุฏ ุฃุฏุฑุงุฌุงู ูุฎููุฉ."
              ></textarea>
            </div>
          </div>

          <button type="submit" class="btn" id="submit-form-btn">
            <i class="fa-solid fa-robot"></i> ุงูุชุฑุงุญ ุชุตููู
          </button>
        </form>

        <div id="processing-message" class="loading-bar-container">
          <div class="loading-bar"></div>
          <p style="text-align: center; font-weight: bold; padding-top: 5px">
            ุฌุงุฑู ูุนุงูุฌุฉ ุทูุจู...
          </p>
        </div>

        <div
          id="design-result"
          class="design-result-section"
          style="display: none"
        >
          <h2 style="margin-bottom: 1.5rem">ุงูุชุฑุงุญูุง ูู</h2>
          <div class="design-result-text" id="result-content"></div>
          <div class="design-result-actions">
            <button class="btn" id="submit-design-btn">
              <i class="fa-solid fa-cart-plus"></i> ุฃุถู ุฅูู ุงูุณูุฉ ูููุฑุงุฌุนุฉ
            </button>
            <button
              class="btn"
              id="regenerate-design-btn"
              style="background-color: var(--accent-color)"
            >
              ุงูุชุฑุงุญ ุขุฎุฑ
            </button>
          </div>
          <div
            style="
              margin-top: 2rem;
              text-align: center;
              font-size: 0.9rem;
              color: #888;
            "
          >
            <p>
              ุงูุณุนุฑ ุงููุนุฑูุถ ูู ุณุนุฑ ุฃููู ููุชุฑุญ. ุณูุชู ุชุฃููุฏู ุจุนุฏ ูุฑุงุฌุนุฉ ุงููุฑูู.
              ููููู ุงูุขู ุฅุถุงูุชู ุฅูู ุงูุณูุฉ ูุฅููุงู ุทูุจู.
            </p>
          </div>
        </div>
      </section>
    </main>

    <div id="design-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-confirm">&times;</span>
        <h2>ุดูุฑุงู ูู!</h2>
        <p>
          ุชู ุงุณุชูุงู ุทูุจู ููุชุตููู ุงููุฎุตุต ุจูุฌุงุญ. ุณูููู ุจูุฑุงุฌุนุชู ูุงูุฑุฏ ุนููู ุฎูุงู
          ูููู ุนูู.
        </p>
        <p>ุฑูุฒ ุงูุชุชุจุน ุงูุฎุงุต ุจุทูุจู ูู:</p>
        <span id="design-tracking-id" class="tracking-id-display"></span>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          ุงูุฑุฌุงุก ุญูุธ ูุฐุง ุงูุฑูุฒ ูุชุชููู ูู ูุชุงุจุนุฉ ุญุงูุฉ ุทูุจู ููุจูู ุฃู ุฑูุถ ุงูุณุนุฑ
          ุงูููุงุฆู.
        </p>
      </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <div id="design-checkout-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-checkout">&times;</span>
        <div class="modal-body">
          <div class="checkout-form-container">
            <h2>ุฅุฑุณุงู ุทูุจ ุงูุชุตููู</h2>
            <p>
              ุงูุฑุฌุงุก ุฅุฏุฎุงู ุจูุงูุงุชู ูุฅุฑุณุงู ุทูุจ ุงูุชุตููู. ุณูุชู ุงูุชูุงุตู ูุนู
              ููุฑุงุฌุนุชู.
            </p>
            <form id="design-checkout-form">
              <div class="form-group">
                <label for="name">ุงูุงุณู ุงููุงูู</label>
                <input type="text" id="design-name" name="name" required />
              </div>
              <div class="form-group">
                <label for="phone">ุฑูู ุงููุงุชู</label>
                <input type="tel" id="design-phone" name="phone" required />
              </div>
              <div class="form-group">
                <label for="email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ุงุฎุชูุงุฑู)</label>
                <input type="email" id="design-email" name="email" />
              </div>
              <div class="form-group">
                <label for="address">ุงูุนููุงู</label>
                <textarea
                  id="design-address"
                  name="address"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn" id="confirm-design-btn">
                ุชุฃููุฏ ุทูุจ ุงูุชุตููู
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // ******* ุฅุนุฏุงุฏุงุช Firebase ู Gemini *******
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const textModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // ูุชุบูุฑุงุช ุชุฎุฒูู ุงูุจูุงูุงุช
      let allProducts = [];
      let allRawMaterials = [];
      let currentUser = null;
      let currentDesign = null;

      const standardColors = [
        "ุฃุจูุถ",
        "ุฃุณูุฏ",
        "ุฑูุงุฏู ูุงุชุญ",
        "ุฃุฒุฑู ูููู",
        "ุฃุฎุถุฑ ุฒูุฑุฏู",
        "ุจูุฌ ูุทูู",
        "ุจูู ุบุงูู",
        "ุฃุญูุฑ ุณุงุทุน",
      ];
      const productDimensions = {
        "ุทุงููุฉ ุณูุฑุฉ": [
          "ููุงุณ ุตุบูุฑ (2-4 ุฃุดุฎุงุต)",
          "ููุงุณ ูุชูุณุท (4-6 ุฃุดุฎุงุต)",
          "ููุงุณ ูุจูุฑ (6-8 ุฃุดุฎุงุต)",
        ],
        ูุฑุณู: ["ููุงุณ ููุงุณู", "ููุงุณ ูุจูุฑ ููุฑูุญ"],
        "ุทูู ููุจ": ["ููุนุฏูู", "ุซูุงุซุฉ ููุงุนุฏ", "ููุจุฉ ุฒุงููุฉ (ุญุฑู L)"],
        "ุบุฑูุฉ ููู": ["ุณุฑูุฑ ูุฒุฏูุฌ ููุงุณู", "ุณุฑูุฑ ููุฑุฏ", "ูุฌููุนุฉ ุชุณุฑูุญุฉ ูุฎุฒุงูุฉ"],
        ูุทุจุฎ: ["ูุญุฏุฉ ุนูููุฉ ููุงุณูุฉ", "ูุญุฏุฉ ุณูููุฉ ููุงุณูุฉ", "ุฌุฒูุฑุฉ ูุทุจุฎ"],
        "ุทุงููุฉ ูุณุท": ["ููุงุณ ููุงุณู (ุตุบูุฑุฉ)", "ููุงุณ ูุจูุฑ"],
        ุฎุฒุงูุฉ: [
          "ุตุบูุฑุฉ (ุจุงุจูู)",
          "ูุชูุณุทุฉ (3-4 ุฃุจูุงุจ)",
          "ูุจูุฑุฉ (ุฃูุซุฑ ูู 4 ุฃุจูุงุจ)",
        ],
        "ุทุงููุฉ ุชููุงุฒ": ["ุตุบูุฑุฉ (ุฃูู ูู 120 ุณู)", "ูุจูุฑุฉ (ุฃูุซุฑ ูู 150 ุณู)"],
        ุขุฎุฑ: ["ููุงุณ ุตุบูุฑ", "ููุงุณ ูุชูุณุท", "ููุงุณ ูุจูุฑ"],
      };

      // ุนูุงุตุฑ ุงููุงุฌูุฉ
      const productTypeSelect = document.getElementById("product-type");
      const colorSelect = document.getElementById("color");
      const materialSelect = document.getElementById("material");
      const dimensionsSelect = document.getElementById("dimensions");
      const toast = document.getElementById("toast-notification");
      const designCheckoutForm = document.getElementById(
        "design-checkout-form"
      );
      const processMessage = document.getElementById("processing-message");
      const designResultSection = document.getElementById("design-result");
      const designForm = document.getElementById("design-form");

      // ====================================================================
      // 1. ูุธุงุฆู ุงููุณุงุนุฏุฉ ุงูุนุงูุฉ ูุชููุฆุฉ ุงูุจูุงูุงุช
      // ====================================================================

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.className = `toast show ${isError ? "error" : "success"}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-close").forEach((btn) => {
        btn.addEventListener("click", () => {
          const modalId = btn.closest(".modal-overlay").id;
          closeModal(modalId);
        });
      });

      function loadCartAndUpdateBadge() {
        const storedCart = localStorage.getItem("shoppingCart") || "[]";
        const cart = JSON.parse(storedCart);
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (cartCountBadge) {
          const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          cartCountBadge.textContent = totalItems;
          cartCountBadge.classList.toggle("visible", totalItems > 0);
        }
        return cart;
      }

      function saveCart(cart) {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        loadCartAndUpdateBadge();
      }

      function generateTrackingId(prefix = "DGN") {
        return `${prefix}-${new Date().getTime().toString(36)}-${Math.random()
          .toString(36)
          .substr(2, 5)}`.toUpperCase();
      }

      async function initializeData() {
        processMessage.style.display = "block";
        try {
          const [productsSnapshot, materialsSnapshot] = await Promise.all([
            getDocs(collection(db, "products")),
            getDocs(collection(db, "raw_materials")),
          ]);

          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          allRawMaterials = materialsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            type: doc.data().type || "ุฃุฎุฑู",
            name_ar: doc.data().name_ar,
          }));

          fillDropdowns();
        } catch (e) {
          console.error("Initialization Error: ", e);
          showToast("โ ูุดู ุชุญููู ุจูุงูุงุช ุงููุฎุฒูู. ูุฑุฌู ูุฑุงุฌุนุฉ Firebase.", true);
          designForm.style.opacity = 0.5;
        } finally {
          processMessage.style.display = "none";
        }
      }

      function fillDropdowns() {
        // 1. ุชุนุจุฆุฉ ุงูุฃุฎุดุงุจ
        const woodMaterials = allRawMaterials.filter((m) => m.type === "ุฎุดุจ");
        let materialOptions = '<option value="">-- ุงุฎุชุฑ ูุงุฏุฉ --</option>';
        woodMaterials.forEach((m) => {
          materialOptions += `<option value="${m.name_ar}">${m.name_ar}</option>`;
        });
        materialSelect.innerHTML = materialOptions;

        // 2. ุชุนุจุฆุฉ ุงูุฃููุงู
        let colorOptions = `<option value="">-- ุงุฎุชุฑ ููู --</option>`;
        colorOptions += `<option value="ููู ุทุจูุนู (ูุฑููุด)">ููู ุทุจูุนู (ูุฑููุด/ุญูุงูุฉ ุดูุงูุฉ)</option>`;
        standardColors.forEach((color) => {
          colorOptions += `<option value="${color} (ุฏูุงู)">${color} (ุฏูุงู)</option>`;
        });
        colorSelect.innerHTML = colorOptions;

        // 3. ุชุญุฏูุซ ุงูุฃุจุนุงุฏ ุจูุงุกู ุนูู ููุน ุงูููุชุฌ
        productTypeSelect.addEventListener("change", updateDimensionsOptions);
        updateDimensionsOptions(); // ุชุนุจุฆุฉ ุฃูููุฉ
      }

      function updateDimensionsOptions() {
        const selectedType = productTypeSelect.value;
        const options =
          productDimensions[selectedType] || productDimensions["ุขุฎุฑ"];

        let optionsHTML = `<option value="">-- ุงุฎุชุฑ ููุงุณุงู ุชูุฑูุจูุงู --</option>`;
        options.forEach((dim) => {
          optionsHTML += `<option value="${dim}">${dim}</option>`;
        });
        dimensionsSelect.innerHTML = optionsHTML;
      }

      function calculateEstimatedCost(materialName, color, productType) {
        let baseCost = 0;
        let woodVolumeFactor = 1;
        let paintVolumeFactor = 1;
        let accessoryCost = 150;

        const woodMaterial = allRawMaterials.find(
          (m) => m.name_ar === materialName && m.type === "ุฎุดุจ"
        );
        const paintMaterial = allRawMaterials.find((m) =>
          m.type.includes("ุทูุงุก")
        );
        const varnishMaterial = allRawMaterials.find((m) =>
          m.name_ar.includes("ูุฑููุด")
        );

        // ุชุญุฏูุฏ ูุนุงูู ุญุฌู ุงูุฎุดุจ ุงูุชูุฑูุจู
        if (productType.includes("ุทุงููุฉ")) woodVolumeFactor = 0.75;
        else if (productType.includes("ููุจ")) woodVolumeFactor = 1.0;
        else if (productType.includes("ุฎุฒุงูุฉ")) woodVolumeFactor = 1.2;
        else woodVolumeFactor = 0.5;

        if (woodMaterial) {
          baseCost += (woodMaterial.cost_per_unit || 0) * woodVolumeFactor;
        } else {
          baseCost += 1500 * woodVolumeFactor;
        }

        // ุชูููุฉ ุงูุชุดุทูุจ
        if (color.includes("ูุฑููุด") && varnishMaterial) {
          baseCost +=
            (varnishMaterial.cost_per_unit || 200) * paintVolumeFactor;
        } else if (paintMaterial) {
          baseCost += (paintMaterial.cost_per_unit || 500) * paintVolumeFactor;
        } else {
          baseCost += 300;
        }

        baseCost += accessoryCost;

        return Math.round(baseCost);
      }

      function addToCartAsCustom(design) {
        let cart = loadCartAndUpdateBadge();

        const tempId = `CUSTOM-${Date.now()}`;

        const newItem = {
          id: tempId,
          name: design.title,
          price: design.price_value,
          quantity: 1,
          isCustom: true,
          // ุญูุธ ุฌููุน ุชูุงุตูู ุงูุชุตููู ุฏุงุฎู ุญูู 'details'
          details: {
            type: design.type,
            dimensions: design.dimensions,
            material: design.material,
            color: design.color,
            notes: design.notes,
            estimatedCOGS: design.estimatedCOGS,
            description: design.description,
            initial_price: design.price_value,
            // ๐ก ูุฅุธูุงุฑูุง ุจูุถูุญ ูููุฏูุฑ:
            title: design.title,
          },
        };

        cart.push(newItem);
        saveCart(cart);
        showToast(`โ ุชูุช ุฅุถุงูุฉ ุงูุชุตููู (${design.title}) ุฅูู ุงูุณูุฉ ูููุฑุงุฌุนุฉ!`);
      }

      // ====================================================================
      // 2. ููุทู ุชูููุฏ ุงูุชุตููู (Gemini Logic)
      // ====================================================================

      designForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // ๐ก ุงูุชุญูู ูู ุตุญุฉ ุงููููุฐุฌ ุจุงุณุชุฎุฏุงู ุงูุชุญูู ุงูุงูุชุฑุงุถู ูู HTML
        if (!designForm.checkValidity()) {
          showToast("ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ ุจุดูู ุตุญูุญ.", true);
          designForm.reportValidity();
          return;
        }

        const productType = productTypeSelect.value;
        const dimensions = dimensionsSelect.value;
        const color = colorSelect.value;
        const material = materialSelect.value;
        const notes = document.getElementById("notes")?.value;
        const roomPlacement = document.getElementById("room-placement")?.value;

        const estimatedCOGS = calculateEstimatedCost(
          material,
          color,
          productType
        );
        const initialSuggestedPrice = Math.round(estimatedCOGS * 1.35);

        // ุฅุธูุงุฑ ุงููุนุงูุฌุฉ
        designResultSection.classList.remove("show");
        designResultSection.style.display = "none";
        processMessage.style.display = "block";

        const filteredProducts = allProducts.filter(
          (p) => p.category === productType && p.is_available !== false
        );

        const productOptionsForAI = filteredProducts
          .map((p) => `- ${p.name} (Price: ${p.price} ISK)`)
          .join(", ");

        const promptText = `
          ุฃูุช ุฎุจูุฑ ูู ุชุตููู ุงูุฃุซุงุซ. ุฃูุดุฆ ุงูุชุฑุงุญ ุชุตููู ุจูุงุกู ุนูู ุทูุจ ุงูุนููู.
          ุงูุชุฑุญ ุณุนุฑุงู ููุงุฆูุงู ููุทููุงูุ ูุฌุจ ุฃู ูุชุฑุงูุญ ุจูู ${initialSuggestedPrice} ุดููู ู ${
          initialSuggestedPrice + 1000
        } ุดููู.
          
          ุจูุงูุงุช ุงูุชุณุนูุฑ ุงูุฏุงุนูุฉ:
          - ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ ููููุงุฏ (COGS): ${estimatedCOGS} ุดููู.
          - ุงูููุชุฌุงุช ุงูููุงุซูุฉ: ${productOptionsForAI || "ูุง ููุฌุฏ."}

          ุทูุจ ุงูุนููู:
          - ููุน ุงูููุชุฌ: ${productType}
          - ุงูููุงุณุงุช: ${dimensions}
          - ุงููุงุฏุฉ: ${material}
          - ุงูููู ูุงูุชุดุทูุจ: ${color}
          - ุงูุชูุงุตูู ุงูุฅุถุงููุฉ: ${notes}
          
          ุฃุนุทูู ุฅุฎุฑุงุฌุงู ุจุงูุชูุณูู ุงูุชุงูู ุจุฏูุฉ:
          ุงูุนููุงู: <ุนููุงู ุงูููุชุฌ ุงูููุฌุฒ>
          ุงููุตู: <ูุตู ุงุญุชุฑุงูู ููููุชุฌ>
          ุงูุณุนุฑ ุงูููุชุฑุญ: <ูููุฉ ููุฏูุฉ (ุฑูู) ุจุงูุนููุฉ ุดููู>
        `;

        try {
          const textResult = await textModel.generateContent(promptText);
          const textResponse = textResult.response.text();

          const titleMatch = textResponse.match(/ุงูุนููุงู:\s*(.*)/);
          const descriptionMatch = textResponse.match(/ุงููุตู:\s*(.*)/);
          const priceMatch = textResponse.match(
            /ุงูุณุนุฑ ุงูููุชุฑุญ:\s*([\d\.\,\s]+)\s*ุดููู/
          );

          let title = titleMatch ? titleMatch[1].trim() : "ุชุตููู ูุฎุตุต ูุฑูุฏ";
          let description = descriptionMatch
            ? descriptionMatch[1].trim()
            : "ูุตู ููุชุฑุญ ูู ุงููุณุงุนุฏ.";

          const finalPriceValueMatch = priceMatch
            ? priceMatch[0].match(/[\d\.]+/g)
            : null;
          const finalPriceValue = finalPriceValueMatch
            ? parseFloat(finalPriceValueMatch[0])
            : initialSuggestedPrice;

          currentDesign = {
            title: title,
            description: description,
            price: finalPriceValue,
            price_value: finalPriceValue,
            type: productType,
            dimensions,
            material,
            color,
            notes,
            quantity: 1,
            estimatedCOGS: estimatedCOGS,
          };

          processMessage.style.display = "none";

          // ๐ก ุนุฑุถ ุงููุนูููุงุช ููุฒุจูู (ุทูุจู ุงูุซุงูู)
          document.getElementById("result-content").innerHTML = `
                <h3 id="result-title">${currentDesign.title}</h3>
                <p><strong>ุงููุตู ุงูููุชุฑุญ:</strong> ${
                  currentDesign.description
                }</p>
                <p><strong>ุงูููุงุตูุงุช ุงูุฑุฆูุณูุฉ:</strong> ${
                  currentDesign.material
                }ุ ${currentDesign.color}ุ ${currentDesign.dimensions}</p>
                <p id="result-price" style="font-size: 1.4rem; font-weight: bold; color: var(--primary-color);">
                    ุงูุณุนุฑ ุงูุฃููู: ${currentDesign.price_value.toFixed(0)} ุดููู
                </p>
                <p style="font-size: 0.9rem; color: #888; margin-top: 10px">
                    ุงูุณุนุฑ ุงูููุชุฑุญ ููุณ ููุงุฆูุงูุ ุณูุชู ุชุฃููุฏู ุจุนุฏ ูุฑุงุฌุนุฉ ุงููุฑูู.
                </p>`;
          designResultSection.classList.add("show");
          designResultSection.style.display = "block";
        } catch (error) {
          console.error("Error generating design:", error);
          processMessage.style.display = "none";
          showToast("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุชุตููู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.", true);
        }
      });

      // ====================================================================
      // 3. ููุทู ุงูุฅุฑุณุงู (ุฅุถุงูุฉ ููุณูุฉ)
      // ====================================================================

      document
        .getElementById("submit-design-btn")
        .addEventListener("click", () => {
          if (!currentDesign) return;

          // ๐ก ุทูุจู ุงูุฃูู: ูุฐูุจ ููุณูุฉ
          addToCartAsCustom(currentDesign);
          designResultSection.style.display = "none"; // ุฅุฎูุงุก ูุณู ุงููุชูุฌุฉ ุจุนุฏ ุงูุฅุถุงูุฉ
          designForm.reset();
          updateDimensionsOptions();
        });

      // ====================================================================
      // 4. ุจุฏุก ุงูุชุดุบูู
      // ====================================================================
      document.addEventListener("DOMContentLoaded", () => {
        loadCartAndUpdateBadge();
        initializeData();

        onAuthStateChanged(auth, (user) => {
          currentUser = user;
        });

        // ุฑุจุท ุฒุฑ ุฅุนุงุฏุฉ ุงูุงูุชุฑุงุญ
        document
          .getElementById("regenerate-design-btn")
          .addEventListener("click", () => {
            designForm.dispatchEvent(
              new Event("submit", { cancelable: true, bubbles: true })
            );
          });
      });
    </script>
  </body>
</html>
