<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | صمم منتجك</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* New styles for the design page */
      .design-page-section {
        max-width: 900px;
        margin: 5rem auto;
        padding: 40px;
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: right;
      }
      .design-form {
        margin-top: 2rem;
      }
      .design-form .form-group {
        margin-bottom: 2rem;
      }
      .design-form .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }
      .design-form .form-group input,
      .design-form .form-group select,
      .design-form .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Cairo", sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .design-form .form-group input:focus,
      .design-form .form-group select:focus,
      .design-form .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(121, 85, 72, 0.2);
      }
      .design-form .btn {
        display: block;
        width: 100%;
        margin-top: 2rem;
      }
      /* --- Multi-Step Form Styles --- */
      .form-step {
        display: none;
        animation: fadeIn 0.5s;
      }
      .form-step.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .form-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
      }
      .form-navigation .btn-secondary {
        background-color: var(--accent-color);
        padding: 10px 25px;
        border-radius: 50px;
        color: var(--white-color);
      }
      .form-navigation .btn-secondary:hover {
        background-color: var(--dark-color);
      }
      .progress-bar {
        height: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
        margin-bottom: 25px;
        overflow: hidden;
      }
      .progress-bar-fill {
        height: 100%;
        width: 0%;
        background-color: var(--primary-color);
        transition: width 0.4s ease-in-out;
      }
      /* Resource Input Section Styles */
      #resources-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        background-color: #fcfcfc;
      }
      .resource-input-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 40px;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }
      .resource-input-row input,
      .resource-input-row select {
        padding: 8px;
      }
      .btn-add-resource,
      .btn-remove-resource {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
      }
      .btn-remove-resource {
        color: var(--danger-color);
      }
      .loading-msg {
        text-align: center;
        font-size: 1rem;
        color: #888;
        padding: 20px 0;
      }
      .low-stock-warning {
        color: var(--danger-color);
        font-size: 0.8rem;
        display: block;
        margin-top: 5px;
      }
      .resource-summary {
        font-weight: 600;
        text-align: left;
        padding: 10px 0;
        color: var(--dark-color);
      }
      .required-field {
        color: var(--danger-color);
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">منجرة</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">الرئيسية</a>
            </li>
            <li>
              <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
            </li>
            <li>
              <a href="order-status.html" class="nav-link">حالة الطلب</a>
            </li>
            <li>
              <a href="recommendation.html" class="nav-link">المساعد</a>
            </li>
            <li>
              <a href="design.html" class="nav-link active">صمم منتجك</a>
            </li>
          </ul>
          <a href="cart.html" class="cart-icon-wrapper">
            <svg
              id="cart-icon"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
              />
            </svg>
            <span id="cart-count-badge">0</span>
          </a>
          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">الرئيسية</a>
      <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
      <a href="order-status.html" class="nav-link">حالة الطلب</a>
      <a href="recommendation.html" class="nav-link">المساعد</a>
      <a href="design.html" class="nav-link">صمم منتجك</a>
    </div>

    <main>
      <section class="section container design-page-section">
        <div class="section-title-wrapper">
          <h2>صمم منتجك الخاص</h2>
        </div>
        <p style="text-align: center; color: #777">
          املأ النموذج التالي على خطوات لتحديد مواصفات تصميمك الفريد.
        </p>

        <div class="progress-bar">
          <div class="progress-bar-fill" id="progress-bar-fill"></div>
        </div>

        <form id="design-form" class="design-form">
          <div class="form-step active" data-step="1">
            <h3 style="margin-bottom: 1.5rem">
              <i class="fa-solid fa-lightbulb"></i> الخطوة 1: الفكرة العامة
            </h3>
            <div class="form-group">
              <label for="product-type"
                ><span class="required-field">*</span> نوع المنتج المطلوب</label
              >
              <select id="product-type" name="product-type" required>
                <option value="">-- اختر نوع المنتج --</option>
                <option value="طاولة سفرة">طاولة سفرة</option>
                <option value="كرسي">كرسي</option>
                <option value="طقم كنب">طقم كنب</option>
                <option value="غرفة نوم">غرفة نوم</option>
                <option value="مطبخ">مطبخ</option>
                <option value="طاولة وسط">طاولة وسط</option>
                <option value="خزانة">خزانة</option>
                <option value="طاولة تلفاز">طاولة تلفاز</option>
                <option value="آخر">آخر...</option>
              </select>
            </div>

            <div class="form-group">
              <label for="design-style">نمط التصميم المفضّل</label>
              <select id="design-style" name="design-style">
                <option value="عصري (Modern)">عصري (Modern)</option>
                <option value="كلاسيكي (Classic)">كلاسيكي (Classic)</option>
                <option value="ريفي (Rustic)">ريفي (Rustic)</option>
                <option value="بوهيمي">بوهيمي</option>
                <option value="صناعي (Industrial)">صناعي (Industrial)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="material"
                ><span class="required-field">*</span> المادة الرئيسية
                المفضلة</label
              >
              <select id="material" name="material" required>
                <option value="">-- جارٍ التحميل --</option>
              </select>
            </div>
          </div>

          <div class="form-step" data-step="2">
            <h3 style="margin-bottom: 1.5rem">
              <i class="fa-solid fa-screwdriver-wrench"></i> الخطوة 2: الأبعاد
              والموارد
            </h3>

            <div id="dynamic-fields"></div>

            <div class="form-group">
              <label>الموارد الخام المطلوبة لتقدير التكلفة</label>
              <div id="resources-container">
                <div class="loading-msg" id="resources-loading-msg">
                  جارٍ تحميل قائمة المواد الخام...
                </div>
                <div id="resource-input-list"></div>
                <div class="resource-summary" id="resource-total-cost">
                  التكلفة التقديرية للمواد: 0.00 شيكل
                </div>
                <button
                  type="button"
                  class="btn-add-resource"
                  id="add-resource-btn"
                >
                  <i class="fa-solid fa-plus-circle"></i> إضافة مادة
                </button>
              </div>
            </div>
          </div>

          <div class="form-step" data-step="3">
            <h3 style="margin-bottom: 1.5rem">
              <i class="fa-solid fa-wand-magic-sparkles"></i> الخطوة 3: اللمسات
              الأخيرة
            </h3>

            <div class="form-group">
              <label for="features">ميزات إضافية وتفاصيل التصميم</label>
              <textarea
                id="features"
                name="features"
                rows="3"
                placeholder="مثال: أدراج مخفية، رفوف مفتوحة، زجاج مقاوم للحرارة..."
              ></textarea>
            </div>

            <div class="form-group" id="notes-group">
              <label for="notes">ملاحظات إضافية (أشياء لم تذكرها)</label>
              <textarea
                id="notes"
                name="notes"
                rows="4"
                placeholder="اكتب أي ملاحظات أو تفاصيل أخرى هنا..."
              ></textarea>
            </div>

            <p
              class="text-center"
              style="
                margin-top: 1rem;
                font-weight: bold;
                color: var(--primary-color);
              "
            >
              مستعد؟ لنطلق العنان لإبداع الذكاء الاصطناعي!
            </p>
          </div>

          <div class="form-navigation">
            <button
              type="button"
              class="btn btn-secondary"
              id="prev-step-btn"
              style="display: none"
            >
              <i class="fa-solid fa-arrow-right"></i> السابق
            </button>
            <button type="button" class="btn" id="next-step-btn">
              التالي <i class="fa-solid fa-arrow-left"></i>
            </button>
            <button
              type="submit"
              class="btn"
              id="submit-form-btn"
              style="display: none"
              disabled
            >
              <i class="fa-solid fa-robot"></i> اقتراح تصميم
            </button>
          </div>
        </form>

        <div id="processing-message" class="loading-bar-container">
          <div class="loading-bar"></div>
          <p style="text-align: center; font-weight: bold; padding-top: 5px">
            جارٍ معالجة طلبك...
          </p>
        </div>

        <div id="design-result" class="design-result-section"></div>
      </section>
    </main>

    <div id="design-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-confirm">&times;</span>
        <h2>شكراً لك!</h2>
        <p>
          تم استلام طلبك للتصميم المخصص بنجاح. سنقوم بمراجعته والرد عليك خلال
          يومي عمل.
        </p>
        <p>رمز التتبع الخاص بطلبك هو:</p>
        <span id="design-tracking-id" class="tracking-id-display"></span>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          الرجاء حفظ هذا الرمز لتتمكن من متابعة حالة طلبك وقبول أو رفض السعر
          النهائي.
        </p>
      </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div class="modal-body">
          <div class="modal-image-container">
            <img id="modal-img" src="" alt="صورة المنتج" />
          </div>
          <div class="modal-details-container">
            <h2 id="modal-title"></h2>
            <p id="modal-price" class="product-price"></p>
            <p id="modal-description"></p>
            <hr class="modal-options-separator" />
            <div class="modal-options">
              <div id="color-section">
                <label for="modal-color-select">اختر اللون</label>
                <select id="modal-color-select"></select>
              </div>
              <div>
                <label for="modal-quantity">الكمية</label>
                <div id="modal-quantity-selector" class="quantity-selector">
                  <button
                    class="quantity-btn quantity-btn-plus"
                    data-change="1"
                  >
                    +
                  </button>
                  <input
                    type="number"
                    id="modal-quantity"
                    value="1"
                    min="1"
                    readonly
                  />
                  <button
                    class="quantity-btn quantity-btn-minus"
                    data-change="-1"
                  >
                    -
                  </button>
                </div>
              </div>
            </div>
            <button class="btn" id="add-to-cart-btn">إضافة إلى السلة</button>
          </div>
        </div>
      </div>
    </div>

    <div id="design-checkout-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-checkout">&times;</span>
        <div class="modal-body">
          <div class="checkout-form-container">
            <h2>إرسال طلب التصميم</h2>
            <p>
              الرجاء إدخال بياناتك لإرسال طلب التصميم. سيتم التواصل معك
              لمراجعته.
            </p>
            <form id="design-checkout-form">
              <div class="form-group">
                <label for="name">الاسم الكامل</label>
                <input type="text" id="design-name" name="name" required />
              </div>
              <div class="form-group">
                <label for="phone">رقم الهاتف</label>
                <input type="tel" id="design-phone" name="phone" required />
              </div>
              <div class="form-group">
                <label for="email">البريد الإلكتروني (اختياري)</label>
                <input type="email" id="design-email" name="email" />
              </div>
              <div class="form-group">
                <label for="address">العنوان</label>
                <textarea
                  id="design-address"
                  name="address"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn" id="confirm-design-btn">
                تأكيد طلب التصميم
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // ******* إعدادات Firebase و Gemini *******
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const textModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // متغيرات تخزين البيانات من Firebase
      let allProducts = [];
      let allRawMaterials = [];
      let currentUser = null;
      let currentStep = 1;

      // عناصر الواجهة
      const formSteps = document.querySelectorAll(".form-step");
      const productTypeSelect = document.getElementById("product-type");
      const materialSelect = document.getElementById("material");
      const dynamicFieldsContainer = document.getElementById("dynamic-fields");
      const generateDesignBtn = document.getElementById("generate-design-btn");
      const resourceInputList = document.getElementById("resource-input-list");
      const addResourceBtn = document.getElementById("add-resource-btn");
      const resourcesLoadingMsg = document.getElementById(
        "resources-loading-msg"
      );
      const resourceTotalCostSpan = document.getElementById(
        "resource-total-cost"
      );
      const nextStepBtn = document.getElementById("next-step-btn");
      const prevStepBtn = document.getElementById("prev-step-btn");
      const submitFormBtn = document.getElementById("submit-form-btn");
      const progressBarFill = document.getElementById("progress-bar-fill");
      const toast = document.getElementById("toast-notification");

      let currentDesign = null;
      let suggestedProductId = null;
      let cart = [];

      // بيانات الأبعاد المقترحة (تبقى ثابتة)
      const productDimensions = {
        "طاولة سفرة": ["180x90x75 سم", "160x80x75 سم", "120x120x75 سم"],
        كرسي: ["45x50x90 سم", "40x40x85 سم", "60x65x90 سم"],
        "طقم كنب": ["220x90x85 سم", "160x90x85 سم", "250x180x85 سم"],
        "غرفة نوم": [
          "200x160x100 سم (سرير مزدوج)",
          "200x90x80 سم (سرير مفرد)",
          "100x45x140 سم (تسريحة)",
        ],
        مطبخ: [
          "80x30x60 سم (خزانة علوية)",
          "80x60x90 سم (خزانة سفلية)",
          "120x80x90 سم (جزيرة مطبخ)",
        ],
        "طاولة وسط": ["80x80x45 سم", "100x60x45 سم", "120x70x40 سم"],
        خزانة: ["90x50x180 سم", "80x30x160 سم", "120x55x180 سم"],
        "طاولة تلفاز": ["140x40x50 سم", "120x40x45 سم", "150x30x30 سم"],
        آخر: [],
      };

      // ====================================================================
      // وظائف الأدوات المساعدة والمخزون
      // ====================================================================

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.className = `toast show ${isError ? "error" : "success"}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function loadCart() {
        const storedCart = localStorage.getItem("shoppingCart");
        cart = storedCart ? JSON.parse(storedCart) : [];
      }

      function updateCartBadge() {
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (!cartCountBadge) return;
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.toggle("visible", totalItems > 0);
      }

      function updateResourceCostSummary() {
        const rows = Array.from(
          resourceInputList.querySelectorAll(".resource-input-row")
        );
        let totalCost = 0;

        rows.forEach((row) => {
          const select = row.querySelector('select[name="resource_id"]');
          const quantityInput = row.querySelector('input[name="quantity"]');

          if (select.value && quantityInput.value) {
            const selectedOption = select.options[select.selectedIndex];
            const cost = parseFloat(selectedOption.dataset.cost);
            const quantity = parseFloat(quantityInput.value);

            if (!isNaN(cost) && !isNaN(quantity)) {
              totalCost += cost * quantity;
            }
          }
        });

        resourceTotalCostSpan.textContent = `التكلفة التقديرية للمواد: ${totalCost.toFixed(
          2
        )} شيكل`;

        // تفعيل زر الاقتراح إذا كان هناك نوع منتج ومواد مختارة
        const isProductTypeSelected = productTypeSelect.value !== "";
        const isMaterialSelected = materialSelect.value !== "";
        const areResourcesAdded = rows.length > 0 && totalCost > 0;

        if (
          currentStep === 3 &&
          isProductTypeSelected &&
          isMaterialSelected &&
          areResourcesAdded
        ) {
          submitFormBtn.disabled = false;
        } else if (currentStep === 3) {
          submitFormBtn.disabled = true;
        }
      }

      // وظيفة جلب المنتجات والمواد الخام من Firebase
      async function fetchFirebaseData() {
        try {
          const productsSnapshot = await getDocs(collection(db, "products"));
          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          const materialsSnapshot = await getDocs(
            collection(db, "raw_materials")
          );
          allRawMaterials = materialsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit),
            current_stock: parseFloat(doc.data().current_stock),
            reorder_point: parseFloat(doc.data().reorder_point) || 0,
          }));

          resourcesLoadingMsg.style.display = "none";

          // ملء قائمة المواد الرئيسية
          const woodMaterials = allRawMaterials.filter((m) => m.type === "خشب");
          materialSelect.innerHTML =
            '<option value="">-- اختر مادة --</option>';
          woodMaterials.forEach((m) => {
            const option = document.createElement("option");
            option.value = m.name_ar;
            option.textContent = m.name_ar;
            materialSelect.appendChild(option);
          });

          addResourceInputRow(true);
          updateDynamicFields();
          updateStepVisibility(); // لإخفاء رسالة التحميل
        } catch (e) {
          console.error("Error fetching Firebase data: ", e);
          resourcesLoadingMsg.textContent =
            "❌ فشل تحميل البيانات الضرورية من المخزون.";
          showToast("❌ فشل تحميل البيانات الضرورية من المخزون.", true);
        }
      }

      function updateDynamicFields() {
        const selectedType = productTypeSelect.value;
        dynamicFieldsContainer.innerHTML = "";

        if (selectedType) {
          // 1. الأبعاد
          const dimensionsGroup = document.createElement("div");
          dimensionsGroup.className = "form-group";
          const dimOptions = productDimensions[selectedType] || ["أبعاد مخصصة"];

          if (dimOptions.length > 1) {
            dimensionsGroup.innerHTML = `
                     <label for="dimensions"><span class="required-field">*</span> الأبعاد المقترحة</label>
                     <select id="dimensions" name="dimensions" required>
                         ${dimOptions
                           .map(
                             (dim) => `<option value="${dim}">${dim}</option>`
                           )
                           .join("")}
                     </select>`;
          } else {
            dimensionsGroup.innerHTML = `
                     <label for="dimensions"><span class="required-field">*</span> الأبعاد (مثال: 120x80x45 سم)</label>
                     <input type="text" id="dimensions" name="dimensions" placeholder="أدخل الطولxالعرضxالارتفاع" required />`;
          }
          dynamicFieldsContainer.appendChild(dimensionsGroup);

          // 2. اللون (اعتماداً على مواد التشطيب)
          const colorsGroup = document.createElement("div");
          colorsGroup.className = "form-group";

          const paintMaterials = allRawMaterials.filter(
            (m) => m.type === "تشطيب" && m.name_ar.includes("طلاء")
          );

          colorsGroup.innerHTML = `
                 <label for="color">اللون المفضّل</label>
                 <select id="color" name="color">
                     <option value="بني طبيعي">بني طبيعي (بدون طلاء)</option>
                     ${paintMaterials
                       .map(
                         (m) =>
                           `<option value="${m.name_ar}">${
                             m.name_ar
                           } (متوفر: ${m.current_stock.toFixed(2)} ${
                             m.unit
                           })</option>`
                       )
                       .join("")}
                 </select>`;
          dynamicFieldsContainer.appendChild(colorsGroup);
        }
      }

      // وظيفة إضافة صف لإدخال مادة خام
      function addResourceInputRow(isDefault = false) {
        if (!isDefault && allRawMaterials.length === 0) {
          showToast(
            "يرجى الانتظار حتى يتم تحميل قائمة المواد الخام أولاً.",
            true
          );
          return;
        }

        const div = document.createElement("div");
        div.className = "resource-input-row";

        // بناء خيارات المواد الخام
        const materialOptions = allRawMaterials
          .map((m) => {
            const isLow = m.current_stock <= m.reorder_point;
            return `<option value="${m.id}" 
                            data-unit="${m.unit}" 
                            data-cost="${m.cost_per_unit}"
                            data-stock="${m.current_stock}"
                            ${isLow ? 'style="color: red;"' : ""}>
                ${m.name_ar} (${m.unit}) [متوفر: ${m.current_stock.toFixed(2)}]
            </option>`;
          })
          .join("");

        div.innerHTML = `
            <select name="resource_id" required>
                <option value="">-- اختر المادة الخام --</option>
                ${materialOptions}
            </select>
            <input type="number" name="quantity" min="0.01" step="0.01" required placeholder="الكمية المطلوبة" />
            <div>
                <input type="text" name="unit_display" disabled placeholder="الوحدة" />
                <span class="low-stock-warning" style="display: none;"></span>
            </div>
            <button type="button" class="btn-remove-resource"><i class="fa-solid fa-trash-alt"></i></button>
        `;

        resourceInputList.appendChild(div);

        // تحديث الوحدة وتحذير المخزون ومجموع التكلفة
        const select = div.querySelector('select[name="resource_id"]');
        const quantityInput = div.querySelector('input[name="quantity"]');
        const unitInput = div.querySelector('input[name="unit_display"]');
        const stockWarning = div.querySelector(".low-stock-warning");

        const updateRow = () => {
          const selectedOption = select.options[select.selectedIndex];
          const stock = parseFloat(selectedOption.dataset.stock) || 0;
          const quantity = parseFloat(quantityInput.value) || 0;

          unitInput.value = selectedOption.dataset.unit || "";

          // تحديث تحذير المخزون
          if (stock <= 10 && select.value) {
            stockWarning.textContent = `⚠️ المخزون منخفض: ${stock.toFixed(2)} ${
              selectedOption.dataset.unit
            }`;
            stockWarning.style.display = "block";
          } else {
            stockWarning.style.display = "none";
          }

          // التحقق من الكمية المدخلة مقابل المخزون
          if (quantity > stock && select.value) {
            showToast(
              `الكمية المطلوبة (${quantity}) تتجاوز المخزون المتوفر!`,
              true
            );
            quantityInput.style.borderColor = "red";
          } else {
            quantityInput.style.borderColor = ""; // استخدام CSS الافتراضي
          }

          updateResourceCostSummary();
        };

        select.addEventListener("change", updateRow);
        quantityInput.addEventListener("input", updateRow);

        // إزالة الصف
        div
          .querySelector(".btn-remove-resource")
          .addEventListener("click", () => {
            div.remove();
            updateResourceCostSummary(); // تحديث التكلفة بعد الحذف
          });

        updateRow(); // تحديث أولي
      }

      // ====================================================================
      // منطق النموذج متعدد المراحل
      // ====================================================================

      function validateStep(step) {
        const currentStepElement = document.querySelector(
          `[data-step="${step}"]`
        );
        const requiredInputs =
          currentStepElement.querySelectorAll("[required]");
        let isValid = true;

        requiredInputs.forEach((input) => {
          if (!input.value) {
            input.style.borderColor = "red";
            isValid = false;
          } else {
            input.style.borderColor = "";
          }
        });

        // تحقق خاص للموارد (الخطوة 2)
        if (step === 2) {
          const resourceRows = resourceInputList.querySelectorAll(
            ".resource-input-row"
          );
          if (resourceRows.length === 0) {
            showToast("الرجاء إضافة مادة خام واحدة على الأقل.", true);
            isValid = false;
          }
        }

        return isValid;
      }

      function updateStepVisibility() {
        formSteps.forEach((step) => step.classList.remove("active"));
        document
          .querySelector(`[data-step="${currentStep}"]`)
          .classList.add("active");

        const totalSteps = formSteps.length;
        progressBarFill.style.width = `${(currentStep / totalSteps) * 100}%`;

        // تحديث أزرار التنقل
        prevStepBtn.style.display = currentStep > 1 ? "block" : "none";

        if (currentStep < totalSteps) {
          nextStepBtn.style.display = "block";
          submitFormBtn.style.display = "none";
        } else {
          nextStepBtn.style.display = "none";
          submitFormBtn.style.display = "block";
          // تحقق من المتطلبات النهائية لتفعيل زر الإرسال
          updateResourceCostSummary();
        }
      }

      nextStepBtn.addEventListener("click", () => {
        if (validateStep(currentStep)) {
          currentStep++;
          updateStepVisibility();
        } else {
          showToast("الرجاء ملء جميع الحقول المطلوبة في هذه الخطوة.", true);
        }
      });

      prevStepBtn.addEventListener("click", () => {
        currentStep--;
        updateStepVisibility();
      });

      // ====================================================================
      // منطق الإرسال (Submit) يبقى كما هو مع تعديل بسيط
      // ====================================================================

      // ... (بقية منطق الإرسال designForm.addEventListener و designCheckoutForm.addEventListener) ...

      // ====================================================================
      // بدء التنفيذ
      // ====================================================================
      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        updateCartBadge();

        fetchFirebaseData();

        onAuthStateChanged(auth, (user) => {
          currentUser = user;
        });

        // ربط الأحداث المتبقية
        productTypeSelect.addEventListener("change", updateDynamicFields);

        // ... (بقية الـ Event Listeners من الكود الأصلي) ...
        // (تم دمج منطق submitFormBtn و nextStepBtn و prevStepBtn في الدوال أعلاه)
      });

      // ... (يجب إضافة بقية الدوال المساعدة مثل showSuggestedProduct, closeDesignConfirmModal, openProductModal) ...
      // نظرًا لكونها طويلة وغير متغيرة في هذا الطلب، سنفترض وجودها لتركيز على الـ Form.

      // ********* مثال مبسط لدالة واحدة متبقية *********
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      // **********************************************
    </script>
  </body>
</html>
