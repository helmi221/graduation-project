<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | ุตูู ููุชุฌู</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .loading-bar-container {
        display: none;
        width: 100%;
        background-color: #eee;
        border-radius: 4px;
        margin-top: 20px;
      }
      .loading-bar {
        width: 0%;
        height: 10px;
        background-color: var(--primary-color);
        border-radius: 4px;
        animation: loading-anim 2s infinite linear;
      }
      @keyframes loading-anim {
        0% {
          width: 0%;
        }
        50% {
          width: 100%;
        }
        100% {
          width: 0%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">FurnAI</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a>
            </li>
            <li>
              <a href="products.html" class="nav-link">ููุชุฌุงุชูุง</a>
            </li>
            <li><a href="order-status.html" class="nav-link">ุญุงูุฉ ุงูุทูุจ</a></li>
            <li>
              <a href="recommendation.html" class="nav-link">ุงููุฌุงุฑ ุงูุฐูู</a>
            </li>
            <li>
              <a href="design.html" class="nav-link active">ุตูู ููุชุฌู</a>
            </li>
          </ul>

          <div class="auth-nav">
            <a href="cart.html" class="cart-icon-wrapper">
              <i class="fa-solid fa-bag-shopping" id="cart-icon"></i>
              <span id="cart-count-badge">0</span>
            </a>
            <div class="profile-dropdown" id="profile-dropdown">
              <div class="profile-icon">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="dropdown-menu">
                <div class="dropdown-header">
                  <span id="user-display-name">ูุฑุญุจุงู ุจู</span>
                  <p id="user-email">ุฒุงุฆุฑ</p>
                </div>
                <a href="login.html" id="auth-link">ุชุณุฌูู ุงูุฏุฎูู</a>
                <a href="#" id="logout-link" style="display: none"
                  >ุชุณุฌูู ุงูุฎุฑูุฌ</a
                >
              </div>
            </div>
          </div>

          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a>
      <a href="products.html" class="nav-link">ููุชุฌุงุชูุง</a>
      <a href="order-status.html" class="nav-link">ุญุงูุฉ ุงูุทูุจ</a>
      <a href="recommendation.html" class="nav-link">ุงููุฌุงุฑ ุงูุฐูู</a>
      <a href="design.html" class="nav-link">ุตูู ููุชุฌู</a>
    </div>

    <main>
      <section class="section container design-page-section">
        <div class="section-title-wrapper" style="margin-bottom: 1rem">
          <h2>ุตูู ููุชุฌู ุงูุฎุงุต</h2>
        </div>
        <p style="text-align: center; color: #777; margin-bottom: 1.5rem">
          ุตู ููุง ููุฑุชู ูู ุฎุทูุงุช ุจุณูุทุฉ ูุณูููู ุจุชุญููููุง ุฅูู ุชุตููู ููุชุฑุญ.
        </p>

        <form id="design-form" class="design-form">
          <div class="form-step active" data-step="1">
            <div class="form-group">
              <label for="product-type"
                ><span class="required-field">*</span> ููุน ุงูููุชุฌ ุงููุทููุจ</label
              >
              <select id="product-type" name="product-type" required>
                <option value="">-- ุงุฎุชุฑ ููุน ุงูููุชุฌ --</option>
                <option value="ุทุงููุฉ ุณูุฑุฉ">ุทุงููุฉ ุณูุฑุฉ</option>
                <option value="ูุฑุณู">ูุฑุณู</option>
                <option value="ุทูู ููุจ">ุทูู ููุจ</option>
                <option value="ุบุฑูุฉ ููู">ุบุฑูุฉ ููู</option>
                <option value="ูุทุจุฎ">ูุทุจุฎ</option>
                <option value="ุทุงููุฉ ูุณุท">ุทุงููุฉ ูุณุท</option>
                <option value="ุฎุฒุงูุฉ">ุฎุฒุงูุฉ</option>
                <option value="ุทุงููุฉ ุชููุงุฒ">ุทุงููุฉ ุชููุงุฒ</option>
                <option value="ุขุฎุฑ">ุขุฎุฑ...</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dimensions"
                  ><span class="required-field">*</span> ุงูููุงุณุงุช
                  ุงูุชูุฑูุจูุฉ</label
                >
                <select id="dimensions" name="dimensions" required>
                  <option value="">-- ุงุฎุชุฑ ููุน ุงูููุชุฌ ุฃููุงู --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="room-placement"
                  ><span class="required-field">*</span> ููุงู ูุถุน ุงูููุชุฌ</label
                >
                <select id="room-placement" name="room-placement" required>
                  <option value="">-- ุงุฎุชุฑ ููุน ุงูููุชุฌ ุฃููุงู --</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="material"
                  ><span class="required-field">*</span> ุงููุงุฏุฉ ุงูุฑุฆูุณูุฉ ุงูููุถูุฉ
                  (ููุน ุงูุฎุดุจ)</label
                >
                <select id="material" name="material" required>
                  <option value="">-- ุฌุงุฑู ุงูุชุญููู --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="color"
                  ><span class="required-field">*</span> ุงูููู ูุงูุชุดุทูุจ
                  ุงูููุถูู</label
                >
                <select id="color" name="color" required>
                  <option value="">-- ุฌุงุฑู ุงูุชุญููู --</option>
                </select>
              </div>
            </div>

            <div id="material-preview-container">
              <div class="preview-card">
                <label>ูุนุงููุฉ ุงูุฎุดุจ (ุงูุชูุณุชุดุฑ)</label>
                <div id="preview-material-box" class="preview-box"></div>
                <p id="material-label">ุงูุฎุดุจ: ูู ููุฎุชุฑ</p>
              </div>
              <div class="preview-card">
                <label>ูุนุงููุฉ ุงูููู</label>
                <div id="preview-color-box" class="preview-box"></div>
                <p id="color-label">ุงูููู: ูู ููุฎุชุฑ</p>
              </div>
            </div>

            <h3
              style="
                margin-top: 1.5rem;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
              "
            >
              <i class="fa-solid fa-layer-group"></i> ุฅุถุงูุงุช ูุชูุงุตูู ูููุฒุฉ
            </h3>
            <div class="form-row" style="grid-template-columns: 3fr 1fr">
              <div class="form-group" style="margin-bottom: 0">
                <label
                  for="addon-input"
                  style="font-size: 1rem; margin-bottom: 0"
                  >ุฃุถู ููุฒุฉ (ูุซู: ุฃุฏุฑุงุฌ ูุฎููุฉุ ุญุงูู ุฃููุงุจุ ุฅุถุงุกุฉ)</label
                >
                <input
                  type="text"
                  id="addon-input"
                  placeholder="ุงูุชุจ ุงูููุฒุฉ ููุง..."
                />
              </div>
              <div class="form-group" style="align-self: end; margin-bottom: 0">
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  id="add-addon-btn"
                  style="
                    background: var(--accent-color);
                    color: var(--dark-color);
                  "
                >
                  <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
                </button>
              </div>
            </div>

            <div class="form-group">
              <ul id="addons-list">
                <li style="text-align: center; color: #777">
                  ูุง ุชูุฌุฏ ุฅุถุงูุงุช ุจุนุฏ
                </li>
              </ul>
            </div>

            <div class="form-group" id="notes-group">
              <label for="notes"
                ><span class="required-field">*</span> ูุตู ููุฑุชู ูุชูุงุตูู
                ุงูุชุตููู</label
              >
              <textarea
                id="notes"
                name="notes"
                rows="4"
                required
                placeholder="ูุซุงู: ุฃุญุชุงุฌ ุทุงููุฉ ุทุนุงู ุจููุท ุฑูููุ ุงูููุฒุงููุฉ 3000-4000 ุดูููุ ุฃุฑูุฏ ุฃุฏุฑุงุฌุงู ูุฎููุฉ."
              ></textarea>
            </div>
          </div>

          <button type="submit" class="btn" id="submit-form-btn">
            <i class="fa-solid fa-robot"></i> ุงูุชุฑุงุญ ุชุตููู
          </button>
        </form>

        <div id="processing-message" class="loading-bar-container">
          <div class="loading-bar"></div>
          <p
            style="
              text-align: center;
              font-weight: bold;
              padding-top: 5px;
              color: var(--dark-color);
            "
          >
            ุฌุงุฑู ูุนุงูุฌุฉ ุทูุจู...
          </p>
        </div>

        <div
          id="design-result"
          class="design-result-section"
          style="display: none"
        >
          <h2 style="margin-bottom: 1.5rem">ุงูุชุฑุงุญูุง ูู</h2>
          <div class="design-result-text" id="result-content"></div>
          <div class="design-result-actions">
            <button class="btn" id="submit-design-btn">
              <i class="fa-solid fa-cart-plus"></i> ุฃุถู ุฅูู ุงูุณูุฉ ูููุฑุงุฌุนุฉ
            </button>
            <button class="btn btn-secondary" id="regenerate-design-btn">
              ุงูุชุฑุงุญ ุขุฎุฑ
            </button>
          </div>
          <div
            style="
              margin-top: 2rem;
              text-align: center;
              font-size: 0.9rem;
              color: #888;
            "
          >
            <p>
              ุงูุณุนุฑ ุงููุนุฑูุถ ูู ูุทุงู ุฃููู ููุชุฑุญ. ุณูุชู ุชุฃููุฏู ุจุนุฏ ูุฑุงุฌุนุฉ ุงููุฑูู.
              ููููู ุงูุขู ุฅุถุงูุชู ุฅูู ุงูุณูุฉ ูุฅููุงู ุทูุจู.
            </p>
          </div>
        </div>
      </section>
    </main>

    <div id="design-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-confirm">&times;</span>
        <div class="confirm-icon">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <h2>ุดูุฑุงู ูู!</h2>
        <p>
          ุชู ุงุณุชูุงู ุทูุจู ููุชุตููู ุงููุฎุตุต ุจูุฌุงุญ. ุณูููู ุจูุฑุงุฌุนุชู ูุงูุฑุฏ ุนููู ุฎูุงู
          ูููู ุนูู.
        </p>
        <p>ุฑูุฒ ุงูุชุชุจุน ุงูุฎุงุต ุจุทูุจู ูู:</p>
        <span id="design-tracking-id" class="tracking-id-display"></span>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          ุงูุฑุฌุงุก ุญูุธ ูุฐุง ุงูุฑูุฒ ูุชุชููู ูู ูุชุงุจุนุฉ ุญุงูุฉ ุทูุจู ููุจูู ุฃู ุฑูุถ ุงูุณุนุฑ
          ุงูููุงุฆู.
        </p>
      </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <div id="design-checkout-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 550px">
        <span class="modal-close" data-modal="design-checkout">&times;</span>
        <div class="modal-body" style="padding: 20px 30px">
          <div class="checkout-form-container">
            <h2>ุฅุฑุณุงู ุทูุจ ุงูุชุตููู</h2>
            <p>
              ุงูุฑุฌุงุก ุฅุฏุฎุงู ุจูุงูุงุชู ูุฅุฑุณุงู ุทูุจ ุงูุชุตููู. ุณูุชู ุงูุชูุงุตู ูุนู
              ููุฑุงุฌุนุชู.
            </p>
            <form id="design-checkout-form">
              <div class="form-group">
                <label for="design-name">ุงูุงุณู ุงููุงูู</label>
                <input type="text" id="design-name" name="name" required />
              </div>
              <div class="form-group">
                <label for="design-phone">ุฑูู ุงููุงุชู</label>
                <input type="tel" id="design-phone" name="phone" required />
              </div>
              <div class="form-group">
                <label for="design-email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ุงุฎุชูุงุฑู)</label>
                <input type="email" id="design-email" name="email" />
              </div>
              <div class="form-group">
                <label for="design-address">ุงูุนููุงู</label>
                <textarea
                  id="design-address"
                  name="address"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn" id="confirm-design-btn">
                ุชุฃููุฏ ุทูุจ ุงูุชุตููู
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container footer-content">
        <div class="footer-col">
          <a href="index.html" class="footer-logo">FurnAI</a>
          <p>ูุตูุน ุฃุซุงุซุงู ูุฑูู ูุตุฉุ ูุตูู ููุจุนุซ ุงูุฏูุก ูุงูุฃูุงูุฉ ูู ุฃุฑุฌุงุก ููุฒูู.</p>
        </div>
        <div class="footer-col">
          <h4>ุฑูุงุจุท ุณุฑูุนุฉ</h4>
          <ul class="footer-links">
            <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
            <li><a href="products.html">ููุชุฌุงุชูุง</a></li>
            <li><a href="design.html">ุตูู ููุชุฌู</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h4>ุฎุฏูุฉ ุงูุนููุงุก</h4>
          <ul class="footer-links">
            <li><a href="order-status.html">ุชุชุจุน ุทูุจู</a></li>
            <li><a href="recommendation.html">ุงููุฌุงุฑ ุงูุฐูู</a></li>
            <li><a href="#">ุชูุงุตู ูุนูุง</a></li>
          </ul>
        </div>
      </div>
      <div class="copyright">&copy; 2025 ุฌููุน ุงูุญููู ูุญููุธุฉ.</div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // (ุฅุนุฏุงุฏุงุช Firebase ู Gemini ููุง ูู)
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const textModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // (ูุชุบูุฑุงุช ูุนูุงุตุฑ ุงููุงุฌูุฉ ููุง ูู)
      let allProducts = [];
      let allRawMaterials = [];
      let currentUser = null;
      let currentDesign = null;
      let currentAddons = [];

      const userDisplayName = document.getElementById("user-display-name");
      const userEmail = document.getElementById("user-email");
      const authLink = document.getElementById("auth-link");
      const logoutLink = document.getElementById("logout-link");
      const menuToggle = document.getElementById("menu-toggle");
      const mobileMenu = document.getElementById("mobile-menu");

      const colorFileMap = {
        ุฃุจูุถ: "white.png",
        ุฃุณูุฏ: "black.png",
        "ุฑูุงุฏู ูุงุชุญ": "gray.png",
        "ุฃุฒุฑู ูููู": "blue.png",
        "ุฃุฎุถุฑ ุฒูุฑุฏู": "green.png",
        "ุจูุฌ ูุทูู": "offwhite.png",
        "ุจูู ุบุงูู": "braw.png",
        "ุฃุญูุฑ ุณุงุทุน": "red.png",
        "ุจูู ุทุจูุนู": "normal.png",
      };
      const woodTextureMap = {
        "ุฎุดุจ ุฒุงู": "wood/Beech Wood.jpg",
        "ุฎุดุจ ุจููุท": "wood/Oak Wood.webp",
        "ุฎุดุจ ุณูุฏูุงู": "wood/white-oak.jpg",
        "ุฎุดุจ ุฌูุฒ": "wood/Walnut Wood.webp",
        "ุฎุดุจ ุตููุจุฑ": "wood/Pine Wood.webp",
        "ุฎุดุจ ุตูุฑ": "colers/braw.png",
      };
      const standardColors = [
        "ุฃุจูุถ",
        "ุฃุณูุฏ",
        "ุฑูุงุฏู ูุงุชุญ",
        "ุฃุฒุฑู ูููู",
        "ุฃุฎุถุฑ ุฒูุฑุฏู",
        "ุจูุฌ ูุทูู",
        "ุจูู ุบุงูู",
        "ุฃุญูุฑ ุณุงุทุน",
      ];
      const productDimensions = {
        "ุทุงููุฉ ุณูุฑุฉ": [
          "ููุงุณ ุตุบูุฑ (2-4 ุฃุดุฎุงุต)",
          "ููุงุณ ูุชูุณุท (4-6 ุฃุดุฎุงุต)",
          "ููุงุณ ูุจูุฑ (6-8 ุฃุดุฎุงุต)",
        ],
        ูุฑุณู: ["ููุงุณ ููุงุณู", "ููุงุณ ูุจูุฑ ููุฑูุญ"],
        "ุทูู ููุจ": ["ููุนุฏูู", "ุซูุงุซุฉ ููุงุนุฏ", "ููุจุฉ ุฒุงููุฉ (ุญุฑู L)"],
        "ุบุฑูุฉ ููู": ["ุณุฑูุฑ ูุฒุฏูุฌ ููุงุณู", "ุณุฑูุฑ ููุฑุฏ", "ูุฌููุนุฉ ุชุณุฑูุญุฉ ูุฎุฒุงูุฉ"],
        ูุทุจุฎ: ["ูุญุฏุฉ ุนูููุฉ ููุงุณูุฉ", "ูุญุฏุฉ ุณูููุฉ ููุงุณูุฉ", "ุฌุฒูุฑุฉ ูุทุจุฎ"],
        "ุทุงููุฉ ูุณุท": ["ููุงุณ ููุงุณู (ุตุบูุฑุฉ)", "ููุงุณ ูุจูุฑ"],
        ุฎุฒุงูุฉ: [
          "ุตุบูุฑุฉ (ุจุงุจูู)",
          "ูุชูุณุทุฉ (3-4 ุฃุจูุงุจ)",
          "ูุจูุฑุฉ (ุฃูุซุฑ ูู 4 ุฃุจูุงุจ)",
        ],
        "ุทุงููุฉ ุชููุงุฒ": ["ุตุบูุฑุฉ (ุฃูู ูู 120 ุณู)", "ูุจูุฑุฉ (ุฃูุซุฑ ูู 150 ุณู)"],
        ุขุฎุฑ: ["ููุงุณ ุตุบูุฑ", "ููุงุณ ูุชูุณุท", "ููุงุณ ูุจูุฑ"],
      };

      // ๐ก (ุฌุฏูุฏ) ูุงุฆูุฉ ุงูุฃูุงูู ุงูุฑุฆูุณูุฉ
      const allPlacements = [
        "ุบุฑูุฉ ุงููุนูุดุฉ",
        "ุบุฑูุฉ ุงูุทุนุงู",
        "ุบุฑูุฉ ุงูููู",
        "ุงููุทุจุฎ",
        "ุงูููุชุจ",
        "ุบุฑูุฉ ุงูุฃุทูุงู",
        "ุฎุงุฑุฌู",
      ];
      // ๐ก (ุฌุฏูุฏ) ุฎุฑูุทุฉ ุฑุจุท ุงูููุชุฌ ุจุงูููุงู
      const productPlacementMap = {
        "ุทุงููุฉ ุณูุฑุฉ": ["ุบุฑูุฉ ุงูุทุนุงู", "ุบุฑูุฉ ุงููุนูุดุฉ", "ุงููุทุจุฎ"],
        ูุฑุณู: allPlacements, // ุงููุฑุณู ูููู ุฃู ูููู ูู ุฃู ููุงู
        "ุทูู ููุจ": ["ุบุฑูุฉ ุงููุนูุดุฉ", "ุงูููุชุจ"],
        "ุบุฑูุฉ ููู": ["ุบุฑูุฉ ุงูููู"],
        ูุทุจุฎ: ["ุงููุทุจุฎ"],
        "ุทุงููุฉ ูุณุท": ["ุบุฑูุฉ ุงููุนูุดุฉ"],
        ุฎุฒุงูุฉ: ["ุบุฑูุฉ ุงูููู", "ุบุฑูุฉ ุงููุนูุดุฉ", "ุงูููุชุจ", "ุบุฑูุฉ ุงูุฃุทูุงู"],
        "ุทุงููุฉ ุชููุงุฒ": ["ุบุฑูุฉ ุงููุนูุดุฉ"],
        ุขุฎุฑ: allPlacements,
      };

      const productTypeSelect = document.getElementById("product-type");
      const colorSelect = document.getElementById("color");
      const materialSelect = document.getElementById("material");
      const dimensionsSelect = document.getElementById("dimensions");
      const toast = document.getElementById("toast-notification");
      const processMessage = document.getElementById("processing-message");
      const designResultSection = document.getElementById("design-result");
      const designForm = document.getElementById("design-form");
      const previewMaterialBox = document.getElementById(
        "preview-material-box"
      );
      const previewColorBox = document.getElementById("preview-color-box");
      const materialLabel = document.getElementById("material-label");
      const colorLabel = document.getElementById("color-label");
      const addonInput = document.getElementById("addon-input");
      const addAddonBtn = document.getElementById("add-addon-btn");
      const addonsList = document.getElementById("addons-list");

      // (ุจููุฉ ุฏูุงู ุงูุฌุงูุงุณูุฑุจุช ููุง ูู)
      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.className = `toast show ${isError ? "error" : "success"}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function loadCartAndUpdateBadge() {
        const storedCart = localStorage.getItem("shoppingCart") || "[]";
        const cart = JSON.parse(storedCart);
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (cartCountBadge) {
          const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          cartCountBadge.textContent = totalItems;
          cartCountBadge.classList.toggle("visible", totalItems > 0);
        }
        return cart;
      }

      function saveCart(cart) {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        loadCartAndUpdateBadge();
      }

      async function initializeData() {
        processMessage.style.display = "block";
        try {
          const [productsSnapshot, materialsSnapshot] = await Promise.all([
            getDocs(collection(db, "products")),
            getDocs(collection(db, "raw_materials")),
          ]);

          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          allRawMaterials = materialsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0),
            reorder_point: parseFloat(doc.data().reorder_point || 0),
            type: doc.data().type || "ุฃุฎุฑู",
            name_ar: doc.data().name_ar,
          }));

          fillDropdowns();
        } catch (e) {
          console.error("Initialization Error: ", e);
          showToast("โ ูุดู ุชุญููู ุจูุงูุงุช ุงููุฎุฒูู. ูุฑุฌู ูุฑุงุฌุนุฉ Firebase.", true);
          designForm.style.opacity = 0.5;
        } finally {
          processMessage.style.display = "none";
        }
      }

      function fillMaterialsDropdown() {
        const woodMaterials = allRawMaterials.filter((m) => m.type === "ุฎุดุจ");
        let materialOptions = '<option value="">-- ุงุฎุชุฑ ูุงุฏุฉ --</option>';

        woodMaterials.forEach((m) => {
          const isLowStock =
            m.current_stock > 0 && m.current_stock <= m.reorder_point;
          const isOutOfStock = m.current_stock <= 0;

          let disabledAttr = "";
          let availabilityText = "";
          let customClass = "";

          if (isOutOfStock) {
            disabledAttr = "disabled";
            availabilityText = " (ููุฐ ุงููุฎุฒูู)";
          } else if (isLowStock) {
            disabledAttr = "disabled";
            availabilityText = " (ูุฎุฒูู ููุฎูุถ - ูุฑุฌู ุงูุงูุชุธุงุฑ)";
            customClass = "low-stock-option";
          }

          materialOptions += `<option value="${m.name_ar}" ${disabledAttr} class="${customClass}">${m.name_ar}${availabilityText}</option>`;
        });
        materialSelect.innerHTML = materialOptions;
      }

      // ๐ก (ูุนุฏู) ุฏุงูุฉ ุชุนุจุฆุฉ ุงูููุงุฆู ุงูููุณุฏูุฉ
      function fillDropdowns() {
        fillMaterialsDropdown();
        let colorOptions = `<option value="">-- ุงุฎุชุฑ ููู --</option>`;
        colorOptions += `<option value="ุจูู ุทุจูุนู (ูุฑููุด)">ุจูู ุทุจูุนู (ูุฑููุด/normal)</option>`;
        standardColors.forEach((color) => {
          const colorName = color.trim();
          if (colorFileMap[colorName]) {
            colorOptions += `<option value="${colorName} (ุฏูุงู)">${colorName} (ุฏูุงู)</option>`;
          }
        });
        colorSelect.innerHTML = colorOptions;

        // ุฑุจุท ุงูุฃุญุฏุงุซ
        productTypeSelect.addEventListener("change", updateDimensionsOptions);
        productTypeSelect.addEventListener("change", updatePlacementOptions); // ๐ก (ุฌุฏูุฏ) ุฑุจุท ุฏุงูุฉ ุงูุฃูุงูู
        materialSelect.addEventListener("change", updateMaterialPreview);
        colorSelect.addEventListener("change", updateMaterialPreview);

        // ุชุญุฏูุซ ุงูุญุงูุฉ ุงูุฃูููุฉ
        updateDimensionsOptions();
        updatePlacementOptions(); // ๐ก (ุฌุฏูุฏ) ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุฃูุงูู
        updateMaterialPreview();
      }

      function updateDimensionsOptions() {
        const selectedType = productTypeSelect.value;
        const options =
          productDimensions[selectedType] || productDimensions["ุขุฎุฑ"];

        let optionsHTML = `<option value="">-- ุงุฎุชุฑ ููุงุณุงู ุชูุฑูุจูุงู --</option>`;

        if (selectedType === "") {
          optionsHTML = `<option value="">-- ุงุฎุชุฑ ููุน ุงูููุชุฌ ุฃููุงู --</option>`;
          dimensionsSelect.disabled = true;
        } else {
          options.forEach((dim) => {
            optionsHTML += `<option value="${dim}">${dim}</option>`;
          });
          dimensionsSelect.disabled = false;
        }
        dimensionsSelect.innerHTML = optionsHTML;
      }

      // ๐ก (ุฌุฏูุฏ) ุฏุงูุฉ ุชุญุฏูุซ ุฃูุงูู ุงูููุชุฌ
      function updatePlacementOptions() {
        const selectedType = productTypeSelect.value;
        const placementSelect = document.getElementById("room-placement");
        const options = productPlacementMap[selectedType] || allPlacements;

        let optionsHTML = `<option value="">-- ุงุฎุชุฑ ุงูููุงู --</option>`;

        if (selectedType === "") {
          optionsHTML = `<option value="">-- ุงุฎุชุฑ ููุน ุงูููุชุฌ ุฃููุงู --</option>`;
          placementSelect.disabled = true;
        } else {
          options.forEach((placement) => {
            optionsHTML += `<option value="${placement}">${placement}</option>`;
          });
          placementSelect.disabled = false;
        }
        placementSelect.innerHTML = optionsHTML;
      }

      function updateMaterialPreview() {
        // (ุงูุฏุงูุฉ ููุง ูู - ูู ุชุชุบูุฑ)
        const selectedMaterial = materialSelect.value.trim();
        const selectedColorOption = colorSelect.value.split("(")[0].trim();
        const woodTexturePath = woodTextureMap[selectedMaterial];

        if (woodTexturePath) {
          previewMaterialBox.style.backgroundImage = `url('${woodTexturePath}')`;
          previewMaterialBox.style.backgroundColor = "transparent";
          materialLabel.textContent = `ุงูุฎุดุจ: ${selectedMaterial}`;
        } else if (selectedMaterial) {
          previewMaterialBox.style.backgroundImage = `url('colers/braw.png')`;
          previewMaterialBox.style.backgroundColor = "transparent";
          materialLabel.textContent = `ุงูุฎุดุจ: ${selectedMaterial}`;
        } else {
          previewMaterialBox.style.backgroundImage = "none";
          previewMaterialBox.style.backgroundColor = "var(--light-color)";
          materialLabel.textContent = "ุงูุฎุดุจ: ูู ููุฎุชุฑ";
        }

        if (selectedColorOption) {
          const fileName = colorFileMap[selectedColorOption];
          if (fileName) {
            previewColorBox.style.backgroundImage = `url('colers/${fileName}')`;
            previewColorBox.style.backgroundColor = "transparent";
          } else {
            previewColorBox.style.backgroundImage = "none";
            previewColorBox.style.backgroundColor = "var(--white-color)";
          }
          colorLabel.textContent = `ุงูููู: ${selectedColorOption}`;
        } else {
          previewColorBox.style.backgroundImage = "none";
          previewColorBox.style.backgroundColor = "var(--white-color)";
          colorLabel.textContent = "ุงูููู: ูู ููุฎุชุฑ";
        }
      }

      function calculateEstimatedCost(
        materialName,
        color,
        productType,
        addons
      ) {
        // (ุงูุฏุงูุฉ ููุง ูู - ูู ุชุชุบูุฑ)
        let baseCost = 0;
        let woodVolumeFactor = 1;
        let paintVolumeFactor = 1;
        let accessoryCost = 150;

        const woodMaterial = allRawMaterials.find(
          (m) => m.name_ar === materialName && m.type === "ุฎุดุจ"
        );
        const paintMaterial = allRawMaterials.find((m) =>
          m.type.includes("ุทูุงุก")
        );
        const varnishMaterial = allRawMaterials.find((m) =>
          m.name_ar.includes("ูุฑููุด")
        );

        if (productType.includes("ุทุงููุฉ")) woodVolumeFactor = 0.75;
        else if (productType.includes("ููุจ")) woodVolumeFactor = 1.0;
        else if (productType.includes("ุฎุฒุงูุฉ")) woodVolumeFactor = 1.2;
        else woodVolumeFactor = 0.5;

        if (woodMaterial) {
          baseCost += (woodMaterial.cost_per_unit || 0) * woodVolumeFactor;
        } else {
          baseCost += 1500 * woodVolumeFactor;
        }

        if (color.includes("ูุฑููุด") && varnishMaterial) {
          baseCost +=
            (varnishMaterial.cost_per_unit || 200) * paintVolumeFactor;
        } else if (paintMaterial) {
          baseCost += (paintMaterial.cost_per_unit || 500) * paintVolumeFactor;
        } else {
          baseCost += 300;
        }

        baseCost += accessoryCost;
        baseCost += addons.length * 100;
        return Math.round(baseCost);
      }

      function addToCartAsCustom(design) {
        // (ุงูุฏุงูุฉ ููุง ูู - ูู ุชุชุบูุฑ)
        let cart = loadCartAndUpdateBadge();
        const tempId = `CUSTOM-${Date.now()}`;
        const newItem = {
          id: tempId,
          name: design.title,
          price: design.price_value,
          quantity: 1,
          isCustom: true,
          details: {
            type: design.type,
            dimensions: design.dimensions,
            material: design.material,
            color: design.color,
            notes: design.notes,
            addons: design.addons,
            estimatedCOGS: design.estimatedCOGS,
            description: design.description,
            initial_price: design.price_value,
            price_range: design.price_range,
            title: design.title,
          },
        };
        cart.push(newItem);
        saveCart(cart);
        showToast(`โ ุชูุช ุฅุถุงูุฉ ุงูุชุตููู (${design.title}) ุฅูู ุงูุณูุฉ ูููุฑุงุฌุนุฉ!`);
      }

      function renderAddonsList() {
        // (ุงูุฏุงูุฉ ููุง ูู - ูู ุชุชุบูุฑ)
        addonsList.innerHTML = "";
        if (currentAddons.length === 0) {
          addonsList.innerHTML =
            '<li style="text-align: center; color: #777;">ูุง ุชูุฌุฏ ุฅุถุงูุงุช ุจุนุฏ</li>';
          return;
        }
        currentAddons.forEach((addon, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
                  <span>${addon}</span>
                  <button type="button" class="btn-danger btn-sm" data-index="${index}" style="background: none; border: none; color: var(--danger-color); font-size: 1.2rem; cursor: pointer;">
                      &times;
                  </button>
              `;
          addonsList.appendChild(li);
        });
        document.querySelectorAll("#addons-list button").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            currentAddons.splice(index, 1);
            renderAddonsList();
            updateNotesWithAddons();
          });
        });
        updateNotesWithAddons();
      }

      function updateNotesWithAddons() {
        // (ุงูุฏุงูุฉ ููุง ูู - ูู ุชุชุบูุฑ)
        const notesTextarea = document.getElementById("notes");
        let currentNotes = notesTextarea.value.split("\n");
        currentNotes = currentNotes.filter(
          (line) => !line.startsWith("ุงูุฅุถุงูุงุช ุงููุทููุจุฉ:")
        );
        if (currentAddons.length > 0) {
          const addonsString = `ุงูุฅุถุงูุงุช ุงููุทููุจุฉ: ${currentAddons.join("ุ ")}`;
          currentNotes.push(addonsString);
        }
        notesTextarea.value = currentNotes
          .filter((line) => line.trim() !== "")
          .join("\n");
      }

      addAddonBtn.addEventListener("click", () => {
        // (ุงูุฏุงูุฉ ููุง ูู - ูู ุชุชุบูุฑ)
        const addonText = addonInput.value.trim();
        if (addonText && currentAddons.length < 5) {
          currentAddons.push(addonText);
          addonInput.value = "";
          renderAddonsList();
        } else if (currentAddons.length >= 5) {
          showToast("ูุง ูููู ุฅุถุงูุฉ ุฃูุซุฑ ูู 5 ุฅุถุงูุงุช.", true);
        }
      });

      designForm.addEventListener("submit", async (e) => {
        // ๐ก (ุชู ุงูุฅุตูุงุญ) ุงูููุฏ ุงูุฎุงุต ุจุฅุฑุณุงู ุงูุทูุจ ููู AI
        e.preventDefault();
        if (materialSelect.selectedOptions[0]?.disabled) {
          alert("ูุง ูููู ุฅุฑุณุงู ุทูุจ ุชุตููู ุจุงุณุชุฎุฏุงู ูุงุฏุฉ ุฎุงู ุบูุฑ ูุชููุฑุฉ ุญุงููุงู.");
          return;
        }
        if (!designForm.checkValidity()) {
          showToast("ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ ุจุดูู ุตุญูุญ.", true);
          designForm.reportValidity();
          return;
        }

        const productType = productTypeSelect.value;
        const dimensions = dimensionsSelect.value;
        const color = colorSelect.value;
        const material = materialSelect.value;
        const notes = document.getElementById("notes")?.value;
        const roomPlacement = document.getElementById("room-placement")?.value;

        const estimatedCOGS = calculateEstimatedCost(
          material,
          color,
          productType,
          currentAddons
        );

        const minMargin = 1.3;
        const maxMargin = 1.6;

        const priceRangeMin = Math.round(estimatedCOGS * minMargin);
        const priceRangeMax = Math.round(estimatedCOGS * maxMargin);

        processMessage.style.display = "block";
        designResultSection.style.display = "none";

        const filteredProducts = allProducts.filter(
          (p) => p.category === productType && p.is_available !== false
        );
        const productOptionsForAI = filteredProducts
          .map((p) => `- ${p.name} (Price: ${p.price} ISK)`)
          .join(", ");

        const promptText = `
          ุฃูุช ุฎุจูุฑ ูู ุชุตููู ุงูุฃุซุงุซ. ูููุชู ูู:
          1. ุฅูุดุงุก ุงูุชุฑุงุญ ุชุตููู ุจูุงุกู ุนูู ุทูุจ ุงูุนููู.
          2. ุงูุชุฑุงุญ ูุทุงู ุณุนุฑู ููุงุฆู ุถูู ุงูุญุฏูุฏ ุงููุชุงุญุฉ.
          
          ุจูุงูุงุช ุงูุชุณุนูุฑ ุงูุฏุงุนูุฉ:
          - ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ ููููุงุฏ (COGS): ${estimatedCOGS} ุดููู.
          - ุงูููุชุฌุงุช ุงูููุงุซูุฉ: ${productOptionsForAI || "ูุง ููุฌุฏ."}
          - **ูุทุงู ุงูุณุนุฑ ุงููุณููุญ ุจู:** ูุฌุจ ุฃู ูุชุฑุงูุญ ุงููุทุงู ุงูููุชุฑุญ ุจูู ${priceRangeMin} ุดููู ู ${priceRangeMax} ุดููู.

          ุทูุจ ุงูุนููู:
          - ููุน ุงูููุชุฌ: ${productType}
          - ุงูููุงุณุงุช: ${dimensions}
          - ุงููุงุฏุฉ: ${material}
          - ุงูููู ูุงูุชุดุทูุจ: ${color}
          - ุงูุชูุงุตูู ุงูุฅุถุงููุฉ ูุงูููุงุญุธุงุช: ${notes}
          
          ุฃุนุทูู ุฅุฎุฑุงุฌุงู ุจุงูุชูุณูู ุงูุชุงูู ุจุฏูุฉุ ููุง ุชุถู ุฃู ุดุฑุญ ุฃู ููุฏูุงุช:
          ุงูุนููุงู: <ุนููุงู ุงูููุชุฌ ุงูููุฌุฒ>
          ุงููุตู: <ูุตู ุงุญุชุฑุงูู ููููุชุฌ>
          ูุทุงู ุงูุณุนุฑ ุงูููุชุฑุญ: <ุงูุณุนุฑ ุงูุฃุฏูู ุฑูููุงู> - <ุงูุณุนุฑ ุงูุฃูุตู ุฑูููุงู> ุดููู
        `;

        try {
          const textResult = await textModel.generateContent(promptText);
          // ๐ก (ูุฐุง ูู ุงูุฅุตูุงุญ)
          const textResponse = textResult.response.text();

          const titleMatch = textResponse.match(/ุงูุนููุงู:\s*(.*)/);
          const descriptionMatch = textResponse.match(/ุงููุตู:\s*(.*)/);
          const priceRangeMatch = textResponse.match(
            /ูุทุงู ุงูุณุนุฑ ุงูููุชุฑุญ:\s*([\d\.\,\s]+)\s*-\s*([\d\.\,\s]+)\s*ุดููู/
          );

          let title = titleMatch ? titleMatch[1].trim() : "ุชุตููู ูุฎุตุต ูุฑูุฏ";
          let description = descriptionMatch
            ? descriptionMatch[1].trim()
            : "ูุตู ููุชุฑุญ ูู ุงููุณุงุนุฏ.";

          let finalPriceMin = priceRangeMin;
          let finalPriceMax = priceRangeMax;

          if (priceRangeMatch && priceRangeMatch[1] && priceRangeMatch[2]) {
            finalPriceMin = parseFloat(
              priceRangeMatch[1].replace(/[^0-9\.]/g, "")
            );
            finalPriceMax = parseFloat(
              priceRangeMatch[2].replace(/[^0-9\.]/g, "")
            );
          }

          if (
            finalPriceMin < priceRangeMin ||
            finalPriceMax > priceRangeMax ||
            finalPriceMin >= finalPriceMax ||
            isNaN(finalPriceMin) ||
            isNaN(finalPriceMax)
          ) {
            finalPriceMin = priceRangeMin;
            finalPriceMax = priceRangeMax;
          }

          const initialDesignPrice = finalPriceMin;

          currentDesign = {
            title: title,
            description: description,
            price: initialDesignPrice,
            price_value: initialDesignPrice,
            price_range: `${finalPriceMin.toFixed(0)} - ${finalPriceMax.toFixed(
              0
            )}`,
            type: productType,
            dimensions,
            material,
            color,
            notes,
            addons: currentAddons,
            quantity: 1,
            estimatedCOGS: estimatedCOGS,
          };

          processMessage.style.display = "none";

          document.getElementById("result-content").innerHTML = `
                <h3 id="result-title">${currentDesign.title}</h3>
                <p><strong>ุงููุตู ุงูููุชุฑุญ:</strong> ${currentDesign.description}</p>
                <p><strong>ุงูููุงุตูุงุช ุงูุฑุฆูุณูุฉ:</strong> ${currentDesign.material}ุ ${currentDesign.color}ุ ${currentDesign.dimensions}</p>
                <p id="result-price" style="font-size: 1.4rem; font-weight: bold; color: var(--primary-color);">
                    ูุทุงู ุงูุณุนุฑ ุงูุฃููู: ${currentDesign.price_range} ุดููู
                </p>
                <p style="font-size: 0.9rem; color: #888; margin-top: 10px">
                    ุงูุณุนุฑ ุงูููุชุฑุญ ููุณ ููุงุฆูุงูุ ุณูุชู ุชุฃููุฏู ุจุนุฏ ูุฑุงุฌุนุฉ ุงููุฑูู.
                </p>`;
          designResultSection.classList.add("show");
          designResultSection.style.display = "block";
        } catch (error) {
          console.error("Error generating design:", error);
          processMessage.style.display = "none";
          showToast("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุชุตููู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.", true);
        }
      });

      document
        .getElementById("submit-design-btn")
        .addEventListener("click", () => {
          if (!currentDesign) return;
          addToCartAsCustom(currentDesign);
          designResultSection.style.display = "none";
          designForm.reset();
          updateDimensionsOptions();
          updatePlacementOptions(); // ๐ก (ุฌุฏูุฏ) ุฅุนุงุฏุฉ ุชุนููู ูุงุฆูุฉ ุงูุฃูุงูู
          currentAddons = [];
          renderAddonsList();
          updateMaterialPreview();
        });

      // ====== ุจุฏุก ุชูููุฐ ุงูุณูุฑุจุช ======
      document.addEventListener("DOMContentLoaded", () => {
        loadCartAndUpdateBadge();
        initializeData();

        // ๐ก (ุฌุฏูุฏ) ููุทู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
        onAuthStateChanged(auth, async (user) => {
          currentUser = user;
          if (user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            let userName = "ูุณุชุฎุฏู";
            if (userDocSnap.exists()) {
              userName = userDocSnap.data().name || userName;
            }
            userDisplayName.textContent = "ูุฑุญุจุงู " + userName;
            userEmail.textContent = user.email;
            authLink.style.display = "none";
            logoutLink.style.display = "block";
            logoutLink.onclick = async (e) => {
              e.preventDefault();
              await signOut(auth);
              window.location.href = "index.html";
            };
          } else {
            userDisplayName.textContent = "ูุฑุญุจุงู ุจู";
            userEmail.textContent = "ุฒุงุฆุฑ";
            authLink.style.display = "block";
            logoutLink.style.display = "none";
          }
        });

        document
          .getElementById("regenerate-design-btn")
          .addEventListener("click", () => {
            designForm.dispatchEvent(
              new Event("submit", { cancelable: true, bubbles: true })
            );
          });

        renderAddonsList();

        // (ููุทู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููููุจุงูู ููุง ูู)
        menuToggle.addEventListener("click", () => {
          mobileMenu.classList.toggle("active");
          document.body.classList.toggle("scroll-lock");
        });
      });
    </script>
  </body>
</html>
