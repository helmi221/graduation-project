<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | صمم منتجك</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .design-page-section {
        max-width: 800px;
        margin: 5rem auto;
        padding: 40px;
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: right;
      }
      .design-form {
        margin-top: 2rem;
      }
      .design-form .form-group {
        margin-bottom: 2rem;
      }
      .design-form .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }
      .design-form .form-group input,
      .design-form .form-group select,
      .design-form .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Cairo", sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .design-form .form-group input:focus,
      .design-form .form-group select:focus,
      .design-form .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(121, 85, 72, 0.2);
      }
      .design-form .btn {
        display: block;
        width: 100%;
        margin-top: 2rem;
      }
      /* General styles */
      .required-field {
        color: var(--danger-color);
        margin-right: 5px;
      }
      .loading-bar-container {
        display: none;
        text-align: center;
        padding: 20px;
        color: var(--primary-color);
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      .design-result-section.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">منجرة</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">الرئيسية</a>
            </li>
            <li>
              <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
            </li>
            <li>
              <a href="order-status.html" class="nav-link">حالة الطلب</a>
            </li>
            <li>
              <a href="recommendation.html" class="nav-link">المساعد</a>
            </li>
            <li>
              <a href="design.html" class="nav-link active">صمم منتجك</a>
            </li>
          </ul>
          <a href="cart.html" class="cart-icon-wrapper">
            <svg
              id="cart-icon"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
              />
            </svg>
            <span id="cart-count-badge">0</span>
          </a>
          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">الرئيسية</a>
      <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
      <a href="order-status.html" class="nav-link">حالة الطلب</a>
      <a href="recommendation.html" class="nav-link">المساعد</a>
      <a href="design.html" class="nav-link">صمم منتجك</a>
    </div>

    <main>
      <section class="section container design-page-section">
        <div class="section-title-wrapper">
          <h2>صمم منتجك الخاص</h2>
        </div>
        <p style="text-align: center; color: #777">
          صف لنا فكرتك في أربع خطوات بسيطة وسنقوم بتحويلها إلى تصميم مقترح.
        </p>

        <form id="design-form" class="design-form">
          <div class="form-step active" data-step="1">
            <div class="form-group">
              <label for="product-type"
                ><span class="required-field">*</span> نوع المنتج المطلوب</label
              >
              <select id="product-type" name="product-type" required>
                <option value="">-- اختر نوع المنتج --</option>
                <option value="طاولة سفرة">طاولة سفرة</option>
                <option value="كرسي">كرسي</option>
                <option value="طقم كنب">طقم كنب</option>
                <option value="غرفة نوم">غرفة نوم</option>
                <option value="مطبخ">مطبخ</option>
                <option value="طاولة وسط">طاولة وسط</option>
                <option value="خزانة">خزانة</option>
                <option value="طاولة تلفاز">طاولة تلفاز</option>
                <option value="آخر">آخر...</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dimensions"
                  ><span class="required-field">*</span> المقاسات
                  التقريبية</label
                >
                <select id="dimensions" name="dimensions" required>
                  <option value="">-- اختر نوع المنتج أولاً --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="room-placement"
                  ><span class="required-field">*</span> مكان وضع المنتج</label
                >
                <select id="room-placement" name="room-placement" required>
                  <option value="">-- اختر المكان --</option>
                  <option value="غرفة المعيشة">غرفة المعيشة</option>
                  <option value="غرفة الطعام">غرفة الطعام</option>
                  <option value="غرفة النوم">غرفة النوم</option>
                  <option value="المطبخ">المطبخ</option>
                  <option value="المكتب">المكتب</option>
                  <option value="غرفة الأطفال">غرفة الأطفال</option>
                  <option value="خارجي">خارجي</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="color"
                  ><span class="required-field">*</span> اللون والتشطيب
                  المفضّل</label
                >
                <select id="color" name="color" required>
                  <option value="">-- جارٍ التحميل --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="material"
                  ><span class="required-field">*</span> المادة الرئيسية المفضلة
                  (نوع الخشب)</label
                >
                <select id="material" name="material" required>
                  <option value="">-- جارٍ التحميل --</option>
                </select>
              </div>
            </div>

            <div class="form-group" id="notes-group">
              <label for="notes"
                ><span class="required-field">*</span> وصف فكرتك وتفاصيل
                التصميم</label
              >
              <textarea
                id="notes"
                name="notes"
                rows="4"
                required
                placeholder="مثال: أحتاج طاولة طعام بنمط ريفي، تتسع لـ 6 أشخاص، الميزانية 2500 شيكل، أريد أدراجاً مخفية."
              ></textarea>
            </div>
          </div>

          <button type="submit" class="btn" id="submit-form-btn">
            <i class="fa-solid fa-robot"></i> اقتراح تصميم
          </button>
        </form>

        <div id="processing-message" class="loading-bar-container">
          <div class="loading-bar"></div>
          <p style="text-align: center; font-weight: bold; padding-top: 5px">
            جارٍ معالجة طلبك...
          </p>
        </div>

        <div
          id="design-result"
          class="design-result-section"
          style="display: none"
        >
          <h2 style="margin-bottom: 1.5rem">اقتراحنا لك</h2>
          <div class="design-result-text" id="result-content"></div>
          <div class="design-result-actions">
            <button class="btn" id="submit-design-btn">
              <i class="fa-solid fa-cart-plus"></i> أضف إلى السلة للمراجعة
            </button>
            <button
              class="btn"
              id="regenerate-design-btn"
              style="background-color: var(--accent-color)"
            >
              اقتراح آخر
            </button>
          </div>
          <div
            style="
              margin-top: 2rem;
              text-align: center;
              font-size: 0.9rem;
              color: #888;
            "
          >
            <p>
              السعر المعروض هو سعر أولي مقترح. سيتم تأكيده بعد مراجعة الفريق.
              يمكنك الآن إضافته إلى السلة وإكمال طلبك.
            </p>
          </div>
        </div>
      </section>
    </main>

    <div id="design-confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-confirm">&times;</span>
        <h2>شكراً لك!</h2>
        <p>
          تم استلام طلبك للتصميم المخصص بنجاح. سنقوم بمراجعته والرد عليك خلال
          يومي عمل.
        </p>
        <p>رمز التتبع الخاص بطلبك هو:</p>
        <span id="design-tracking-id" class="tracking-id-display"></span>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #888">
          الرجاء حفظ هذا الرمز لتتمكن من متابعة حالة طلبك وقبول أو رفض السعر
          النهائي.
        </p>
      </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <div id="design-checkout-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" data-modal="design-checkout">&times;</span>
        <div class="modal-body">
          <div class="checkout-form-container">
            <h2>إرسال طلب التصميم</h2>
            <p>
              الرجاء إدخال بياناتك لإرسال طلب التصميم. سيتم التواصل معك
              لمراجعته.
            </p>
            <form id="design-checkout-form">
              <div class="form-group">
                <label for="name">الاسم الكامل</label>
                <input type="text" id="design-name" name="name" required />
              </div>
              <div class="form-group">
                <label for="phone">رقم الهاتف</label>
                <input type="tel" id="design-phone" name="phone" required />
              </div>
              <div class="form-group">
                <label for="email">البريد الإلكتروني (اختياري)</label>
                <input type="email" id="design-email" name="email" />
              </div>
              <div class="form-group">
                <label for="address">العنوان</label>
                <textarea
                  id="design-address"
                  name="address"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn" id="confirm-design-btn">
                تأكيد طلب التصميم
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // ******* إعدادات Firebase و Gemini *******
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const textModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // متغيرات تخزين البيانات
      let allProducts = [];
      let allRawMaterials = [];
      let currentUser = null;
      let currentDesign = null;

      const standardColors = [
        "أبيض",
        "أسود",
        "رمادي فاتح",
        "أزرق نيلي",
        "أخضر زمردي",
        "بيج مطفي",
        "بني غامق",
        "أحمر ساطع",
      ];
      const productDimensions = {
        "طاولة سفرة": [
          "مقاس صغير (2-4 أشخاص)",
          "مقاس متوسط (4-6 أشخاص)",
          "مقاس كبير (6-8 أشخاص)",
        ],
        كرسي: ["مقاس قياسي", "مقاس كبير ومريح"],
        "طقم كنب": ["مقعدين", "ثلاثة مقاعد", "كنبة زاوية (حرف L)"],
        "غرفة نوم": ["سرير مزدوج قياسي", "سرير مفرد", "مجموعة تسريحة وخزانة"],
        مطبخ: ["وحدة علوية قياسية", "وحدة سفلية قياسية", "جزيرة مطبخ"],
        "طاولة وسط": ["مقاس قياسي (صغيرة)", "مقاس كبير"],
        خزانة: [
          "صغيرة (بابين)",
          "متوسطة (3-4 أبواب)",
          "كبيرة (أكثر من 4 أبواب)",
        ],
        "طاولة تلفاز": ["صغيرة (أقل من 120 سم)", "كبيرة (أكثر من 150 سم)"],
        آخر: ["مقاس صغير", "مقاس متوسط", "مقاس كبير"],
      };

      // عناصر الواجهة
      const productTypeSelect = document.getElementById("product-type");
      const colorSelect = document.getElementById("color");
      const materialSelect = document.getElementById("material");
      const dimensionsSelect = document.getElementById("dimensions");
      const toast = document.getElementById("toast-notification");
      const designCheckoutForm = document.getElementById(
        "design-checkout-form"
      );
      const processMessage = document.getElementById("processing-message");
      const designResultSection = document.getElementById("design-result");
      const designForm = document.getElementById("design-form");

      // ====================================================================
      // 1. وظائف المساعدة العامة وتهيئة البيانات
      // ====================================================================

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.className = `toast show ${isError ? "error" : "success"}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-close").forEach((btn) => {
        btn.addEventListener("click", () => {
          const modalId = btn.closest(".modal-overlay").id;
          closeModal(modalId);
        });
      });

      function loadCartAndUpdateBadge() {
        const storedCart = localStorage.getItem("shoppingCart") || "[]";
        const cart = JSON.parse(storedCart);
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (cartCountBadge) {
          const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          cartCountBadge.textContent = totalItems;
          cartCountBadge.classList.toggle("visible", totalItems > 0);
        }
        return cart;
      }

      function saveCart(cart) {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        loadCartAndUpdateBadge();
      }

      function generateTrackingId(prefix = "DGN") {
        return `${prefix}-${new Date().getTime().toString(36)}-${Math.random()
          .toString(36)
          .substr(2, 5)}`.toUpperCase();
      }

      async function initializeData() {
        processMessage.style.display = "block";
        try {
          const [productsSnapshot, materialsSnapshot] = await Promise.all([
            getDocs(collection(db, "products")),
            getDocs(collection(db, "raw_materials")),
          ]);

          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          allRawMaterials = materialsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            type: doc.data().type || "أخرى",
            name_ar: doc.data().name_ar,
          }));

          fillDropdowns();
        } catch (e) {
          console.error("Initialization Error: ", e);
          showToast("❌ فشل تحميل بيانات المخزون. يرجى مراجعة Firebase.", true);
          designForm.style.opacity = 0.5;
        } finally {
          processMessage.style.display = "none";
        }
      }

      function fillDropdowns() {
        // 1. تعبئة الأخشاب
        const woodMaterials = allRawMaterials.filter((m) => m.type === "خشب");
        let materialOptions = '<option value="">-- اختر مادة --</option>';
        woodMaterials.forEach((m) => {
          materialOptions += `<option value="${m.name_ar}">${m.name_ar}</option>`;
        });
        materialSelect.innerHTML = materialOptions;

        // 2. تعبئة الألوان
        let colorOptions = `<option value="">-- اختر لون --</option>`;
        colorOptions += `<option value="لون طبيعي (ورنيش)">لون طبيعي (ورنيش/حماية شفافة)</option>`;
        standardColors.forEach((color) => {
          colorOptions += `<option value="${color} (دهان)">${color} (دهان)</option>`;
        });
        colorSelect.innerHTML = colorOptions;

        // 3. تحديث الأبعاد بناءً على نوع المنتج
        productTypeSelect.addEventListener("change", updateDimensionsOptions);
        updateDimensionsOptions(); // تعبئة أولية
      }

      function updateDimensionsOptions() {
        const selectedType = productTypeSelect.value;
        const options =
          productDimensions[selectedType] || productDimensions["آخر"];

        let optionsHTML = `<option value="">-- اختر مقاساً تقريبياً --</option>`;
        options.forEach((dim) => {
          optionsHTML += `<option value="${dim}">${dim}</option>`;
        });
        dimensionsSelect.innerHTML = optionsHTML;
      }

      function calculateEstimatedCost(materialName, color, productType) {
        let baseCost = 0;
        let woodVolumeFactor = 1;
        let paintVolumeFactor = 1;
        let accessoryCost = 150;

        const woodMaterial = allRawMaterials.find(
          (m) => m.name_ar === materialName && m.type === "خشب"
        );
        const paintMaterial = allRawMaterials.find((m) =>
          m.type.includes("طلاء")
        );
        const varnishMaterial = allRawMaterials.find((m) =>
          m.name_ar.includes("ورنيش")
        );

        // تحديد معامل حجم الخشب التقريبي
        if (productType.includes("طاولة")) woodVolumeFactor = 0.75;
        else if (productType.includes("كنب")) woodVolumeFactor = 1.0;
        else if (productType.includes("خزانة")) woodVolumeFactor = 1.2;
        else woodVolumeFactor = 0.5;

        if (woodMaterial) {
          baseCost += (woodMaterial.cost_per_unit || 0) * woodVolumeFactor;
        } else {
          baseCost += 1500 * woodVolumeFactor;
        }

        // تكلفة التشطيب
        if (color.includes("ورنيش") && varnishMaterial) {
          baseCost +=
            (varnishMaterial.cost_per_unit || 200) * paintVolumeFactor;
        } else if (paintMaterial) {
          baseCost += (paintMaterial.cost_per_unit || 500) * paintVolumeFactor;
        } else {
          baseCost += 300;
        }

        baseCost += accessoryCost;

        return Math.round(baseCost);
      }

      function addToCartAsCustom(design) {
        let cart = loadCartAndUpdateBadge();

        const tempId = `CUSTOM-${Date.now()}`;

        const newItem = {
          id: tempId,
          name: design.title,
          price: design.price_value,
          quantity: 1,
          isCustom: true,
          // حفظ جميع تفاصيل التصميم داخل حقل 'details'
          details: {
            type: design.type,
            dimensions: design.dimensions,
            material: design.material,
            color: design.color,
            notes: design.notes,
            estimatedCOGS: design.estimatedCOGS,
            description: design.description,
            initial_price: design.price_value,
            // 💡 لإظهارها بوضوح للمدير:
            title: design.title,
          },
        };

        cart.push(newItem);
        saveCart(cart);
        showToast(`✅ تمت إضافة التصميم (${design.title}) إلى السلة للمراجعة!`);
      }

      // ====================================================================
      // 2. منطق توليد التصميم (Gemini Logic)
      // ====================================================================

      designForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 💡 التحقق من صحة النموذج باستخدام التحقق الافتراضي لـ HTML
        if (!designForm.checkValidity()) {
          showToast("الرجاء ملء جميع الحقول المطلوبة بشكل صحيح.", true);
          designForm.reportValidity();
          return;
        }

        const productType = productTypeSelect.value;
        const dimensions = dimensionsSelect.value;
        const color = colorSelect.value;
        const material = materialSelect.value;
        const notes = document.getElementById("notes")?.value;
        const roomPlacement = document.getElementById("room-placement")?.value;

        const estimatedCOGS = calculateEstimatedCost(
          material,
          color,
          productType
        );
        const initialSuggestedPrice = Math.round(estimatedCOGS * 1.35);

        // إظهار المعالجة
        designResultSection.classList.remove("show");
        designResultSection.style.display = "none";
        processMessage.style.display = "block";

        const filteredProducts = allProducts.filter(
          (p) => p.category === productType && p.is_available !== false
        );

        const productOptionsForAI = filteredProducts
          .map((p) => `- ${p.name} (Price: ${p.price} ISK)`)
          .join(", ");

        const promptText = `
          أنت خبير في تصميم الأثاث. أنشئ اقتراح تصميم بناءً على طلب العميل.
          اقترح سعراً نهائياً منطقياً، يجب أن يتراوح بين ${initialSuggestedPrice} شيكل و ${
          initialSuggestedPrice + 1000
        } شيكل.
          
          بيانات التسعير الداعمة:
          - التكلفة التقديرية للمواد (COGS): ${estimatedCOGS} شيكل.
          - المنتجات المماثلة: ${productOptionsForAI || "لا يوجد."}

          طلب العميل:
          - نوع المنتج: ${productType}
          - المقاسات: ${dimensions}
          - المادة: ${material}
          - اللون والتشطيب: ${color}
          - التفاصيل الإضافية: ${notes}
          
          أعطني إخراجاً بالتنسيق التالي بدقة:
          العنوان: <عنوان المنتج الموجز>
          الوصف: <وصف احترافي للمنتج>
          السعر المقترح: <قيمة نقدية (رقم) بالعملة شيكل>
        `;

        try {
          const textResult = await textModel.generateContent(promptText);
          const textResponse = textResult.response.text();

          const titleMatch = textResponse.match(/العنوان:\s*(.*)/);
          const descriptionMatch = textResponse.match(/الوصف:\s*(.*)/);
          const priceMatch = textResponse.match(
            /السعر المقترح:\s*([\d\.\,\s]+)\s*شيكل/
          );

          let title = titleMatch ? titleMatch[1].trim() : "تصميم مخصص فريد";
          let description = descriptionMatch
            ? descriptionMatch[1].trim()
            : "وصف مقترح من المساعد.";

          const finalPriceValueMatch = priceMatch
            ? priceMatch[0].match(/[\d\.]+/g)
            : null;
          const finalPriceValue = finalPriceValueMatch
            ? parseFloat(finalPriceValueMatch[0])
            : initialSuggestedPrice;

          currentDesign = {
            title: title,
            description: description,
            price: finalPriceValue,
            price_value: finalPriceValue,
            type: productType,
            dimensions,
            material,
            color,
            notes,
            quantity: 1,
            estimatedCOGS: estimatedCOGS,
          };

          processMessage.style.display = "none";

          // 💡 عرض المعلومات للزبون (طلبك الثاني)
          document.getElementById("result-content").innerHTML = `
                <h3 id="result-title">${currentDesign.title}</h3>
                <p><strong>الوصف المقترح:</strong> ${
                  currentDesign.description
                }</p>
                <p><strong>المواصفات الرئيسية:</strong> ${
                  currentDesign.material
                }، ${currentDesign.color}، ${currentDesign.dimensions}</p>
                <p id="result-price" style="font-size: 1.4rem; font-weight: bold; color: var(--primary-color);">
                    السعر الأولي: ${currentDesign.price_value.toFixed(0)} شيكل
                </p>
                <p style="font-size: 0.9rem; color: #888; margin-top: 10px">
                    السعر المقترح ليس نهائياً، سيتم تأكيده بعد مراجعة الفريق.
                </p>`;
          designResultSection.classList.add("show");
          designResultSection.style.display = "block";
        } catch (error) {
          console.error("Error generating design:", error);
          processMessage.style.display = "none";
          showToast("❌ حدث خطأ أثناء إنشاء التصميم. حاول مرة أخرى.", true);
        }
      });

      // ====================================================================
      // 3. منطق الإرسال (إضافة للسلة)
      // ====================================================================

      document
        .getElementById("submit-design-btn")
        .addEventListener("click", () => {
          if (!currentDesign) return;

          // 💡 طلبك الأول: يذهب للسلة
          addToCartAsCustom(currentDesign);
          designResultSection.style.display = "none"; // إخفاء قسم النتيجة بعد الإضافة
          designForm.reset();
          updateDimensionsOptions();
        });

      // ====================================================================
      // 4. بدء التشغيل
      // ====================================================================
      document.addEventListener("DOMContentLoaded", () => {
        loadCartAndUpdateBadge();
        initializeData();

        onAuthStateChanged(auth, (user) => {
          currentUser = user;
        });

        // ربط زر إعادة الاقتراح
        document
          .getElementById("regenerate-design-btn")
          .addEventListener("click", () => {
            designForm.dispatchEvent(
              new Event("submit", { cancelable: true, bubbles: true })
            );
          });
      });
    </script>
  </body>
</html>
