<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      .customer-header-controls {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        align-items: center;
      }

      /* ğŸ’¡ ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
      #customer-search {
        flex-grow: 1;
        padding: 12px 20px 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
      }
      #customer-search:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.1);
      }

      /* ğŸ’¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
      #customer-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .stat-card {
        background-color: var(--white-color);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        border-right: 4px solid var(--primary-color);
      }
      .stat-card h4 {
        font-size: 0.9rem;
        color: #777;
        margin-bottom: 5px;
      }
      .stat-card p {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark-color);
        margin: 0;
      }

      /* ğŸ’¡ ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ† (Card-based) */
      .customer-accordion-item {
        margin-bottom: 12px;
        border: 1px solid #eee;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
      }
      .customer-accordion-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .customer-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background-color: var(--white-color);
        cursor: pointer;
        font-weight: 700;
        border-radius: 8px;
      }
      .customer-info-header[aria-expanded="true"] {
        border-radius: 8px 8px 0 0;
        background-color: var(--light-color);
      }
      /* ğŸ’¡ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… flex Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
      .customer-main-details {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1rem;
        color: var(--dark-color);
        flex-grow: 1; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙ…Ø¯Ø¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
      }
      .customer-avatar-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
      }
      .orders-count-badge {
        background-color: var(--primary-color);
        color: white;
        padding: 5px 10px;
        border-radius: 50px;
        font-size: 0.9rem;
        min-width: 80px; /* ØªØ­Ø¯ÙŠØ¯ Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ù„Ø¹Ø¯Ù… ØªØ´ÙˆÙ‡ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
        text-align: center;
        display: inline-block;
      }

      /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ† - Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª */
      .orders-list-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        background-color: #fafafa;
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
      }
      .orders-list-content.active {
        max-height: 1500px;
        padding: 15px;
        transition: max-height 0.7s ease-in;
      }

      .customer-details-section {
        padding: 15px 0;
        margin-bottom: 10px;
        border-bottom: 1px dashed #ddd;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .customer-details-section p {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
        font-size: 0.95rem;
        color: #555;
      }
      .customer-details-section strong {
        color: var(--dark-color);
      }

      .order-details-card {
        background-color: var(--white-color);
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .order-details-card.ready {
        border-right: 4px solid var(--success-color);
      }
      .order-details-card.custom {
        border-right: 4px solid var(--info-color);
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">Ù…Ù†Ø¬Ø±Ø©</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</a
            >
          </li>
          <li>
            <a href="customers_admin.html" class="active"
              ><i class="fa-solid fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>

      <div class="admin-panel">
        <div id="customer-stats">
          <div class="stat-card">
            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
            <p id="total-customers-count">0</p>
          </div>
          <div class="stat-card" style="border-color: var(--info-color)">
            <h4>Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</h4>
            <p id="active-customers-count">0</p>
          </div>
          <div class="stat-card" style="border-color: var(--success-color)">
            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
            <p id="total-orders-count">0</p>
          </div>
        </div>

        <div class="customer-header-controls">
          <input
            type="text"
            id="customer-search"
            placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..."
          />
          <i class="fa-solid fa-magnifying-glass" style="color: #999"></i>
        </div>

        <div id="customers-list-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // ØªÙ‡ÙŠØ¦Ø© Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const customersListContainer = document.getElementById(
        "customers-list-container"
      );
      const searchInput = document.getElementById("customer-search");

      let allCustomersData = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©

      // --------------------------------------------------------
      // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      // --------------------------------------------------------
      function updateCustomerStats(customers, allOrders) {
        document.getElementById("total-customers-count").textContent =
          customers.length;
        document.getElementById("total-orders-count").textContent =
          allOrders.length;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø© (Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø§Ù„Ø®...)
        const activeStatuses = [
          "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
          "Ù…Ù‚Ø¨ÙˆÙ„",
          "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
        ];
        const activeOrderUids = new Set(
          allOrders
            .filter((order) => activeStatuses.includes(order.status))
            .map((order) => order.customer_uid)
        );
        document.getElementById("active-customers-count").textContent =
          activeOrderUids.size;
      }

      // --------------------------------------------------------
      // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
      // --------------------------------------------------------
      async function fetchAndRenderCustomers() {
        customersListContainer.innerHTML =
          '<p class="loading-msg"><i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>';
        try {
          // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
          const usersQuery = query(
            collection(db, "users"),
            where("role", "!=", "admin")
          );
          const usersSnapshot = await getDocs(usersQuery);
          const customers = usersSnapshot.docs.map((doc) => ({
            uid: doc.id,
            ...doc.data(),
          }));

          // 2. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          const ordersSnap = await getDocs(collection(db, "orders"));
          const customSnap = await getDocs(collection(db, "custom_designs"));

          const allOrders = [
            ...ordersSnap.docs.map((d) => ({
              id: d.id,
              type: "ready",
              order_date: d.data().order_date || "2000-01-01",
              ...d.data(),
            })),
            ...customSnap.docs.map((d) => ({
              id: d.id,
              type: "custom",
              order_date: d.data().order_date || "2000-01-01",
              ...d.data(),
            })),
          ];

          // 3. Ø¯Ù…Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
          allCustomersData = customers.map((customer) => {
            const customerOrders = allOrders
              .filter((order) => order.customer_uid === customer.uid)
              .sort((a, b) => new Date(b.order_date) - new Date(a.order_date));

            return {
              ...customer,
              orders: customerOrders,
              orderCount: customerOrders.length,
            };
          });

          updateCustomerStats(customers, allOrders); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
          renderCustomersList(allCustomersData); // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
          setupAccordionListeners();
          setupSearchListener();
        } catch (e) {
          console.error("Error fetching customer data: ", e);
          customersListContainer.innerHTML =
            '<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.</p>';
        }
      }

      // --------------------------------------------------------
      // ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø·ÙˆÙŠØ©
      // --------------------------------------------------------
      function renderCustomersList(customersToRender) {
        if (customersToRender.length === 0) {
          customersListContainer.innerHTML =
            '<p style="text-align: center; color: #999; margin-top: 30px;"><i class="fa-solid fa-exclamation-triangle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ø­Ø«.</p>';
          return;
        }

        let listHtml = "";

        customersToRender.forEach((customer) => {
          const orderCount = customer.orderCount;
          const lastOrderDate =
            orderCount > 0
              ? new Date(customer.orders[0].order_date).toLocaleDateString(
                  "ar-EG"
                )
              : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";

          listHtml += `
                    <div class="customer-accordion-item">
                        <div class="customer-info-header" data-uid="${
                          customer.uid
                        }" aria-expanded="false" role="button">
                            <div class="customer-main-details">
                                <i class="fa-solid fa-circle-user customer-avatar-icon"></i>
                                ${customer.name || "Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <span class="orders-count-badge">${orderCount} Ø·Ù„Ø¨</span>
                                <i class="fa-solid fa-chevron-left accordion-toggle-icon"></i>
                            </div>
                        </div>
                        
                        <div class="orders-list-content" id="orders-content-${
                          customer.uid
                        }">
                            <div class="customer-details-section">
                                <p><strong><i class="fa-solid fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> <span>${
                                  customer.email || "---"
                                }</span></p>
                                <p><strong><i class="fa-solid fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span>${
                                  customer.phone || "---"
                                }</span></p>
                                <p><strong><i class="fa-solid fa-map-marker-alt"></i> Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span>${
                                  customer.address || "---"
                                }</span></p>
                                <p><strong><i class="fa-solid fa-calendar-alt"></i> Ø¢Ø®Ø± Ø·Ù„Ø¨:</strong> <span>${lastOrderDate}</span></p>
                            </div>
                            
                            <h4 style="margin-bottom: 10px; color: var(--dark-color); padding-top: 5px;">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
                            ${
                              orderCount > 0
                                ? renderCustomerOrders(customer.orders)
                                : '<p style="text-align: center; color: #999; padding-bottom: 15px;">Ù„Ù… ÙŠÙ‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø·Ù„Ø¨ Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</p>'
                            }
                        </div>
                    </div>
                `;
        });

        customersListContainer.innerHTML = listHtml;
        setupAccordionListeners(); // ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ HTML
      }

      // --------------------------------------------------------
      // ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù… ØªØªØºÙŠØ± Ø¬ÙˆÙ‡Ø±ÙŠØ§Ù‹)
      // --------------------------------------------------------
      function renderCustomerOrders(orders) {
        return orders
          .map((order) => {
            const totalDisplay =
              order.type === "ready"
                ? `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${parseFloat(order.total || 0).toFixed(0)} â‚ª`
                : `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${parseFloat(
                    order.final_price || order.initial_price || 0
                  ).toFixed(0)} â‚ª`;

            const typeClass = order.type === "ready" ? "ready" : "custom";
            const productInfo =
              order.type === "ready"
                ? `Ø§Ù„Ù…Ù†ØªØ¬: ${order.items[0].name} ${
                    order.items.length > 1
                      ? `Ùˆ ${order.items.length - 1} Ø¢Ø®Ø±`
                      : ""
                  }`
                : `Ù†ÙˆØ¹ Ø§Ù„ØªØµÙ…ÙŠÙ…: ${order.type_of_product || "---"}`;

            // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù„ÙˆÙ† Ù…Ù†Ø§Ø³Ø¨
            const getStatusBadge = (status) => {
              const statusClass = status.replace(/\s+/g, "-");
              return `<span class="status-badge ${statusClass}">${status}</span>`;
            };

            return `
                    <div class="order-details-card ${typeClass}">
                        <p><strong><i class="fa-solid fa-receipt"></i> Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${
                          order.id
                        }</p>
                        <p><strong><i class="fa-solid fa-box"></i> ${productInfo}</strong></p>
                        <p><strong><i class="fa-solid fa-calendar"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(
                          order.order_date
                        ).toLocaleDateString("ar-EG")}</p>
                        <p><strong><i class="fa-solid fa-tag"></i> Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${getStatusBadge(
                          order.status
                        )}</p>
                        <p><strong><i class="fa-solid fa-money-bill-wave"></i> ${totalDisplay}</strong></p>
                    </div>
                `;
          })
          .join("");
      }

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« (Filtering)
      // --------------------------------------------------------
      function setupSearchListener() {
        searchInput.addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase().trim();

          if (searchTerm === "") {
            renderCustomersList(allCustomersData);
            return;
          }

          const filteredCustomers = allCustomersData.filter((customer) => {
            const name = (customer.name || "").toLowerCase();
            const email = (customer.email || "").toLowerCase();
            const phone = (customer.phone || "").toLowerCase();

            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ
            return (
              name.includes(searchTerm) ||
              email.includes(searchTerm) ||
              phone.includes(searchTerm)
            );
          });

          renderCustomersList(filteredCustomers);
        });
      }

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ† (Accordion)
      // --------------------------------------------------------
      function setupAccordionListeners() {
        document.querySelectorAll(".customer-info-header").forEach((header) => {
          header.removeEventListener("click", toggleAccordion); // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
          header.addEventListener("click", toggleAccordion);
        });
      }

      function toggleAccordion(e) {
        const header = e.currentTarget;
        const contentId = `orders-content-${header.dataset.uid}`;
        const content = document.getElementById(contentId);
        const isExpanded = header.getAttribute("aria-expanded") === "true";

        // Ø¥ØºÙ„Ø§Ù‚ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙØªÙˆØ­
        document
          .querySelectorAll(".customer-info-header[aria-expanded='true']")
          .forEach((h) => {
            if (h !== header) {
              h.setAttribute("aria-expanded", "false");
              document
                .getElementById(`orders-content-${h.dataset.uid}`)
                .classList.remove("active");
            }
          });

        // ÙØªØ­ Ø£Ùˆ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø¯Ø¯
        if (isExpanded) {
          header.setAttribute("aria-expanded", "false");
          content.classList.remove("active");
        } else {
          header.setAttribute("aria-expanded", "true");
          content.classList.add("active");
        }
      }

      // --------------------------------------------------------
      // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchAndRenderCustomers();
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });
    </script>
  </body>
</html>
