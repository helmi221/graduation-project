<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | إدارة العملاء (تحليل البيانات)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      .customer-header-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      #customer-search {
        flex-grow: 1;
        padding: 12px 20px 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        min-width: 250px;
      }
      #customer-search:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.1);
      }
      #customer-sort {
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        background-color: #f9f9f9;
        min-width: 180px;
      }

      /* زر التحديث الجديد */
      #refresh-data-btn {
        background-color: var(--secondary-color);
        color: white;
        padding: 12px 20px;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #refresh-data-btn:hover {
        background-color: var(--primary-color);
      }

      #customer-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .stat-card {
        background-color: var(--white-color);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        border-right: 4px solid var(--primary-color);
      }
      .stat-card h4 {
        font-size: 0.9rem;
        color: #777;
        margin-bottom: 5px;
      }
      .stat-card p {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark-color);
        margin: 0;
      }
      .stat-card .small-text {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dark-color);
      }
      .customer-accordion-item {
        margin-bottom: 12px;
        border: 1px solid #eee;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
      }
      .customer-accordion-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .customer-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background-color: var(--white-color);
        cursor: pointer;
        font-weight: 700;
        border-radius: 8px;
        flex-wrap: wrap;
      }
      .customer-info-header[aria-expanded="true"] {
        border-radius: 8px 8px 0 0;
        background-color: var(--light-color);
      }
      .customer-main-details {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1rem;
        color: var(--dark-color);
        flex-grow: 1;
      }
      .customer-avatar-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
      }
      .customer-badges {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: 20px;
      }
      .customer-segment-badge {
        background-color: var(--accent-1);
        color: white;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
      }
      /* ألوان الفئات التي تم إنشاؤها بواسطة Python Script */
      .customer-segment-badge.vip {
        background-color: #c0392b;
      }
      .customer-segment-badge.loyal {
        background-color: var(--success-color);
      }
      .customer-segment-badge.promising {
        background-color: var(--info-color);
      }
      .customer-segment-badge.new {
        background-color: #16a085;
      }
      .customer-segment-badge.at-risk {
        background-color: var(--warning-color);
      }
      .customer-segment-badge.hibernating {
        background-color: #7f8c8d;
      }
      .customer-segment-badge.idle {
        background-color: #95a5a6;
      }
      .customer-segment-badge.regular {
        background-color: #bdc3c7;
      }
      .customer-segment-badge.unclassified {
        background-color: #ecf0f1;
        color: #777;
        border: 1px solid #ccc;
      }

      .orders-count-badge {
        background-color: var(--primary-color);
        color: white;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 0.9rem;
        min-width: 80px;
        text-align: center;
        display: inline-block;
      }
      .customer-value-badge {
        background-color: var(--success-color);
        color: white;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 0.9rem;
        min-width: 120px;
        text-align: center;
        font-weight: 700;
      }
      .orders-list-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        background-color: #fafafa;
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
      }
      .orders-list-content.active {
        max-height: 2500px;
        padding: 20px;
        transition: max-height 0.7s ease-in;
      }
      .customer-details-section {
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-bottom: 1px dashed #ddd;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 20px;
      }
      .customer-details-section p {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
        font-size: 0.95rem;
        color: #555;
      }
      .customer-details-section p a {
        color: var(--info-color);
        font-weight: 600;
        text-decoration: none;
      }
      .customer-details-section p a:hover {
        text-decoration: underline;
      }
      .customer-details-section strong {
        color: var(--dark-color);
      }
      .admin-notes-section {
        margin-top: 20px;
      }
      .admin-notes-section h4 {
        margin-bottom: 10px;
        color: var(--dark-color);
      }
      .admin-notes-section textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-family: "Cairo", sans-serif;
        min-height: 80px;
      }
      .admin-notes-section .btn {
        margin-top: 10px;
      }
      .order-details-card {
        background-color: var(--white-color);
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .order-details-card.ready {
        border-right: 4px solid var(--success-color);
      }
      .order-details-card.custom {
        border-right: 4px solid var(--info-color);
      }
      .ai-advisor-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed #ddd;
      }
      .ai-advisor-section h4 {
        color: var(--dark-color);
      }
      .ai-advisor-section .btn {
        background-color: var(--info-color);
      }
      .ai-advisor-results {
        background-color: var(--white-color);
        border: 1px solid var(--info-color);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        display: none;
      }
      .ai-advisor-results ul {
        padding-right: 20px;
        margin: 0;
      }
      .ai-advisor-results li {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
      }

      .delete-customer-btn {
        padding: 5px 10px;
        font-size: 0.9rem;
        line-height: 1.2;
        background-color: #fbe9e7;
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
      }
      .delete-customer-btn:hover {
        background-color: var(--danger-color);
        color: white;
      }
      .delete-customer-btn i {
        pointer-events: none;
      }

      /* تنسيق ملخص الفئات */
      #segment-summary-card {
        background-color: var(--white-color);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
      }
      #segment-summary-card h3 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        font-size: 1.2rem;
      }
      .segment-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }
      .segment-summary-item {
        background-color: var(--light-color);
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }
      .segment-summary-item p {
        margin: 0;
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--dark-color);
      }
      .segment-summary-item span {
        font-size: 0.9rem;
        font-weight: 600;
      }
      /* تطبيق الألوان على الملخص */
      .segment-summary-item.vip span {
        color: #c0392b;
      }
      .segment-summary-item.loyal span {
        color: var(--success-color);
      }
      .segment-summary-item.promising span {
        color: var(--info-color);
      }
      .segment-summary-item.new span {
        color: #16a085;
      }
      .segment-summary-item.at-risk span {
        color: var(--warning-color);
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> لوحة التحكم</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> إدارة الطلبات</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> إدارة المنتجات</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> المواد الخام</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html"
              ><i class="fa-solid fa-truck-fast"></i> الموردين</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> التكاليف</a
            >
          </li>
          <li>
            <a href="customers_admin.html" class="active"
              ><i class="fa-solid fa-users"></i> العملاء</a
            >
          </li>
          <li>
            <a href="strategy_admin.html"
              ><i class="fa-solid fa-lightbulb"></i> الاستراتيجية</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> خروج</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>إدارة العملاء (CRM)</h1>

      <div class="admin-panel">
        <div id="customer-stats">
          <div class="stat-card">
            <h4>إجمالي العملاء</h4>
            <p id="total-customers-count">0</p>
          </div>
          <div class="stat-card" style="border-color: var(--info-color)">
            <h4>عملاء بطلبات نشطة</h4>
            <p id="active-customers-count">0</p>
          </div>
          <div class="stat-card" style="border-color: var(--success-color)">
            <h4>إجمالي الإيرادات المكتملة</h4>
            <p id="total-revenue-count" class="small-text">0 ₪</p>
          </div>
          <div class="stat-card" style="border-color: var(--danger-color)">
            <h4>متوسط قيمة العميل (LTV)</h4>
            <p id="average-customer-value" class="small-text">0 ₪</p>
          </div>
        </div>

        <div id="segment-summary-card">
          <h3>
            <i class="fa-solid fa-users-gear"></i> ملخص فئات العملاء (من النظام
            المركزي)
          </h3>
          <div class="segment-summary-grid" id="segment-summary-grid"></div>
        </div>

        <div class="customer-header-controls">
          <i class="fa-solid fa-magnifying-glass" style="color: #999"></i>
          <input
            type="text"
            id="customer-search"
            placeholder="ابحث بالاسم أو البريد الإلكتروني أو الهاتف..."
          />
          <select id="customer-sort">
            <option value="default">فرز حسب: الأحدث تسجيلاً</option>
            <option value="spending">فرز حسب: الأكثر إنفاقاً</option>
            <option value="orders">فرز حسب: الأكثر طلباً</option>
          </select>
          <button id="refresh-data-btn">
            <i class="fa-solid fa-rotate-right"></i> تحديث البيانات
          </button>
        </div>

        <div id="customers-list-container">
          <p class="loading-msg">جارٍ تحميل بيانات العملاء...</p>
        </div>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 500px">
        <span class="modal-close" data-modal="confirmation-modal"
          ><i class="fa-solid fa-xmark"></i
        ></span>
        <h2 id="confirm-title">تأكيد الحذف</h2>
        <p
          id="confirm-message"
          style="text-align: center; margin-bottom: 2rem; line-height: 1.7"
        ></p>
        <div class="btn-group" style="justify-content: center">
          <button id="confirm-action-btn" class="btn btn-danger">
            نعم، قم بالحذف
          </button>
          <button
            class="btn btn-secondary"
            id="confirm-cancel-btn"
            style="background-color: #777"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        query,
        where,
        updateDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

      // إعدادات Gemini API (للمستشار الذكي فقط - النصائح)
      const API_KEY = "AIzaSyAgqtZVBiwfZqsyweNdSVb-HvHTwDNxefU";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const aiModel = genAI.getGenerativeModel({
        model: "gemini-2.5-flash-lite",
      });

      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const customersListContainer = document.getElementById(
        "customers-list-container"
      );
      const searchInput = document.getElementById("customer-search");
      const sortSelect = document.getElementById("customer-sort");
      const refreshBtn = document.getElementById("refresh-data-btn");

      let allCustomersData = [];

      // دوال النافذة المنبثقة
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document
        .querySelector("#confirmation-modal .modal-close")
        .addEventListener("click", () => closeModal("confirmation-modal"));
      document
        .getElementById("confirm-cancel-btn")
        .addEventListener("click", () => closeModal("confirmation-modal"));

      // دالة تحديد لون الشارة حسب الفئة
      function getSegmentClass(segmentName) {
        if (!segmentName) return "unclassified";
        if (segmentName.includes("VIP") || segmentName.includes("أبطال"))
          return "vip";
        if (segmentName.includes("مخلص")) return "loyal";
        if (segmentName.includes("واعد")) return "promising";
        if (segmentName.includes("جديد")) return "new";
        if (segmentName.includes("خطر")) return "at-risk";
        if (segmentName.includes("خامل")) return "hibernating";
        if (segmentName.includes("عادي")) return "regular";
        return "unclassified";
      }

      // تحديث الإحصائيات
      function updateCustomerStats(customers, allOrders) {
        const completedOrders = allOrders.filter((o) => o.status === "مكتمل");
        const totalRevenue = completedOrders.reduce(
          (sum, o) => sum + parseFloat(o.total || o.final_price || 0),
          0
        );
        const totalCustomers = customers.length > 0 ? customers.length : 1;
        const avgValue = totalRevenue / totalCustomers;
        document.getElementById("total-customers-count").textContent =
          customers.length;
        document.getElementById(
          "total-revenue-count"
        ).textContent = `${totalRevenue.toFixed(0)} ₪`;
        document.getElementById(
          "average-customer-value"
        ).textContent = `${avgValue.toFixed(0)} ₪`;

        const activeStatuses = [
          "قيد المراجعة",
          "مقبول",
          "مقبول-العميل",
          "قيد التصنيع",
          "قيد الطلاء",
          "قيد التغليف",
          "قيد الشحن",
        ];
        const activeOrderUids = new Set(
          allOrders
            .filter((order) => activeStatuses.includes(order.status))
            .map((order) => order.customer_uid)
        );
        document.getElementById("active-customers-count").textContent =
          activeOrderUids.size;
      }

      // عرض ملخص الفئات
      function renderSegmentSummary(customers) {
        const grid = document.getElementById("segment-summary-grid");
        const segmentCounts = {};
        customers.forEach((customer) => {
          const segment = customer.customerSegment || "غير مصنف";
          segmentCounts[segment] = (segmentCounts[segment] || 0) + 1;
        });
        const sortedSegments = Object.entries(segmentCounts).sort(
          (a, b) => b[1] - a[1]
        );

        grid.innerHTML = "";
        if (sortedSegments.length === 0) {
          grid.innerHTML = "<p>لم يتم العثور على بيانات للتصنيف.</p>";
          return;
        }
        sortedSegments.forEach(([name, count]) => {
          const cssClass = getSegmentClass(name);
          const item = document.createElement("div");
          item.className = `segment-summary-item ${cssClass}`;
          item.innerHTML = `
            <p>${count}</p>
            <span class="segment-name">${name}</span>
          `;
          grid.appendChild(item);
        });
      }

      // جلب البيانات (يقرأ التصنيف الجاهز من DB)
      async function fetchAndRenderCustomers() {
        customersListContainer.innerHTML =
          '<p class="loading-msg"><i class="fa-solid fa-spinner fa-spin"></i> جارٍ تحميل بيانات العملاء...</p>';
        try {
          const usersQuery = query(
            collection(db, "users"),
            where("role", "!=", "admin")
          );
          const usersSnapshot = await getDocs(usersQuery);
          const customers = usersSnapshot.docs.map((doc) => ({
            uid: doc.id,
            ...doc.data(),
          }));

          const ordersSnap = await getDocs(collection(db, "orders"));
          const customSnap = await getDocs(collection(db, "custom_designs"));

          const allOrders = [
            ...ordersSnap.docs.map((d) => ({
              id: d.id,
              type: "ready",
              order_date: d.data().order_date || "2000-01-01",
              ...d.data(),
            })),
            ...customSnap.docs.map((d) => ({
              id: d.id,
              type: "custom",
              order_date: d.data().order_date || "2000-01-01",
              ...d.data(),
            })),
          ];

          allCustomersData = customers.map((customer) => {
            const customerOrders = allOrders
              .filter((order) => order.customer_uid === customer.uid)
              .sort((a, b) => new Date(b.order_date) - new Date(a.order_date));

            const totalSpending = customerOrders
              .filter((o) => o.status === "مكتمل")
              .reduce(
                (sum, o) => sum + parseFloat(o.total || o.final_price || 0),
                0
              );

            return {
              ...customer,
              orders: customerOrders,
              orderCount: customerOrders.length,
              totalSpending: totalSpending,
              // هنا التغيير الجوهري: نقرأ فقط، ولا نحسب
              customerSegment: customer.customerSegment || "غير مصنف",
              admin_notes: customer.admin_notes || "",
            };
          });

          allCustomersData.sort((a, b) => (a.uid > b.uid ? -1 : 1));

          updateCustomerStats(customers, allOrders);
          renderSegmentSummary(allCustomersData);
          renderCustomersList(allCustomersData);
          setupSearchAndSortListeners();
        } catch (e) {
          console.error("Error fetching customer data: ", e);
          customersListContainer.innerHTML =
            '<p class="loading-msg" style="color: red;">حدث خطأ في جلب بيانات العملاء.</p>';
        }
      }

      // عرض القائمة (تصميم البطاقات والأكورديون)
      function renderCustomersList(customersToRender) {
        if (customersToRender.length === 0) {
          customersListContainer.innerHTML =
            '<p style="text-align: center; color: #999; margin-top: 30px;">لا توجد نتائج مطابقة.</p>';
          return;
        }
        let listHtml = "";
        customersToRender.forEach((customer) => {
          const orderCount = customer.orderCount;
          const lastOrderDate =
            orderCount > 0
              ? new Date(customer.orders[0].order_date).toLocaleDateString(
                  "ar-EG"
                )
              : "لا يوجد";
          const segmentName = customer.customerSegment;
          const segmentClass = getSegmentClass(segmentName);
          const customerName = customer.name || "عميل غير معروف";

          listHtml += `
            <div class="customer-accordion-item">
                <div class="customer-info-header" data-uid="${
                  customer.uid
                }" aria-expanded="false" role="button">
                    <div class="customer-main-details">
                        <i class="fa-solid fa-circle-user customer-avatar-icon"></i>
                        ${customerName}
                    </div>
                    <div class="customer-badges">
                        <span class="customer-segment-badge ${segmentClass}">${segmentName}</span>
                        <span class="orders-count-badge">${orderCount} طلب</span>
                        <span class="customer-value-badge">${customer.totalSpending.toFixed(
                          0
                        )} ₪</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-right: auto; padding-right: 20px;">
                        <button class="btn btn-danger btn-sm delete-customer-btn" 
                                data-uid="${customer.uid}" 
                                data-name="${customerName}" 
                                title="حذف العميل">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <i class="fa-solid fa-chevron-left accordion-toggle-icon"></i>
                    </div>
                </div>
                <div class="orders-list-content" id="orders-content-${
                  customer.uid
                }">
                    <div class="customer-details-section">
                        <p><strong><i class="fa-solid fa-envelope"></i> البريد الإلكتروني:</strong> 
                            <a href="mailto:${customer.email || ""}">${
            customer.email || "---"
          }</a></p>
                        <p><strong><i class="fa-solid fa-phone"></i> رقم الهاتف:</strong> 
                            <a href="tel:${customer.phone || ""}">${
            customer.phone || "---"
          }</a></p>
                        <p><strong><i class="fa-solid fa-map-marker-alt"></i> العنوان:</strong> <span>${
                          customer.address || "---"
                        }</span></p>
                        <p><strong><i class="fa-solid fa-calendar-alt"></i> آخر طلب:</strong> <span>${lastOrderDate}</span></p>
                    </div>
                    <div class="admin-notes-section">
                        <h4><i class="fa-solid fa-clipboard"></i> ملاحظات إدارية:</h4>
                        <textarea id="notes-for-${
                          customer.uid
                        }" rows="3" placeholder="أضف ملاحظة عن العميل...">${
            customer.admin_notes
          }</textarea>
                        <button class="btn btn-sm save-notes-btn" data-uid="${
                          customer.uid
                        }">
                            <i class="fa-solid fa-save"></i> حفظ الملاحظة
                        </button>
                    </div>
                    <div class="ai-advisor-section">
                        <h4><i class="fa-solid fa-brain"></i> مستشار البيانات (CRM)</h4>
                        <button class="btn btn-sm get-ai-advice-btn" data-uid="${
                          customer.uid
                        }">
                            <i class="fa-solid fa-robot"></i> تحليل سلوك العميل (نصائح)
                        </button>
                        <div class="ai-advisor-results" id="ai-results-for-${
                          customer.uid
                        }"></div>
                    </div>
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--dark-color); padding-top: 5px;">سجل الطلبات</h4>
                    ${
                      orderCount > 0
                        ? renderCustomerOrders(customer.orders)
                        : '<p style="text-align: center; color: #999; padding-bottom: 15px;">لم يقم العميل بطلب أي منتجات بعد.</p>'
                    }
                </div>
            </div>
          `;
        });
        customersListContainer.innerHTML = listHtml;
        setupAccordionAndNotesListeners();
      }

      // بناء بطاقات الطلبات (كما في التصميم القديم)
      function renderCustomerOrders(orders) {
        return orders
          .map((order) => {
            const totalDisplay =
              order.type === "ready"
                ? `الإجمالي: ${parseFloat(order.total || 0).toFixed(0)} ₪`
                : `السعر المقترح: ${parseFloat(
                    order.final_price || order.initial_price || 0
                  ).toFixed(0)} ₪`;
            const typeClass = order.type === "ready" ? "ready" : "custom";
            const productInfo =
              order.type === "ready"
                ? `المنتج: ${order.items[0].name} ${
                    order.items.length > 1
                      ? `و ${order.items.length - 1} آخر`
                      : ""
                  }`
                : `نوع التصميم: ${order.type_of_product || "---"}`;
            const getStatusBadge = (status) => {
              const statusClass = status.replace(/\s+/g, "-");
              return `<span class="status-badge ${statusClass}">${status}</span>`;
            };
            return `
              <div class="order-details-card ${typeClass}">
                  <p><strong><i class="fa-solid fa-receipt"></i> رقم الطلب:</strong> ${
                    order.id
                  }</p>
                  <p><strong><i class="fa-solid fa-box"></i> ${productInfo}</strong></p>
                  <p><strong><i class="fa-solid fa-calendar"></i> التاريخ:</strong> ${new Date(
                    order.order_date
                  ).toLocaleDateString("ar-EG")}</p>
                  <p><strong><i class="fa-solid fa-tag"></i> الحالة:</strong> ${getStatusBadge(
                    order.status
                  )}</p>
                  <p><strong><i class="fa-solid fa-money-bill-wave"></i> ${totalDisplay}</strong></p>
              </div>
            `;
          })
          .join("");
      }

      function setupSearchAndSortListeners() {
        searchInput.addEventListener("input", applyFiltersAndSort);
        sortSelect.addEventListener("change", applyFiltersAndSort);
        // تفعيل زر التحديث
        refreshBtn.addEventListener("click", fetchAndRenderCustomers);
      }

      function applyFiltersAndSort() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const sortBy = sortSelect.value;
        let filteredCustomers = allCustomersData;
        if (searchTerm !== "") {
          filteredCustomers = allCustomersData.filter((customer) => {
            const name = (customer.name || "").toLowerCase();
            const email = (customer.email || "").toLowerCase();
            const phone = (customer.phone || "").toLowerCase();
            return (
              name.includes(searchTerm) ||
              email.includes(searchTerm) ||
              phone.includes(searchTerm)
            );
          });
        }
        if (sortBy === "spending") {
          filteredCustomers.sort((a, b) => b.totalSpending - a.totalSpending);
        } else if (sortBy === "orders") {
          filteredCustomers.sort((a, b) => b.orderCount - a.orderCount);
        } else {
          filteredCustomers.sort((a, b) => (a.uid > b.uid ? -1 : 1));
        }
        renderCustomersList(filteredCustomers);
      }

      function setupAccordionAndNotesListeners() {
        document.querySelectorAll(".customer-info-header").forEach((header) => {
          header.removeEventListener("click", toggleAccordion);
          header.addEventListener("click", toggleAccordion);
        });
        document.querySelectorAll(".save-notes-btn").forEach((button) => {
          button.removeEventListener("click", saveAdminNote);
          button.addEventListener("click", saveAdminNote);
        });
        document.querySelectorAll(".get-ai-advice-btn").forEach((button) => {
          button.removeEventListener("click", getAiAdvice);
          button.addEventListener("click", getAiAdvice);
        });
        document.querySelectorAll(".delete-customer-btn").forEach((button) => {
          button.removeEventListener("click", handleDeleteCustomerClick);
          button.addEventListener("click", handleDeleteCustomerClick);
        });
      }

      function showConfirmationModal(title, message, callback) {
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        const confirmBtn = document.getElementById("confirm-action-btn");
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener("click", () => {
          callback();
          closeModal("confirmation-modal");
        });
        openModal("confirmation-modal");
      }

      function handleDeleteCustomerClick(e) {
        e.stopPropagation();
        const uid = e.currentTarget.dataset.uid;
        const name = e.currentTarget.dataset.name;
        showConfirmationModal(
          "تأكيد حذف العميل",
          `هل أنت متأكد من حذف العميل "${name}"؟\n\n⚠️ ملاحظة: سيتم حذف حساب العميل فقط.`,
          () => deleteCustomer(uid)
        );
      }

      async function deleteCustomer(uid) {
        try {
          await deleteDoc(doc(db, "users", uid));
          alert("تم حذف العميل بنجاح.");
          fetchAndRenderCustomers();
        } catch (err) {
          console.error("Error deleting customer: ", err);
          alert("حدث خطأ أثناء حذف العميل.");
        }
      }

      async function saveAdminNote(e) {
        const button = e.currentTarget;
        const uid = button.dataset.uid;
        const noteText = document.getElementById(`notes-for-${uid}`).value;
        button.disabled = true;
        button.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> جارٍ الحفظ...';
        try {
          const userRef = doc(db, "users", uid);
          await updateDoc(userRef, { admin_notes: noteText });
          const customer = allCustomersData.find((c) => c.uid === uid);
          if (customer) customer.admin_notes = noteText;
          button.innerHTML = '<i class="fa-solid fa-check"></i> تم الحفظ!';
          setTimeout(() => {
            button.innerHTML = '<i class="fa-solid fa-save"></i> حفظ الملاحظة';
            button.disabled = false;
          }, 2000);
        } catch (err) {
          console.error("Error saving note: ", err);
          alert("حدث خطأ أثناء حفظ الملاحظة.");
          button.innerHTML = '<i class="fa-solid fa-save"></i> حفظ الملاحظة';
          button.disabled = false;
        }
      }

      // دالة المستشار الذكي (CRM Tips) - بقيت كما هي لتقديم النصائح
      async function getAiAdvice(e) {
        const button = e.currentTarget;
        const uid = button.dataset.uid;
        const customer = allCustomersData.find((c) => c.uid === uid);
        const resultsContainer = document.getElementById(
          `ai-results-for-${uid}`
        );
        if (!customer) return;

        button.disabled = true;
        button.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> جارٍ التحليل...';
        resultsContainer.style.display = "block";
        resultsContainer.innerHTML =
          '<p class="loading-msg"><i class="fa-solid fa-spinner fa-spin"></i> ... يفكر المحلل</p>';

        try {
          const lastOrderDate =
            customer.orderCount > 0
              ? new Date(customer.orders[0].order_date).toLocaleDateString(
                  "ar-EG"
                )
              : "لا يوجد";

          const prompt = `
            أنت خبير في تحليل بيانات العملاء (CRM).
            العميل: ${customer.name}
            تصنيفه: ${customer.customerSegment}
            إنفاقه: ${customer.totalSpending}
            آخر طلب: ${lastOrderDate}
            لا تكتب اي شيء سوى:
            وفسر كل تحليل وخذ بعين الاعتبار كل العوامل 
            قدم 3 نصائح عملية قصيرة للمدير لزيادة ولاء هذا العميل أو زيادة مبيعاته.
            `;

          const result = await aiModel.generateContent(prompt);
          const response = result.response.text().trim();
          resultsContainer.innerHTML = response
            .replace(/\*/g, "")
            .replace(/\n/g, "<br>");
        } catch (error) {
          console.error("Advice Error:", error);
          resultsContainer.innerHTML =
            '<p style="color: red;">حدث خطأ في جلب النصيحة.</p>';
        } finally {
          button.disabled = false;
          button.innerHTML =
            '<i class="fa-solid fa-robot"></i> إعادة تحليل السلوك';
        }
      }

      function toggleAccordion(e) {
        if (e.target.classList.contains("delete-customer-btn")) return;
        const header = e.currentTarget;
        const contentId = `orders-content-${header.dataset.uid}`;
        const content = document.getElementById(contentId);
        const isExpanded = header.getAttribute("aria-expanded") === "true";
        document
          .querySelectorAll(".customer-info-header[aria-expanded='true']")
          .forEach((h) => {
            if (h !== header) {
              h.setAttribute("aria-expanded", "false");
              document
                .getElementById(`orders-content-${h.dataset.uid}`)
                .classList.remove("active");
            }
          });
        if (isExpanded) {
          header.setAttribute("aria-expanded", "false");
          content.classList.remove("active");
        } else {
          header.setAttribute("aria-expanded", "true");
          content.classList.add("active");
        }
      }

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchAndRenderCustomers();
          } else {
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });
    </script>
  </body>
</html>
