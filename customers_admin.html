<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      .customer-header-controls {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        align-items: center;
      }
      #customer-search {
        flex-grow: 1;
        padding: 12px 20px 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
      }
      #customer-search:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.1);
      }
      #customer-sort {
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        background-color: #f9f9f9;
        min-width: 180px;
      }
      #customer-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .stat-card {
        background-color: var(--white-color);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        border-right: 4px solid var(--primary-color);
      }
      .stat-card h4 {
        font-size: 0.9rem;
        color: #777;
        margin-bottom: 5px;
      }
      .stat-card p {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark-color);
        margin: 0;
      }
      .stat-card .small-text {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dark-color);
      }
      .customer-accordion-item {
        margin-bottom: 12px;
        border: 1px solid #eee;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
      }
      .customer-accordion-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .customer-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background-color: var(--white-color);
        cursor: pointer;
        font-weight: 700;
        border-radius: 8px;
        flex-wrap: wrap;
      }
      .customer-info-header[aria-expanded="true"] {
        border-radius: 8px 8px 0 0;
        background-color: var(--light-color);
      }
      .customer-main-details {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1rem;
        color: var(--dark-color);
        flex-grow: 1;
      }
      .customer-avatar-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
      }
      .customer-badges {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: 20px;
      }
      .customer-segment-badge {
        background-color: var(--accent-1);
        color: white;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .customer-segment-badge.vip {
        background-color: var(--danger-color);
      }
      .customer-segment-badge.at-risk {
        background-color: var(--warning-color);
      }
      .orders-count-badge {
        background-color: var(--primary-color);
        color: white;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 0.9rem;
        min-width: 80px;
        text-align: center;
        display: inline-block;
      }
      .customer-value-badge {
        background-color: var(--success-color);
        color: white;
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 0.9rem;
        min-width: 120px;
        text-align: center;
        font-weight: 700;
      }
      .orders-list-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        background-color: #fafafa;
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
      }
      .orders-list-content.active {
        max-height: 2500px;
        padding: 20px;
        transition: max-height 0.7s ease-in;
      }
      .customer-details-section {
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-bottom: 1px dashed #ddd;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 20px;
      }
      .customer-details-section p {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
        font-size: 0.95rem;
        color: #555;
      }
      .customer-details-section p a {
        color: var(--info-color);
        font-weight: 600;
        text-decoration: none;
      }
      .customer-details-section p a:hover {
        text-decoration: underline;
      }
      .customer-details-section strong {
        color: var(--dark-color);
      }
      .admin-notes-section {
        margin-top: 20px;
      }
      .admin-notes-section h4 {
        margin-bottom: 10px;
        color: var(--dark-color);
      }
      .admin-notes-section textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-family: "Cairo", sans-serif;
        min-height: 80px;
      }
      .admin-notes-section .btn {
        margin-top: 10px;
      }
      .order-details-card {
        background-color: var(--white-color);
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .order-details-card.ready {
        border-right: 4px solid var(--success-color);
      }
      .order-details-card.custom {
        border-right: 4px solid var(--info-color);
      }
      /* ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ */
      .ai-advisor-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px dashed #ddd;
      }
      .ai-advisor-section .btn {
        background-color: var(--info-color);
      }
      .ai-advisor-results {
        background-color: var(--white-color);
        border: 1px solid var(--info-color);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
      }
      .ai-advisor-results ul {
        padding-right: 20px;
        margin: 0;
      }
      .ai-advisor-results li {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html"
              ><i class="fa-solid fa-truck-fast"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</a
            >
          </li>
          <li>
            <a href="customers_admin.html" class="active"
              ><i class="fa-solid fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)</h1>

      <div class="admin-panel">
        <div id="customer-stats">
          <div class="stat-card">
            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
            <p id="total-customers-count">0</p>
          </div>
          <div class="stat-card" style="border-color: var(--info-color)">
            <h4>Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</h4>
            <p id="active-customers-count">0</p>
          </div>
          <div class="stat-card" style="border-color: var(--success-color)">
            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h4>
            <p id="total-revenue-count" class="small-text">0 â‚ª</p>
          </div>
          <div class="stat-card" style="border-color: var(--danger-color)">
            <h4>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (LTV)</h4>
            <p id="average-customer-value" class="small-text">0 â‚ª</p>
          </div>
        </div>

        <div class="customer-header-controls">
          <i class="fa-solid fa-magnifying-glass" style="color: #999"></i>
          <input
            type="text"
            id="customer-search"
            placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..."
          />
          <select id="customer-sort">
            <option value="default">ÙØ±Ø² Ø­Ø³Ø¨: Ø§Ù„Ø£Ø­Ø¯Ø« ØªØ³Ø¬ÙŠÙ„Ø§Ù‹</option>
            <option value="spending">ÙØ±Ø² Ø­Ø³Ø¨: Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†ÙØ§Ù‚Ø§Ù‹</option>
            <option value="orders">ÙØ±Ø² Ø­Ø³Ø¨: Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</option>
          </select>
        </div>

        <div id="customers-list-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        query,
        where,
        updateDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

      // ğŸ›‘ ğŸ’¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Gemini AI
      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const aiModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

      // ØªÙ‡ÙŠØ¦Ø© Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const customersListContainer = document.getElementById(
        "customers-list-container"
      );
      const searchInput = document.getElementById("customer-search");
      const sortSelect = document.getElementById("customer-sort");

      let allCustomersData = [];

      // --------------------------------------------------------
      // (Ù…Ø¹Ø¯Ù„) ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      // --------------------------------------------------------
      function updateCustomerStats(customers, allOrders) {
        const completedOrders = allOrders.filter((o) => o.status === "Ù…ÙƒØªÙ…Ù„");
        const totalRevenue = completedOrders.reduce(
          (sum, o) => sum + parseFloat(o.total || o.final_price || 0),
          0
        );
        const totalCustomers = customers.length > 0 ? customers.length : 1;
        const avgValue = totalRevenue / totalCustomers;

        document.getElementById("total-customers-count").textContent =
          customers.length;
        document.getElementById(
          "total-revenue-count"
        ).textContent = `${totalRevenue.toFixed(0)} â‚ª`;
        document.getElementById(
          "average-customer-value"
        ).textContent = `${avgValue.toFixed(0)} â‚ª`;

        const activeStatuses = [
          "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
          "Ù…Ù‚Ø¨ÙˆÙ„",
          "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
        ];
        const activeOrderUids = new Set(
          allOrders
            .filter((order) => activeStatuses.includes(order.status))
            .map((order) => order.customer_uid)
        );
        document.getElementById("active-customers-count").textContent =
          activeOrderUids.size;
      }

      // --------------------------------------------------------
      // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
      // --------------------------------------------------------
      async function fetchAndRenderCustomers() {
        customersListContainer.innerHTML =
          '<p class="loading-msg"><i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>';
        try {
          // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
          const usersQuery = query(
            collection(db, "users"),
            where("role", "!=", "admin")
          );
          const usersSnapshot = await getDocs(usersQuery);
          const customers = usersSnapshot.docs.map((doc) => ({
            uid: doc.id,
            ...doc.data(),
          }));

          // 2. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          const ordersSnap = await getDocs(collection(db, "orders"));
          const customSnap = await getDocs(collection(db, "custom_designs"));

          const allOrders = [
            ...ordersSnap.docs.map((d) => ({
              id: d.id,
              type: "ready",
              order_date: d.data().order_date || "2000-01-01",
              ...d.data(),
            })),
            ...customSnap.docs.map((d) => ({
              id: d.id,
              type: "custom",
              order_date: d.data().order_date || "2000-01-01",
              ...d.data(),
            })),
          ];

          // 3. Ø¯Ù…Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
          allCustomersData = customers.map((customer) => {
            const customerOrders = allOrders
              .filter((order) => order.customer_uid === customer.uid)
              .sort((a, b) => new Date(b.order_date) - new Date(a.order_date));

            const totalSpending = customerOrders
              .filter((o) => o.status === "Ù…ÙƒØªÙ…Ù„")
              .reduce(
                (sum, o) => sum + parseFloat(o.total || o.final_price || 0),
                0
              );

            return {
              ...customer,
              orders: customerOrders,
              orderCount: customerOrders.length,
              totalSpending: totalSpending,
              segment: customer.segment || "Ø¹Ù…ÙŠÙ„ Ø¹Ø§Ù…",
              admin_notes: customer.admin_notes || "",
            };
          });

          // Ø§Ù„ÙØ±Ø² Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          allCustomersData.sort((a, b) => (a.uid > b.uid ? -1 : 1));

          updateCustomerStats(customers, allOrders);
          renderCustomersList(allCustomersData);
          setupSearchAndSortListeners();
        } catch (e) {
          console.error("Error fetching customer data: ", e);
          customersListContainer.innerHTML =
            '<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.</p>';
        }
      }

      // --------------------------------------------------------
      // (Ù…Ø¹Ø¯Ù„) ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
      // --------------------------------------------------------
      function renderCustomersList(customersToRender) {
        if (customersToRender.length === 0) {
          customersListContainer.innerHTML =
            '<p style="text-align: center; color: #999; margin-top: 30px;"><i class="fa-solid fa-exclamation-triangle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ø­Ø«.</p>';
          return;
        }

        let listHtml = "";

        customersToRender.forEach((customer) => {
          const orderCount = customer.orderCount;
          const lastOrderDate =
            orderCount > 0
              ? new Date(customer.orders[0].order_date).toLocaleDateString(
                  "ar-EG"
                )
              : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";

          let segmentClass = "";
          if (customer.segment === "VIP") segmentClass = "vip";
          if (customer.segment === "At Risk") segmentClass = "at-risk";

          listHtml += `
            <div class="customer-accordion-item">
                <div class="customer-info-header" data-uid="${
                  customer.uid
                }" aria-expanded="false" role="button">
                    <div class="customer-main-details">
                        <i class="fa-solid fa-circle-user customer-avatar-icon"></i>
                        ${customer.name || "Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}
                    </div>
                    
                    <div class="customer-badges">
                        <span class="customer-segment-badge ${segmentClass}">${
            customer.segment
          }</span>
                        <span class="orders-count-badge">${orderCount} Ø·Ù„Ø¨</span>
                        <span class="customer-value-badge">${customer.totalSpending.toFixed(
                          0
                        )} â‚ª</span>
                    </div>

                    <div style="display: flex; gap: 15px; align-items: center;">
                        <i class="fa-solid fa-chevron-left accordion-toggle-icon"></i>
                    </div>
                </div>
                
                <div class="orders-list-content" id="orders-content-${
                  customer.uid
                }">
                    <div class="customer-details-section">
                        <p><strong><i class="fa-solid fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> 
                            <a href="mailto:${customer.email || ""}">${
            customer.email || "---"
          }</a></p>
                        <p><strong><i class="fa-solid fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> 
                            <a href="tel:${customer.phone || ""}">${
            customer.phone || "---"
          }</a></p>
                        <p><strong><i class="fa-solid fa-map-marker-alt"></i> Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span>${
                          customer.address || "---"
                        }</span></p>
                        <p><strong><i class="fa-solid fa-calendar-alt"></i> Ø¢Ø®Ø± Ø·Ù„Ø¨:</strong> <span>${lastOrderDate}</span></p>
                    </div>
                    
                    <div class="admin-notes-section">
                        <h4><i class="fa-solid fa-clipboard"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©:</h4>
                        <textarea id="notes-for-${
                          customer.uid
                        }" rows="3" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„...">${
            customer.admin_notes
          }</textarea>
                        <button class="btn btn-sm save-notes-btn" data-uid="${
                          customer.uid
                        }">
                            <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
                        </button>
                    </div>

                    <div class="ai-advisor-section">
                        <h4><i class="fa-solid fa-brain"></i> Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ (CRM)</h4>
                        <button class="btn btn-sm get-ai-advice-btn" data-uid="${
                          customer.uid
                        }">
                            <i class="fa-solid fa-robot"></i> ØªØ­Ù„ÙŠÙ„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¹Ù…ÙŠÙ„ (AI)
                        </button>
                        <div class="ai-advisor-results" id="ai-results-for-${
                          customer.uid
                        }">
                            </div>
                    </div>
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--dark-color); padding-top: 5px;">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
                    ${
                      orderCount > 0
                        ? renderCustomerOrders(customer.orders)
                        : '<p style="text-align: center; color: #999; padding-bottom: 15px;">Ù„Ù… ÙŠÙ‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø·Ù„Ø¨ Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</p>'
                    }
                </div>
            </div>
          `;
        });

        customersListContainer.innerHTML = listHtml;
        setupAccordionAndNotesListeners();
      }

      // --------------------------------------------------------
      // ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
      // --------------------------------------------------------
      function renderCustomerOrders(orders) {
        // (Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ - Ù„Ù… ØªØªØºÙŠØ±)
        return orders
          .map((order) => {
            const totalDisplay =
              order.type === "ready"
                ? `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${parseFloat(order.total || 0).toFixed(0)} â‚ª`
                : `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${parseFloat(
                    order.final_price || order.initial_price || 0
                  ).toFixed(0)} â‚ª`;
            const typeClass = order.type === "ready" ? "ready" : "custom";
            const productInfo =
              order.type === "ready"
                ? `Ø§Ù„Ù…Ù†ØªØ¬: ${order.items[0].name} ${
                    order.items.length > 1
                      ? `Ùˆ ${order.items.length - 1} Ø¢Ø®Ø±`
                      : ""
                  }`
                : `Ù†ÙˆØ¹ Ø§Ù„ØªØµÙ…ÙŠÙ…: ${order.type_of_product || "---"}`;
            const getStatusBadge = (status) => {
              const statusClass = status.replace(/\s+/g, "-");
              return `<span class="status-badge ${statusClass}">${status}</span>`;
            };
            return `
              <div class="order-details-card ${typeClass}">
                  <p><strong><i class="fa-solid fa-receipt"></i> Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${
                    order.id
                  }</p>
                  <p><strong><i class="fa-solid fa-box"></i> ${productInfo}</strong></p>
                  <p><strong><i class="fa-solid fa-calendar"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(
                    order.order_date
                  ).toLocaleDateString("ar-EG")}</p>
                  <p><strong><i class="fa-solid fa-tag"></i> Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${getStatusBadge(
                    order.status
                  )}</p>
                  <p><strong><i class="fa-solid fa-money-bill-wave"></i> ${totalDisplay}</strong></p>
              </div>
            `;
          })
          .join("");
      }

      // --------------------------------------------------------
      // (Ù…Ø¹Ø¯Ù„) Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙØ±Ø²
      // --------------------------------------------------------
      function setupSearchAndSortListeners() {
        searchInput.addEventListener("input", applyFiltersAndSort);
        sortSelect.addEventListener("change", applyFiltersAndSort);
      }

      function applyFiltersAndSort() {
        // (Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ - Ù„Ù… ØªØªØºÙŠØ±)
        const searchTerm = searchInput.value.toLowerCase().trim();
        const sortBy = sortSelect.value;
        let filteredCustomers = allCustomersData;

        if (searchTerm !== "") {
          filteredCustomers = allCustomersData.filter((customer) => {
            const name = (customer.name || "").toLowerCase();
            const email = (customer.email || "").toLowerCase();
            const phone = (customer.phone || "").toLowerCase();
            return (
              name.includes(searchTerm) ||
              email.includes(searchTerm) ||
              phone.includes(searchTerm)
            );
          });
        }

        if (sortBy === "spending") {
          filteredCustomers.sort((a, b) => b.totalSpending - a.totalSpending);
        } else if (sortBy === "orders") {
          filteredCustomers.sort((a, b) => b.orderCount - a.orderCount);
        } else {
          filteredCustomers.sort((a, b) => (a.uid > b.uid ? -1 : 1));
        }

        renderCustomersList(filteredCustomers);
      }

      // --------------------------------------------------------
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ†ØŒ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
      // --------------------------------------------------------
      function setupAccordionAndNotesListeners() {
        document.querySelectorAll(".customer-info-header").forEach((header) => {
          header.removeEventListener("click", toggleAccordion);
          header.addEventListener("click", toggleAccordion);
        });

        document.querySelectorAll(".save-notes-btn").forEach((button) => {
          button.removeEventListener("click", saveAdminNote);
          button.addEventListener("click", saveAdminNote);
        });

        // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ
        document.querySelectorAll(".get-ai-advice-btn").forEach((button) => {
          button.removeEventListener("click", getAiAdvice);
          button.addEventListener("click", getAiAdvice);
        });
      }

      async function saveAdminNote(e) {
        // (Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ - Ù„Ù… ØªØªØºÙŠØ±)
        const button = e.currentTarget;
        const uid = button.dataset.uid;
        const noteText = document.getElementById(`notes-for-${uid}`).value;
        button.disabled = true;
        button.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
        try {
          const userRef = doc(db, "users", uid);
          await updateDoc(userRef, {
            admin_notes: noteText,
          });
          const customer = allCustomersData.find((c) => c.uid === uid);
          if (customer) customer.admin_notes = noteText;
          button.innerHTML = '<i class="fa-solid fa-check"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸!';
          setTimeout(() => {
            button.innerHTML = '<i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©';
            button.disabled = false;
          }, 2000);
        } catch (err) {
          console.error("Error saving note: ", err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.");
          button.innerHTML = '<i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©';
          button.disabled = false;
        }
      }

      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ
      async function getAiAdvice(e) {
        const button = e.currentTarget;
        const uid = button.dataset.uid;
        const customer = allCustomersData.find((c) => c.uid === uid);
        const resultsContainer = document.getElementById(
          `ai-results-for-${uid}`
        );

        if (!customer) {
          alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„.");
          return;
        }

        button.disabled = true;
        button.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„...';
        resultsContainer.style.display = "block";
        resultsContainer.innerHTML =
          '<p class="loading-msg" style="padding: 10px 0;"><i class="fa-solid fa-spinner fa-spin"></i> ... ÙŠÙÙƒØ± Ø§Ù„Ù…Ø­Ù„Ù„</p>';

        try {
          // 1. ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
          const lastOrderDate =
            customer.orderCount > 0
              ? new Date(customer.orders[0].order_date).toLocaleDateString(
                  "ar-EG"
                )
              : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
          const customerDataSnapshot = `
            - Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.name}
            - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚ (Ø§Ù„Ù…ÙƒØªÙ…Ù„): ${customer.totalSpending.toFixed(
              0
            )} Ø´ÙŠÙƒÙ„
            - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${customer.orderCount}
            - ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø·Ù„Ø¨: ${lastOrderDate}
            - Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹): ${customer.segment}
            - Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù†Ù‡: ${customer.admin_notes || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}
            - Ø£ÙˆÙ„ 3 Ø·Ù„Ø¨Ø§Øª Ù„Ù‡ (Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·): ${
              customer.orders
                .slice(0, 3)
                .map((o) =>
                  o.type === "ready"
                    ? o.items[0]?.name || "Ù…Ù†ØªØ¬ Ø¬Ø§Ù‡Ø²"
                    : `ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ (${o.type_of_product})`
                )
                .join("ØŒ ") || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"
            }
            `;

          // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ Prompt
          const prompt = `
            Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM) ÙÙŠ FurnAI Ø£Ø«Ø§Ø« ÙØ§Ø®Ø±Ø©.
            Ø£Ù…Ø§Ù…Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…ÙŠÙ„ ÙˆØ§Ø­Ø¯. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªÙ‚Ø¯ÙŠÙ… 3 Ù†ØµØ§Ø¦Ø­ Ø¹Ù…Ù„ÙŠØ© ÙˆÙ…Ø®ØµØµØ© Ù„Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.

            **Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:**
            ${customerDataSnapshot}

            **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**
            Ù‚Ø¯Ù… Ù„ÙŠ 3 Ù†ØµØ§Ø¦Ø­ **Ù‚ØµÙŠØ±Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©** ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø¯ÙŠØ± ØªÙ†ÙÙŠØ°Ù‡Ø§. Ø±ÙƒØ² Ø¹Ù„Ù‰:
            1.  ÙƒÙŠÙÙŠØ© Ø²ÙŠØ§Ø¯Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Up-selling / Cross-selling).
            2.  ÙƒÙŠÙÙŠØ© Ø¶Ù…Ø§Ù† ÙˆÙ„Ø§Ø¦Ù‡ (Retention).
            3.  Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡ ÙÙˆØ±ÙŠ Ù…Ø·Ù„ÙˆØ¨ (Ù…Ø«Ù„: Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ù…Ø¹Ø±Ø¶Ø§Ù‹ Ù„Ù„Ø®Ø·Ø±).

            **Ù…Ø«Ø§Ù„ Ù„Ù„Ø¥Ø®Ø±Ø§Ø¬:**
            "<ul>
              <li>Ù†ØµÙŠØ­Ø© 1...</li>
              <li>Ù†ØµÙŠØ­Ø© 2...</li>
              <li>Ù†ØµÙŠØ­Ø© 3...</li>
            </ul>"
            `;

          // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ AI
          const result = await aiModel.generateContent(prompt);
          const response = result.response.text().trim();

          resultsContainer.innerHTML = response;
        } catch (error) {
          console.error("AI Advice Error:", error);
          resultsContainer.innerHTML =
            '<p style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù†ØµÙŠØ­Ø©.</p>';
        } finally {
          button.disabled = false;
          button.innerHTML =
            '<i class="fa-solid fa-robot"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„ÙˆÙƒ (AI)';
        }
      }

      function toggleAccordion(e) {
        // (Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ - Ù„Ù… ØªØªØºÙŠØ±)
        const header = e.currentTarget;
        const contentId = `orders-content-${header.dataset.uid}`;
        const content = document.getElementById(contentId);
        const isExpanded = header.getAttribute("aria-expanded") === "true";

        document
          .querySelectorAll(".customer-info-header[aria-expanded='true']")
          .forEach((h) => {
            if (h !== header) {
              h.setAttribute("aria-expanded", "false");
              document
                .getElementById(`orders-content-${h.dataset.uid}`)
                .classList.remove("active");
            }
          });

        if (isExpanded) {
          header.setAttribute("aria-expanded", "false");
          content.classList.remove("active");
        } else {
          header.setAttribute("aria-expanded", "true");
          content.classList.add("active");
        }
      }

      // --------------------------------------------------------
      // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchAndRenderCustomers();
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });
    </script>
  </body>
</html>
