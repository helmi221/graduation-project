<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link rel="stylesheet" href="admin.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

    <style>
      /* ๐ก ุณุชุงูู ูุฎุตุต ูุตูุญุฉ ุงูุชุญููู ุจูุงุกู ุนูู admin.css */

      /* 1. ูุธุงู ุงูุชุจููุจุงุช (Tabs) */
      .tab-navigation {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 25px;
        flex-wrap: wrap; /* ููุณูุงุญ ุจุงูุงูุชูุงู ูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ */
      }
      .tab-btn {
        padding: 10px 15px;
        font-size: 0.95rem; /* ุชุตุบูุฑ ุงูุฎุท ููููุงู ููุซุฑุฉ ุงูุชุจููุจุงุช */
        font-weight: 600;
        cursor: pointer;
        border: none;
        background-color: transparent;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        color: #777;
      }
      .tab-btn:hover {
        background-color: #f7f5f2;
      }
      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 2. ุชูุณูู ุงูุจุทุงูุงุช ูุงูููุงุฐุฌ */
      .card {
        background-color: var(--card-bg, #ffffff);
        border-radius: var(--border-radius, 8px);
        box-shadow: var(--shadow, 0 4px 12px rgba(0, 0, 0, 0.05));
        padding: 25px;
        margin-bottom: 25px;
        overflow-x: auto;
      }
      .card h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .form-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
      }
      .form-group label {
        font-weight: 600;
        flex-basis: 150px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 0.95rem;
        flex-grow: 1;
        font-family: "Cairo", sans-serif;
      }
      textarea {
        width: 100%;
        min-height: 80px;
      }
      /* ุงุณุชุฎุฏุงู ุณุชุงูู ุงูุฌุฏุงูู ูู admin.css */
      table.matrix-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        min-width: 600px;
      }
      .matrix-table th,
      .matrix-table td {
        border: 1px solid var(--border-color);
        padding: 12px;
        text-align: right;
        vertical-align: middle;
      }
      .matrix-table th {
        background-color: var(--light-color);
      }
      .matrix-table td input[type="number"] {
        width: 80px;
        padding: 8px;
      }
      .totals {
        margin-top: 25px;
        padding: 20px;
        background: #fdfdfd;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .totals .analysis-result {
        font-weight: normal;
        font-size: 1rem;
        color: var(--text-dark);
        margin-top: 10px;
        border-top: 1px dashed var(--border-color);
        padding-top: 10px;
      }
      .swot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .qspm-table input[type="number"] {
        width: 60px;
      }
      .qspm-table .tas {
        font-weight: bold;
        background-color: #f8f9fa;
      }

      /* 3. ุชูุณูู ูุฎุฑุฌุงุช ุงูุชูุฑูุฑ */
      #ai-report-output {
        white-space: pre-wrap;
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 20px;
        min-height: 200px;
        line-height: 1.6;
        text-align: right;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* 4. ุชูุณูู ุงูููุฏุงู (Info Modal) */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000; /* ูุฌุจ ุฃู ูููู ุฃุนูู ูู ุงูููุฏุฑ */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
        animation: fadeIn 0.3s;
      }
      .modal-content {
        /* ุงุณุชุฎุฏุงู ููุณ ููุงุณ ุงูููุฏุงู ูู admin.css */
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        text-align: right;
        overflow-y: auto;
        margin: 5% auto;
        animation: slideIn 0.3s;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 20px;
      }
      .modal-header h2 {
        color: var(--primary-color);
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
      .close-btn {
        font-size: 2rem;
        color: #aaa;
        cursor: pointer;
        line-height: 1;
      }
      .close-btn:hover {
        color: var(--danger-color);
      }
      .arabic-note {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
      }

      /* ุดุฑูุท ุงูุญูุธ ุงูุชููุงุฆู */
      #autosave-status {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: var(--success-color);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: all 0.5s ease;
      }
      #autosave-status.saving {
        opacity: 1;
        visibility: visible;
        background-color: var(--warning-color);
        color: #333;
      }
      #autosave-status.saved {
        opacity: 1;
        visibility: visible;
        background-color: var(--success-color);
        color: white;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateY(-50px);
        }
        to {
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> ููุญุฉ ุงูุชุญูู</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> ุงูููุงุฏ ุงูุฎุงู</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html"
              ><i class="fa-solid fa-truck-fast"></i> ุงูููุฑุฏูู</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> ุงูุชูุงููู</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> ุงูุนููุงุก</a
            >
          </li>
          <li>
            <a href="strategy_admin.html" class="active"
              ><i class="fa-solid fa-lightbulb"></i> ุงูุงุณุชุฑุงุชูุฌูุฉ</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ุฎุฑูุฌ</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <header
        class="page-header"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h1 id="page-title">ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู</h1>
        <button
          class="btn btn-secondary"
          id="info-btn"
          style="font-size: 1.1rem; padding: 8px 15px; min-width: 50px"
        >
          <i class="fa-solid fa-info-circle"></i> ุดุฑุญ
        </button>
      </header>

      <div class="tab-navigation" id="main-nav"></div>

      <div class="admin-panel" style="padding: 10px">
        <section id="page-welcome" class="tool-page tab-content active">
          <div class="card">
            <h2><i class="fa-solid fa-building"></i> ูุนูููุงุช ุงูุดุฑูุฉ</h2>
            <p>
              ุงุจุฏุฃ ุจุฅุฏุฎุงู ูุนูููุงุช ุดุฑูุชู ุงูุฃุณุงุณูุฉ. ูุชู ุญูุธ ุฌููุน ุงูุจูุงูุงุช ุชููุงุฆูุงู
              ูู Firebase.
            </p>
            <div class="form-grid" style="margin-top: 20px">
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-name">ุงุณู ุงูุดุฑูุฉ</label>
                <input
                  type="text"
                  id="company-name"
                  placeholder="ูุซุงู: FurnAI"
                  oninput="app.debouncedSave()"
                />
              </div>
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-industry">ุงูุตูุงุนุฉ</label>
                <input
                  type="text"
                  id="company-industry"
                  placeholder="ูุซุงู: ุตูุงุนุฉ ุงูุฃุซุงุซ"
                  oninput="app.debouncedSave()"
                />
              </div>
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-country">ุงูุฏููุฉ / ุงูููุทูุฉ</label>
                <input
                  type="text"
                  id="company-country"
                  placeholder="ูุซุงู: ููุณุทูู"
                  oninput="app.debouncedSave()"
                />
              </div>
              <div
                class="form-group"
                style="flex-direction: column; align-items: stretch"
              >
                <label for="company-notes">ููุงุญุธุงุช ุฃุฎุฑู</label>
                <input
                  type="text"
                  id="company-notes"
                  placeholder="ูุซุงู: ุดุฑูุฉ ูุงุดุฆุฉุ ุชุฑูุฒ ุนูู ุงูุชุตููู ุงููุฎุตุต"
                  oninput="app.debouncedSave()"
                />
              </div>
            </div>
          </div>
        </section>

        <section id="page-ife" class="tool-page tab-content">
          <div class="card">
            <h2>
              <i class="fa-solid fa-plus-circle"></i> ุฅุถุงูุฉ ุนุงูู ุฏุงุฎูู ุฌุฏูุฏ
            </h2>
            <div class="form-group">
              <select id="ife-type" style="flex-basis: 200px">
                <option value="strength">ููุทุฉ ููุฉ (ุชูููู 3 ุฃู 4)</option>
                <option value="weakness">ููุทุฉ ุถุนู (ุชูููู 1 ุฃู 2)</option>
              </select>
              <input
                type="text"
                id="ife-text"
                placeholder="ูุตู ุงูุนุงูู (ูุซุงู: 'ุณูุนุฉ ูููุฉ ููุนูุงูุฉ ุงูุชุฌุงุฑูุฉ')"
                style="flex-grow: 2"
              />
              <input
                type="number"
                id="ife-weight"
                placeholder="ุงููุฒู (0.01 - 1.0)"
                step="0.01"
              />
              <input
                type="number"
                id="ife-rating"
                placeholder="ุงูุชูููู (1-4)"
                min="1"
                max="4"
              />
              <button onclick="app.ife.add()">
                <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
              </button>
            </div>
          </div>
          <div class="card">
            <h2>ูุตูููุฉ ุงูุนูุงูู ุงูุฏุงุฎููุฉ (IFE)</h2>
            <table id="ife-table" class="matrix-table">
              <thead>
                <tr>
                  <th>ูุตู ุงูุนุงูู</th>
                  <th>ุงูููุน</th>
                  <th>ุงููุฒู</th>
                  <th>ุงูุชูููู</th>
                  <th>ุงููุชูุฌุฉ ุงูููุฒููุฉ</th>
                  <th>ุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="totals" id="ife-totals"></div>
          </div>
        </section>

        <section id="page-efe" class="tool-page tab-content">
          <div class="card">
            <h2>
              <i class="fa-solid fa-plus-circle"></i> ุฅุถุงูุฉ ุนุงูู ุฎุงุฑุฌู ุฌุฏูุฏ
            </h2>
            <div class="form-group">
              <select id="efe-type" style="flex-basis: 200px">
                <option value="opportunity">ูุฑุตุฉ (ุชูููู 3 ุฃู 4)</option>
                <option value="threat">ุชูุฏูุฏ (ุชูููู 1 ุฃู 2)</option>
              </select>
              <input
                type="text"
                id="efe-text"
                placeholder="ูุตู ุงูุนุงูู (ูุซุงู: 'ุฒูุงุฏุฉ ุงูุทูุจ ุนูู ุงูุฃุซุงุซ ุงููุฎุตุต')"
                style="flex-grow: 2"
              />
              <input
                type="number"
                id="efe-weight"
                placeholder="ุงููุฒู (0.01 - 1.0)"
                step="0.01"
              />
              <input
                type="number"
                id="efe-rating"
                placeholder="ุงูุชูููู (1-4)"
                min="1"
                max="4"
              />
              <button onclick="app.efe.add()">
                <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
              </button>
            </div>
          </div>
          <div class="card">
            <h2>ูุตูููุฉ ุงูุนูุงูู ุงูุฎุงุฑุฌูุฉ (EFE)</h2>
            <table id="efe-table" class="matrix-table">
              <thead>
                <tr>
                  <th>ูุตู ุงูุนุงูู</th>
                  <th>ุงูููุน</th>
                  <th>ุงููุฒู</th>
                  <th>ุงูุชูููู</th>
                  <th>ุงููุชูุฌุฉ ุงูููุฒููุฉ</th>
                  <th>ุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="totals" id="efe-totals"></div>
          </div>
        </section>

        <section id="page-cpm" class="tool-page tab-content">
          <div class="card">
            <h2>ุฅุฏุงุฑุฉ ุงูููุงูุณูู</h2>
            <div class="form-group">
              <input
                type="text"
                id="cpm-competitor-name"
                placeholder="ุงุณู ุงูููุงูุณ ุงูุฌุฏูุฏ"
              />
              <button onclick="app.cpm.addCompetitor()">ุฅุถุงูุฉ ููุงูุณ</button>
            </div>
            <p>
              ุดุฑูุชู (ุงูุนููุฏ 1) ูุงูููุงูุณูู:
              <strong id="cpm-competitor-list"></strong>
            </p>
          </div>
          <div class="card">
            <h2>ุฅุถุงูุฉ ุนุงูู ูุฌุงุญ ุญุงุณู (CSF)</h2>
            <div class="form-group">
              <input
                type="text"
                id="cpm-factor-text"
                placeholder="ุงูุนุงูู (ูุซุงู: 'ุงูุญุตุฉ ุงูุณูููุฉ')"
              />
              <input
                type="number"
                id="cpm-factor-weight"
                placeholder="ุงููุฒู (0.01 - 1.0)"
                step="0.01"
              />
              <button onclick="app.cpm.addFactor()">ุฅุถุงูุฉ ุนุงูู</button>
            </div>
          </div>
          <div class="card">
            <h2>ูุตูููุฉ ุงููุถุน ุงูุชูุงูุณู (CPM)</h2>
            <table id="cpm-table" class="matrix-table">
              <thead></thead>
              <tbody></tbody>
              <tfoot></tfoot>
            </table>
          </div>
        </section>

        <section id="page-swot" class="tool-page tab-content">
          <div class="card">
            <h2>ูุตูููุฉ SWOT ูุชูููุฏ ุงูุงุณุชุฑุงุชูุฌูุงุช</h2>
            <p>
              ุฑุงุฌุน ุนูุงููู ุงูุฑุฆูุณูุฉ ููู ุจุตูุงุบุฉ ุงูุงุณุชุฑุงุชูุฌูุงุช. ูุชู ุญูุธ ููุงุญุธุงุชู
              ุชููุงุฆูุงู.
            </p>
            <button
              onclick="app.swot.pullFactors()"
              class="btn"
              style="margin-top: 10px"
            >
              <i class="fa-solid fa-sync"></i> ุณุญุจ/ุชุญุฏูุซ ุงูุนูุงูู ูู
              (IFE/EFE/Firebase)
            </button>
            <div id="swot-reference" style="display: none; margin-top: 20px">
              <div class="swot-grid">
                <div class="swot-card strengths">
                  <h3><i class="fa-solid fa-star"></i> ููุงุท ุงูููุฉ (S)</h3>
                  <ul id="swot-s"></ul>
                </div>
                <div class="swot-card weaknesses">
                  <h3>
                    <i class="fa-solid fa-triangle-exclamation"></i> ููุงุท ุงูุถุนู
                    (W)
                  </h3>
                  <ul id="swot-w"></ul>
                </div>
                <div class="swot-card opportunities">
                  <h3><i class="fa-solid fa-sun"></i> ุงููุฑุต (O)</h3>
                  <ul id="swot-o"></ul>
                </div>
                <div class="swot-card threats">
                  <h3><i class="fa-solid fa-bolt"></i> ุงูุชูุฏูุฏุงุช (T)</h3>
                  <ul id="swot-t"></ul>
                </div>
              </div>
            </div>
          </div>
          <div class="swot-grid">
            <div class="card">
              <h3>ุงุณุชุฑุงุชูุฌูุงุช S-O (ุงูููุฉ-ุงููุฑุต)</h3>
              <textarea
                id="swot-so"
                placeholder="ุงุณุชุฎุฏู ููุงุท ุงูููุฉ ูุงูุชูุงุต ุงููุฑุต..."
                oninput="app.debouncedSave()"
              ></textarea>
            </div>
            <div class="card">
              <h3>ุงุณุชุฑุงุชูุฌูุงุช W-O (ุงูุถุนู-ุงููุฑุต)</h3>
              <textarea
                id="swot-wo"
                placeholder="ุชุบูุจ ุนูู ููุงุท ุงูุถุนู ุจุงุณุชุบูุงู ุงููุฑุต..."
                oninput="app.debouncedSave()"
              ></textarea>
            </div>
            <div class="card">
              <h3>ุงุณุชุฑุงุชูุฌูุงุช S-T (ุงูููุฉ-ุงูุชูุฏูุฏุงุช)</h3>
              <textarea
                id="swot-st"
                placeholder="ุงุณุชุฎุฏู ููุงุท ุงูููุฉ ูุฏุฑุก ุงูุชูุฏูุฏุงุช..."
                oninput="app.debouncedSave()"
              ></textarea>
            </div>
            <div class="card">
              <h3>ุงุณุชุฑุงุชูุฌูุงุช W-T (ุงูุถุนู-ุงูุชูุฏูุฏุงุช)</h3>
              <textarea
                id="swot-wt"
                placeholder="ุงุณุชุฑุงุชูุฌูุงุช ุฏูุงุนูุฉ ูุชูููู ุงูุถุนู ูุชุฌูุจ ุงูุชูุฏูุฏุงุช..."
                oninput="app.debouncedSave()"
              ></textarea>
            </div>
          </div>
        </section>

        <section id="page-bcg" class="tool-page tab-content">
          <div class="card">
            <h2>ุฅุถุงูุฉ ูุณู / ููุชุฌ ุฌุฏูุฏ (ูู BCG)</h2>
            <div class="form-group">
              <input type="text" id="bcg-division" placeholder="ุงุณู ุงููุณู" />
              <input
                type="number"
                id="bcg-growth"
                placeholder="ูุนุฏู ููู ุงูุตูุงุนุฉ (-20 ุฅูู 20)"
                step="0.1"
              />
              <input
                type="number"
                id="bcg-rmsp"
                placeholder="ุงูุญุตุฉ ุงูุณูููุฉ ุงููุณุจูุฉ (0.0 ุฅูู 1.0)"
                step="0.01"
              />
              <input
                type="number"
                id="bcg-revenue"
                placeholder="ุงูุฅูุฑุงุฏุงุช (ูุญุฌู ุงูุฏุงุฆุฑุฉ)"
              />
              <button onclick="app.bcg.add()">ุฅุถุงูุฉ</button>
              <button class="btn btn-danger" onclick="app.bcg.clear()">
                ูุณุญ ุงููู
              </button>
            </div>
          </div>
          <div class="card">
            <h2>ูุตูููุฉ ุจูุณุทู (BCG)</h2>
            <div
              style="width: 100%; max-width: 700px; margin: auto; padding: 10px"
            >
              <canvas id="bcgChart"></canvas>
            </div>
          </div>
        </section>

        <section id="page-ie" class="tool-page tab-content">
          <div class="card">
            <h2>ุงููุตูููุฉ ุงูุฏุงุฎููุฉ-ุงูุฎุงุฑุฌูุฉ (IE)</h2>
            <p>ูุฐู ุงููุตูููุฉ ุชุฑุณู ูููุน ุดุฑูุชู ุจูุงุกู ุนูู ูุชุงุฆุฌ IFE ู EFE.</p>
            <p style="margin-top: 10px">
              <strong>ูุชูุฌุฉ IFE ุงูุฅุฌูุงููุฉ ุงูุญุงููุฉ: </strong
              ><span id="ie-ife-score">N/A</span><br />
              <strong>ูุชูุฌุฉ EFE ุงูุฅุฌูุงููุฉ ุงูุญุงููุฉ: </strong
              ><span id="ie-efe-score">N/A</span>
            </p>
            <button onclick="app.ie.plotFirm()" class="btn">
              <i class="fa-solid fa-map-pin"></i> ุชุญุฏูุฏ ูููุน ุงูุดุฑูุฉ ุนูู ุงููุตูููุฉ
            </button>
          </div>
          <div class="card">
            <h2>ุฅุถุงูุฉ ูุณู (ูู IE)</h2>
            <div class="form-group">
              <input type="text" id="ie-division" placeholder="ุงุณู ุงููุณู" />
              <input
                type="number"
                id="ie-ife"
                placeholder="ูุชูุฌุฉ IFE ูููุณู (1.0 - 4.0)"
                step="0.1"
              />
              <input
                type="number"
                id="ie-efe"
                placeholder="ูุชูุฌุฉ EFE ูููุณู (1.0 - 4.0)"
                step="0.1"
              />
              <input
                type="number"
                id="ie-revenue"
                placeholder="ุงูุฅูุฑุงุฏุงุช (ูุญุฌู ุงูุฏุงุฆุฑุฉ)"
              />
              <button onclick="app.ie.add()">ุฅุถุงูุฉ</button>
              <button class="btn btn-danger" onclick="app.ie.clear()">
                ูุณุญ ุงููู
              </button>
            </div>
          </div>
          <div class="card">
            <div
              style="width: 100%; max-width: 700px; margin: auto; padding: 10px"
            >
              <canvas id="ieChart"></canvas>
            </div>
          </div>
        </section>

        <section id="page-space" class="tool-page tab-content">
          <div class="card">
            <h2>ุชููููุงุช ูุตูููุฉ SPACE</h2>
            <p>
              ุฃุฏุฎู ุงูุชููููุงุช ููู ุนุงูู. ุงุณุชุฎุฏู ุงููููุงุณ ุงูููุถุญ (ุฑุงุฌุน ุฒุฑ ุงูุดุฑุญ 'i'
              ูููุฒูุฏ).
            </p>
            <div class="swot-grid" style="grid-template-columns: 1fr 1fr">
              <div>
                <h3>
                  ุงููุฑูุฒ ุงููุงูู (FP)
                  <span style="font-weight: normal">(ูู +1 ุฅูู +7)</span>
                </h3>
                <div class="form-group">
                  <label>ุงูุนุงุฆุฏ ุนูู ุงูุงุณุชุซูุงุฑ (ROI)</label
                  ><input
                    type="number"
                    id="space-fp1"
                    min="1"
                    max="7"
                    oninput="app.space.update()"
                  />
                </div>
                <div class="form-group">
                  <label>ุงูุฑุงูุนุฉ ุงููุงููุฉ</label
                  ><input
                    type="number"
                    id="space-fp2"
                    min="1"
                    max="7"
                    oninput="app.space.update()"
                  />
                </div>
                <strong style="margin-top: 10px; display: block"
                  >ูุชูุณุท (FP): <span id="space-fp-avg">0</span></strong
                >
              </div>
              <div>
                <h3>
                  ูุฑูุฒ ุงูุงุณุชูุฑุงุฑ (SP)
                  <span style="font-weight: normal">(ูู -1 ุฅูู -7)</span>
                </h3>
                <div class="form-group">
                  <label>ูุนุฏู ุงูุชุถุฎู</label
                  ><input
                    type="number"
                    id="space-sp1"
                    min="-7"
                    max="-1"
                    oninput="app.space.update()"
                  />
                </div>
                <div class="form-group">
                  <label>ุงูุชุบูุฑ ุงูุชูููููุฌู</label
                  ><input
                    type="number"
                    id="space-sp2"
                    min="-7"
                    max="-1"
                    oninput="app.space.update()"
                  />
                </div>
                <strong style="margin-top: 10px; display: block"
                  >ูุชูุณุท (SP): <span id="space-sp-avg">0</span></strong
                >
              </div>
              <div>
                <h3>
                  ูุฑูุฒ ุงูุตูุงุนุฉ (IP)
                  <span style="font-weight: normal">(ูู +1 ุฅูู +7)</span>
                </h3>
                <div class="form-group">
                  <label>ุฅููุงูุงุช ุงูููู</label
                  ><input
                    type="number"
                    id="space-ip1"
                    min="1"
                    max="7"
                    oninput="app.space.update()"
                  />
                </div>
                <div class="form-group">
                  <label>ุฅููุงูุงุช ุงูุฑุจุญ</label
                  ><input
                    type="number"
                    id="space-ip2"
                    min="1"
                    max="7"
                    oninput="app.space.update()"
                  />
                </div>
                <strong style="margin-top: 10px; display: block"
                  >ูุชูุณุท (IP): <span id="space-ip-avg">0</span></strong
                >
              </div>
              <div>
                <h3>
                  ุงููุฑูุฒ ุงูุชูุงูุณู (CP)
                  <span style="font-weight: normal">(ูู -1 ุฅูู -7)</span>
                </h3>
                <div class="form-group">
                  <label>ุงูุญุตุฉ ุงูุณูููุฉ</label
                  ><input
                    type="number"
                    id="space-cp1"
                    min="-7"
                    max="-1"
                    oninput="app.space.update()"
                  />
                </div>
                <div class="form-group">
                  <label>ุฌูุฏุฉ ุงูููุชุฌ</label
                  ><input
                    type="number"
                    id="space-cp2"
                    min="-7"
                    max="-1"
                    oninput="app.space.update()"
                  />
                </div>
                <strong style="margin-top: 10px; display: block"
                  >ูุชูุณุท (CP): <span id="space-cp-avg">0</span></strong
                >
              </div>
            </div>
          </div>
          <div class="card">
            <h2>ูุตูููุฉ SPACE ูุงูุชุญููู</h2>
            <div class="totals">
              <p>
                <strong>ุฅุญุฏุงุซู ุงููุญูุฑ ุงูุณููู (X = IP + CP): </strong
                ><span id="space-x-axis">0</span>
              </p>
              <p>
                <strong>ุฅุญุฏุงุซู ุงููุญูุฑ ุงูุตุงุฏู (Y = FP + SP): </strong
                ><span id="space-y-axis">0</span>
              </p>
              <p class="analysis-result">
                <strong>ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูููุชุฑุญุฉ: </strong
                ><span id="space-strategy">N/A</span>
              </p>
            </div>
            <div
              style="width: 100%; max-width: 600px; margin: auto; padding: 10px"
            >
              <canvas id="spaceChart"></canvas>
            </div>
          </div>
        </section>

        <section id="page-qspm" class="tool-page tab-content">
          <div class="card">
            <h2>ูุตูููุฉ ุงูุชุฎุทูุท ุงูุงุณุชุฑุงุชูุฌู ุงูููู (QSPM)</h2>
            <p>ูุงุฑู ุจูู ุงุณุชุฑุงุชูุฌูุชูู ุจุฏููุชูู (ูู SWOT ูุซูุงู) ูุงุฎุชูุงุฑ ุงูุฃูุถู.</p>
            <div class="form-group">
              <input
                type="text"
                id="qspm-s1-name"
                placeholder="ุงุณู ุงูุงุณุชุฑุงุชูุฌูุฉ 1"
                oninput="app.debouncedSave(); app.qspm.updateNames()"
              />
              <input
                type="text"
                id="qspm-s2-name"
                placeholder="ุงุณู ุงูุงุณุชุฑุงุชูุฌูุฉ 2"
                oninput="app.debouncedSave(); app.qspm.updateNames()"
              />
            </div>
          </div>
          <div class="card">
            <table id="qspm-table" class="matrix-table qspm-table">
              <thead>
                <tr>
                  <th>ุงูุนุงูู ุงูุญุงุณู</th>
                  <th>ุงููุฒู</th>
                  <th id="qspm-s1-header">ุงุณุชุฑุงุชูุฌูุฉ 1: AS</th>
                  <th id="qspm-s1-tas-header">ุงุณุชุฑุงุชูุฌูุฉ 1: TAS</th>
                  <th id="qspm-s2-header">ุงุณุชุฑุงุชูุฌูุฉ 2: AS</th>
                  <th id="qspm-s2-tas-header">ุงุณุชุฑุงุชูุฌูุฉ 2: TAS</th>
                </tr>
              </thead>
              <tbody id="qspm-factors-body"></tbody>
              <tfoot id="qspm-totals-foot"></tfoot>
            </table>
          </div>
        </section>

        <section id="page-ai-report" class="tool-page tab-content">
          <div class="card">
            <h2>
              <i class="fa-solid fa-robot"></i> ูููุดุฆ ุงูุชูุฑูุฑ ุงูุงุณุชุฑุงุชูุฌู (AI)
            </h2>
            <p>
              ุณุชููู ูุฐู ุงูุฃุฏุงุฉ ุจุชุญููู ุฌููุน ุงูุจูุงูุงุช ุงูุชู ุฃุฏุฎูุชูุง (IFE, EFE, CPM,
              BCG, SWOT, SPACE) ูุฅูุดุงุก ุชูุฑูุฑ ุงุณุชุฑุงุชูุฌู ุดุงูู.
            </p>
            <div class="form-group">
              <label for="ai-language">ุงุฎุชุฑ ูุบุฉ ุงูุชูุฑูุฑ:</label>
              <select id="ai-language">
                <option value="Arabic">ุงูุนุฑุจูุฉ (Arabic)</option>
                <option value="English">ุงูุฅูุฌููุฒูุฉ (English)</option>
              </select>
              <button id="ai-generate-btn" onclick="app.aiReport.generate()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> ุฅูุดุงุก ุงูุชูุฑูุฑ
              </button>
            </div>
          </div>
          <div class="card">
            <h2>ุงูุชูุฑูุฑ ุงููููุดุฃ</h2>
            <div class="loader" id="ai-loader"></div>
            <div id="ai-report-output">
              ุณูุธูุฑ ุชูุฑูุฑู ููุง. ุงุถุบุท "ุฅูุดุงุก ุงูุชูุฑูุฑ" ููุจุฏุก...
            </div>
          </div>
        </section>
      </div>
    </div>
    <div id="autosave-status">...</div>

    <div id="info-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Info</h2>
          <span class="close-btn" onclick="app.closeModal()">&times;</span>
        </div>
        <div id="modal-body">
          <p>Welcome!</p>
        </div>
      </div>
    </div>

    <script type="module">
      // --- ุฅุนุฏุงุฏุงุช Firebase ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      // --- ุฅุนุฏุงุฏุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ---
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

      // ๐ ุฅุนุฏุงุฏุงุช Firebase (ุงุณุชุฎุฏู ููุณ ุงูุฅุนุฏุงุฏุงุช ูู ูููุงุชู ุงูุฃุฎุฑู)
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };

      // ๐ ๐ก (ูุงู) ุงุณุชุฎุฏู ููุณ ููุชุงุญ AI ูู ูููุงุชู ุงูุฃุฎุฑู
      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";

      // --- ุชููุฆุฉ ุงูุชุทุจููุงุช ---
      const appFirebase = initializeApp(firebaseConfig);
      const db = getFirestore(appFirebase);
      const auth = getAuth(appFirebase);
      const genAI = new GoogleGenerativeAI(API_KEY);

      (function () {
        const app = {
          data: {},
          dbRef: null, // (ูุฑุฌุน ูุณุชูุฏ Firebase)
          charts: { bcg: null, ie: null, space: null },

          tools: [
            { id: "welcome", name: "ูุนูููุงุช ุงูุดุฑูุฉ" },
            { id: "ife", name: "IFE" },
            { id: "efe", name: "EFE" },
            { id: "cpm", name: "CPM" },
            { id: "swot", name: "SWOT" },
            { id: "bcg", name: "BCG" },
            { id: "ie", name: "IE" },
            { id: "space", name: "SPACE" },
            { id: "qspm", name: "QSPM" },
            { id: "ai-report", name: "ุชูุฑูุฑ AI" },
          ],

          infoContent: {
            welcome: {
              title: "ูุนูููุงุช ุงูุดุฑูุฉ",
              body: `<p>ุงุจุฏุฃ ุจุฅุฏุฎุงู ูุนูููุงุช ุดุฑูุชู ุงูุฃุณุงุณูุฉ. ูุชู ุญูุธ ุงูุจูุงูุงุช ุชููุงุฆูุงู ูู Firebase.</p>`,
            },
            ife: {
              title: "ูุตูููุฉ ุงูุนูุงูู ุงูุฏุงุฎููุฉ (IFE)",
              body: `<p>ุชูุฎุต ูุชูููู ููุงุท ุงูููุฉ ูุงูุถุนู ุงูุฑุฆูุณูุฉ ูุดุฑูุชู.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุฃุถู ุนูุงูู ุฏุงุฎููุฉ (10-20 ุนุงูู).</li>
                           <li>ุฃุนุทู ูู ุนุงูู <strong>"ูุฒู" (Weight)</strong> ูู 0.0 ุฅูู 1.0 ุญุณุจ ุฃูููุชู *ููุตูุงุนุฉ*. (ูุฌุจ ุฃู ูููู ูุฌููุน ุงูุฃูุฒุงู = 1.0).</li>
                           <li>ุฃุนุทู ูู ุนุงูู <strong>"ุชูููู" (Rating)</strong> ูู 1 ุฅูู 4 ุญุณุจ ุฃุฏุงุก *ุดุฑูุชู* ููู: (4 = ููุฉ ุฑุฆูุณูุฉ, 3 = ููุฉ ุซุงูููุฉ, 2 = ุถุนู ุซุงููู, 1 = ุถุนู ุฑุฆูุณู).</li>
                           <li>ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ููู 2.5 ุชุนูู ุฃู ุงููุถุน ุงูุฏุงุฎูู ููู.</li>
                       </ol>`,
            },
            efe: {
              title: "ูุตูููุฉ ุงูุนูุงูู ุงูุฎุงุฑุฌูุฉ (EFE)",
              body: `<p>ุชูุฎุต ูุชูููู ุงููุฑุต ูุงูุชูุฏูุฏุงุช ุงูุฎุงุฑุฌูุฉ ุงูุชู ุชูุงุฌู ุดุฑูุชู.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุฃุถู ุนูุงูู ุฎุงุฑุฌูุฉ (10-20 ุนุงูู).</li>
                           <li>ุฃุนุทู ูู ุนุงูู <strong>"ูุฒู" (Weight)</strong> ูู 0.0 ุฅูู 1.0 ุญุณุจ ุฃูููุชู *ููุตูุงุนุฉ*. (ูุฌุจ ุฃู ูููู ูุฌููุน ุงูุฃูุฒุงู = 1.0).</li>
                           <li>ุฃุนุทู ูู ุนุงูู <strong>"ุชูููู" (Rating)</strong> ูู 1 ุฅูู 4 ุญุณุจ ุฌูุฏุฉ *ุงุณุชุฌุงุจุฉ ุดุฑูุชู* ููุฐุง ุงูุนุงูู: (4 = ุงุณุชุฌุงุจุฉ ููุชุงุฒุฉ, 3 = ููู ุงููุชูุณุท, 2 = ูุชูุณุทุฉ, 1 = ุถุนููุฉ).</li>
                           <li>ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ููู 2.5 ุชุนูู ุฃู ุงูุดุฑูุฉ ุชุณุชุฌูุจ ุฌูุฏุงู ููุจูุฆุฉ ุงูุฎุงุฑุฌูุฉ.</li>
                       </ol>`,
            },
            cpm: {
              title: "ูุตูููุฉ ุงููุถุน ุงูุชูุงูุณู (CPM)",
              body: `<p>ุชูุงุฑู ูุฐู ุงููุตูููุฉ ุดุฑูุชู ุจุฃูู ููุงูุณูู ุจูุงุกู ุนูู ุนูุงูู ุงููุฌุงุญ ุงูุฑุฆูุณูุฉ ูู ุงูุตูุงุนุฉ.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุฃุถู ุดุฑูุชู (ุชููุงุฆูุงู ูู ุฃูู ุนููุฏ) ุซู ุฃุถู ุงูููุงูุณูู.</li>
                           <li>ุฃุถู "ุนูุงูู ุงููุฌุงุญ ุงูุฑุฆูุณูุฉ" (CSFs) ูู ุตูุงุนุชู.</li>
                           <li>ุฃุนุทู ูู ุนุงูู <strong>"ูุฒู" (Weight)</strong> ูู 0.0 ุฅูู 1.0. (ุงููุฌููุน ูุฌุจ ุฃู = 1.0).</li>
                           <li>ุฃุนุทู <strong>"ุชูููู" (Rating)</strong> ูู 1 ุฅูู 4 (ูุซู IFE) *ููู ุดุฑูุฉ* ุนูู *ูู ุนุงูู*.</li>
                           <li>ุงูุดุฑูุฉ ุตุงุญุจุฉ ุฃุนูู ูุฌููุน ูู ุงูุฑุงุฆุฏุฉ ูู ุงูููุงูุณุฉ.</li>
                       </ol>`,
            },
            swot: {
              title: "ูุตูููุฉ SWOT (ุงูุชุญููู ุงูุฑุจุงุนู)",
              body: `<p>ุชุณุงุนุฏู ุนูู ุชูููุฏ ุงุณุชุฑุงุชูุฌูุงุช ุจูุงุกู ุนูู ุนูุงููู ุงูุฏุงุฎููุฉ ูุงูุฎุงุฑุฌูุฉ.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุงุถุบุท ุนูู "ุณุญุจ/ุชุญุฏูุซ ุงูุนูุงูู" ูุณุญุจ ุฃูู ุงูุนูุงูู ูู IFE ู EFE ูุจูุงูุงุช FurnAI.</li>
                           <li>ุจูุงุกู ุนูู ูุฐู ุงูุนูุงููุ ุงุจุฏุฃ ุจูุชุงุจุฉ ุงูุงุณุชุฑุงุชูุฌูุงุช ูู ุงููุฑุจุนุงุช ุงูุฃุฑุจุนุฉ (SO, WO, ST, WT).</li>
                           <li>ูุชู ุญูุธ ูุง ุชูุชุจู ุชููุงุฆูุงู.</li>
                       </ol>`,
            },
            bcg: {
              title: "ูุตูููุฉ ุจูุณุทู (BCG)",
              body: `<p>ุชุถุน ุฃูุณุงู ุดุฑูุชู (ุฃู ููุชุฌุงุชู) ุนูู ุฑุณู ุจูุงูู ูุชุณุงุนุฏู ุนูู ุชุญุฏูุฏ ุฃูู ุชุณุชุซูุฑ ููุงุฑุฏู.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ููู ูุณู ุฃู ููุชุฌุ ุฃุฏุฎู:</li>
                           <li><strong>ูุนุฏู ููู ุงูุตูุงุนุฉ (IGR):</strong> ูู -20 ุฅูู 20. (ุงููุญูุฑ Y).</li>
                           <li><strong>ุงูุญุตุฉ ุงูุณูููุฉ ุงููุณุจูุฉ (RMSP):</strong> ูู 0.0 ุฅูู 1.0. (ุงููุญูุฑ X).</li>
                           <li><strong>ุงูุฅูุฑุงุฏุงุช (Revenue):</strong> ูุฐุง ูุญุฏุฏ ุญุฌู ุงูุฏุงุฆุฑุฉ.</li>
                           <li>ุงูุฃุฏุงุฉ ุณุชุฑุณู ุงูุฏุงุฆุฑุฉ ูู ุงููุฑุจุน ุงูุตุญูุญ: (ูุฌููุ ุงุณุชููุงูุ ุฃุจูุงุฑ ุญููุจุ ููุงุจ).</li>
                       </ol>`,
            },
            ie: {
              title: "ุงููุตูููุฉ ุงูุฏุงุฎููุฉ-ุงูุฎุงุฑุฌูุฉ (IE)",
              body: `<p>ุชุถุน ุดุฑูุชู ุฃู ุฃูุณุงููุง ุนูู ุดุจูุฉ ูู 9 ูุฑุจุนุงุช ุจูุงุกู ุนูู ูุชุงุฆุฌ IFE ู EFE.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุงูุฃุฏุงุฉ ุชุณุชุฎุฏู ูุชูุฌุชู ุงูุฅุฌูุงููุฉ ูู IFE (ุงููุญูุฑ X) ู EFE (ุงููุญูุฑ Y).</li>
                           <li>ุงุถุบุท "ุชุญุฏูุฏ ูููุน ุงูุดุฑูุฉ" ูุชุฑู ูููุน ุดุฑูุชู ุงูุญุงูู.</li>
                           <li>ููููู ุฃูุถุงู ุฅุถุงูุฉ "ุฃูุณุงู" ูููุตูุฉ ุฅุฐุง ูุงู ูุฏูู ูุชูุฌุฉ IFE ู EFE ููู ูุณู.</li>
                           <li>ุงููุฑุจุนุงุช ุงูู 9 ููุณูุฉ ุฅูู 3 ููุงุทู ุงุณุชุฑุงุชูุฌูุฉ: (ุงูููู ูุงูุจูุงุกุ ุงูุญูุงุธ ูุงูุตูุงูุฉุ ุฃู ุงูุญุตุงุฏ ูุงูุชุฎุงุฑุฌ).</li>
                       </ol>`,
            },
            space: {
              title: "ูุตูููุฉ (SPACE)",
              body: `<p>ุชุญุฏุฏ ูุฐู ุงููุตูููุฉ "ุงููุถุน" ุงูุงุณุชุฑุงุชูุฌู ูุดุฑูุชู (ูุฌูููุ ูุชุญูุธุ ุฏูุงุนูุ ุฃู ุชูุงูุณู).</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุฃุนุทู ุชููููุงู ููู ุจูุนุฏ ูู ุงูุฃุจุนุงุฏ ุงูุฃุฑุจุนุฉ. *ุงูุชุจู ุฌูุฏุงู ููููุงุณ ุงูุชูููู*:</li>
                           <li><strong>ุงููุฑูุฒ ุงููุงูู (FP):</strong> ูู +1 (ุงูุฃุณูุฃ) ุฅูู +7 (ุงูุฃูุถู).</li>
                           <li><strong>ูุฑูุฒ ุงูุตูุงุนุฉ (IP):</strong> ูู +1 (ุงูุฃุณูุฃ) ุฅูู +7 (ุงูุฃูุถู).</li>
                           <li><strong>ูุฑูุฒ ุงูุงุณุชูุฑุงุฑ (SP):</strong> ูู -1 (ุงูุฃูุถู) ุฅูู -7 (ุงูุฃุณูุฃ). (ุจุงูุนูุณ)</li>
                           <li><strong>ุงููุฑูุฒ ุงูุชูุงูุณู (CP):</strong> ูู -1 (ุงูุฃูุถู) ุฅูู -7 (ุงูุฃุณูุฃ). (ุจุงูุนูุณ)</li>
                           <li>ุงูุฃุฏุงุฉ ุณุชุญุณุจ ุงูุฅุญุฏุงุซูุงุช (X, Y). ุงูุฑุจุน ุงูุฐู ุชูุน ููู ุงูููุทุฉ ูุญุฏุฏ ููุน ุงูุงุณุชุฑุงุชูุฌูุฉ.</li>
                       </ol>`,
            },
            qspm: {
              title: "ูุตูููุฉ (QSPM)",
              body: `<p>ุชุณุชุฎุฏู ุนูุงูู IFE/EFE ููููุงุฑูุฉ "ุจุดูู ููู" ุจูู ุงุณุชุฑุงุชูุฌูุชูู ูุงุฎุชูุงุฑ ุงูุฃูุถู.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุฃุฏุฎู ุงุณู "ุงูุงุณุชุฑุงุชูุฌูุฉ 1" ู "ุงูุงุณุชุฑุงุชูุฌูุฉ 2".</li>
                           <li>ุงูุฌุฏูู ุณูุนุฑุถ ุชููุงุฆูุงู ูู ุงูุนูุงูู ูุงูุฃูุฒุงู ูู IFE ู EFE.</li>
                           <li>ููู ุนุงููุ ุฃุนุทู <strong>"ุฏุฑุฌุฉ ุฌุงุฐุจูุฉ" (AS)</strong> ูู 1 ุฅูู 4. (1 = ุบูุฑ ุฌุฐุงุจุฉุ 4 = ุฌุฐุงุจุฉ ุฌุฏุงู).</li>
                           <li>*ูุงุนุฏุฉ ูููุฉ:* ูุง ุชุนุทู ููุณ ุฏุฑุฌุฉ ุงูุฌุงุฐุจูุฉ ููุงุณุชุฑุงุชูุฌูุชูู ูู ููุณ ุงูุตู (ุฅูุง ุฅุฐุง ูุงูุช 0).</li>
                           <li>*ูุงุนุฏุฉ ูููุฉ:* ุฅุฐุง ูุงู ุงูุนุงูู ูุง ูุคุซุฑ ุนูู ูุฑุงุฑ ุงูููุงุถูุฉุ ุฃุนุทู ููุชุง ุงูุงุณุชุฑุงุชูุฌูุชูู ุฏุฑุฌุฉ 0.</li>
                           <li>ุงูุงุณุชุฑุงุชูุฌูุฉ ุฐุงุช ุงููุฌููุน ุงูุฃุนูู (STAS) ูู ุงูุฃูุถู.</li>
                       </ol>`,
            },
            "ai-report": {
              title: "ูููุดุฆ ุงูุชูุงุฑูุฑ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู (AI)",
              body: `<p>ุชุณุชุฎุฏู ูุฐู ุงูุฃุฏุงุฉ ูููุฐุฌ Gemini ูู ุฌูุฌู ูุชุญููู ูุดุฑูุนู ุจุงููุงูู.</p>
                       <strong>ูุงุฐุง ุฃูุนูุ</strong>
                       <ol>
                           <li>ุชุฃูุฏ ุฃููุงู ูู ุชุนุจุฆุฉ ุงูุจูุงูุงุช ูู ุงูุฃุฏูุงุช ุงูุฃุฎุฑู (IFE, EFE, SWOT, SPACE...).</li>
                           <li>ุงุฎุชุฑ ุงููุบุฉ ุงูุชู ุชุฑูุฏ ุงูุชูุฑูุฑ ุจูุง (English ุฃู Arabic).</li>
                           <li>ุงุถุบุท "ุฅูุดุงุก ุงูุชูุฑูุฑ". ุณุชููู ุงูุฃุฏุงุฉ ุจุฌูุน ูู ุจูุงูุงุชู ูุฅุฑุณุงููุง ููุฐูุงุก ุงูุงุตุทูุงุนู.</li>
                           <li>ูุฑุฌู ุงูุงูุชุธุงุฑุ ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ูู 10 ุฅูู 30 ุซุงููุฉ.</li>
                       </ol>`,
            },
          },

          // --- ๐ก ุฏุงูุฉ ูุฅูุดุงุก ุดุฑูุท ุงูุชููู (Tabs) ---
          initTabs() {
            const nav = document.getElementById("main-nav");
            nav.innerHTML = "";
            app.tools.forEach((tool) => {
              nav.innerHTML += `<button id="btn-${tool.id}" class="tab-btn" onclick="app.showPage('${tool.id}')">
                    ${tool.name}
                </button>`;
            });

            document.getElementById("info-btn").onclick = () => {
              const activePageId = document
                .querySelector(".tool-page.active")
                .id.replace("page-", "");
              app.showModal(activePageId);
            };
          },

          showPage(pageId) {
            document
              .querySelectorAll(".tab-content")
              .forEach((p) => p.classList.remove("active"));
            document.getElementById(`page-${pageId}`).classList.add("active");

            document
              .querySelectorAll("#main-nav button")
              .forEach((b) => b.classList.remove("active"));
            document.getElementById(`btn-${pageId}`).classList.add("active");

            const tool = app.tools.find((t) => t.id === pageId);
            document.getElementById("page-title").textContent = tool.name;

            // ุฅุนุงุฏุฉ ุงูุนุฑุถ ุนูุฏ ูุชุญ ุงูุชุจููุจ (ููู ููุฑุณูู ุงูุจูุงููุฉ)
            if (pageId === "qspm") app.qspm.render();
            if (pageId === "swot") app.swot.render();
            if (pageId === "ie") app.ie.render();
            if (pageId === "bcg") app.bcg.render();
            if (pageId === "space")
              app.space.render(
                app.data.space.xAxis || 0,
                app.data.space.yAxis || 0
              );
          },

          // --- ๐ก ุฏูุงู ุงูุญูุธ ูุงูุชุญููู ูู Firebase ---

          // ุฏุงูุฉ ุงูุญูุธ ุงูุชููุงุฆู (Debounce)
          utils: {
            debounce(func, delay = 1500) {
              let timeout;
              return (...args) => {
                const statusEl = document.getElementById("autosave-status");
                statusEl.textContent = "ูุชู ุงูุญูุธ...";
                statusEl.className = "saving";
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                  func.apply(this, args);
                  statusEl.textContent = "ุชู ุงูุญูุธ โ";
                  statusEl.className = "saved";
                  setTimeout(() => {
                    statusEl.className = "";
                  }, 2000);
                }, delay);
              };
            },
          },

          async saveData() {
            if (app.dbRef) {
              try {
                await setDoc(app.dbRef, app.data);
              } catch (e) {
                console.error("Firebase save error: ", e);
                alert("ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ ูู Firebase.");
              }
            }
          },

          // ุชููุฆุฉ ุงูุชุทุจูู ุจุนุฏ ุงูุชุญูู ูู ุงููุฏูุฑ
          init(user) {
            // ๐ก ุชุญุฏูุฏ ูุณุชูุฏ Firebase ุจูุงุกู ุนูู ุงููุณุชุฎุฏู
            // (ููููู ุชุบููุฑ "main_data" ุฅุฐุง ุฃุฑุฏุช)
            app.dbRef = doc(db, "strategy", "main_data");

            app.initTabs();
            app.loadData(); // (ุงูุขู ุณูุชู ุงูุชุญููู ูู Firebase)

            // ุฑุจุท ุฒุฑ ุงูุฎุฑูุฌ
            document
              .getElementById("logout-btn")
              .addEventListener("click", async (e) => {
                e.preventDefault();
                await signOut(auth);
                window.location.href = "login.html";
              });
          },

          async loadData() {
            const defaultData = {
              companyInfo: {
                name: "FurnAI",
                industry: "ุงูุฃุซุงุซ",
                country: "ููุณุทูู",
                notes: "",
              },
              ife: { items: [] },
              efe: { items: [] },
              cpm: { competitors: ["FurnAI"], factors: [] },
              swot: { so: "", st: "", wo: "", wt: "" },
              bcg: { items: [] },
              ie: { items: [], firm: null },
              space: { ratings: {}, xAxis: 0, yAxis: 0 },
              qspm: {
                s1Name: "ุงุณุชุฑุงุชูุฌูุฉ 1",
                s2Name: "ุงุณุชุฑุงุชูุฌูุฉ 2",
                scores: {},
              },
            };

            try {
              const docSnap = await getDoc(app.dbRef);
              if (docSnap.exists()) {
                app.data = { ...defaultData, ...docSnap.data() }; // ุฏูุฌ ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ ูุน ุงููุญููุธุฉ
              } else {
                app.data = defaultData; // ุงุณุชุฎุฏุงู ุงูุงูุชุฑุงุถู ุฅุฐุง ูู ููุฌุฏ ูุณุชูุฏ
              }
            } catch (e) {
              console.error("Firebase load error: ", e);
              app.data = defaultData;
            }

            app.showPage("welcome");
            app.renderAll();
          },

          debouncedSave: null, // ุณูุชู ุชููุฆุชู

          renderAll() {
            // ุชููุฆุฉ ุงูุญูุธ ุงูุชููุงุฆู
            app.debouncedSave = app.utils.debounce(app.saveData, 1500);

            app.companyInfo.render();
            app.ife.render();
            app.efe.render();
            app.cpm.render();
            app.swot.render();
            app.bcg.render();
            app.ie.render();
            app.space._loadRender();
            app.qspm.render();
          },

          // (ูุง ุญุงุฌุฉ ูู export/import/clear data ูุฃููุง ูุณุชุฎุฏู Firebase)

          showModal(toolId) {
            const info = app.infoContent[toolId];
            if (info) {
              document.getElementById("modal-title").innerHTML = info.title;
              document.getElementById("modal-body").innerHTML = info.body;
              document.getElementById("info-modal").style.display = "block";
            }
          },

          closeModal() {
            document.getElementById("info-modal").style.display = "none";
          },

          companyInfo: {
            save() {
              app.data.companyInfo = {
                name: document.getElementById("company-name").value,
                industry: document.getElementById("company-industry").value,
                country: document.getElementById("company-country").value,
                notes: document.getElementById("company-notes").value,
              };
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            render() {
              if (!app.data.companyInfo) return;
              document.getElementById("company-name").value =
                app.data.companyInfo.name || "";
              document.getElementById("company-industry").value =
                app.data.companyInfo.industry || "";
              document.getElementById("company-country").value =
                app.data.companyInfo.country || "";
              document.getElementById("company-notes").value =
                app.data.companyInfo.notes || "";
            },
          },

          ife: {
            add() {
              const text = document.getElementById("ife-text").value;
              const type = document.getElementById("ife-type").value;
              const weight = parseFloat(
                document.getElementById("ife-weight").value
              );
              const rating = parseInt(
                document.getElementById("ife-rating").value
              );

              if (!text || !weight || !rating)
                return alert("ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู");

              app.data.ife.items.push({
                id: Date.now(),
                text,
                type,
                weight,
                rating,
              });
              app.ife.render();
              app.saveData(); // (ุญูุธ ููุฑู)

              document.getElementById("ife-text").value = "";
              document.getElementById("ife-weight").value = "";
              document.getElementById("ife-rating").value = "";
            },
            delete(id) {
              app.data.ife.items = app.data.ife.items.filter(
                (i) => i.id !== id
              );
              app.ife.render();
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            render() {
              const tableBody = document.querySelector("#ife-table tbody");
              tableBody.innerHTML = "";
              let totalWeight = 0;
              let totalScore = 0;

              app.data.ife.items.forEach((item) => {
                const weightedScore = (item.weight * item.rating).toFixed(2);
                totalWeight += item.weight;
                totalScore += parseFloat(weightedScore);

                const row = tableBody.insertRow();
                row.innerHTML = `
                  <td>${item.text}</td>
                  <td>${item.type === "strength" ? "ููุฉ" : "ุถุนู"}</td>
                  <td>${item.weight.toFixed(2)}</td>
                  <td>${item.rating}</td>
                  <td><strong>${weightedScore}</strong></td>
                  <td><button class="btn btn-danger btn-sm" onclick="app.ife.delete(${
                    item.id
                  })">ุญุฐู</button></td>
                `;
              });

              const totalsDiv = document.getElementById("ife-totals");
              const analysis =
                totalScore > 2.5
                  ? "ูุถุน ุฏุงุฎูู ููู"
                  : totalScore < 2.5
                  ? "ูุถุน ุฏุงุฎูู ุถุนูู"
                  : "ูุถุน ุฏุงุฎูู ูุชูุณุท";
              totalsDiv.innerHTML = `
                <p>ูุฌููุน ุงูุฃูุฒุงู: <span style="color: ${
                  totalWeight.toFixed(2) == 1.0 ? "green" : "red"
                }">${totalWeight.toFixed(2)}</span> (ูุฌุจ ุฃู ูุณุงูู 1.0)</p>
                <p>ูุฌููุน ุงููุชุงุฆุฌ ุงูููุฒููุฉ: <strong>${totalScore.toFixed(
                  2
                )}</strong></p>
                <p class="analysis-result"><strong>ุงูุชุญููู:</strong> ${analysis} (ุงููุชูุฌุฉ: ${totalScore.toFixed(
                2
              )})</p>
              `;
            },
          },

          efe: {
            add() {
              const text = document.getElementById("efe-text").value;
              const type = document.getElementById("efe-type").value;
              const weight = parseFloat(
                document.getElementById("efe-weight").value
              );
              const rating = parseInt(
                document.getElementById("efe-rating").value
              );

              if (!text || !weight || !rating)
                return alert("ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู");

              app.data.efe.items.push({
                id: Date.now(),
                text,
                type,
                weight,
                rating,
              });
              app.efe.render();
              app.saveData(); // (ุญูุธ ููุฑู)

              document.getElementById("efe-text").value = "";
              document.getElementById("efe-weight").value = "";
              document.getElementById("efe-rating").value = "";
            },
            delete(id) {
              app.data.efe.items = app.data.efe.items.filter(
                (i) => i.id !== id
              );
              app.efe.render();
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            render() {
              const tableBody = document.querySelector("#efe-table tbody");
              tableBody.innerHTML = "";
              let totalWeight = 0;
              let totalScore = 0;

              app.data.efe.items.forEach((item) => {
                const weightedScore = (item.weight * item.rating).toFixed(2);
                totalWeight += item.weight;
                totalScore += parseFloat(weightedScore);

                const row = tableBody.insertRow();
                row.innerHTML = `
                  <td>${item.text}</td>
                  <td>${item.type === "opportunity" ? "ูุฑุตุฉ" : "ุชูุฏูุฏ"}</td>
                  <td>${item.weight.toFixed(2)}</td>
                  <td>${item.rating}</td>
                  <td><strong>${weightedScore}</strong></td>
                  <td><button class="btn btn-danger btn-sm" onclick="app.efe.delete(${
                    item.id
                  })">ุญุฐู</button></td>
                `;
              });

              const totalsDiv = document.getElementById("efe-totals");
              const analysis =
                totalScore > 2.5
                  ? "ุงุณุชุฌุงุจุฉ ูููุฉ ููุจูุฆุฉ"
                  : totalScore < 2.5
                  ? "ุงุณุชุฌุงุจุฉ ุถุนููุฉ ููุจูุฆุฉ"
                  : "ุงุณุชุฌุงุจุฉ ูุชูุณุทุฉ";
              totalsDiv.innerHTML = `
                <p>ูุฌููุน ุงูุฃูุฒุงู: <span style="color: ${
                  totalWeight.toFixed(2) == 1.0 ? "green" : "red"
                }">${totalWeight.toFixed(2)}</span> (ูุฌุจ ุฃู ูุณุงูู 1.0)</p>
                <p>ูุฌููุน ุงููุชุงุฆุฌ ุงูููุฒููุฉ: <strong>${totalScore.toFixed(
                  2
                )}</strong></p>
                <p class="analysis-result"><strong>ุงูุชุญููู:</strong> ${analysis} (ุงููุชูุฌุฉ: ${totalScore.toFixed(
                2
              )})</p>
              `;
            },
          },

          cpm: {
            addCompetitor() {
              const name = document.getElementById("cpm-competitor-name").value;
              if (!name) return alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู");
              app.data.cpm.competitors.push(name);
              app.data.cpm.factors.forEach((f) => f.ratings.push(1)); // (ุฅุถุงูุฉ ุชูููู ุงูุชุฑุงุถู)
              app.cpm.render();
              app.saveData(); // (ุญูุธ ููุฑู)
              document.getElementById("cpm-competitor-name").value = "";
            },
            addFactor() {
              const text = document.getElementById("cpm-factor-text").value;
              const weight = parseFloat(
                document.getElementById("cpm-factor-weight").value
              );
              if (!text || !weight) return alert("ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู");

              const ratings = new Array(app.data.cpm.competitors.length).fill(
                1
              );
              app.data.cpm.factors.push({
                id: Date.now(),
                text,
                weight,
                ratings,
              });
              app.cpm.render();
              app.saveData(); // (ุญูุธ ููุฑู)
              document.getElementById("cpm-factor-text").value = "";
              document.getElementById("cpm-factor-weight").value = "";
            },
            deleteFactor(id) {
              app.data.cpm.factors = app.data.cpm.factors.filter(
                (f) => f.id !== id
              );
              app.cpm.render();
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            updateRating(factorId, compIndex, value) {
              const factor = app.data.cpm.factors.find(
                (f) => f.id === factorId
              );
              factor.ratings[compIndex] = parseInt(value);
              app.cpm.render();
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            render() {
              const competitors = app.data.cpm.competitors;
              const factors = app.data.cpm.factors;

              document.getElementById("cpm-competitor-list").textContent =
                competitors.join(", ");
              const tableHead = document.querySelector("#cpm-table thead");
              const tableBody = document.querySelector("#cpm-table tbody");
              const tableFoot = document.querySelector("#cpm-table tfoot");

              let headHTML = "<tr><th>ุนุงูู ุงููุฌุงุญ ุงูุญุงุณู</th><th>ุงููุฒู</th>";
              competitors.forEach((name, index) => {
                headHTML += `<th>${name} (ุชูููู)</th><th>${name} (ูุชูุฌุฉ)</th>`;
              });
              headHTML += "<th>ุฅุฌุฑุงุกุงุช</th></tr>";
              tableHead.innerHTML = headHTML;

              tableBody.innerHTML = "";
              let totalWeight = 0;
              let columnTotals = new Array(competitors.length).fill(0);

              factors.forEach((factor) => {
                let rowHTML = `
                  <td>${factor.text}</td>
                  <td>${factor.weight.toFixed(2)}</td>
                `;
                totalWeight += factor.weight;
                factor.ratings.forEach((rating, index) => {
                  const score = (rating * factor.weight).toFixed(2);
                  columnTotals[index] += parseFloat(score);
                  rowHTML += `
                    <td><input type="number" min="1" max="4" value="${rating}" oninput="app.cpm.updateRating(${factor.id}, ${index}, this.value)"></td>
                    <td><strong>${score}</strong></td>
                  `;
                });
                rowHTML += `<td><button class="btn btn-danger btn-sm" onclick="app.cpm.deleteFactor(${factor.id})">ุญุฐู</button></td>`;
                tableBody.innerHTML += `<tr>${rowHTML}</tr>`;
              });

              let footHTML = `<tr>
                <td><strong>ุงููุฌููุน</strong></td>
                <td><strong style="color: ${
                  totalWeight.toFixed(2) == 1.0 ? "green" : "red"
                }">${totalWeight.toFixed(2)}</strong></td>
              `;
              competitors.forEach((name, index) => {
                footHTML += `
                  <td>---</td>
                  <td><strong>${columnTotals[index].toFixed(2)}</strong></td>
                `;
              });
              footHTML += "<td>---</td></tr>";
              tableFoot.innerHTML = footHTML;
            },
          },

          swot: {
            // ๐ก (ูุนุฏู) ุณุญุจ ุงูุจูุงูุงุช ูู Firebase
            async pullFactors() {
              document.getElementById("swot-reference").style.display = "block";
              const sList = document.getElementById("swot-s");
              const wList = document.getElementById("swot-w");
              const oList = document.getElementById("swot-o");
              const tList = document.getElementById("swot-t");

              // 1. ุณุญุจ ูู IFE/EFE (ุงููุฎุฒูุฉ ูุญููุงู ูู app.data)
              sList.innerHTML =
                app.data.ife.items
                  .filter((i) => i.type === "strength")
                  .map(
                    (i) =>
                      `<li><i class="fa-solid fa-list-check"></i> ${i.text} (ุชูููู: ${i.rating})</li>`
                  )
                  .join("") || "<li>ูู ูุชู ุฅุถุงูุฉ ููุงุท ููุฉ ูู IFE.</li>";
              wList.innerHTML =
                app.data.ife.items
                  .filter((i) => i.type === "weakness")
                  .map(
                    (i) =>
                      `<li><i class="fa-solid fa-list-check"></i> ${i.text} (ุชูููู: ${i.rating})</li>`
                  )
                  .join("") || "<li>ูู ูุชู ุฅุถุงูุฉ ููุงุท ุถุนู ูู IFE.</li>";
              oList.innerHTML =
                app.data.efe.items
                  .filter((i) => i.type === "opportunity")
                  .map(
                    (i) =>
                      `<li><i class="fa-solid fa-list-check"></i> ${i.text} (ุชูููู: ${i.rating})</li>`
                  )
                  .join("") || "<li>ูู ูุชู ุฅุถุงูุฉ ูุฑุต ูู EFE.</li>";
              tList.innerHTML =
                app.data.efe.items
                  .filter((i) => i.type === "threat")
                  .map(
                    (i) =>
                      `<li><i class="fa-solid fa-list-check"></i> ${i.text} (ุชูููู: ${i.rating})</li>`
                  )
                  .join("") || "<li>ูู ูุชู ุฅุถุงูุฉ ุชูุฏูุฏุงุช ูู EFE.</li>";

              // 2. ุณุญุจ ุจูุงูุงุช ุญูุฉ ูู Firebase
              try {
                const [productsSnap, materialsSnap] = await Promise.all([
                  getDocs(collection(db, "products")),
                  getDocs(collection(db, "raw_materials")),
                ]);

                const productsCount = productsSnap.size;
                const materials = materialsSnap.docs.map((d) => d.data());
                const lowStockCount = materials.filter(
                  (m) =>
                    m.current_stock <= m.reorder_point && m.reorder_point > 0
                ).length;

                sList.innerHTML += `<li style="color: green;"><i class="fa-solid fa-database"></i> ูุชุงููุฌ ููุชุฌุงุช ูุชููุน (${productsCount} ููุชุฌ)</li>`;
                if (lowStockCount > 0) {
                  wList.innerHTML += `<li style="color: red;"><i class="fa-solid fa-database"></i> ููุฌุฏ ${lowStockCount} ููุงุฏ ุฎุงู ุนูุฏ ููุทุฉ ุฅุนุงุฏุฉ ุงูุทูุจ</li>`;
                } else {
                  sList.innerHTML += `<li style="color: green;"><i class="fa-solid fa-database"></i> ุฅุฏุงุฑุฉ ุฌูุฏุฉ ูููุฎุฒูู (ูุง ููุฌุฏ ููุต ุญุฑุฌ)</li>`;
                }
              } catch (e) {
                console.error("Error pulling live data: ", e);
                wList.innerHTML += `<li><i class="fa-solid fa-database"></i> ุฎุทุฃ ูู ุณุญุจ ุงูุจูุงูุงุช ุงูุญูุฉ</li>`;
              }
            },
            render() {
              document.getElementById("swot-so").value = app.data.swot.so || "";
              document.getElementById("swot-st").value = app.data.swot.st || "";
              document.getElementById("swot-wo").value = app.data.swot.wo || "";
              document.getElementById("swot-wt").value = app.data.swot.wt || "";
            },
          },

          bcg: {
            add() {
              const name = document.getElementById("bcg-division").value;
              const growth = parseFloat(
                document.getElementById("bcg-growth").value
              );
              const rmsp = parseFloat(
                document.getElementById("bcg-rmsp").value
              );
              const revenue = parseFloat(
                document.getElementById("bcg-revenue").value
              );

              if (!name || isNaN(growth) || isNaN(rmsp) || isNaN(revenue))
                return alert("ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู");

              const safeRevenue = Math.max(1, revenue);
              const radius = 5 + Math.log10(safeRevenue) * 3;

              app.data.bcg.items.push({
                x: rmsp,
                y: growth,
                r: radius,
                label: name,
                revenue: revenue,
              });
              app.bcg.render();
              app.saveData(); // (ุญูุธ ููุฑู)

              document.getElementById("bcg-division").value = "";
              document.getElementById("bcg-growth").value = "";
              document.getElementById("bcg-rmsp").value = "";
              document.getElementById("bcg-revenue").value = "";
            },
            clear() {
              if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุฌููุน ุฃูุณุงู BCGุ")) {
                app.data.bcg.items = [];
                app.bcg.render();
                app.saveData(); // (ุญูุธ ููุฑู)
              }
            },
            render() {
              const ctx = document.getElementById("bcgChart").getContext("2d");
              if (app.charts.bcg) app.charts.bcg.destroy();

              const datasets = app.data.bcg.items.map((item) => {
                const quadrant =
                  item.x >= 0.5 && item.y >= 0
                    ? "ูุฌู"
                    : item.x < 0.5 && item.y >= 0
                    ? "ุงุณุชููุงู"
                    : item.x >= 0.5 && item.y < 0
                    ? "ุจูุฑุฉ ุญููุจ"
                    : "ููุจ";
                const color =
                  quadrant === "ูุฌู"
                    ? "rgba(54, 162, 235, 0.7)"
                    : quadrant === "ุงุณุชููุงู"
                    ? "rgba(255, 159, 64, 0.7)"
                    : quadrant === "ุจูุฑุฉ ุญููุจ"
                    ? "rgba(75, 192, 192, 0.7)"
                    : "rgba(255, 99, 132, 0.7)";

                return {
                  label: `${item.label} (${quadrant})`,
                  data: [{ x: item.x, y: item.y, r: item.r }],
                  backgroundColor: color,
                };
              });

              app.charts.bcg = new Chart(ctx, {
                type: "bubble",
                data: { datasets },
                options: {
                  responsive: true,
                  plugins: {
                    title: {
                      display: true,
                      text: "ูุตูููุฉ ุจูุณุทู (BCG)",
                      font: { family: "Cairo" },
                    },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          const item = app.data.bcg.items[context.datasetIndex];
                          return `${item.label}: (ุงูุญุตุฉ: ${item.x}, ุงูููู: ${
                            item.y
                          }%, ุงูุฅูุฑุงุฏุงุช: ${item.revenue.toLocaleString()})`;
                        },
                      },
                    },
                    annotation: {
                      annotations: {
                        line1: {
                          type: "line",
                          yMin: 0,
                          yMax: 0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                        line2: {
                          type: "line",
                          xMin: 0.5,
                          xMax: 0.5,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                      },
                    },
                  },
                  scales: {
                    x: {
                      title: {
                        display: true,
                        text: "ุงูุญุตุฉ ุงูุณูููุฉ ุงููุณุจูุฉ (RMSP)",
                        font: { family: "Cairo" },
                      },
                      reverse: true,
                      min: 0,
                      max: 1.0,
                      ticks: { stepSize: 0.1 },
                    },
                    y: {
                      title: {
                        display: true,
                        text: "ูุนุฏู ููู ุงูุตูุงุนุฉ (%)",
                        font: { family: "Cairo" },
                      },
                      min: -20,
                      max: 20,
                      ticks: { stepSize: 5 },
                    },
                  },
                },
              });
            },
          },

          ie: {
            add() {
              const name = document.getElementById("ie-division").value;
              const ife = parseFloat(document.getElementById("ie-ife").value);
              const efe = parseFloat(document.getElementById("ie-efe").value);
              const revenue = parseFloat(
                document.getElementById("ie-revenue").value
              );
              if (!name || isNaN(ife) || isNaN(efe) || isNaN(revenue))
                return alert("ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู");
              const safeRevenue = Math.max(1, revenue);
              const radius = 5 + Math.log10(safeRevenue) * 3;
              app.data.ie.items.push({
                x: ife,
                y: efe,
                r: radius,
                label: name,
                revenue: revenue,
              });
              app.ie.render();
              app.saveData(); // (ุญูุธ ููุฑู)
              document.getElementById("ie-division").value = "";
              document.getElementById("ie-ife").value = "";
              document.getElementById("ie-efe").value = "";
              document.getElementById("ie-revenue").value = "";
            },
            plotFirm() {
              const ifeScore = parseFloat(
                document.querySelector("#ife-totals strong")?.textContent || 0
              );
              const efeScore = parseFloat(
                document.querySelector("#efe-totals strong")?.textContent || 0
              );
              if (
                isNaN(ifeScore) ||
                isNaN(efeScore) ||
                ifeScore === 0 ||
                efeScore === 0
              )
                return alert("ุงูุฑุฌุงุก ุฅููุงู ูุตูููุงุช IFE ู EFE ุฃููุงู.");
              app.data.ie.firm = {
                x: ifeScore,
                y: efeScore,
                r: 10,
                label: "ุดุฑูุชู",
              };
              app.ie.render();
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            clear() {
              if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุฌููุน ุฃูุณุงู IEุ")) {
                app.data.ie.items = [];
                app.data.ie.firm = null;
                app.ie.render();
                app.saveData(); // (ุญูุธ ููุฑู)
              }
            },
            render() {
              const ctx = document.getElementById("ieChart").getContext("2d");
              if (app.charts.ie) app.charts.ie.destroy();

              const ifeScore = app.data.ife.items
                .reduce((acc, i) => acc + i.weight * i.rating, 0)
                .toFixed(2);
              const efeScore = app.data.efe.items
                .reduce((acc, i) => acc + i.weight * i.rating, 0)
                .toFixed(2);
              document.getElementById("ie-ife-score").textContent =
                ifeScore > 0 ? ifeScore : "N/A";
              document.getElementById("ie-efe-score").textContent =
                efeScore > 0 ? efeScore : "N/A";

              let allData = [...app.data.ie.items];
              if (app.data.ie.firm) {
                allData.push(app.data.ie.firm);
              }

              const datasets = allData.map((item, index) => ({
                label: item.label,
                data: [{ x: item.x, y: item.y, r: item.r }],
                backgroundColor:
                  item.label === "ุดุฑูุชู"
                    ? "rgba(255, 99, 132, 0.9)"
                    : "rgba(54, 162, 235, 0.7)",
              }));

              app.charts.ie = new Chart(ctx, {
                type: "bubble",
                data: { datasets },
                options: {
                  responsive: true,
                  plugins: {
                    title: {
                      display: true,
                      text: "ุงููุตูููุฉ ุงูุฏุงุฎููุฉ-ุงูุฎุงุฑุฌูุฉ (IE)",
                      font: { family: "Cairo" },
                    },
                    tooltip: {
                      callbacks: {
                        label: (ctx) =>
                          `${allData[ctx.datasetIndex].label}: (IFE: ${
                            ctx.parsed.x
                          }, EFE: ${ctx.parsed.y})`,
                      },
                    },
                    annotation: {
                      annotations: {
                        lineX1: {
                          type: "line",
                          xMin: 2.0,
                          xMax: 2.0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                        lineX2: {
                          type: "line",
                          xMin: 3.0,
                          xMax: 3.0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                        lineY1: {
                          type: "line",
                          yMin: 2.0,
                          yMax: 2.0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                        lineY2: {
                          type: "line",
                          yMin: 3.0,
                          yMax: 3.0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                          borderDash: [6, 6],
                        },
                        labelGrow1: {
                          type: "label",
                          xValue: 3.5,
                          yValue: 3.5,
                          content: "ููู ูุจูุงุก",
                          font: { size: 14, family: "Cairo" },
                        },
                        labelHold: {
                          type: "label",
                          xValue: 2.5,
                          yValue: 2.5,
                          content: "ุญูุงุธ ูุตูุงูุฉ",
                          font: { size: 14, family: "Cairo" },
                        },
                        labelHarvest: {
                          type: "label",
                          xValue: 1.5,
                          yValue: 1.5,
                          content: "ุญุตุงุฏ/ุชุฎุงุฑุฌ",
                          font: { size: 14, family: "Cairo" },
                        },
                      },
                    },
                  },
                  scales: {
                    x: {
                      title: {
                        display: true,
                        text: "ูุชูุฌุฉ IFE (1.0 - 4.0)",
                        font: { family: "Cairo" },
                      },
                      min: 1.0,
                      max: 4.0,
                      ticks: { stepSize: 0.5 },
                    },
                    y: {
                      title: {
                        display: true,
                        text: "ูุชูุฌุฉ EFE (1.0 - 4.0)",
                        font: { family: "Cairo" },
                      },
                      min: 1.0,
                      max: 4.0,
                      ticks: { stepSize: 0.5 },
                    },
                  },
                },
              });
            },
          },

          space: {
            update() {
              const ratings = app.data.space.ratings;
              const getAvg = (prefix, count) => {
                let sum = 0;
                let num = 0;
                for (let i = 1; i <= 2; i++) {
                  // (ุชุจุณูุท ูู 2 ุนูุงูู ููุท ููุง ูู ุงููุซุงู ุงูุฌุฏูุฏ)
                  const id = `${prefix}${i}`;
                  const val = parseFloat(
                    document.getElementById(`space-${id}`)?.value
                  );
                  ratings[id] = val;
                  if (!isNaN(val)) {
                    sum += val;
                    num++;
                  }
                }
                return num === 0 ? 0 : sum / num;
              };

              const avgFP = getAvg("fp", 2);
              const avgSP = getAvg("sp", 2);
              const avgIP = getAvg("ip", 2);
              const avgCP = getAvg("cp", 2);

              document.getElementById("space-fp-avg").textContent =
                avgFP.toFixed(2);
              document.getElementById("space-sp-avg").textContent =
                avgSP.toFixed(2);
              document.getElementById("space-ip-avg").textContent =
                avgIP.toFixed(2);
              document.getElementById("space-cp-avg").textContent =
                avgCP.toFixed(2);

              const xAxis = avgIP + avgCP;
              const yAxis = avgFP + avgSP;

              app.data.space.xAxis = xAxis; // ุญูุธ ุงูุฅุญุฏุงุซูุงุช
              app.data.space.yAxis = yAxis;

              document.getElementById("space-x-axis").textContent =
                xAxis.toFixed(2);
              document.getElementById("space-y-axis").textContent =
                yAxis.toFixed(2);

              let strategy = "N/A";
              if (xAxis > 0 && yAxis > 0) strategy = "ูุฌููู (Aggressive)";
              else if (xAxis < 0 && yAxis > 0)
                strategy = "ูุชุญูุธ (Conservative)";
              else if (xAxis < 0 && yAxis < 0) strategy = "ุฏูุงุนู (Defensive)";
              else if (xAxis > 0 && yAxis < 0)
                strategy = "ุชูุงูุณู (Competitive)";

              document.getElementById("space-strategy").textContent = strategy;
              app.space.render(xAxis, yAxis);
              app.debouncedSave(); // (ุญูุธ ุชููุงุฆู)
            },
            render(xAxis = 0, yAxis = 0) {
              const ctx = document
                .getElementById("spaceChart")
                .getContext("2d");
              if (app.charts.space) app.charts.space.destroy();
              app.charts.space = new Chart(ctx, {
                type: "scatter",
                data: {
                  datasets: [
                    {
                      label: "ุงููุชุฌู ุงูุงุณุชุฑุงุชูุฌู",
                      data: [{ x: xAxis, y: yAxis }],
                      pointRadius: 10,
                      backgroundColor: "rgba(255, 99, 132, 0.9)",
                    },
                  ],
                },
                options: {
                  plugins: {
                    title: {
                      display: true,
                      text: "ูุตูููุฉ SPACE",
                      font: { family: "Cairo" },
                    },
                    tooltip: {
                      callbacks: {
                        label: (ctx) =>
                          `ุงููุชุฌู: (X: ${ctx.parsed.x.toFixed(
                            2
                          )}, Y: ${ctx.parsed.y.toFixed(2)})`,
                      },
                    },
                    annotation: {
                      annotations: {
                        lineX: {
                          type: "line",
                          xMin: 0,
                          xMax: 0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                        },
                        lineY: {
                          type: "line",
                          yMin: 0,
                          yMax: 0,
                          borderColor: "rgba(0,0,0,0.5)",
                          borderWidth: 2,
                        },
                        labelAggressive: {
                          type: "label",
                          xValue: 3.5,
                          yValue: 3.5,
                          content: "ูุฌููู",
                          font: { size: 12, family: "Cairo" },
                        },
                        labelConservative: {
                          type: "label",
                          xValue: -3.5,
                          yValue: 3.5,
                          content: "ูุชุญูุธ",
                          font: { size: 12, family: "Cairo" },
                        },
                        labelDefensive: {
                          type: "label",
                          xValue: -3.5,
                          yValue: -3.5,
                          content: "ุฏูุงุนู",
                          font: { size: 12, family: "Cairo" },
                        },
                        labelCompetitive: {
                          type: "label",
                          xValue: 3.5,
                          yValue: -3.5,
                          content: "ุชูุงูุณู",
                          font: { size: 12, family: "Cairo" },
                        },
                      },
                    },
                  },
                  scales: {
                    x: {
                      title: {
                        display: true,
                        text: "ูุญูุฑ (CP + IP)",
                        font: { family: "Cairo" },
                      },
                      min: -7,
                      max: 7,
                      ticks: { stepSize: 1 },
                    },
                    y: {
                      title: {
                        display: true,
                        text: "ูุญูุฑ (FP + SP)",
                        font: { family: "Cairo" },
                      },
                      min: -7,
                      max: 7,
                      ticks: { stepSize: 1 },
                    },
                  },
                },
              });
            },
            _loadRender() {
              // (ุชุจุณูุท ูู 2 ุนูุงูู ููุท)
              ["fp1", "fp2", "sp1", "sp2", "ip1", "ip2", "cp1", "cp2"].forEach(
                (id) => {
                  const el = document.getElementById(`space-${id}`);
                  if (el && app.data.space.ratings[id])
                    el.value = app.data.space.ratings[id];
                }
              );
              app.space.update();
            },
          },

          qspm: {
            updateNames() {
              app.data.qspm.s1Name =
                document.getElementById("qspm-s1-name").value || "ุงุณุชุฑุงุชูุฌูุฉ 1";
              app.data.qspm.s2Name =
                document.getElementById("qspm-s2-name").value || "ุงุณุชุฑุงุชูุฌูุฉ 2";
              app.qspm.render();
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            updateScore(factorType, factorId, strategyNum, value) {
              const key = `${factorType}-${factorId}`;
              if (!app.data.qspm.scores[key]) {
                app.data.qspm.scores[key] = { as1: 0, as2: 0 };
              }
              app.data.qspm.scores[key][`as${strategyNum}`] =
                parseInt(value) || 0;
              app.qspm.render();
              app.saveData(); // (ุญูุธ ููุฑู)
            },
            render() {
              const s1Name = app.data.qspm.s1Name;
              const s2Name = app.data.qspm.s2Name;
              document.getElementById("qspm-s1-name").value = s1Name;
              document.getElementById("qspm-s2-name").value = s2Name;
              document.getElementById(
                "qspm-s1-header"
              ).textContent = `${s1Name}: AS`;
              document.getElementById(
                "qspm-s1-tas-header"
              ).textContent = `${s1Name}: TAS`;
              document.getElementById(
                "qspm-s2-header"
              ).textContent = `${s2Name}: AS`;
              document.getElementById(
                "qspm-s2-tas-header"
              ).textContent = `${s2Name}: TAS`;

              const body = document.getElementById("qspm-factors-body");
              body.innerHTML = "";
              let totalTAS1 = 0;
              let totalTAS2 = 0;

              const buildRows = (title, factors, type) => {
                if (factors.length === 0) return;
                body.innerHTML += `<tr><td colspan="6" style="background-color: #f8f9fa;"><strong>${title}</strong></td></tr>`;
                factors.forEach((f) => {
                  const key = `${type}-${f.id}`;
                  const scoreData = app.data.qspm.scores[key] || {
                    as1: 0,
                    as2: 0,
                  };
                  const as1 = scoreData.as1;
                  const as2 = scoreData.as2;
                  const tas1 = (f.weight * as1).toFixed(2);
                  const tas2 = (f.weight * as2).toFixed(2);
                  totalTAS1 += parseFloat(tas1);
                  totalTAS2 += parseFloat(tas2);
                  body.innerHTML += `
                    <tr>
                      <td>${f.text}</td>
                      <td>${f.weight.toFixed(2)}</td>
                      <td><input type="number" min="0" max="4" value="${as1}" oninput="app.qspm.updateScore('${type}', ${
                    f.id
                  }, 1, this.value)"></td>
                      <td class="tas">${tas1}</td>
                      <td><input type="number" min="0" max="4" value="${as2}" oninput="app.qspm.updateScore('${type}', ${
                    f.id
                  }, 2, this.value)"></td>
                      <td class="tas">${tas2}</td>
                    </tr>
                  `;
                });
              };

              buildRows(
                "ููุงุท ุงูููุฉ ุงูุฏุงุฎููุฉ",
                app.data.ife.items.filter((i) => i.type === "strength"),
                "ife"
              );
              buildRows(
                "ููุงุท ุงูุถุนู ุงูุฏุงุฎููุฉ",
                app.data.ife.items.filter((i) => i.type === "weakness"),
                "ife"
              );
              buildRows(
                "ุงููุฑุต ุงูุฎุงุฑุฌูุฉ",
                app.data.efe.items.filter((i) => i.type === "opportunity"),
                "efe"
              );
              buildRows(
                "ุงูุชูุฏูุฏุงุช ุงูุฎุงุฑุฌูุฉ",
                app.data.efe.items.filter((i) => i.type === "threat"),
                "efe"
              );

              const foot = document.getElementById("qspm-totals-foot");
              foot.innerHTML = `
                <tr>
                  <td colspan="2"><strong>ูุฌููุน ุฏุฑุฌุงุช ุงูุฌุงุฐุจูุฉ (STAS)</strong></td>
                  <td>---</td>
                  <td class="tas"><strong>${totalTAS1.toFixed(2)}</strong></td>
                  <td>---</td>
                  <td class="tas"><strong>${totalTAS2.toFixed(2)}</strong></td>
                </tr>
              `;
            },
          },

          // ๐ก (ูุนุฏู) ูุงุณุชุฎุฏุงู ููุชุจุฉ @google/generative-ai
          aiReport: {
            model: null,
            _gatherData() {
              let context = "START OF DATA:\n\n";
              context += "== COMPANY INFO ==\n";
              context += `Name: ${app.data.companyInfo.name}\n`;
              context += `Industry: ${app.data.companyInfo.industry}\n`;
              context += `Country/Region: ${app.data.companyInfo.country}\n`;
              context += `Notes: ${app.data.companyInfo.notes}\n\n`;
              const ifeScore = app.data.ife.items
                .reduce((acc, i) => acc + i.weight * i.rating, 0)
                .toFixed(2);
              context += `== IFE MATRIX (Total Score: ${ifeScore}) ==\n`;
              context += "Strengths:\n";
              app.data.ife.items
                .filter((i) => i.type === "strength")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "Weaknesses:\n";
              app.data.ife.items
                .filter((i) => i.type === "weakness")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "\n";
              const efeScore = app.data.efe.items
                .reduce((acc, i) => acc + i.weight * i.rating, 0)
                .toFixed(2);
              context += `== EFE MATRIX (Total Score: ${efeScore}) ==\n`;
              context += "Opportunities:\n";
              app.data.efe.items
                .filter((i) => i.type === "opportunity")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "Threats:\n";
              app.data.efe.items
                .filter((i) => i.type === "threat")
                .forEach(
                  (i) =>
                    (context += `- ${i.text} (W:${i.weight}, R:${i.rating})\n`)
                );
              context += "\n";
              context += "== CPM MATRIX ==\n";
              context += `Competitors: ${app.data.cpm.competitors.join(
                ", "
              )}\n`;
              app.data.cpm.factors.forEach((f) => {
                context += `- Factor: ${f.text} (W:${
                  f.weight
                }), Ratings: [${f.ratings.join(", ")}]\n`;
              });
              context += "\n";
              context += "== SWOT STRATEGIES ==\n";
              context += `S-O: ${app.data.swot.so}\n`;
              context += `W-O: ${app.data.swot.wo}\n`;
              context += `S-T: ${app.data.swot.st}\n`;
              context += `W-T: ${app.data.swot.wt}\n\n`;
              context += "== BCG MATRIX ==\n";
              app.data.bcg.items.forEach((i) => {
                context += `- Division: ${i.label} (Growth: ${i.y}%, RMSP: ${i.x}, Revenue: ${i.revenue})\n`;
              });
              context += "\n";
              context += "== SPACE MATRIX ==\n";
              context += `Coordinates: (X: ${app.data.space.xAxis?.toFixed(
                2
              )}, Y: ${app.data.space.yAxis?.toFixed(2)})\n\n`;
              context += "== QSPM ==\n";
              context += `Strategy 1 (${app.data.qspm.s1Name}) vs Strategy 2 (${app.data.qspm.s2Name})\n`;
              // (ูููู ุฅุถุงูุฉ ุชูุงุตูู QSPM ููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ)
              context += "END OF DATA\n";
              return context;
            },

            async generate() {
              const language = document.getElementById("ai-language").value;
              const btn = document.getElementById("ai-generate-btn");
              const loader = document.getElementById("ai-loader");
              const output = document.getElementById("ai-report-output");

              btn.disabled = true;
              loader.style.display = "block";
              output.textContent =
                "ูุชู ุชุฌููุน ุงูุจูุงูุงุช ูุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู... ูุฏ ูุณุชุบุฑู ูุฐุง 30 ุซุงููุฉ.";

              try {
                if (!this.model) {
                  this.model = genAI.getGenerativeModel({
                    model: "gemini-2.5-flash",
                  });
                }
                const dataContext = this._gatherData();
                const prompt = `
                  ุฃูุช ูุณุชุดุงุฑ ุฅุฏุงุฑุฉ ุงุณุชุฑุงุชูุฌูุฉ ูุญุชุฑู. ูููุชู ูู ูุชุงุจุฉ ุชูุฑูุฑ ุชุญููู ุงุณุชุฑุงุชูุฌู ูุงูู ููุนููู ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูุชู ูุฏููุง.

                  ูุฐู ูู ุงูุจูุงูุงุช:
                  ${dataContext}

                  ูุฌุจ ูุชุงุจุฉ ุชูุฑูุฑู ุจุงููุบุฉ: ${language}.
                  
                  ูุฑุฌู ููููุฉ ุชูุฑูุฑู ูุงูุชุงูู (ุงุณุชุฎุฏู ุชูุณูู Markdown ู h3 ููุนูุงููู ุงูุฑุฆูุณูุฉ):
                  1.  **ููุฎุต ุชูููุฐู:** ูุธุฑุฉ ุนุงูุฉ ูุฎุชุตุฑุฉ ุนูู ุงููุถุน ุงูุงุณุชุฑุงุชูุฌู ููุดุฑูุฉ ูุฃูู ุงูุชูุตูุงุช.
                  2.  **ุงูุชุญููู ุงูุฏุงุฎูู (IFE):** ุชุญููู ุงููุชูุฌุฉ ุงูุฅุฌูุงููุฉุ ูุฃูู ููุงุท ุงูููุฉุ ูุฃูู ููุงุท ุงูุถุนู.
                  3.  **ุงูุชุญููู ุงูุฎุงุฑุฌู (EFE):** ุชุญููู ุงููุชูุฌุฉ ุงูุฅุฌูุงููุฉุ ูุฃูู ุงููุฑุตุ ูุฃูู ุงูุชูุฏูุฏุงุช.
                  4.  **ุงููุดูุฏ ุงูุชูุงูุณู (CPM):** ุชุญููู ูุถุน ุงูุดุฑูุฉ ููุงุจู ููุงูุณููุง ุจูุงุกู ุนูู ูุชุงุฆุฌ CPM.
                  5.  **ุชุญููู ุงููุญูุธุฉ (BCG & IE):** ุชุญููู ุงูุฃูุณุงู ุจูุงุกู ุนูู ุจูุงูุงุช BCG ู IE (ุฅู ูุฌุฏุช).
                  6.  **ุงููุถุน ุงูุงุณุชุฑุงุชูุฌู (SPACE):** ุชุญููู ุฅุญุฏุงุซูุงุช ูุตูููุฉ SPACE ูุงูุชูุตูุฉ ุจุงููุถุน ุงูุงุณุชุฑุงุชูุฌู (ูุฌูููุ ูุชุญูุธุ ุงูุฎ).
                  7.  **ุงูุชูุตูุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ (SWOT & QSPM):** ุชุฌููุน ุงุณุชุฑุงุชูุฌูุงุช SWOT ููุชุงุฆุฌ QSPM (ุฅู ูุฌุฏุช) ูุชูุฏูู 3-5 ุชูุตูุงุช ุงุณุชุฑุงุชูุฌูุฉ ูุญุฏุฏุฉ ููุงุจูุฉ ููุชูููุฐ.

                  ูู ูุญุชุฑูุงูุ ููุฏู ุฑุคู ุซุงูุจุฉุ ูุงุณุชุฎุฏู ุงูุจูุงูุงุช ูุชุจุฑูุฑ ุงุณุชูุชุงุฌุงุชู.
                `;

                const result = await this.model.generateContent(prompt);
                const response = result.response;
                const reportText = response.text();

                // (ุชูุธูู ุจุณูุท ูููุต)
                output.textContent = reportText.replace(
                  /h3>/g,
                  'h3 style="color:var(--primary-color);">'
                );
              } catch (error) {
                output.textContent = `ุญุฏุซ ุฎุทุฃ: ${error.message}\n\nูุฑุฌู ุงูุชุฃูุฏ ูู ุฃู ููุชุงุญ API ูู ุงูุณูุฑุจุช ุตุญูุญ ูุฃู ูุฏูู ุงุชุตุงู ุจุงูุฅูุชุฑูุช.`;
                console.error("AI Report Error:", error);
              } finally {
                btn.disabled = false;
                loader.style.display = "none";
              }
            },
          },
        };

        // --- ููุทุฉ ุจุฏุงูุฉ ุงูุชุทุจูู ---
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === "admin") {
              app.init(user); // ๐ก ุจุฏุก ุงูุชุทุจูู
            } else {
              alert("ุบูุฑ ูุตุฑุญ ูู ุจุงููุตูู ุฅูู ูุฐู ุงูุตูุญุฉ.");
              window.location.href = "login.html";
            }
          } else {
            window.location.href = "login.html";
          }
        });

        // (ุฌุนู ุงููุงุฆู 'app' ูุชุงุญุงู ูู ุงููุทุงู ุงูุนุงู ููุฃุฒุฑุงุฑ)
        window.app = app;
      })();
    </script>
  </body>
</html>
