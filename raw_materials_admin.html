<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | إدارة المواد الخام</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* تصميم خاص للجدول ليتناسب مع المواد الخام */
      .materials-table th,
      .materials-table td {
        white-space: nowrap;
      }
      /* (باقي الستايلات الخاصة بالجدول موجودة في admin.css الآن) */
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">منجرة</div>
      <nav>
        <ul>
          <li><a href="admin.html">لوحة التحكم</a></li>
          <li><a href="orders_admin.html">إدارة الطلبات</a></li>
          <li><a href="inventory.html">إدارة المنتجات</a></li>
          <li>
            <a href="raw_materials_admin.html" class="active"
              >إدارة المواد الخام</a
            >
          </li>
          <li><a href="#" id="logout-btn">تسجيل الخروج</a></li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>إدارة المواد الخام</h1>

      <div class="inventory-section admin-panel">
        <div class="section-header">
          <button class="btn" id="add-material-btn">
            <i class="fa-solid fa-plus"></i> إضافة مادة خام جديدة
          </button>
        </div>
        <div id="materials-table-container">
          <p class="loading-msg">جارٍ تحميل المواد الخام...</p>
        </div>
      </div>
    </div>

    <div id="material-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="modal-title"></h2>
        <form id="material-form">
          <input type="hidden" id="material-id" />
          <div class="form-group">
            <label for="material-name">اسم المادة (عربي)</label>
            <input type="text" id="material-name" required />
          </div>
          <div class="form-group">
            <label for="material-type">النوع</label>
            <select id="material-type" required>
              <option value="خشب">خشب</option>
              <option value="طلاء">طلاء / ورنيش</option>
              <option value="قماش">قماش / تنجيد</option>
              <option value="معدن">معدن / فولاذ</option>
              <option value="مادة ربط">مادة ربط (براغي، غراء)</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>
          <div class="form-group">
            <label for="material-unit"
              >وحدة القياس (مثل: متر مكعب، قطعة، لتر، متر)</label
            >
            <input type="text" id="material-unit" required />
          </div>
          <div class="form-group">
            <label for="material-cost">تكلفة الوحدة (شيكل)</label>
            <input
              type="number"
              id="material-cost"
              min="0.01"
              step="0.01"
              required
            />
          </div>
          <div class="form-group">
            <label for="material-stock">الكمية المتوفرة حالياً</label>
            <input
              type="number"
              id="material-stock"
              min="0"
              step="any"
              required
            />
          </div>
          <div class="form-group">
            <label for="material-reorder"
              >نقطة إعادة الطلب (تنبيه عند الوصول لهذا الرقم)</label
            >
            <input
              type="number"
              id="material-reorder"
              min="0"
              step="any"
              required
            />
          </div>
          <div class="btn-group">
            <button type="submit" class="btn" id="save-material-btn">
              حفظ
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="confirm-title"></h2>
        <p
          id="confirm-message"
          style="text-align: center; margin-bottom: 2rem"
        ></p>
        <div class="btn-group">
          <button id="confirm-action-btn" class="btn btn-danger">تأكيد</button>
          <button class="btn btn-secondary modal-close">x</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // تهيئة Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // الدوال المساعدة لفتح وإغلاق المودال مع تحسينات التمرير
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      // إغلاق المودال بالنقر خارجها
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target.classList.contains("modal-overlay")) {
            closeModal(modal.id);
          }
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal-overlay.active")
            .forEach((modal) => {
              closeModal(modal.id);
            });
        }
      });

      // عناصر الواجهة
      const materialsTableContainer = document.getElementById(
        "materials-table-container"
      );
      const materialForm = document.getElementById("material-form");
      const materialIdInput = document.getElementById("material-id");
      const confirmActionBtn = document.getElementById("confirm-action-btn");
      const modalTitleEl = document.getElementById("modal-title");

      let allRawMaterials = [];

      // التحقق من صلاحيات المدير
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchAndRenderRawMaterials();
          } else {
            alert("غير مصرح لك بالوصول إلى هذه الصفحة.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      async function fetchAndRenderRawMaterials() {
        materialsTableContainer.innerHTML =
          '<p class="loading-msg">جارٍ تحميل المواد الخام...</p>';
        try {
          const snapshot = await getDocs(collection(db, "raw_materials"));
          allRawMaterials = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0),
            reorder_point: parseFloat(doc.data().reorder_point || 0),
          }));

          renderMaterialsTable(allRawMaterials);
        } catch (e) {
          console.error("Error fetching raw materials: ", e);
          materialsTableContainer.innerHTML =
            '<p class="loading-msg" style="color: red;">حدث خطأ في جلب المواد الخام.</p>';
        }
      }

      function renderMaterialsTable(materials) {
        if (materials.length === 0) {
          materialsTableContainer.innerHTML =
            '<p class="loading-msg">لا توجد مواد خام مسجلة.</p>';
          return;
        }

        let tableHtml = `
          <table class="orders-table materials-table">
            <thead>
              <tr>
                <th>اسم المادة</th>
                <th>النوع</th>
                <th>وحدة القياس</th>
                <th>التكلفة (شيكل)</th>
                <th>الكمية المتوفرة</th>
                <th>إعادة الطلب</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody>
        `;
        materials.forEach((material) => {
          const stock = material.current_stock;
          const reorder = material.reorder_point;
          let statusHtml = "";

          if (stock <= reorder) {
            statusHtml = `<span class="inventory-alert"> يجب إعادة الطلب</span>`;
          } else if (stock < reorder * 2) {
            statusHtml = `<span class="inventory-warning"> مخزون منخفض</span>`;
          } else {
            statusHtml = `<span class="inventory-ok"> متوفر</span>`;
          }

          tableHtml += `
            <tr data-id="${material.id}">
              <td>${material.name_ar}</td>
              <td>${material.type}</td>
              <td>${material.unit || "---"}</td>
              <td>${material.cost_per_unit.toFixed(2)}</td>
              <td>${stock.toFixed(2)}</td>
              <td>${reorder.toFixed(2)}</td>
              <td>${statusHtml}</td>
              <td class="actions-buttons">
                <button class="btn btn-secondary btn-sm edit-material-btn" data-id="${
                  material.id
                }">تعديل</button>
                <button class="btn btn-danger btn-sm delete-material-btn" data-id="${
                  material.id
                }">حذف</button>
              </td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        materialsTableContainer.innerHTML = tableHtml;
      }

      document
        .getElementById("add-material-btn")
        .addEventListener("click", () => {
          modalTitleEl.textContent = "إضافة مادة خام جديدة";
          materialIdInput.value = "";
          materialForm.reset();
          openModal("material-modal");
        });

      materialsTableContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("edit-material-btn")) {
          const id = e.target.dataset.id;
          const material = allRawMaterials.find((m) => m.id === id);
          if (material) {
            modalTitleEl.textContent = "تعديل مادة خام";
            materialIdInput.value = id;
            document.getElementById("material-name").value = material.name_ar;
            document.getElementById("material-type").value = material.type;
            document.getElementById("material-unit").value =
              material.unit || "";
            document.getElementById("material-cost").value =
              material.cost_per_unit;
            document.getElementById("material-stock").value =
              material.current_stock;
            document.getElementById("material-reorder").value =
              material.reorder_point;
            openModal("material-modal");
          }
        } else if (e.target.classList.contains("delete-material-btn")) {
          const id = e.target.dataset.id;
          showConfirmationModal(
            "حذف مادة خام",
            "هل أنت متأكد من حذف هذه المادة الخام نهائياً؟",
            () => deleteRawMaterial(id)
          );
        }
      });

      materialForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const isNew = !materialIdInput.value;
        const id = isNew
          ? doc(collection(db, "raw_materials")).id
          : materialIdInput.value;

        const materialData = {
          name_ar: document.getElementById("material-name").value,
          type: document.getElementById("material-type").value,
          unit: document.getElementById("material-unit").value,
          cost_per_unit: parseFloat(
            document.getElementById("material-cost").value
          ),
          current_stock: parseFloat(
            document.getElementById("material-stock").value
          ),
          reorder_point: parseFloat(
            document.getElementById("material-reorder").value
          ),
          last_update: new Date().toISOString(),
        };

        try {
          await setDoc(doc(db, "raw_materials", id), materialData);
          closeModal("material-modal");
          fetchAndRenderRawMaterials();
          alert(`تم ${isNew ? "إضافة" : "تحديث"} المادة الخام بنجاح.`);
        } catch (error) {
          console.error("Error saving material: ", error);
          alert("حدث خطأ أثناء حفظ المادة الخام.");
        }
      });

      async function deleteRawMaterial(id) {
        try {
          await deleteDoc(doc(db, "raw_materials", id));
          closeModal("confirmation-modal");
          fetchAndRenderRawMaterials();
          alert("تم حذف المادة الخام بنجاح.");
        } catch (e) {
          console.error("Error deleting material: ", e);
          alert("حدث خطأ أثناء حذف المادة الخام.");
        }
      }

      function showConfirmationModal(title, message, callback) {
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        confirmActionBtn.onclick = () => {
          callback();
          closeModal("confirmation-modal");
        };
        openModal("confirmation-modal");
      }
    </script>
  </body>
</html>
