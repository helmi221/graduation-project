<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      .materials-table th,
      .materials-table td {
        white-space: nowrap;
      }
      .inventory-alert {
        color: var(--danger-color);
        font-weight: 700;
      }
      .inventory-ok {
        color: var(--success-color);
        font-weight: 700;
      }
      .inventory-warning {
        color: var(--warning-color);
        font-weight: 700;
      }
      .purchase-controls {
        display: flex;
        gap: 10px;
        justify-content: flex-start;
        margin-bottom: 20px;
      }
      .purchase-controls .btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ */
      .stock-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .cost-review-box {
        background-color: var(--light-color);
        border: 1px solid var(--border-color);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        grid-column: 1 / -1;
      }
      .cost-review-box p {
        margin-bottom: 5px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--dark-color);
      }
      .cost-review-box p span {
        color: var(--primary-color);
        font-size: 1rem;
        margin-left: 10px;
      }
      .correction-note {
        color: var(--warning-color);
        font-size: 0.9rem;
        margin-bottom: 10px;
      }
      .operation-select {
        font-weight: 600;
        border: 1px solid var(--primary-color);
      }
      /* ğŸ’¡ Ø£Ù†Ù…Ø§Ø· Ø·ÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© */
      .log-toggle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background-color: #f7f5f2;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid var(--border-color);
      }
      .log-toggle-header h2 {
        margin: 0;
        font-size: 1.2rem;
        text-align: right;
      }
      .log-content-wrapper {
        display: none;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .log-content-wrapper.active {
        display: block;
        max-height: 600px; /* Ù‚ÙŠÙ…Ø© ÙƒØ¨ÙŠØ±Ø© Ø¨Ù…Ø§ ÙŠÙƒÙÙŠ Ù„Ù„Ø¹Ø±Ø¶ */
        transition: max-height 0.5s ease-in;
      }
      .log-toggle-icon {
        transition: transform 0.3s;
      }
      .log-toggle-header[aria-expanded="true"] .log-toggle-icon {
        transform: rotate(90deg);
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">Ù…Ù†Ø¬Ø±Ø©</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html" class="active"
              ><i class="fa-solid fa-hammer"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</h1>

      <div class="inventory-section admin-panel">
        <div class="purchase-controls">
          <button class="btn" id="add-material-btn">
            <i class="fa-solid fa-plus"></i> ØªØ¹Ø±ÙŠÙ Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
          </button>
          <button class="btn btn-secondary" id="open-full-stock-modal-btn">
            <i class="fa-solid fa-cubes-stacked"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡
            (Ø¨Ø§Ù„ØªÙƒÙ„ÙØ©)
          </button>
        </div>
        <div id="materials-table-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…...</p>
        </div>
      </div>

      <div class="inventory-section admin-panel" style="margin-top: 30px">
        <div
          class="log-toggle-header"
          id="log-toggle-header"
          aria-expanded="false"
        >
          <h2>
            <i class="fa-solid fa-clipboard-list"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¹Ø§Ù…
            (Ø¢Ø®Ø± 50 Ø­Ø±ÙƒØ©)
          </h2>
          <i class="fa-solid fa-chevron-left log-toggle-icon"></i>
        </div>
        <div id="materials-log-container-wrapper" class="log-content-wrapper">
          <div id="materials-log-container">
            <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª...</p>
          </div>
        </div>
      </div>
    </div>

    <div id="material-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="modal-title">ØªØ¹Ø±ÙŠÙ Ù…Ø§Ø¯Ø© Ø®Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <form id="material-form">
          <input type="hidden" id="material-id" />

          <div class="form-group">
            <label for="material-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ø¹Ø±Ø¨ÙŠ)</label>
            <input type="text" id="material-name" required />
          </div>

          <div class="modal-form-grid">
            <div class="form-group">
              <label for="material-type">Ø§Ù„Ù†ÙˆØ¹</label>
              <select id="material-type" required>
                <option value="Ø®Ø´Ø¨">Ø®Ø´Ø¨</option>
                <option value="Ø·Ù„Ø§Ø¡">Ø·Ù„Ø§Ø¡ / ÙˆØ±Ù†ÙŠØ´</option>
                <option value="Ù‚Ù…Ø§Ø´">Ù‚Ù…Ø§Ø´ / ØªÙ†Ø¬ÙŠØ¯</option>
                <option value="Ù…Ø¹Ø¯Ù†">Ù…Ø¹Ø¯Ù† / ÙÙˆÙ„Ø§Ø°</option>
                <option value="Ù…Ø§Ø¯Ø© Ø±Ø¨Ø·">Ù…Ø§Ø¯Ø© Ø±Ø¨Ø· (Ø¨Ø±Ø§ØºÙŠØŒ ØºØ±Ø§Ø¡)</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
            <div class="form-group">
              <label for="material-unit">ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³</label>
              <input type="text" id="material-unit" required />
            </div>
          </div>

          <div class="form-group">
            <label for="material-reorder">Ù†Ù‚Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</label>
            <input
              type="number"
              id="material-reorder"
              min="0"
              step="any"
              value="0"
              required
            />
          </div>

          <div class="btn-group">
            <button type="submit" class="btn" id="save-material-btn">
              <i class="fa-solid fa-save"></i> Ø­ÙØ¸ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø§Ø¯Ø©
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="stock-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡/ØªØµØ­ÙŠØ­ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
        <form id="stock-form">
          <div class="form-group">
            <label for="stock-material-select">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…</label>
            <select id="stock-material-select" required>
              <option value="">-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="stock-operation">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="stock-operation" class="operation-select" required>
              <option value="purchase">Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ / Ø¥Ø¶Ø§ÙØ©</option>
              <option value="correction">ØªØµØ­ÙŠØ­ (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø·Ø±Ø­ ÙƒÙ…ÙŠØ©/Ù‚ÙŠÙ…Ø©)</option>
            </select>
          </div>
          <p class="correction-note" id="correction-tip">
            * Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "ØªØµØ­ÙŠØ­"ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø© Ù„ØªØ®ÙÙŠØ¶ Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ
            Ø§Ù„ØªÙƒÙ„ÙØ©.
          </p>

          <div class="stock-form-grid">
            <div class="form-group">
              <label for="stock-quantity"
                ><span id="qty-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</span></label
              >
              <input type="number" id="stock-quantity" step="any" required />
            </div>
            <div class="form-group">
              <label for="stock-total-cost"
                ><span id="cost-label"
                  >Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡ (Ø´ÙŠÙƒÙ„)</span
                ></label
              >
              <input type="number" id="stock-total-cost" step="0.01" required />
            </div>
          </div>

          <div class="cost-review-box">
            <p>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="current-stock-value">---</span></p>
            <p>
              Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ÙˆØ­Ø¯Ø©:
              <span id="current-unit-cost">---</span>
            </p>
            <p>
              Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†:
              <span id="current-total-value">---</span>
            </p>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn">
              <i class="fa-solid fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="confirm-title"></h2>
        <p
          id="confirm-message"
          style="text-align: center; margin-bottom: 2rem"
        ></p>
        <div class="btn-group">
          <button id="confirm-action-btn" class="btn btn-danger">ØªØ£ÙƒÙŠØ¯</button>
          <button class="btn btn-secondary modal-close">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
        updateDoc,
        writeBatch,
        query,
        orderBy,
        limit,
        where, // ğŸ’¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ where Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // ØªÙ‡ÙŠØ¦Ø© Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      const materialsTableContainer = document.getElementById(
        "materials-table-container"
      );
      const materialModal = document.getElementById("material-modal");
      const stockModal = document.getElementById("stock-modal");
      const materialForm = document.getElementById("material-form");
      const stockForm = document.getElementById("stock-form");
      const materialIdInput = document.getElementById("material-id");
      const stockMaterialSelect = document.getElementById(
        "stock-material-select"
      );
      const stockOperationSelect = document.getElementById("stock-operation");
      const currentUnitCostDisplay =
        document.getElementById("current-unit-cost");
      const currentTotalValueDisplay = document.getElementById(
        "current-total-value"
      );
      const currentStockValueDisplay = document.getElementById(
        "current-stock-value"
      );
      const stockQuantityInput = document.getElementById("stock-quantity");
      const stockTotalCostInput = document.getElementById("stock-total-cost");
      const qtyLabel = document.getElementById("qty-label");
      const costLabel = document.getElementById("cost-label");
      const correctionTip = document.getElementById("correction-tip");
      const confirmActionBtn = document.getElementById("confirm-action-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const openFullStockModalBtn = document.getElementById(
        "open-full-stock-modal-btn"
      );

      const logToggleHeader = document.getElementById("log-toggle-header");
      const logContentWrapper = document.getElementById(
        "materials-log-container-wrapper"
      );
      const logContainer = document.getElementById("materials-log-container");

      let allRawMaterials = [];
      let rawMaterialsMap = new Map(); // ğŸ’¡ Map for quick lookup

      // ------------------------------------
      // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
      // ------------------------------------
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal-overlay.active")
            .forEach((modal) => {
              closeModal(modal.id);
            });
        }
      });

      // ğŸ’¡ Ù…Ù†Ø·Ù‚ ÙØªØ­ ÙˆØ·Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
      logToggleHeader.addEventListener("click", () => {
        const isExpanded =
          logToggleHeader.getAttribute("aria-expanded") === "true";
        logToggleHeader.setAttribute("aria-expanded", !isExpanded);
        logContentWrapper.classList.toggle("active");

        // Ø¥Ø°Ø§ ØªÙ… ÙØªØ­Ù‡ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…
        if (!isExpanded && logContainer.querySelector(".loading-msg")) {
          fetchAndRenderLog();
        }
      });

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchAndRenderRawMaterials();
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        await signOut(auth);
        window.location.href = "login.html";
      });

      // ------------------------------------
      // ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      // ------------------------------------
      async function fetchAndRenderRawMaterials() {
        materialsTableContainer.innerHTML =
          '<p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…...</p>';
        try {
          const snapshot = await getDocs(collection(db, "raw_materials"));
          allRawMaterials = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø­Ø³Ø§Ø¨
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0),
            total_cost_value: parseFloat(doc.data().total_cost_value || 0), // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
            reorder_point: parseFloat(doc.data().reorder_point || 0),
            unit: doc.data().unit || "ÙˆØ­Ø¯Ø©",
            name_ar: doc.data().name_ar || "---",
          }));

          rawMaterialsMap = new Map(allRawMaterials.map((m) => [m.id, m])); // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Map

          renderMaterialsTable(allRawMaterials);
          fillStockSelect(allRawMaterials);

          // ğŸ’¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¬Ù„ Ù…ÙØªÙˆØ­Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡
          if (logContentWrapper.classList.contains("active")) {
            await fetchAndRenderLog();
          }
        } catch (e) {
          console.error("Error fetching fixed costs: ", e);
          materialsTableContainer.innerHTML =
            '<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù….</p>';
        }
      }

      // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·)
      async function fetchAndRenderLog() {
        logContainer.innerHTML =
          '<p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª...</p>';

        try {
          const logCollection = collection(db, "raw_materials_log");
          // Ø³Ø¬Ù„ Ø¹Ø§Ù…
          const q = query(logCollection, orderBy("date", "desc"), limit(50));
          const snapshot = await getDocs(q);

          const logEntries = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            date: new Date(doc.data().date).toLocaleString("ar-EG", {
              dateStyle: "short",
              timeStyle: "short",
            }),
          }));

          renderLogTable(logEntries, logContainer, false);
        } catch (e) {
          console.error("Error fetching materials log: ", e);
          logContainer.innerHTML =
            '<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª.</p>';
        }
      }

      function renderLogTable(
        logEntries,
        targetContainer,
        isSingleMaterial = false
      ) {
        if (logEntries.length === 0) {
          targetContainer.innerHTML =
            '<p class="loading-msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ù„Ø¹Ø±Ø¶Ù‡.</p>';
          return;
        }

        let tableHtml = `
              <table class="orders-table">
                  <thead>
                      <tr>
                          ${
                            !isSingleMaterial
                              ? '<th><i class="fa-solid fa-list-check"></i> Ø§Ù„Ù…Ø§Ø¯Ø©</th>'
                              : ""
                          }
                          <th><i class="fa-solid fa-gear"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                          <th><i class="fa-solid fa-arrows-up-down"></i> Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                          <th><i class="fa-solid fa-money-bill-wave"></i> Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø´ÙŠÙƒÙ„)</th>
                          <th><i class="fa-solid fa-calendar-alt"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                          <th><i class="fa-solid fa-box"></i> Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ù…ØµØ¯Ø±</th>
                      </tr>
                  </thead>
                  <tbody>
          `;
        logEntries.forEach((entry) => {
          const materialData = rawMaterialsMap.get(entry.material_id) || {};
          const unit = materialData.unit || "ÙˆØ­Ø¯Ø©";
          const typeDisplay =
            entry.operation_type === "purchase"
              ? "Ø´Ø±Ø§Ø¡/Ø¥Ø¶Ø§ÙØ©"
              : entry.operation_type === "correction"
              ? "ØªØµØ­ÙŠØ­"
              : "Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ (Ø·Ù„Ø¨)";
          const quantityColor =
            entry.change_quantity > 0
              ? "color: var(--success-color); font-weight: 700;"
              : entry.change_quantity < 0
              ? "color: var(--danger-color); font-weight: 700;"
              : "color: #888;";
          const valueColor =
            entry.change_value > 0
              ? "color: var(--success-color); font-weight: 700;"
              : entry.change_value < 0
              ? "color: var(--danger-color); font-weight: 700;"
              : "color: #888;";

          tableHtml += `
                  <tr>
                      ${
                        !isSingleMaterial
                          ? `<td>${entry.material_name || "---"}</td>`
                          : ""
                      }
                      <td>${typeDisplay}</td>
                      <td style="${quantityColor}">${entry.change_quantity.toFixed(
            2
          )} ${unit}</td>
                      <td style="${valueColor}">${entry.change_value.toFixed(
            2
          )} Ø´ÙŠÙƒÙ„</td>
                      <td>${entry.date}</td>
                      <td>${
                        entry.order_id
                          ? `Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${entry.order_id}`
                          : "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"
                      }</td>
                  </tr>
              `;
        });
        tableHtml += "</tbody></table>";
        targetContainer.innerHTML = tableHtml;
      }

      function renderMaterialsTable(materials) {
        if (materials.length === 0) {
          materialsTableContainer.innerHTML =
            '<p class="loading-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… Ù…Ø³Ø¬Ù„Ø©.</p>';
          return;
        }

        let tableHtml = `
          <table class="orders-table materials-table">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³</th>
                <th>Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© (Ø´ÙŠÙƒÙ„)</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</th>
                <th>Ù†Ù‚Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
        `;
        materials.forEach((material) => {
          const stock = material.current_stock;
          const reorder = material.reorder_point;
          let statusHtml = "";
          let lastUpdate = material.last_update
            ? new Date(material.last_update).toLocaleDateString()
            : "---";

          if (stock <= 0 && reorder > 0) {
            statusHtml = `<span class="inventory-alert">Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>`;
          } else if (stock <= reorder) {
            statusHtml = `<span class="inventory-alert">ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</span>`;
          } else if (stock < reorder * 2) {
            statusHtml = `<span class="inventory-warning">Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶</span>`;
          } else {
            statusHtml = `<span class="inventory-ok">Ù…ØªÙˆÙØ±</span>`;
          }

          tableHtml += `
            <tr data-id="${material.id}">
              <td>${material.name_ar}</td>
              <td>${material.type}</td>
              <td>${material.unit || "---"}</td>
              <td>${material.cost_per_unit.toFixed(2)}</td>
              <td>${stock.toFixed(2)}</td>
              <td>${reorder.toFixed(2)}</td>
              <td>${statusHtml}</td>
              <td class="actions-buttons" style="white-space: nowrap;">
                
                <button class="btn btn-secondary btn-sm edit-material-btn" data-id="${
                  material.id
                }"><i class="fa-solid fa-pencil"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ</button>
                <button class="btn btn-danger btn-sm delete-material-btn" data-id="${
                  material.id
                }"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</button>
              </td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        materialsTableContainer.innerHTML = tableHtml;

        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        document.querySelectorAll(".edit-material-btn").forEach((btn) => {
          btn.addEventListener("click", handleEditMaterial);
        });
        document.querySelectorAll(".delete-material-btn").forEach((btn) => {
          btn.addEventListener("click", handleDeleteMaterialClick);
        });
      }

      function fillStockSelect(materials) {
        stockMaterialSelect.innerHTML =
          '<option value="">-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© --</option>';
        materials.forEach((m) => {
          const option = document.createElement("option");
          option.value = m.id;
          option.textContent = `${m.name_ar} (Ø§Ù„ÙˆØ­Ø¯Ø©: ${m.unit || "---"})`;
          stockMaterialSelect.appendChild(option);
        });
      }

      // ------------------------------------
      // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª (Ø§Ù„Ø£ØµÙ„ÙŠØ©)
      // ------------------------------------

      openFullStockModalBtn.addEventListener("click", () => {
        stockForm.reset();
        stockOperationSelect.value = "purchase";
        stockOperationSelect.dispatchEvent(new Event("change"));
        openModal("stock-modal");
      });

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      stockOperationSelect.addEventListener("change", () => {
        const isCorrection = stockOperationSelect.value === "correction";

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµØ§Ø¦Ø­ ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ù†ÙŠØ§
        correctionTip.style.display = isCorrection ? "block" : "none";
        stockQuantityInput.type = isCorrection ? "number" : "number"; // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹
        stockTotalCostInput.type = isCorrection ? "number" : "number";
        stockQuantityInput.min = isCorrection ? "" : "0.01";
        stockTotalCostInput.min = isCorrection ? "" : "0.01";
        stockQuantityInput.required = true;
        stockTotalCostInput.required = true;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ù…ÙŠØ§Øª
        qtyLabel.textContent = isCorrection
          ? "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§/Ø·Ø±Ø­Ù‡Ø§"
          : "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©";
        costLabel.textContent = isCorrection
          ? "Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§/Ø·Ø±Ø­Ù‡Ø§ (Ø´ÙŠÙƒÙ„)"
          : "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡ (Ø´ÙŠÙƒÙ„)";

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        stockMaterialSelect.dispatchEvent(new Event("change"));
      });

      // Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡
      stockMaterialSelect.addEventListener("change", () => {
        const selectedId = stockMaterialSelect.value;

        if (selectedId) {
          const material = allRawMaterials.find((m) => m.id === selectedId);
          if (material) {
            currentStockValueDisplay.textContent = `${material.current_stock.toFixed(
              2
            )} ${material.unit}`;
            currentUnitCostDisplay.textContent = `${material.cost_per_unit.toFixed(
              2
            )} Ø´ÙŠÙƒÙ„/${material.unit}`;
            currentTotalValueDisplay.textContent = `${material.total_cost_value.toFixed(
              2
            )} Ø´ÙŠÙƒÙ„`;
          }
        } else {
          currentStockValueDisplay.textContent = "---";
          currentUnitCostDisplay.textContent = "---";
          currentTotalValueDisplay.textContent = "---";
        }
      });

      // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ / Ø­Ø°Ù Ù…Ø§Ø¯Ø©
      function handleEditMaterial(e) {
        const id = e.currentTarget.dataset.id;
        const material = allRawMaterials.find((m) => m.id === id);
        if (material) {
          document.getElementById("modal-title").textContent =
            "ØªØ¹Ø¯ÙŠÙ„ ÙˆØµÙ Ø§Ù„Ù…Ø§Ø¯Ø©";
          materialIdInput.value = id;
          document.getElementById("material-name").value = material.name_ar;
          document.getElementById("material-type").value = material.type;
          document.getElementById("material-unit").value = material.unit || "";
          document.getElementById("material-reorder").value =
            material.reorder_point;
          openModal("material-modal");
        }
      }

      function handleDeleteMaterialClick(e) {
        const id = e.currentTarget.dataset.id;
        showConfirmationModal(
          "Ø­Ø°Ù Ù…Ø§Ø¯Ø© Ø®Ø§Ù…",
          "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ",
          () => deleteRawMaterial(id)
        );
      }

      document
        .getElementById("add-material-btn")
        .addEventListener("click", () => {
          document.getElementById("modal-title").textContent =
            "ØªØ¹Ø±ÙŠÙ Ù…Ø§Ø¯Ø© Ø®Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø©";
          materialIdInput.value = "";
          materialForm.reset();
          openModal("material-modal");
        });

      // ------------------------------------
      // ÙˆØ¸Ø§Ø¦Ù Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      // ------------------------------------

      // Ø­ÙØ¸ (ØªØ¹Ø±ÙŠÙ/ØªØ¹Ø¯ÙŠÙ„) Ù…Ø§Ø¯Ø© Ø®Ø§Ù…
      materialForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id =
          materialIdInput.value || doc(collection(db, "raw_materials")).id;
        const isUpdate = !!materialIdInput.value;

        let materialData = {
          name_ar: document.getElementById("material-name").value,
          type: document.getElementById("material-type").value,
          unit: document.getElementById("material-unit").value,
          reorder_point: parseFloat(
            document.getElementById("material-reorder").value
          ),
          last_update: new Date().toISOString(),
        };

        if (isUpdate) {
          const existingMaterial = allRawMaterials.find((m) => m.id === id);
          if (existingMaterial) {
            // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„ØªÙƒÙ„ÙØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØµÙÙŠ
            materialData.current_stock = existingMaterial.current_stock;
            materialData.cost_per_unit = existingMaterial.cost_per_unit;
            materialData.total_cost_value = existingMaterial.total_cost_value;
          }
        } else {
          materialData.current_stock = 0;
          materialData.cost_per_unit = 0;
          materialData.total_cost_value = 0;
        }

        try {
          await setDoc(doc(db, "raw_materials", id), materialData, {
            merge: true,
          });
          closeModal("material-modal");
          fetchAndRenderRawMaterials();
          alert(`ØªÙ… ${isUpdate ? "ØªØ¹Ø¯ÙŠÙ„ ÙˆØµÙ" : "ØªØ¹Ø±ÙŠÙ"} Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.`);
        } catch (error) {
          console.error("Error saving material: ", error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù….");
        }
      });

      // Ø­ÙØ¸ Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ…ÙŠØ© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø© (Stock Purchase/Correction)
      stockForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const materialId = stockMaterialSelect.value;
        const inputQuantity = parseFloat(stockQuantityInput.value);
        const inputTotalCost = parseFloat(stockTotalCostInput.value);
        const operationType = stockOperationSelect.value;

        const material = allRawMaterials.find((m) => m.id === materialId);

        if (!material || (inputQuantity === 0 && inputTotalCost === 0)) {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø£Ùˆ ÙƒÙ„ÙŠÙ‡Ù…Ø§).");
          return;
        }

        let currentStock = material.current_stock;
        let currentTotalCostValue = material.total_cost_value;
        let newTotalStock, newTotalCostValue, newAverageCostPerUnit;
        let changeQuantity = 0;
        let changeValue = 0;

        if (operationType === "purchase") {
          if (inputQuantity <= 0 || inputTotalCost <= 0) {
            alert(
              "ÙÙŠ Ø¹Ù…Ù„ÙŠØ© 'Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯'ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„ØªÙƒÙ„ÙØ© Ù…ÙˆØ¬Ø¨Ø© ÙˆØ£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±."
            );
            return;
          }

          changeQuantity = inputQuantity;
          changeValue = inputTotalCost;
          newTotalCostValue = currentTotalCostValue + inputTotalCost;
          newTotalStock = currentStock + inputQuantity;
        } else if (operationType === "correction") {
          // Ø§Ù„ØªØµØ­ÙŠØ­: Ù†Ø¶ÙŠÙ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø© (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø©)
          changeQuantity = inputQuantity;
          changeValue = inputTotalCost;
          newTotalStock = currentStock + inputQuantity;
          newTotalCostValue = currentTotalCostValue + inputTotalCost;

          if (newTotalStock < 0) {
            alert(
              " ÙØ´Ù„: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø©. (Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: " +
                currentStock.toFixed(2) +
                ")"
            );
            return;
          }
          if (newTotalCostValue < 0 && newTotalStock > 0) {
            alert(
              " ÙØ´Ù„: Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø®Ø²ÙˆÙ† ÙØ¹Ù„ÙŠ."
            );
            return;
          }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© (Average Costing Method)
        if (newTotalStock > 0) {
          newAverageCostPerUnit = newTotalCostValue / newTotalStock;
        } else {
          // Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† 0ØŒ ÙÙ…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© ÙŠØµØ¨Ø­ 0
          newAverageCostPerUnit = 0;
          newTotalCostValue = 0; // Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        }

        const batch = writeBatch(db);
        const materialRef = doc(db, "raw_materials", materialId);
        const logCollection = collection(db, "raw_materials_log");

        // 1. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…
        batch.update(materialRef, {
          current_stock: newTotalStock,
          total_cost_value: newTotalCostValue,
          cost_per_unit: newAverageCostPerUnit,
          last_update: new Date().toISOString(),
        });

        // 2. ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø±Ø§Ø¡/Ø§Ù„ØªØµØ­ÙŠØ­
        batch.set(doc(logCollection), {
          material_id: materialId,
          material_name: material.name_ar,
          change_quantity: changeQuantity, // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ
          change_value: changeValue, // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ
          operation_type: operationType,
          order_id: null, // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù‡Ù†Ø§
          date: new Date().toISOString(),
        });

        try {
          await batch.commit();

          closeModal("stock-modal");
          fetchAndRenderRawMaterials();
          alert(
            ` ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${newTotalStock.toFixed(
              2
            )}. Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${newAverageCostPerUnit.toFixed(
              2
            )} Ø´ÙŠÙƒÙ„.`
          );
        } catch (error) {
          console.error("Error updating stock:", error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.");
        }
      });

      async function deleteRawMaterial(id) {
        try {
          await deleteDoc(doc(db, "raw_materials", id));
          closeModal("confirmation-modal");
          fetchAndRenderRawMaterials();
          alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.");
        } catch (e) {
          console.error("Error deleting material: ", e);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù….");
        }
      }

      function showConfirmationModal(title, message, callback) {
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        confirmActionBtn.onclick = () => {
          callback();
          closeModal("confirmation-modal");
        };
        openModal("confirmation-modal");
      }
    </script>
  </body>
</html>
