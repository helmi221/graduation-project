<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | حالة الطلب</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .order-check-section {
        max-width: 900px;
        margin: 5rem auto;
        padding: 40px;
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: right;
      }
      .order-check-section h2,
      .order-check-section p {
        text-align: center;
      }
      .order-status-result-container {
        margin-top: 2rem;
        padding: 20px 0;
      }
      .order-card {
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 25px;
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
      }
      .order-card::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        width: 8px;
        background-color: var(--primary-color);
      }
      .order-card.status-مقبول-العميل::before,
      .order-card.status-مكتمل::before {
        background-color: #27ae60;
      }
      .order-card.status-قيد-المراجعة::before {
        background-color: #f1c40f;
      }
      .order-card.status-قيد-التنفيذ::before {
        background-color: #3498db;
      }
      .order-card.status-تم-الرفض::before {
        background-color: #e74c3c;
      }
      .order-card.status-مرفوض-العميل::before {
        background-color: #e74c3c;
      }
      .order-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
      }
      .order-id {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--dark-color);
      }
      .order-id i {
        color: var(--primary-color);
        margin-left: 10px;
      }
      .order-type {
        font-size: 0.9rem;
        color: #777;
        margin-top: 5px;
      }
      .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: bold;
        color: white;
        text-align: center;
        background-color: #34495e;
      }
      .status-badge.قيد-المراجعة {
        background-color: #ffeb3b;
        color: #3e2723;
      }
      .status-badge.مقبول {
        background-color: #2ecc71;
      }
      .status-badge.قيد-التصنيع,
      .status-badge.قيد-الطلاء,
      .status-badge.قيد-التغليف,
      .status-badge.قيد-الشحن,
      .status-badge.قيد-التنفيذ {
        background-color: #3498db;
      }
      .status-badge.مكتمل,
      .status-badge.مقبول-العميل {
        background-color: #27ae60;
      }
      .status-badge.تم-الرفض,
      .status-badge.مرفوض-العميل {
        background-color: #c0392b;
      }
      .order-details-list {
        list-style: none;
        padding: 0;
        margin-top: 10px;
      }
      .order-details-list li {
        padding: 5px 0;
        border-bottom: 1px dashed #eee;
        font-size: 1rem;
        display: flex;
        justify-content: space-between;
      }
      .order-details-list li:last-child {
        border-bottom: none;
      }
      .custom-design-details {
        margin-top: 15px;
        padding: 15px;
        background-color: #fafafa;
        border-radius: 8px;
        border: 1px dashed #ddd;
      }
      .custom-design-details p {
        margin-bottom: 5px;
      }
      .price-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .price-buttons .btn {
        font-family: "Cairo", sans-serif;
        padding: 10px 20px;
      }
      .price-buttons .btn-accept {
        background-color: #27ae60;
      }
      .price-buttons .btn-reject {
        background-color: #c0392b;
      }
      @media (max-width: 768px) {
        .order-card-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .order-id {
          font-size: 1.1rem;
        }
        .order-type {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">منجرة</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">الرئيسية</a>
            </li>
            <li>
              <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
            </li>
            <li>
              <a href="order-status.html" class="nav-link active">حالة الطلب</a>
            </li>
            <li>
              <a href="recommendation.html" class="nav-link">المساعد</a>
            </li>
            <li>
              <a href="design.html" class="nav-link">صمم منتجك</a>
            </li>
          </ul>
          <a href="cart.html" class="cart-icon-wrapper">
            <svg
              id="cart-icon"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
              />
            </svg>
            <span id="cart-count-badge">0</span>
          </a>
          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">الرئيسية</a>
      <a href="index.html#products-page" class="nav-link">منتجاتنا</a>
      <a href="order-status.html" class="nav-link">حالة الطلب</a>
      <a href="recommendation.html" class="nav-link">المساعد</a>
      <a href="design.html" class="nav-link">صمم منتجك</a>
    </div>

    <main>
      <div class="section container order-check-section">
        <div class="section-title-wrapper">
          <h2>التحقق من حالة الطلب</h2>
        </div>
        <div id="order-status-result" class="order-status-result-container">
          <p>يرجى تسجيل الدخول لعرض حالة طلباتك.</p>
        </div>
      </div>
    </main>

    <footer>
      <div class="container footer-content">
        <a href="index.html" class="footer-logo">منجرة</a>
        <div class="footer-links">
          <a href="#">من نحن</a> <a href="#">تواصل معنا</a>
        </div>
      </div>
      <div class="copyright">&copy; 2025 جميع الحقوق محفوظة.</div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        orderBy,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const orderStatusResult = document.getElementById("order-status-result");
      let cart = [];

      const simplifyStatus = (status) => {
        if (["قيد التصنيع", "قيد الطلاء", "قيد التغليف"].includes(status)) {
          return "قيد التنفيذ";
        }
        return status;
      };

      const handlePriceDecision = async (orderId, collectionName, status) => {
        try {
          const orderRef = doc(db, collectionName, orderId);
          await updateDoc(orderRef, { status: status });
          alert(`تم تحديث حالة طلبك إلى: ${status}`);
          location.reload();
        } catch (e) {
          console.error("Error updating order status: ", e);
          alert("حدث خطأ أثناء تحديث حالة الطلب. حاول مرة أخرى.");
        }
      };

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          orderStatusResult.innerHTML =
            "<h2 style='text-align: center;'>طلباتي</h2>";
          const ordersCollection = collection(db, "orders");
          const customDesignsCollection = collection(db, "custom_designs");

          const q1 = query(
            ordersCollection,
            where("customer_uid", "==", user.uid)
          );
          const q2 = query(
            customDesignsCollection,
            where("customer_uid", "==", user.uid)
          );

          const [ordersSnapshot, customDesignsSnapshot] = await Promise.all([
            getDocs(q1),
            getDocs(q2),
          ]);

          const allOrders = [];
          ordersSnapshot.forEach((doc) =>
            allOrders.push({ ...doc.data(), id: doc.id, type: "ready" })
          );
          customDesignsSnapshot.forEach((doc) =>
            allOrders.push({ ...doc.data(), id: doc.id, type: "custom" })
          );

          allOrders.sort(
            (a, b) => new Date(b.order_date) - new Date(a.order_date)
          );

          if (allOrders.length === 0) {
            orderStatusResult.innerHTML += "<p>لم تقم بإجراء أي طلبات بعد.</p>";
          } else {
            let resultHTML = "";
            allOrders.forEach((orderData) => {
              const simplifiedStatus = simplifyStatus(orderData.status);
              const statusClass = simplifiedStatus.replace(/\s+/g, "-");
              const orderType =
                orderData.type === "ready" ? "منتج جاهز" : "تصميم مخصص";

              let itemsListHTML = "";
              let totalDisplay = "";
              let actionsHtml = "";

              if (orderData.type === "ready") {
                itemsListHTML = orderData.items
                  .map(
                    (item) =>
                      `<li><span>${item.name} (العدد: ${item.quantity})</span><span>${item.price} شيكل</span></li>`
                  )
                  .join("");
                totalDisplay = `<p style="margin-top: 15px;"><strong>الإجمالي:</strong> ${orderData.total} شيكل</p>`;
              } else {
                itemsListHTML = `
                      <div class="custom-design-details">
                          <p><strong><i class="fa-solid fa-list-check"></i> وصف التصميم:</strong> ${
                            orderData.notes
                          }</p>
                          <p><strong><i class="fa-solid fa-chair"></i> النوع:</strong> ${
                            orderData.type_of_product || "---"
                          }</p>
                          <p><strong><i class="fa-solid fa-ruler-combined"></i> الأبعاد:</strong> ${
                            orderData.dimensions || "---"
                          }</p>
                          <p><strong><i class="fa-solid fa-tree"></i> المادة:</strong> ${
                            orderData.material || "---"
                          }</p>
                          <p><strong><i class="fa-solid fa-palette"></i> اللون:</strong> ${
                            orderData.color || "---"
                          }</p>
                      </div>
                  `;
                if (orderData.status === "مقبول" && orderData.final_price) {
                  totalDisplay = `<p><strong><i class="fa-solid fa-hand-holding-dollar"></i> السعر النهائي:</strong> <span style="color: green;">${orderData.final_price} شيكل</span></p>`;
                  actionsHtml = `
                    <div class="price-buttons">
                      <button class="btn btn-accept" data-id="${orderData.id}" data-collection="custom_designs" data-status="مقبول-العميل">قبول السعر</button>
                      <button class="btn btn-reject" data-id="${orderData.id}" data-collection="custom_designs" data-status="مرفوض-العميل">رفض السعر</button>
                    </div>
                  `;
                } else if (
                  orderData.status === "تم الرفض" &&
                  orderData.rejection_reason
                ) {
                  totalDisplay = `<p><strong><i class="fa-solid fa-hand-holding-dollar"></i> السعر المقترح:</strong> ${orderData.price}</p>`;
                  itemsListHTML += `<p style="color:red; margin-top: 10px;"><strong><i class="fa-solid fa-circle-xmark"></i> سبب الرفض:</strong> ${orderData.rejection_reason}</p>`;
                } else {
                  totalDisplay = `<p><strong><i class="fa-solid fa-hand-holding-dollar"></i> السعر المقترح:</strong> ${orderData.price}</p>`;
                }
              }

              resultHTML += `
                <div class="order-card status-${statusClass}">
                    <div class="order-card-header">
                        <div>
                            <p class="order-id"><i class="fa-solid fa-receipt"></i> رقم الطلب: ${
                              orderData.id
                            }</p>
                            <p class="order-type">نوع الطلب: ${orderType}</p>
                        </div>
                        <span class="status-badge ${statusClass}">${simplifiedStatus}</span>
                    </div>
                    <div class="order-card-body">
                        <p><strong><i class="fa-solid fa-calendar-alt"></i> التاريخ:</strong> ${new Date(
                          orderData.order_date
                        ).toLocaleDateString("en-US")}</p>
                        ${
                          orderData.type === "ready"
                            ? `<h4><i class="fa-solid fa-boxes-stacked"></i> المنتجات:</h4>`
                            : ""
                        }
                        <ul class="order-details-list">
                            ${itemsListHTML}
                        </ul>
                        ${totalDisplay}
                        ${actionsHtml}
                    </div>
                </div>
              `;
            });
            orderStatusResult.innerHTML += resultHTML;

            document
              .querySelectorAll(".price-buttons .btn")
              .forEach((button) => {
                button.addEventListener("click", (e) => {
                  const id = e.target.dataset.id;
                  const collection = e.target.dataset.collection;
                  const status = e.target.dataset.status;
                  handlePriceDecision(id, collection, status);
                });
              });
          }
        } else {
          orderStatusResult.innerHTML =
            "<p>يرجى تسجيل الدخول لعرض حالة طلباتك.</p><a href='login.html' class='btn'>تسجيل الدخول</a>";
        }
      });
      function loadCart() {
        const storedCart = localStorage.getItem("shoppingCart");
        cart = storedCart ? JSON.parse(storedCart) : [];
      }
      function updateCartBadge() {
        const cartCountBadge = document.getElementById("cart-count-badge");
        if (!cartCountBadge) return;
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.toggle("visible", totalItems > 0);
      }
      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        updateCartBadge();
        const menuToggle = document.getElementById("menu-toggle");
        const mobileMenu = document.getElementById("mobile-menu");
        const body = document.body;
        menuToggle.addEventListener("click", () => {
          mobileMenu.classList.toggle("active");
          body.classList.toggle("scroll-lock");
        });
      });
    </script>
  </body>
</html>
