<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      .cost-table th,
      .cost-table td {
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">Ù…Ù†Ø¬Ø±Ø©</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html" class="active"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</h1>

      <div class="admin-panel">
        <p style="color: #777; margin-bottom: 20px">
          Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø³ÙŠØªÙ… ØªÙ‚Ø³ÙŠÙ…Ù‡ Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹ Ø³Ø§Ø¹Ø§Øª ØªØµÙ†ÙŠØ¹ Ø¬Ù…ÙŠØ¹
          Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ØªÙ‚Ø¯ÙŠØ± ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø¹Ø¨Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© (Overhead) Ù„Ù„Ø³Ø§Ø¹Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©.
        </p>
        <div class="section-header">
          <button class="btn" id="add-cost-btn">
            <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ØªÙƒÙ„ÙØ©
          </button>
        </div>
        <div id="costs-table-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ...</p>
        </div>
      </div>
    </div>

    <div id="cost-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="cost-modal-title"></h2>
        <form id="cost-form">
          <input type="hidden" id="cost-id" />

          <div class="form-group">
            <label for="cost-name">Ø§Ø³Ù… Ø¨Ù†Ø¯ Ø§Ù„ØªÙƒÙ„ÙØ©</label>
            <input type="text" id="cost-name" required />
          </div>

          <div class="form-group">
            <label for="cost-amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø´ÙŠÙƒÙ„)</label>
            <input
              type="number"
              id="cost-amount"
              min="0"
              step="0.01"
              required
            />
          </div>

          <div class="form-group">
            <label for="cost-description">Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="cost-description" rows="2"></textarea>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn">
              <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // ğŸ›‘ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ØªÙ†Ø§Ø³Ø¨ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ admin.css Ø£Ùˆ Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØµÙØ­Ø©)
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });

      let allFixedCosts = [];

      // --------------------------------------------------------
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchAndRenderCosts();
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      // --------------------------------------------------------
      // ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      // --------------------------------------------------------
      async function fetchAndRenderCosts() {
        const container = document.getElementById("costs-table-container");
        container.innerHTML =
          '<p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ...</p>';
        try {
          const snapshot = await getDocs(collection(db, "fixed_costs"));
          allFixedCosts = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            amount: parseFloat(doc.data().amount || 0),
          }));

          renderCostsTable(allFixedCosts);
        } catch (e) {
          console.error("Error fetching fixed costs: ", e);
          container.innerHTML =
            '<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©.</p>';
        }
      }

      function renderCostsTable(costs) {
        const container = document.getElementById("costs-table-container");
        if (costs.length === 0) {
          container.innerHTML =
            '<p class="loading-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒØ§Ù„ÙŠÙ Ø«Ø§Ø¨ØªØ© Ù…Ø³Ø¬Ù„Ø©.</p>';
          return;
        }

        const totalFixedCost = costs.reduce(
          (sum, cost) => sum + cost.amount,
          0
        );

        let tableHtml = `
          <div style="text-align: center; margin-bottom: 25px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid var(--primary-color);">
            <p style="font-size: 1.5rem; font-weight: 700;">
              Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©:
              <span style="color: var(--danger-color);">${totalFixedCost.toFixed(
                2
              )} Ø´ÙŠÙƒÙ„</span>
            </p>
          </div>
          <table class="orders-table cost-table">
            <thead>
              <tr>
                <th><i class="fa-solid fa-list-check"></i> Ø§Ù„Ø¨Ù†Ø¯</th>
                <th><i class="fa-solid fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø´ÙŠÙƒÙ„)</th>
                <th><i class="fa-solid fa-info-circle"></i> Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
        `;
        costs.forEach((cost) => {
          tableHtml += `
            <tr data-id="${cost.id}">
              <td>${cost.name}</td>
              <td>${cost.amount.toFixed(2)}</td>
              <td>${cost.description || "---"}</td>
              <td class="actions-buttons" style="white-space: nowrap;">
                <button class="btn btn-secondary btn-sm edit-cost-btn" data-id="${
                  cost.id
                }"><i class="fa-solid fa-pencil"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-danger btn-sm delete-cost-btn" data-id="${
                  cost.id
                }"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</button>
              </td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        container.innerHTML = tableHtml;

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶
        document.querySelectorAll(".edit-cost-btn").forEach((btn) => {
          btn.addEventListener("click", handleEditCost);
        });
        document.querySelectorAll(".delete-cost-btn").forEach((btn) => {
          btn.addEventListener("click", handleDeleteCost);
        });
      }

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù
      // --------------------------------------------------------
      document.getElementById("add-cost-btn").addEventListener("click", () => {
        document.getElementById("cost-modal-title").textContent =
          "Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ØªÙƒÙ„ÙØ© Ø¬Ø¯ÙŠØ¯";
        document.getElementById("cost-id").value = "";
        document.getElementById("cost-form").reset();
        openModal("cost-modal");
      });

      function handleEditCost(e) {
        const id = e.currentTarget.dataset.id;
        const cost = allFixedCosts.find((c) => c.id === id);
        if (cost) {
          document.getElementById(
            "cost-modal-title"
          ).textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¯: ${cost.name}`;
          document.getElementById("cost-id").value = cost.id;
          document.getElementById("cost-name").value = cost.name;
          document.getElementById("cost-amount").value = cost.amount;
          document.getElementById("cost-description").value =
            cost.description || "";
          openModal("cost-modal");
        }
      }

      function handleDeleteCost(e) {
        const id = e.currentTarget.dataset.id;
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ")) {
          deleteCost(id);
        }
      }

      document
        .getElementById("cost-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id =
            document.getElementById("cost-id").value ||
            doc(collection(db, "fixed_costs")).id;
          const costData = {
            name: document.getElementById("cost-name").value,
            amount: parseFloat(document.getElementById("cost-amount").value),
            description:
              document.getElementById("cost-description").value || null,
          };
          try {
            await setDoc(doc(db, "fixed_costs", id), costData);
            closeModal("cost-modal");
            fetchAndRenderCosts();
            alert("ØªÙ… Ø­ÙØ¸ Ø¨Ù†Ø¯ Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ù†Ø¬Ø§Ø­.");
          } catch (error) {
            console.error("Error saving cost: ", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ©.");
          }
        });

      async function deleteCost(id) {
        try {
          await deleteDoc(doc(db, "fixed_costs", id));
          fetchAndRenderCosts();
          alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
        } catch (e) {
          console.error("Error deleting cost: ", e);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù.");
        }
      }
    </script>
  </body>
</html>
