<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* (Ù†ÙØ³ ÙƒÙˆØ¯ ×”-CSS Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ - Ù„Ù… ÙŠØªØºÙŠØ±) */
      .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }
      .tab-navigation {
        display: flex;
        gap: 10px;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 25px;
      }
      .tab-btn {
        padding: 10px 20px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background-color: transparent;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        color: #777;
      }
      .tab-btn:hover {
        background-color: #f7f5f2;
      }
      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .section-header .btn-group {
        display: flex;
        gap: 10px;
      }
      /* ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØºÙŠÙŠØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„Ø§Øª */
      .status-badge.Ø¨Ø§Ù†ØªØ¸Ø§Ø±-Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… {
        background-color: #777;
        color: white;
      }
      .status-badge.ØªÙ…-Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…-Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ† {
        background-color: var(--success-color);
        color: white;
      }
      #ai-search-results {
        min-height: 200px;
        max-height: 40vh;
        overflow-y: auto;
        background-color: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
      }
      .ai-result-item {
        border-bottom: 1px dashed #ccc;
        padding-bottom: 10px;
        margin-bottom: 10px;
      }
      .ai-result-item p {
        margin: 5px 0;
      }
      .ai-result-item .price {
        font-weight: 700;
        color: var(--success-color);
      }
      .ai-result-item .source {
        font-size: 0.9rem;
      }
      .ai-result-item .source a {
        color: var(--info-color);
      }
      #supplier-log-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        background: #f7f5f2;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      #supplier-log-controls label {
        font-weight: 600;
      }
      #supplier-log-select {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid var(--border-color);
      }
      .log-toggle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background-color: #f7f5f2;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid var(--border-color);
      }
      .log-toggle-header h2 {
        margin: 0;
        font-size: 1.2rem;
        text-align: right;
      }
      .log-content-wrapper {
        display: none;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .log-content-wrapper.active {
        display: block;
        max-height: 600px;
        transition: max-height 0.5s ease-in;
      }
      .log-toggle-icon {
        transition: transform 0.3s;
      }
      .log-toggle-header[aria-expanded="true"] .log-toggle-icon {
        transform: rotate(90deg);
      }

      /* ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø§Ù‚Øµ */
      .btn-success {
        background-color: var(--success-color);
      }
      .btn-success:hover {
        background-color: #388e3c;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html" class="active"
              ><i class="fa-solid fa-truck-fast"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="strategy_admin.html"
              ><i class="fa-solid fa-lightbulb"></i> Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h1>

      <div class="dashboard-stats">
        <div class="stat-card" style="border-left-color: var(--primary-color)">
          <div class="stat-icon" style="color: var(--primary-color)">
            <i class="fa-solid fa-users"></i>
          </div>
          <div class="stat-info">
            <h3><span id="total-suppliers-count">0</span></h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</p>
          </div>
        </div>
        <div class="stat-card" style="border-left-color: var(--warning-color)">
          <div class="stat-icon" style="color: var(--warning-color)">
            <i class="fa-solid fa-file-invoice"></i>
          </div>
          <div class="stat-info">
            <h3><span id="pending-invoice-count">0</span></h3>
            <p>ÙÙˆØ§ØªÙŠØ± Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</p>
          </div>
        </div>
        <div class="stat-card" style="border-left-color: var(--info-color)">
          <div class="stat-icon" style="color: var(--info-color)">
            <i class="fa-solid fa-money-bill-wave"></i>
          </div>
          <div class="stat-info">
            <h3><span id="pending-invoice-value">0</span> â‚ª</h3>
            <p>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„ÙÙˆØ§ØªÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
          </div>
        </div>
      </div>

      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="suppliers">
          <i class="fa-solid fa-users"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        </button>
        <button class="tab-btn" data-tab="purchase-invoices">
          <i class="fa-solid fa-file-invoice-dollar"></i> ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        </button>
        <button class="tab-btn" data-tab="logs">
          <i class="fa-solid fa-history"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        </button>
      </div>

      <div class="admin-panel">
        <div id="suppliers" class="tab-content active">
          <div class="section-header">
            <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h2>
            <div class="btn-group">
              <button class="btn btn-secondary" id="ai-search-btn">
                <i class="fa-solid fa-robot"></i> (AI) Ø¨Ø­Ø« Ø¹Ù† Ø£Ø³Ø¹Ø§Ø± Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…
              </button>
              <button class="btn" id="add-supplier-btn">
                <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯
              </button>
            </div>
          </div>
          <div id="suppliers-table-container">
            <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†...</p>
          </div>
        </div>

        <div id="purchase-invoices" class="tab-content">
          <div class="section-header">
            <h2>ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h2>
            <button class="btn" id="add-invoice-btn">
              <i class="fa-solid fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©
            </button>
          </div>
          <div id="invoice-table-container">
            <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±...</p>
          </div>
        </div>

        <div id="logs" class="tab-content">
          <div class="data-card" style="margin-bottom: 20px">
            <h3><i class="fa-solid fa-filter"></i> ÙÙ„ØªØ±Ø© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
            <div id="supplier-log-controls">
              <label for="supplier-log-select">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ù…ÙˆØ±Ø¯:</label>
              <select id="supplier-log-select"></select>
            </div>
            <div id="supplier-log-container">
              <p class="loading-msg" style="padding: 10px">
                Ø§Ø®ØªØ± Ù…ÙˆØ±Ø¯Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù…Ø´ØªØ±ÙŠØ§ØªÙ‡...
              </p>
            </div>
          </div>

          <div
            class="log-toggle-header"
            id="log-toggle-header"
            aria-expanded="true"
          >
            <h2>
              <i class="fa-solid fa-clipboard-list"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¹Ø§Ù…
              (Ø¢Ø®Ø± 50 Ø­Ø±ÙƒØ©)
            </h2>
            <i class="fa-solid fa-chevron-left log-toggle-icon"></i>
          </div>
          <div
            id="materials-log-container-wrapper"
            class="log-content-wrapper active"
          >
            <div id="materials-log-container">
              <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="supplier-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="supplier-modal-title">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="supplier-form">
          <input type="hidden" id="supplier-id" />
          <div class="form-group">
            <label for="supplier-name">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ / Ø§Ù„Ø´Ø±ÙƒØ©</label>
            <input type="text" id="supplier-name" required />
          </div>
          <div class="modal-form-grid">
            <div class="form-group">
              <label for="supplier-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
              <input type="tel" id="supplier-phone" />
            </div>
            <div class="form-group">
              <label for="supplier-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
              <input type="email" id="supplier-email" />
            </div>
          </div>
          <div class="form-group">
            <label for="supplier-materials">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ÙŠÙˆØ±Ø¯Ù‡Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input
              type="text"
              id="supplier-materials"
              placeholder="Ù…Ø«Ø§Ù„: Ø®Ø´Ø¨ Ø²Ø§Ù†, Ø¨Ø±Ø§ØºÙŠ, Ø¯Ù‡Ø§Ù† Ø£Ø¨ÙŠØ¶"
            />
          </div>
          <div class="btn-group">
            <button type="submit" class="btn">
              <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="invoice-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 800px">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="invoice-modal-title">ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <form id="invoice-form">
          <input type="hidden" id="invoice-id" />
          <div class="form-group">
            <label for="invoice-supplier">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</label>
            <select id="invoice-supplier" required></select>
          </div>
          <hr style="margin: 15px 0" />
          <h3>Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
          <div id="invoice-items-container"></div>
          <div
            class="modal-form-grid"
            style="
              grid-template-columns: 2fr 1fr 1fr;
              align-items: flex-end;
              background: #f9f9f9;
              padding: 10px;
              border-radius: 8px;
            "
          >
            <div class="form-group">
              <label for="invoice-material-select">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
              <select id="invoice-material-select"></select>
            </div>
            <div class="form-group">
              <label for="invoice-item-quantity">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input
                type="number"
                id="invoice-item-quantity"
                min="1"
                step="any"
              />
            </div>
            <div class="form-group">
              <label for="invoice-item-cost">ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© (Ø´ÙŠÙƒÙ„)</label>
              <input type="number" id="invoice-item-cost" min="0" step="0.01" />
            </div>
            <button
              type="button"
              class="btn btn-secondary btn-sm"
              id="add-invoice-item-btn"
            >
              <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯
            </button>
          </div>
          <h3
            style="
              margin-top: 20px;
              text-align: left;
              color: var(--success-color);
            "
          >
            Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="invoice-total-cost">0.00</span> Ø´ÙŠÙƒÙ„
          </h3>
          <div class="btn-group" style="margin-top: 20px">
            <button type="submit" class="btn" id="save-invoice-btn">
              <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…)
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="receive-stock-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (<span id="receive-invoice-id"></span>)</h2>
        <form id="receive-stock-form">
          <p>
            Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§
            Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù….
          </p>
          <div id="receive-items-summary"></div>
          <p
            style="
              font-size: 1.2rem;
              font-weight: 700;
              margin-top: 15px;
              color: var(--dark-color);
            "
          >
            Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…:
            <span
              id="receive-total-value"
              style="color: var(--success-color)"
            ></span>
          </p>
          <div class="btn-group">
            <button type="submit" class="btn">
              <i class="fa-solid fa-check-double"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªØ­Ø¯ÙŠØ«
              Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="ai-search-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 700px">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2><i class="fa-solid fa-robot"></i> Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠ</h2>
        <p>
          Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆØ³Ø£Ø¨Ø­Ø« Ù„Ùƒ ÙÙŠ Ø§Ù„ÙˆÙŠØ¨ Ø¹Ù† Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ£Ø³Ø¹Ø§Ø±.
        </p>
        <form id="ai-search-form">
          <div class="form-group" style="display: flex; gap: 10px">
            <select id="ai-search-select" required style="flex-grow: 1">
              <option value="">-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø®Ø§Ù… Ù…Ø³Ø¬Ù„Ø© --</option>
            </select>
            <button type="submit" class="btn" id="ai-search-submit-btn">
              <i class="fa-solid fa-magnifying-glass"></i> Ø§Ø¨Ø­Ø«
            </button>
          </div>
        </form>
        <div id="ai-search-results">
          <p class="loading-msg" style="padding: 10px">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù„Ù„Ø¨Ø­Ø«...</p>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¥Ø¶Ø§ÙØ© "limit" Ø§Ù„Ù†Ø§Ù‚Øµ
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
        writeBatch,
        addDoc,
        Timestamp,
        query,
        orderBy,
        where,
        limit, // ğŸ’¡ (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„Ù„Ø®Ø·Ø£ Ø±Ù‚Ù… 1)
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

      // ğŸ›‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };

      // ğŸ›‘ ğŸ’¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Gemini AI
      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const aiModel = genAI.getGenerativeModel({
        model: "gemini-2.5-flash",
        tools: {
          googleSearch: {},
        },
      });

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØºÙŠÙŠØ± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
      let allSuppliers = [];
      let allInvoices = [];
      let allRawMaterials = [];
      let rawMaterialsMap = new Map();
      let currentInvoiceItems = [];
      let invoiceToReceive = null;
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");
      const suppliersTableContainer = document.getElementById(
        "suppliers-table-container"
      );
      const invoiceTableContainer = document.getElementById(
        "invoice-table-container"
      );
      const logToggleHeader = document.getElementById("log-toggle-header");
      const logContentWrapper = document.getElementById(
        "materials-log-container-wrapper"
      );
      const generalLogContainer = document.getElementById(
        "materials-log-container"
      );
      const supplierLogContainer = document.getElementById(
        "supplier-log-container"
      );
      const supplierLogSelect = document.getElementById("supplier-log-select");
      const totalSuppliersCount = document.getElementById(
        "total-suppliers-count"
      );
      const pendingInvoiceCount = document.getElementById(
        "pending-invoice-count"
      );
      const pendingInvoiceValue = document.getElementById(
        "pending-invoice-value"
      );

      // --------------------------------------------------------
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await loadInitialData();
            renderSuppliersTable(allSuppliers);
            renderInvoiceTable(allInvoices); // ğŸ’¡ (Ù…Ø¹Ø¯Ù„)
            fillAImodalSelect(allRawMaterials);
            fillSelectOptions(
              supplierLogSelect,
              allSuppliers,
              "id",
              "name",
              "-- Ø§Ø®ØªØ± Ù…ÙˆØ±Ø¯ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ù‡ --"
            );
            calculateStats();
            // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù… ÙÙˆØ±Ø§Ù‹
            fetchAndRenderGeneralLog();
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„)
      async function loadInitialData() {
        try {
          const [suppliersSnap, invoiceSnap, materialsSnap] = await Promise.all(
            [
              getDocs(query(collection(db, "suppliers"), orderBy("name"))),
              // ğŸ’¡ (Ù…Ù„Ø§Ø­Ø¸Ø©) Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
              getDocs(
                query(
                  collection(db, "purchase_orders"),
                  orderBy("date", "desc")
                )
              ),
              getDocs(collection(db, "raw_materials")),
            ]
          );

          allSuppliers = suppliersSnap.docs.map((d) => ({
            id: d.id,
            ...d.data(),
          }));
          allInvoices = invoiceSnap.docs.map((d) => ({
            id: d.id,
            ...d.data(),
            date: d.data().date.toDate(),
          }));
          allRawMaterials = materialsSnap.docs.map((d) => ({
            id: d.id,
            ...d.data(),
            cost_per_unit: parseFloat(d.data().cost_per_unit || 0),
            current_stock: parseFloat(d.data().current_stock || 0),
            total_cost_value: parseFloat(d.data().total_cost_value || 0),
          }));
          rawMaterialsMap.clear();
          allRawMaterials.forEach((m) => rawMaterialsMap.set(m.id, m));
        } catch (e) {
          console.error("Error loading initial data: ", e);
          alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.");
        }
      }

      // --------------------------------------------------------
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      // --------------------------------------------------------
      function calculateStats() {
        totalSuppliersCount.textContent = allSuppliers.length;
        let pendingCount = 0;
        let pendingValue = 0;
        allInvoices.forEach((invoice) => {
          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "Ù…Ø³ÙˆØ¯Ø©"
          if (invoice.status === "Ù…Ø³ÙˆØ¯Ø©") {
            pendingCount++;
            pendingValue += invoice.items.reduce(
              (sum, item) => sum + item.quantity * item.cost_per_unit,
              0
            );
          }
        });
        pendingInvoiceCount.textContent = pendingCount;
        pendingInvoiceValue.textContent = pendingValue.toFixed(0);
      }

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
      // --------------------------------------------------------
      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          tabContents.forEach((content) => content.classList.remove("active"));
          button.classList.add("active");
          document.getElementById(button.dataset.tab).classList.add("active");
        });
      });

      // --------------------------------------------------------
      // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      // --------------------------------------------------------
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });

      // ========================================================
      // Ø§Ù„Ù‚Ø³Ù… 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (ÙƒÙ…Ø§ Ù‡Ùˆ)
      // ========================================================

      function renderSuppliersTable(suppliers) {
        if (suppliers.length === 0) {
          suppliersTableContainer.innerHTML =
            '<p class="loading-msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ±Ø¯ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†.</p>';
          return;
        }
        let tableHtml = `
          <table class="orders-table">
            <thead>
              <tr>
                <th><i class="fa-solid fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th><i class="fa-solid fa-phone"></i> Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th><i class="fa-solid fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th><i class="fa-solid fa-tags"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
        `;
        suppliers.forEach((s) => {
          tableHtml += `
            <tr data-id="${s.id}">
              <td>${s.name}</td>
              <td>${s.phone || "---"}</td>
              <td>${s.email || "---"}</td>
              <td>${s.materials || "---"}</td>
              <td class="actions-buttons" style="white-space: nowrap;">
                <button class="btn btn-secondary btn-sm edit-supplier-btn" data-id="${
                  s.id
                }"><i class="fa-solid fa-pencil"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-danger btn-sm delete-supplier-btn" data-id="${
                  s.id
                }"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</button>
              </td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        suppliersTableContainer.innerHTML = tableHtml;

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        document.querySelectorAll(".edit-supplier-btn").forEach((btn) => {
          btn.addEventListener("click", handleEditSupplier);
        });
        document.querySelectorAll(".delete-supplier-btn").forEach((btn) => {
          btn.addEventListener("click", handleDeleteSupplier);
        });
      }

      document
        .getElementById("add-supplier-btn")
        .addEventListener("click", () => {
          document.getElementById("supplier-modal-title").textContent =
            "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯";
          document.getElementById("supplier-form").reset();
          document.getElementById("supplier-id").value = "";
          openModal("supplier-modal");
        });

      function handleEditSupplier(e) {
        const id = e.currentTarget.dataset.id;
        const supplier = allSuppliers.find((s) => s.id === id);
        if (supplier) {
          document.getElementById(
            "supplier-modal-title"
          ).textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯: ${supplier.name}`;
          document.getElementById("supplier-id").value = supplier.id;
          document.getElementById("supplier-name").value = supplier.name;
          document.getElementById("supplier-phone").value =
            supplier.phone || "";
          document.getElementById("supplier-email").value =
            supplier.email || "";
          document.getElementById("supplier-materials").value =
            supplier.materials || "";
          openModal("supplier-modal");
        }
      }

      async function handleDeleteSupplier(e) {
        const id = e.currentTarget.dataset.id;
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ØŸ")) {
          try {
            await deleteDoc(doc(db, "suppliers", id));
            await loadInitialData(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
            renderSuppliersTable(allSuppliers);
            calculateStats();
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯.");
          } catch (err) {
            alert("Ø®Ø·Ø£: " + err.message);
          }
        }
      }

      document
        .getElementById("supplier-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id =
            document.getElementById("supplier-id").value ||
            doc(collection(db, "suppliers")).id;
          const data = {
            name: document.getElementById("supplier-name").value,
            phone: document.getElementById("supplier-phone").value || null,
            email: document.getElementById("supplier-email").value || null,
            materials:
              document.getElementById("supplier-materials").value || null,
          };
          try {
            await setDoc(doc(db, "suppliers", id), data, { merge: true });
            closeModal("supplier-modal");
            await loadInitialData();
            renderSuppliersTable(allSuppliers);
            calculateStats();
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
          } catch (err) {
            alert("Ø®Ø·Ø£: " + err.message);
          }
        });

      // ========================================================
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù‚Ø³Ù… 2: Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡
      // ========================================================

      function renderInvoiceTable(invoices) {
        if (invoices.length === 0) {
          invoiceTableContainer.innerHTML =
            '<p class="loading-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø´Ø±Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø©.</p>';
          return;
        }
        let tableHtml = `
          <table class="orders-table">
            <thead>
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
        `;
        invoices.forEach((invoice) => {
          const supplier = allSuppliers.find(
            (s) => s.id === invoice.supplier_id
          );
          const supplierName = supplier ? supplier.name : "Ù…ÙˆØ±Ø¯ Ù…Ø­Ø°ÙˆÙ";
          const totalCost = invoice.items.reduce(
            (sum, item) => sum + item.quantity * item.cost_per_unit,
            0
          );

          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØºÙŠÙŠØ± Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª
          let statusText = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
          let statusClass = "";
          if (invoice.status === "Ù…Ø³ÙˆØ¯Ø©") {
            statusText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
            statusClass = "Ø¨Ø§Ù†ØªØ¸Ø§Ø±-Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
          } else if (invoice.status === "Ù…ÙØ³ØªÙ„Ù…") {
            statusText = "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†";
            statusClass = "ØªÙ…-Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…-Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†";
          }

          let actions = `<button class="btn btn-secondary btn-sm edit-invoice-btn" data-id="${invoice.id}"><i class="fa-solid fa-pencil"></i> ØªØ¹Ø¯ÙŠÙ„</button>`;
          if (invoice.status === "Ù…Ø³ÙˆØ¯Ø©") {
            // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ style
            actions += ` <button class="btn btn-success btn-sm" id="receive-invoice-btn" data-id="${invoice.id}"><i class="fa-solid fa-box-open"></i> Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</button>`;
          }

          tableHtml += `
            <tr data-id="${invoice.id}">
              <td>${invoice.id.substring(0, 8)}...</td>
              <td>${supplierName}</td>
              <td>${invoice.date.toLocaleDateString("ar-EG")}</td>
              <td>${totalCost.toFixed(2)} Ø´ÙŠÙƒÙ„</td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td class="actions-buttons" style="white-space: nowrap;">${actions}</td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        invoiceTableContainer.innerHTML = tableHtml;

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        document.querySelectorAll(".edit-invoice-btn").forEach((btn) => {
          btn.addEventListener("click", handleEditInvoice);
        });
        document.querySelectorAll("#receive-invoice-btn").forEach((btn) => {
          btn.addEventListener("click", handleReceiveInvoice);
        });
      }

      function fillSelectOptions(
        selectEl,
        data,
        valueField,
        textField,
        placeholder = "-- Ø§Ø®ØªØ± --"
      ) {
        selectEl.innerHTML = `<option value="">${placeholder}</option>`;
        data.forEach((item) => {
          const option = document.createElement("option");
          option.value = item[valueField];
          option.textContent = item[textField];
          selectEl.appendChild(option);
        });
      }

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„)
      document
        .getElementById("add-invoice-btn")
        .addEventListener("click", () => {
          document.getElementById("invoice-modal-title").textContent =
            "ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©";
          document.getElementById("invoice-form").reset();
          document.getElementById("invoice-id").value = "";
          currentInvoiceItems = [];
          renderInvoiceItemsList();
          fillSelectOptions(
            document.getElementById("invoice-supplier"),
            allSuppliers,
            "id",
            "name"
          );
          fillSelectOptions(
            document.getElementById("invoice-material-select"),
            allRawMaterials,
            "id",
            "name_ar"
          );
          document.getElementById("save-invoice-btn").disabled = false;
          openModal("invoice-modal");
        });

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„)
      function handleEditInvoice(e) {
        const id = e.currentTarget.dataset.id;
        const invoice = allInvoices.find((p) => p.id === id);
        if (invoice) {
          if (invoice.status === "Ù…ÙØ³ØªÙ„Ù…") {
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© ØªÙ… Ø§Ø³ØªÙ„Ø§Ù…Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„.");
            return;
          }

          document.getElementById(
            "invoice-modal-title"
          ).textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoice.id.substring(0, 8)}`;
          document.getElementById("invoice-id").value = invoice.id;
          fillSelectOptions(
            document.getElementById("invoice-supplier"),
            allSuppliers,
            "id",
            "name"
          );
          document.getElementById("invoice-supplier").value =
            invoice.supplier_id;
          fillSelectOptions(
            document.getElementById("invoice-material-select"),
            allRawMaterials,
            "id",
            "name_ar"
          );
          currentInvoiceItems = invoice.items;
          renderInvoiceItemsList();
          document.getElementById("save-invoice-btn").disabled = false;
          openModal("invoice-modal");
        }
      }

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„)
      function renderInvoiceItemsList() {
        const container = document.getElementById("invoice-items-container");
        const totalCostEl = document.getElementById("invoice-total-cost");
        let total = 0;
        if (currentInvoiceItems.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #999;">Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ø¨Ø¹Ø¯.</p>';
          totalCostEl.textContent = "0.00";
          return;
        }

        let html = `
          <table class="orders-table" style="font-size: 0.9rem;">
            <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr></thead>
            <tbody>
        `;
        currentInvoiceItems.forEach((item, index) => {
          const material = rawMaterialsMap.get(item.material_id);
          const materialName = material ? material.name_ar : "Ù…Ø§Ø¯Ø© Ù…Ø­Ø°ÙˆÙØ©";
          const itemTotal = item.quantity * item.cost_per_unit;
          total += itemTotal;
          html += `
            <tr>
              <td>${materialName}</td>
              <td>${item.quantity} ${material ? material.unit : ""}</td>
              <td>${item.cost_per_unit.toFixed(2)} Ø´ÙŠÙƒÙ„</td>
              <td>${itemTotal.toFixed(2)} Ø´ÙŠÙƒÙ„</td>
              <td><button type="button" class="btn btn-danger btn-sm remove-invoice-item-btn" data-index="${index}">&times;</button></td>
            </tr>
          `;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
        totalCostEl.textContent = total.toFixed(2);

        document.querySelectorAll(".remove-invoice-item-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            currentInvoiceItems.splice(e.currentTarget.dataset.index, 1);
            renderInvoiceItemsList();
          });
        });
      }

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„)
      document
        .getElementById("add-invoice-item-btn")
        .addEventListener("click", () => {
          const materialId = document.getElementById(
            "invoice-material-select"
          ).value;
          const quantity = parseFloat(
            document.getElementById("invoice-item-quantity").value
          );
          const cost = parseFloat(
            document.getElementById("invoice-item-cost").value
          );

          if (!materialId || isNaN(quantity) || quantity <= 0 || isNaN(cost)) {
            alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„ØªÙƒÙ„ÙØ©.");
            return;
          }

          currentInvoiceItems.push({
            material_id: materialId,
            quantity: quantity,
            cost_per_unit: cost,
          });
          renderInvoiceItemsList();
          document.getElementById("invoice-item-quantity").value = "";
          document.getElementById("invoice-item-cost").value = "";
          document.getElementById("invoice-material-select").value = "";
        });

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡ÙˆØŒ ÙÙ‚Ø· Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªØºÙŠØ±Øª)
      document
        .getElementById("invoice-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id =
            document.getElementById("invoice-id").value ||
            doc(collection(db, "purchase_orders")).id;
          const isEdit = !!document.getElementById("invoice-id").value;
          let currentStatus = "Ù…Ø³ÙˆØ¯Ø©"; // ğŸ’¡ (Ù…Ù‡Ù…) Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØ¨Ù‚Ù‰ "Ù…Ø³ÙˆØ¯Ø©" Ù„Ù„Ø¯Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø£Ù†Ù‡Ø§ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…

          if (isEdit) {
            const invoice = allInvoices.find((p) => p.id === id);
            if (invoice && invoice.status === "Ù…ÙØ³ØªÙ„Ù…") {
              alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© ØªÙ… Ø§Ø³ØªÙ„Ø§Ù…Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„.");
              return;
            }
            currentStatus = invoice.status;
          }

          const data = {
            supplier_id: document.getElementById("invoice-supplier").value,
            status: currentStatus, // "Ù…Ø³ÙˆØ¯Ø©"
            items: currentInvoiceItems,
            date: Timestamp.now(),
          };

          try {
            await setDoc(doc(db, "purchase_orders", id), data, { merge: true });
            closeModal("invoice-modal");
            await loadInitialData();
            renderInvoiceTable(allInvoices); // ğŸ’¡ (Ù…Ø¹Ø¯Ù„)
            calculateStats();
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…) Ø¨Ù†Ø¬Ø§Ø­.");
          } catch (err) {
            alert("Ø®Ø·Ø£: " + err.message);
          }
        });

      // ========================================================
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù‚Ø³Ù… 3: Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©
      // ========================================================
      function handleReceiveInvoice(e) {
        const id = e.currentTarget.dataset.id;
        invoiceToReceive = allInvoices.find((p) => p.id === id);
        if (!invoiceToReceive) {
          alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.");
          return;
        }
        if (invoiceToReceive.status !== "Ù…Ø³ÙˆØ¯Ø©") {
          alert(
            "Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙ„Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª ÙÙŠ Ø­Ø§Ù„Ø© 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…'."
          );
          return;
        }

        document.getElementById("receive-invoice-id").textContent =
          id.substring(0, 8);
        const summaryEl = document.getElementById("receive-items-summary");
        const totalValueEl = document.getElementById("receive-total-value");
        let html = "<ul>";
        let totalValue = 0;

        invoiceToReceive.items.forEach((item) => {
          const material = rawMaterialsMap.get(item.material_id);
          const materialName = material ? material.name_ar : "Ù…Ø§Ø¯Ø© Ù…Ø­Ø°ÙˆÙØ©";
          const itemTotal = item.quantity * item.cost_per_unit;
          totalValue += itemTotal;
          html += `<li><strong>${materialName}:</strong> ÙƒÙ…ÙŠØ© ${
            item.quantity
          } (Ø¨ØªÙƒÙ„ÙØ© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ${itemTotal.toFixed(2)} Ø´ÙŠÙƒÙ„)</li>`;
        });
        html += "</ul>";
        summaryEl.innerHTML = html;
        totalValueEl.textContent = `${totalValue.toFixed(2)} Ø´ÙŠÙƒÙ„`;
        openModal("receive-stock-modal");
      }

      document
        .getElementById("receive-stock-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!invoiceToReceive) return;

          const batch = writeBatch(db);
          const logCollection = collection(db, "raw_materials_log");

          let totalItemsCost = 0;

          for (const item of invoiceToReceive.items) {
            const material = rawMaterialsMap.get(item.material_id);
            if (!material) {
              alert(`Ø®Ø·Ø£: Ø§Ù„Ù…Ø§Ø¯Ø© ${item.material_id} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.`);
              return;
            }

            const inputQuantity = item.quantity;
            const inputTotalCost = item.quantity * item.cost_per_unit;
            totalItemsCost += inputTotalCost;

            const newTotalStock = material.current_stock + inputQuantity;
            const newTotalCostValue =
              material.total_cost_value + inputTotalCost;
            const newAverageCostPerUnit = newTotalCostValue / newTotalStock;

            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…
            const materialRef = doc(db, "raw_materials", item.material_id);
            batch.update(materialRef, {
              current_stock: newTotalStock,
              total_cost_value: newTotalCostValue,
              cost_per_unit: newAverageCostPerUnit,
              last_update: new Date().toISOString(),
            });

            // 2. ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø±Ø§Ø¡
            batch.set(doc(logCollection), {
              material_id: item.material_id,
              material_name: material.name_ar,
              change_quantity: inputQuantity,
              change_value: inputTotalCost,
              operation_type: "purchase", // Ù…Ù† ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡
              order_id: invoiceToReceive.id, // Ø±Ø¨Ø· Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø©
              date: new Date().toISOString(),
            });
          }

          // 3. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ "Ù…ÙØ³ØªÙ„Ù…"
          const invoiceRef = doc(db, "purchase_orders", invoiceToReceive.id);
          batch.update(invoiceRef, {
            status: "Ù…ÙØ³ØªÙ„Ù…",
            received_date: new Date().toISOString(),
            received_value: totalItemsCost,
          });

          try {
            await batch.commit();
            closeModal("receive-stock-modal");
            await loadInitialData();
            renderInvoiceTable(allInvoices);
            calculateStats();
            // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            fetchAndRenderGeneralLog();
            if (supplierLogSelect.value) {
              supplierLogSelect.dispatchEvent(new Event("change"));
            }
            alert("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­.");
            invoiceToReceive = null;
          } catch (err) {
            alert("Ø®Ø·Ø£ ÙØ§Ø¯Ø­ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: " + err.message);
          }
        });

      // ========================================================
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù‚Ø³Ù… 4: Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠ (AI)
      // ========================================================

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¯Ø§Ù„Ø© ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
      function fillAImodalSelect(materials) {
        const select = document.getElementById("ai-search-select");
        select.innerHTML =
          '<option value="">-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø®Ø§Ù… Ù…Ø³Ø¬Ù„Ø© --</option>';
        materials.forEach((m) => {
          const option = document.createElement("option");
          option.value = m.name_ar; // ğŸ’¡ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡ÙŠ Ø§Ù„Ø§Ø³Ù…
          option.textContent = `${m.name_ar} (Ø§Ù„Ù†ÙˆØ¹: ${m.type})`;
          select.appendChild(option);
        });
      }

      document.getElementById("ai-search-btn").addEventListener("click", () => {
        document.getElementById("ai-search-select").value = "";
        document.getElementById("ai-search-results").innerHTML =
          '<p class="loading-msg" style="padding: 10px">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù„Ù„Ø¨Ø­Ø«...</p>';
        openModal("ai-search-modal");
      });

      document
        .getElementById("ai-search-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
          const query = document
            .getElementById("ai-search-select")
            .value.trim();
          if (!query) return;

          const resultsContainer = document.getElementById("ai-search-results");
          const submitBtn = document.getElementById("ai-search-submit-btn");
          resultsContainer.innerHTML =
            '<p class="loading-msg" style="padding: 10px;"><i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆÙŠØ¨... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª...</p>';
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

          try {
            const searchQueries = [
              `price of ${query} in Palestine`,
              `Ø´Ø±Ø§Ø¡ ${query} ÙÙŠ ÙÙ„Ø³Ø·ÙŠÙ†`,
              `Ø£Ø³Ø¹Ø§Ø± ${query} Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©`,
              `Ù…ÙˆØ±Ø¯ÙŠÙ† ${query}`,
            ];

            const chat = aiModel.startChat();

            const prompt = `
              Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø®Ø¨ÙŠØ± Ù„FurnAI ÙÙŠ ÙÙ„Ø³Ø·ÙŠÙ†. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ù„Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…: "${query}".
              
              Ø§Ù„Ù…Ù‡Ø§Ù…:
              1.  Ù‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ${JSON.stringify(
                searchQueries
              )}
              2.  Ø­Ù„Ù„ Ø£ÙØ¶Ù„ 5-7 Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø«.
              3.  Ø§Ø³ØªØ®Ø±Ø¬ "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" (Ø¥Ù† ÙˆØ¬Ø¯)ØŒ "Ø§Ù„Ø³Ø¹Ø±" (Ø¥Ù† ÙˆØ¬Ø¯)ØŒ Ùˆ"Ù…Ù„Ø®Øµ Ø¨Ø³ÙŠØ·" Ù…Ù† ÙƒÙ„ Ù†ØªÙŠØ¬Ø©.
              4.  **ØªØ¬Ø§Ù‡Ù„ ØªÙ…Ø§Ù…Ø§Ù‹** Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ø°Ø§Øª Ø§Ù„ØµÙ„Ø© (Ù…Ø«Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠØ©ØŒ ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§ØŒ Ø£Ùˆ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡). Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¬Ù…Ù„Ø©.
              5.  Ù‚Ù… Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙƒÙ‚Ø§Ø¦Ù…Ø© HTML.

              Ø§Ù„Ø®Ø±Ø¬ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ØµÙŠØºØ© HTML ÙÙ‚Ø·. Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù„ÙƒÙ„ Ù†ØªÙŠØ¬Ø©:
              <div class="ai-result-item">
                <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯/Ø§Ù„Ù…ØµØ¯Ø±:</strong> [Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹]</p>
                <p><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø°ÙƒÙˆØ±:</strong> <span class="price">[Ø§Ù„Ø³Ø¹Ø± Ø¥Ù† ÙˆØ¬Ø¯ØŒ Ø£Ùˆ "ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±"]</span></p>
                <p><strong>Ø§Ù„Ù…Ù„Ø®Øµ:</strong> [Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©]</p>
                <p class="source"><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> <a href="[Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØµØ¯Ø±]" target="_blank">[Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØµØ¯Ø±]</a></p>
              </div>

              Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ø£ÙŠ Ù†ØªØ§Ø¦Ø¬ Ù…ÙÙŠØ¯Ø©ØŒ Ø§Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:
              <p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ø¶Ø­Ø© Ø£Ùˆ Ù…ÙˆØ±Ø¯ÙŠÙ† Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>
            `;

            const result = await chat.sendMessage(prompt);
            const response = result.response;

            let htmlContent = response.text().trim();
            if (htmlContent.startsWith("```html")) {
              htmlContent = htmlContent.substring(7);
            }
            if (htmlContent.endsWith("```")) {
              htmlContent = htmlContent.substring(0, htmlContent.length - 3);
            }

            resultsContainer.innerHTML = htmlContent;
          } catch (error) {
            console.error("AI Search Error:", error);
            resultsContainer.innerHTML =
              '<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>';
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML =
              '<i class="fa-solid fa-magnifying-glass"></i> Ø§Ø¨Ø­Ø«';
          }
        });

      // ========================================================
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù‚Ø³Ù… 5: Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
      // ========================================================

      // Ù…Ù†Ø·Ù‚ ÙØªØ­ ÙˆØ·Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…
      logToggleHeader.addEventListener("click", () => {
        const isExpanded =
          logToggleHeader.getAttribute("aria-expanded") === "true";
        logToggleHeader.setAttribute("aria-expanded", !isExpanded);
        logContentWrapper.classList.toggle("active");

        if (!isExpanded && generalLogContainer.querySelector(".loading-msg")) {
          fetchAndRenderGeneralLog();
        }
      });

      // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù… (ÙŠØ´Ù…Ù„ ÙƒÙ„ Ø´ÙŠØ¡)
      async function fetchAndRenderGeneralLog() {
        generalLogContainer.innerHTML =
          '<p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª...</p>';
        try {
          const logCollection = collection(db, "raw_materials_log");
          // ğŸ’¡ (Ù‡Ù†Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£) Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ "limit"
          const q = query(logCollection, orderBy("date", "desc"), limit(50));
          const snapshot = await getDocs(q);
          const logEntries = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            date: new Date(doc.data().date).toLocaleString("ar-EG", {
              dateStyle: "short",
              timeStyle: "short",
            }),
          }));
          renderLogTable(logEntries, generalLogContainer, false);
        } catch (e) {
          console.error("Error fetching general log: ", e);
          generalLogContainer.innerHTML = `<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª. (ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Firestore)</p><p style="color: #999; text-align: left; direction: ltr;">${e.message}</p>`;
        }
      }

      // Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ù…ÙˆØ±Ø¯ Ù…Ø­Ø¯Ø¯ (Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±)
      supplierLogSelect.addEventListener("change", async (e) => {
        const supplierId = e.target.value;
        if (!supplierId) {
          supplierLogContainer.innerHTML =
            '<p class="loading-msg" style="padding: 10px;">Ø§Ø®ØªØ± Ù…ÙˆØ±Ø¯Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù…Ø´ØªØ±ÙŠØ§ØªÙ‡...</p>';
          return;
        }

        supplierLogContainer.innerHTML =
          '<p class="loading-msg">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯...</p>';
        try {
          // 1. Ø¥ÙŠØ¬Ø§Ø¯ ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (PO) Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯
          const poQuery = query(
            collection(db, "purchase_orders"),
            where("supplier_id", "==", supplierId),
            where("status", "==", "Ù…ÙØ³ØªÙ„Ù…") // ÙÙ‚Ø· Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©
          );
          const poSnapshot = await getDocs(poQuery);
          const poIds = poSnapshot.docs.map((doc) => doc.id);

          if (poIds.length === 0) {
            supplierLogContainer.innerHTML =
              '<p class="loading-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³ØªÙ„Ù…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯.</p>';
            return;
          }

          // 2. Ø¥ÙŠØ¬Ø§Ø¯ ÙƒÙ„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù‡Ø°Ù‡
          const logQuery = query(
            collection(db, "raw_materials_log"),
            where("order_id", "in", poIds),
            orderBy("date", "desc")
          );
          const logSnapshot = await getDocs(logQuery);
          const logEntries = logSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            date: new Date(doc.data().date).toLocaleString("ar-EG", {
              dateStyle: "short",
              timeStyle: "short",
            }),
          }));

          renderLogTable(logEntries, supplierLogContainer, false);
        } catch (e) {
          console.error("Error fetching supplier log: ", e);
          supplierLogContainer.innerHTML = `<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯. (ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Firestore)</p><p style="color: #999; text-align: left; direction: ltr;">${e.message}</p>`;
        }
      });

      // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø´ØªØ±ÙƒØ©)
      function renderLogTable(
        logEntries,
        targetContainer,
        isSingleMaterial = false
      ) {
        if (logEntries.length === 0) {
          targetContainer.innerHTML =
            '<p class="loading-msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ù„Ø¹Ø±Ø¶Ù‡.</p>';
          return;
        }

        let tableHtml = `
              <table class="orders-table">
                  <thead>
                      <tr>
                          ${
                            !isSingleMaterial
                              ? '<th><i class="fa-solid fa-list-check"></i> Ø§Ù„Ù…Ø§Ø¯Ø©</th>'
                              : ""
                          }
                          <th><i class="fa-solid fa-gear"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                          <th><i class="fa-solid fa-arrows-up-down"></i> Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                          <th><i class="fa-solid fa-money-bill-wave"></i> Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø´ÙŠÙƒÙ„)</th>
                          <th><i class="fa-solid fa-calendar-alt"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                          <th><i class="fa-solid fa-box"></i> Ø§Ù„Ù…ØµØ¯Ø± (ÙØ§ØªÙˆØ±Ø© / Ø·Ù„Ø¨)</th>
                      </tr>
                  </thead>
                  <tbody>
          `;
        logEntries.forEach((entry) => {
          const materialData = rawMaterialsMap.get(entry.material_id) || {};
          const unit = materialData.unit || "ÙˆØ­Ø¯Ø©";
          const typeDisplay =
            entry.operation_type === "purchase"
              ? "Ø´Ø±Ø§Ø¡ (ÙØ§ØªÙˆØ±Ø©)"
              : entry.operation_type === "correction"
              ? "ØªØµØ­ÙŠØ­/ØªØ³ÙˆÙŠØ©"
              : "Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ (Ø·Ù„Ø¨)";
          const quantityColor =
            entry.change_quantity > 0
              ? "color: var(--success-color); font-weight: 700;"
              : entry.change_quantity < 0
              ? "color: var(--danger-color); font-weight: 700;"
              : "color: #888;";
          const valueColor =
            entry.change_value > 0
              ? "color: var(--success-color); font-weight: 700;"
              : entry.change_value < 0
              ? "color: var(--danger-color); font-weight: 700;"
              : "color: #888;";
          const sourceDisplay = entry.order_id
            ? `${entry.order_id.substring(0, 8)}...`
            : "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†";

          tableHtml += `
                  <tr>
                      ${
                        !isSingleMaterial
                          ? `<td>${entry.material_name || "---"}</td>`
                          : ""
                      }
                      <td>${typeDisplay}</td>
                      <td style="${quantityColor}">${entry.change_quantity.toFixed(
            2
          )} ${unit}</td>
                      <td style="${valueColor}">${entry.change_value.toFixed(
            2
          )} Ø´ÙŠÙƒÙ„</td>
                      <td>${entry.date}</td>
                      <td>${sourceDisplay}</td>
                  </tr>
              `;
        });
        tableHtml += "</tbody></table>";
        targetContainer.innerHTML = tableHtml;
      }
    </script>
  </body>
</html>
