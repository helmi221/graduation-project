<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | ุงูุฑุฆูุณูุฉ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">FurnAI</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link active">ุงูุฑุฆูุณูุฉ</a>
            </li>
            <li>
              <a href="products.html" class="nav-link">ููุชุฌุงุชูุง</a>
            </li>
            <li><a href="order-status.html" class="nav-link">ุญุงูุฉ ุงูุทูุจ</a></li>
            <li>
              <a href="recommendation.html" class="nav-link">ุงููุฌุงุฑ ุงูุฐูู</a>
            </li>
            <li><a href="design.html" class="nav-link">ุตูู ููุชุฌู</a></li>
          </ul>

          <div class="auth-nav">
            <a href="cart.html" class="cart-icon-wrapper">
              <i class="fa-solid fa-bag-shopping" id="cart-icon"></i>
              <span id="cart-count-badge">0</span>
            </a>

            <div class="profile-dropdown" id="profile-dropdown">
              <div class="profile-icon">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="dropdown-menu">
                <div class="dropdown-header">
                  <span id="user-display-name">ูุฑุญุจุงู ุจู</span>
                  <p id="user-email">ุฒุงุฆุฑ</p>
                </div>
                <a href="login.html" id="auth-link">ุชุณุฌูู ุงูุฏุฎูู</a>
                <a href="#" id="logout-link" style="display: none"
                  >ุชุณุฌูู ุงูุฎุฑูุฌ</a
                >
              </div>
            </div>
          </div>

          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a>
      <a href="products.html" class="nav-link">ููุชุฌุงุชูุง</a>
      <a href="order-status.html" class="nav-link">ุญุงูุฉ ุงูุทูุจ</a>
      <a href="recommendation.html" class="nav-link">ุงููุฌุงุฑ ุงูุฐูู</a>
      <a href="design.html" class="nav-link">ุตูู ููุชุฌู</a>
    </div>

    <main>
      <section class="hero-section">
        <div class="hero-background-image"></div>
        <div class="container hero-content">
          <h1>ูู ุงูุฎุดุจุ ูู ูู ูุทุนุฉ</h1>
          <p>
            ูุตูุน ุฃุซุงุซุงู ูุฑูู ูุตุฉุ ูุตูู ููุจุนุซ ุงูุฏูุก ูุงูุฃูุงูุฉ ูู ุฃุฑุฌุงุก ููุฒูู.
            ุงูุชุดู ูุทุนุงู ูุฑูุฏุฉ ุตููุนุช ูุชุฏูู.
          </p>
          <a href="products.html" class="btn">ุชุตูุญ ุฃุนูุงููุง ุงูุขู</a>
        </div>
      </section>

      <section class="our-promise-section">
        <div class="container promise-grid">
          <div class="promise-card">
            <i class="fa-solid fa-hammer"></i>
            <h3>ุตูุงุนุฉ ูุฏููุฉ ุฏูููุฉ</h3>
            <p>ูู ูุทุนุฉ ุชูุตูุน ุจุนูุงูุฉ ูุงุฆูุฉ ูุถูุงู ุฃุนูู ูุณุชููุงุช ุงูุฌูุฏุฉ.</p>
          </div>
          <div class="promise-card">
            <i class="fa-solid fa-tree"></i>
            <h3>ุฃุฌูุฏ ุงูุฃุฎุดุงุจ ุงูุทุจูุนูุฉ</h3>
            <p>ูุณุชุฎุฏู ููุท ุงูุฃุฎุดุงุจ ุงูุตูุจุฉ ูุงููุณุชุฏุงูุฉ ุงูุชู ุชุนูุด ุทูููุงู.</p>
          </div>
          <div class="promise-card">
            <i class="fa-solid fa-ruler-combined"></i>
            <h3>ุชุตููู ูุฎุตุต ุญุณุจ ุฑุคูุชู</h3>
            <p>ุญููู ููุฑุชู ุฅูู ูุงูุน ููููุณ ูุน ุฎุฏูุฉ ุงูุชุตููู ุญุณุจ ุงูุทูุจ.</p>
          </div>
        </div>
      </section>

      <section class="container about-us-new">
        <div class="about-us-new-text">
          <div class="section-title-wrapper" style="margin-bottom: 2rem">
            <h2 style="text-align: right; margin-bottom: 0">ูุตุฉ ุญุฑููุฉ ูุฌูุฏุฉ</h2>
          </div>
          <p>
            ูู FurnAIุ ูุคูู ุจุฃู ุงูุฃุซุงุซ ููุณ ูุฌุฑุฏ ูุทุน ุฎุดุจูุฉุ ุจู ูู ุฌุฒุก ูู ูุตุฉ
            ููุฒูู. ููุฑุณ ุดุบููุง ูููุงุฑุชูุง ุงููุฏููุฉ ูุตูุงุนุฉ ูุทุน ูุฑูุฏุฉ ุชุนูุณ ุดุฎุตูุชู
            ูุชุถูู ุงูุฏูุก ุนูู ูุณุงุญุชู.
          </p>
          <p>
            ูู ูุทุนุฉ ูุตูุนูุง ูุตููุฉ ูุชุฏููุ ูุชุฌูุน ุจูู ุงูุฌูุฏุฉ ุงูุนุงููุฉ ูุงูุฌูุงู ุงูุฎุงูุฏ.
          </p>
          <a href="design.html" class="btn btn-secondary">ุงุจุฏุฃ ุชุตูููู ุงููุฎุตุต</a>
        </div>
        <div class="about-us-new-image">
          <img
            src="https://images.unsplash.com/photo-1595267256616-7d0e5a96096a?q=80&w=1770&auto=format&fit=crop"
            alt="ูุฌุงุฑ ูุนูู ูู ูุฑุดุฉ"
          />
        </div>
      </section>

      <section class="section container" style="padding-top: 40px">
        <div class="section-title-wrapper">
          <h2>ูุฎุชุงุฑุงุชูุง</h2>
        </div>
        <div class="product-grid" id="featured-products-grid"></div>
      </section>

      <section class="testimonials-section">
        <div class="container">
          <div class="section-title-wrapper">
            <h2>ูุงุฐุง ูููู ุนููุงุคูุง</h2>
          </div>
          <div class="testimonials-grid">
            <div class="testimonial-card">
              <i class="fa-solid fa-quote-right"></i>
              <p>
                "ุฌูุฏุฉ ูุง ุชูุนูู ุนูููุง. ุทูุจุช ุทุงููุฉ ุทุนุงู ูุฃุจูุฑุชูู ุฏูุฉ ุงูุชูุงุตูู
                ูุงููุชุงูุฉ. ุดูุฑุงู ููู!"
              </p>
              <h4>- ูุญูุฏ ุฃุญูุฏ</h4>
            </div>
            <div class="testimonial-card">
              <i class="fa-solid fa-quote-right"></i>
              <p>
                "ูุงู ูุฏู ุชุตููู ูุฎุตุต ูุบุฑูุฉ ููููุ ููุฑูู ุงูFurnAI ุญููู ุฅูู ุญูููุฉ
                ุฃุฌูู ููุง ุชุฎููุช. ุฎุฏูุฉ ุฑุงุฆุนุฉ."
              </p>
              <h4>- ุณุงุฑุฉ ุฎููู</h4>
            </div>
            <div class="testimonial-card">
              <i class="fa-solid fa-quote-right"></i>
              <p>
                "ุงูุชุนุงูู ูุนูู ูุงู ูุฑูุญุงู ุฌุฏุงู. 'ุงููุฌุงุฑ ุงูุฐูู' ุณุงุนุฏูู ูู ุงุฎุชูุงุฑ
                ุงููุทุนุฉ ุงูููุงุณุจุฉ ูููุฒุงููุชู."
              </p>
              <h4>- ููุณู ุนูู</h4>
            </div>
          </div>
        </div>
      </section>

      <section
        class="section container cta-section"
        style="background: none; padding-bottom: 80px"
      >
        <div
          class="container"
          style="
            background-color: var(--dark-color);
            color: var(--white-color);
            padding: 60px 40px;
            border-radius: var(--border-radius);
            text-align: center;
          "
        >
          <h2 style="color: var(--white-color)">ุตูู ุฃุซุงุซู ุงูุฎุงุต!</h2>
          <p
            style="
              color: #eee;
              max-width: 600px;
              margin: 0 auto 2rem auto;
              opacity: 0.9;
            "
          >
            ูู ูุฏูู ููุฑุฉ ูุฑูุฏุฉ ูู ุฐูููุ ุฏุนูุง ูุญูููุง ุฅูู ุญูููุฉ. ูู FurnAIุ ููุฏู
            ุฎุฏูุฉ ุงูุชุตููู ุงููุฎุตุต ููุตูุน ูู ูุทุนุฉ ุฃุซุงุซ ุชูุงุณุจ ุฐููู ูุงุญุชูุงุฌุงุชู ุชูุงูุงู.
          </p>
          <a href="design.html" class="btn">ุงุจุฏุฃ ุงูุขู</a>
        </div>
      </section>
    </main>

    <footer>
      <div class="container footer-content">
        <a href="index.html" class="footer-logo">FurnAI</a>
        <div class="footer-links">
          <a href="#">ูู ูุญู</a> <a href="#">ุชูุงุตู ูุนูุง</a>
        </div>
      </div>
      <div class="copyright">&copy; 2025 ุฌููุน ุงูุญููู ูุญููุธุฉ.</div>
    </footer>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div class="modal-body">
          <div class="modal-image-col">
            <img id="modal-img" src="" alt="ุตูุฑุฉ ุงูููุชุฌ" />
          </div>
          <div class="modal-details-col">
            <h2 id="modal-title"></h2>
            <p id="modal-price" class="product-price"></p>
            <p id="modal-description"></p>

            <hr class="modal-options-separator" />

            <div class="modal-options">
              <div id="color-section">
                <label for="modal-color-select">ุงุฎุชุฑ ุงูููู</label>
                <select id="modal-color-select"></select>
              </div>
              <div>
                <label for="modal-quantity">ุงููููุฉ</label>
                <div id="modal-quantity-selector" class="quantity-selector">
                  <button
                    class="quantity-btn quantity-btn-plus"
                    data-change="1"
                  >
                    +
                  </button>
                  <input
                    type="number"
                    id="modal-quantity"
                    value="1"
                    min="1"
                    readonly
                  />
                  <button
                    class="quantity-btn quantity-btn-minus"
                    data-change="-1"
                  >
                    -
                  </button>
                </div>
              </div>
            </div>
            <button class="btn" id="add-to-cart-btn">ุฅุถุงูุฉ ุฅูู ุงูุณูุฉ</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // (ุฅุนุฏุงุฏุงุช Firebase ููุง ูู)
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ๐ก (ูุนุฏู) ุนูุงุตุฑ ุงููุงุฌูุฉ ูููุงุฆูุฉ ุงูููุณุฏูุฉ
      const userDisplayName = document.getElementById("user-display-name");
      const userEmail = document.getElementById("user-email");
      const authLink = document.getElementById("auth-link");
      const logoutLink = document.getElementById("logout-link");

      const featuredGrid = document.getElementById("featured-products-grid");
      const modal = document.getElementById("product-modal");
      const modalClose = document.querySelector(".modal-close");
      const addToCartBtn = document.getElementById("add-to-cart-btn");
      const cartCountBadge = document.getElementById("cart-count-badge");
      const body = document.body;
      const menuToggle = document.getElementById("menu-toggle");
      const mobileMenu = document.getElementById("mobile-menu");
      const toast = document.getElementById("toast-notification");
      const quantitySelector = document.getElementById(
        "modal-quantity-selector"
      );

      let allProducts = [];
      let cart = [];
      // ๐ก (ุฌุฏูุฏ) ูุชุบูุฑ ูุฎุฑูุทุฉ ุงูููุงุฏ ุงูุฎุงู
      let allRawMaterialsMap = new Map();

      // ๐ก (ูุนุฏู) ุฏุงูุฉ ุงููุตุงุฏูุฉ ูุชุญุฏูุซ ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDocRef = doc(db, "users", user.uid);
          const userDocSnap = await getDoc(userDocRef);
          let userName = "ูุณุชุฎุฏู";
          if (userDocSnap.exists()) {
            userName = userDocSnap.data().name || userName;
          }
          userDisplayName.textContent = "ูุฑุญุจุงู " + userName;
          userEmail.textContent = user.email;
          authLink.style.display = "none";
          logoutLink.style.display = "block";

          logoutLink.onclick = async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = "index.html";
          };
        } else {
          userDisplayName.textContent = "ูุฑุญุจุงู ุจู";
          userEmail.textContent = "ุฒุงุฆุฑ";
          authLink.style.display = "block";
          logoutLink.style.display = "none";
        }
      });

      // (ุฏุงูุฉ ุฅูุดุงุก ุจุทุงูุฉ ุงูููุชุฌ ููุง ูู)
      function createProductCard(product) {
        const isAvailable = product.is_available !== false;
        const card = document.createElement("div");
        card.className = `product-card ${isAvailable ? "" : "out-of-stock"}`;
        card.dataset.productId = product.id;
        const imageSrc = `images/${product.id}.png`;
        card.innerHTML = `
                <div class="product-image-container">
                    <img src="${imageSrc}" alt="${
          product.name
        }" loading="lazy" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80';">
                </div>
                <div class="product-card-content">
                    <span class="product-category">${product.category}</span>
                    <h3>${product.name}</h3>
                    <p class="product-price">${parseFloat(
                      product.price
                    ).toFixed(0)} ุดููู</p>
                </div>`;
        return card;
      }

      const displayProducts = (productsToDisplay, gridElement) => {
        if (!gridElement) return;
        gridElement.innerHTML = "";
        productsToDisplay.forEach((product) => {
          gridElement.appendChild(createProductCard(product));
        });
      };

      // (ุฏูุงู ุงูููุฏุงู ูุงูุณูุฉ ูุงูุชูุจููุงุช ููุง ูู)
      function openModal(product) {
        const isAvailable = product.is_available !== false;
        const imageSrc = `images/${product.id}.png`;
        document.getElementById("modal-img").src = imageSrc;
        document.getElementById("modal-img").onerror = function () {
          this.onerror = null;
          this.src =
            "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80";
        };
        document.getElementById("modal-title").textContent = product.name;
        document.getElementById("modal-price").textContent = `${parseFloat(
          product.price
        ).toFixed(0)} ุดููู`;
        document.getElementById("modal-description").textContent =
          product.description || "";
        const colorSection = document.getElementById("color-section");
        const colorSelect = document.getElementById("modal-color-select");
        colorSelect.innerHTML = "";
        if (product.specs && product.specs.includes("ุฎูุงุฑุงุช ุงูุฃููุงู:")) {
          const colors = product.specs
            .replace("ุฎูุงุฑุงุช ุงูุฃููุงู:", "")
            .split("ุ")
            .map((c) => c.trim())
            .filter(Boolean);
          colors.forEach((color) => {
            const option = document.createElement("option");
            option.value = color;
            option.textContent = color;
            colorSelect.appendChild(option);
          });
          colorSection.style.display = "block";
        } else {
          colorSection.style.display = "none";
        }

        addToCartBtn.dataset.productId = product.id;
        addToCartBtn.disabled = !isAvailable;
        addToCartBtn.textContent = isAvailable
          ? "ุฅุถุงูุฉ ุฅูู ุงูุณูุฉ"
          : "ุบูุฑ ูุชููุฑ ุญุงููุงู";

        document.getElementById("modal-quantity").value = 1;
        modal.classList.add("active");
        body.classList.add("scroll-lock");
      }

      function addToCart(productId, quantity, color) {
        const product = allProducts.find((p) => p.id === productId);
        if (!product || product.is_available === false) return;

        if (!product) return;
        const existingItem = cart.find(
          (item) => item.id === productId && item.color === color
        );
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({
            id: product.id,
            name: product.name,
            price: parseFloat(product.price),
            quantity,
            color,
            image: `images/${product.id}.png`,
          });
        }
        saveCart();
        updateCartBadge();
      }

      quantitySelector.addEventListener("click", (e) => {
        if (e.target.classList.contains("quantity-btn")) {
          const quantityInput = document.getElementById("modal-quantity");
          let currentValue = parseInt(quantityInput.value, 10);
          currentValue += parseInt(e.target.dataset.change, 10);
          if (currentValue < 1) currentValue = 1;
          quantityInput.value = currentValue;
        }
      });

      addToCartBtn.addEventListener("click", (e) => {
        const productId = parseInt(e.currentTarget.dataset.productId, 10);
        const quantity = parseInt(
          document.getElementById("modal-quantity").value,
          10
        );
        const colorSelect = document.getElementById("modal-color-select");
        const color =
          colorSelect.style.display !== "none" ? colorSelect.value : null;
        addToCart(productId, quantity, color);
        closeModal();
        showToast("โ ุชูุช ุฅุถุงูุฉ ุงูููุชุฌ ุฅูู ุงูุณูุฉ ุจูุฌุงุญ!");
      });

      function closeModal() {
        modal.classList.remove("active");
        if (!mobileMenu.classList.contains("active")) {
          body.classList.remove("scroll-lock");
        }
      }

      function handleGridClick(e) {
        const card = e.target.closest(".product-card");
        if (card) {
          const productId = parseInt(card.dataset.productId, 10);
          const product = allProducts.find((p) => p.id === productId);
          if (product) openModal(product);
        }
      }

      function saveCart() {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
      }

      function loadCart() {
        const storedCart = localStorage.getItem("shoppingCart");
        cart = storedCart ? JSON.parse(storedCart) : [];
      }

      function updateCartBadge() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.toggle("visible", totalItems > 0);
      }

      function showToast(message) {
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // (ููุทู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููููุจุงูู ููุง ูู)
      menuToggle.addEventListener("click", () => {
        mobileMenu.classList.toggle("active");
        body.classList.toggle("scroll-lock");
      });

      featuredGrid.addEventListener("click", handleGridClick);
      modalClose.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      // ๐ก (ูุนุฏู ุจุงููุงูู) ุฏุงูุฉ ุฌูุจ ุงูููุชุฌุงุช (ููุตูุญุฉ ุงูุฑุฆูุณูุฉ)
      async function fetchProductsAndRender() {
        try {
          // 1. (ุฌุฏูุฏ) ุฌูุจ ุงูููุงุฏ ุงูุฎุงู ุฃููุงู
          const materialsSnapshot = await getDocs(
            collection(db, "raw_materials")
          );
          allRawMaterialsMap.clear();
          materialsSnapshot.docs.forEach((doc) => {
            allRawMaterialsMap.set(doc.id, {
              ...doc.data(),
              current_stock: parseFloat(doc.data().current_stock || 0),
            });
          });

          // 2. ุฌูุจ ุงูููุชุฌุงุช
          const productsSnapshot = await getDocs(collection(db, "products"));
          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          // 3. (ุฌุฏูุฏ) ุญุณุงุจ ุงูุชููุฑ ุงูุญูููู ูุชุญุฏูุซ ูุตูููุฉ allProducts
          allProducts.forEach((product) => {
            const manualAvailable = product.is_available !== false;

            if (!manualAvailable) {
              product.is_available = false;
              return;
            }

            const requiredMats = product.required_materials || [];
            if (requiredMats.length === 0) {
              product.is_available = true;
              return;
            }

            let materialsAvailable = true;
            for (const reqMat of requiredMats) {
              const material = allRawMaterialsMap.get(reqMat.id);
              if (!material || material.current_stock < reqMat.quantity) {
                materialsAvailable = false;
                break;
              }
            }
            product.is_available = materialsAvailable;
          });

          // 4. (ูุนุฏู) ุนุฑุถ ุงูููุชุฌุงุช ุงููููุฒุฉ
          const featuredIds = [3, 15, 43, 40];
          const featuredProducts = allProducts.filter((p) =>
            featuredIds.includes(p.id)
          );

          displayProducts(featuredProducts, featuredGrid);
        } catch (e) {
          console.error("Error fetching products from Firebase: ", e);
          featuredGrid.innerHTML =
            "<p>ุนุฐุฑุงูุ ูู ูุชููู ูู ุฌูุจ ุงูููุชุฌุงุช ุญุงููุงู.</p>";
        }
      }

      // ====== ุจุฏุก ุชูููุฐ ุงูุณูุฑุจุช ======
      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        updateCartBadge();
        fetchProductsAndRender();
      });
    </script>
  </body>
</html>
