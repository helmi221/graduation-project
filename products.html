<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">FurnAI</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </li>
            <li>
              <a href="products.html" class="nav-link active">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
            </li>
            <li><a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a></li>
            <li>
              <a href="recommendation.html" class="nav-link">Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</a>
            </li>
            <li><a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a></li>
          </ul>

          <div class="auth-nav">
            <a href="cart.html" class="cart-icon-wrapper">
              <i class="fa-solid fa-bag-shopping" id="cart-icon"></i>
              <span id="cart-count-badge">0</span>
            </a>

            <div class="profile-dropdown" id="profile-dropdown">
              <div class="profile-icon">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="dropdown-menu">
                <div class="dropdown-header">
                  <span id="user-display-name">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</span>
                  <p id="user-email">Ø²Ø§Ø¦Ø±</p>
                </div>
                <a href="login.html" id="auth-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                <a href="#" id="logout-link" style="display: none"
                  >ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
                >
              </div>
            </div>
          </div>

          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="products.html" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
      <a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a>
      <a href="recommendation.html" class="nav-link">Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</a>
      <a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a>
    </div>

    <main>
      <section class="section container">
        <div class="section-title-wrapper">
          <h2>Ø¬Ù…ÙŠØ¹ Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</h2>
        </div>
        <div class="filters">
          <button class="filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
          <button class="filter-btn" data-filter="Ø·Ø§ÙˆÙ„Ø© Ø³ÙØ±Ø©">
            Ø·Ø§ÙˆÙ„Ø§Øª Ø³ÙØ±Ø©
          </button>
          <button class="filter-btn" data-filter="ÙƒØ±Ø³ÙŠ">ÙƒØ±Ø§Ø³ÙŠ</button>
          <button class="filter-btn" data-filter="Ø·Ù‚Ù… ÙƒÙ†Ø¨">Ø£Ø·Ù‚Ù… ÙƒÙ†Ø¨</button>
          <button class="filter-btn" data-filter="ØºØ±ÙØ© Ù†ÙˆÙ…">ØºØ±Ù Ù†ÙˆÙ…</button>
          <button class="filter-btn" data-filter="Ù…Ø·Ø¨Ø®">Ø£Ø«Ø§Ø« Ù…Ø·Ø¨Ø®</button>
          <button class="filter-btn" data-filter="Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·">Ø·Ø§ÙˆÙ„Ø§Øª ÙˆØ³Ø·</button>
          <button class="filter-btn" data-filter="Ø®Ø²Ø§Ù†Ø©">Ø®Ø²Ø§Ø¦Ù†</button>
          <button class="filter-btn" data-filter="Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ§Ø²">
            Ø·Ø§ÙˆÙ„Ø§Øª ØªÙ„ÙØ§Ø²
          </button>
        </div>
        <div
          class="product-grid"
          id="product-grid-container"
          style="margin-top: 4rem"
        ></div>
      </section>
    </main>

    <footer>
      <div class="container footer-content">
        <a href="index.html" class="footer-logo">FurnAI</a>
        <div class="footer-links">
          <a href="#">Ù…Ù† Ù†Ø­Ù†</a> <a href="#">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
        </div>
      </div>
      <div class="copyright">&copy; 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
    </footer>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div class="modal-body">
          <div class="modal-image-col">
            <img id="modal-img" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" />
          </div>
          <div class="modal-details-col">
            <h2 id="modal-title"></h2>
            <p id="modal-price" class="product-price"></p>
            <p id="modal-description"></p>

            <hr class="modal-options-separator" />

            <div class="modal-options">
              <div id="color-section">
                <label for="modal-color-select">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†</label>
                <select id="modal-color-select"></select>
              </div>
              <div>
                <label for="modal-quantity">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <div id="modal-quantity-selector" class="quantity-selector">
                  <button
                    class="quantity-btn quantity-btn-plus"
                    data-change="1"
                  >
                    +
                  </button>
                  <input
                    type="number"
                    id="modal-quantity"
                    value="1"
                    min="1"
                    readonly
                  />
                  <button
                    class="quantity-btn quantity-btn-minus"
                    data-change="-1"
                  >
                    -
                  </button>
                </div>
              </div>
            </div>
            <button class="btn" id="add-to-cart-btn">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙƒÙ…Ø§ Ù‡ÙŠ)
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // (Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙƒÙ…Ø§ Ù‡ÙŠ)
      const userDisplayName = document.getElementById("user-display-name");
      const userEmail = document.getElementById("user-email");
      const authLink = document.getElementById("auth-link");
      const logoutLink = document.getElementById("logout-link");

      const productGrid = document.getElementById("product-grid-container");
      const filterButtons = document.querySelectorAll(".filter-btn");
      const modal = document.getElementById("product-modal");
      const modalClose = document.querySelector(".modal-close");
      const addToCartBtn = document.getElementById("add-to-cart-btn");
      const cartCountBadge = document.getElementById("cart-count-badge");
      const body = document.body;
      const menuToggle = document.getElementById("menu-toggle");
      const mobileMenu = document.getElementById("mobile-menu");
      const toast = document.getElementById("toast-notification");
      const quantitySelector = document.getElementById(
        "modal-quantity-selector"
      );

      let allProducts = [];
      let cart = [];
      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ± Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
      let allRawMaterialsMap = new Map();

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDocRef = doc(db, "users", user.uid);
          const userDocSnap = await getDoc(userDocRef);
          let userName = "Ù…Ø³ØªØ®Ø¯Ù…";
          if (userDocSnap.exists()) {
            userName = userDocSnap.data().name || userName;
          }
          userDisplayName.textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + userName;
          userEmail.textContent = user.email;
          authLink.style.display = "none";
          logoutLink.style.display = "block";

          logoutLink.onclick = async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = "index.html";
          };
        } else {
          userDisplayName.textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ";
          userEmail.textContent = "Ø²Ø§Ø¦Ø±";
          authLink.style.display = "block";
          logoutLink.style.display = "none";
        }
      });

      // (Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ…Ø§ Ù‡ÙŠ)
      function createProductCard(product) {
        const isAvailable = product.is_available !== false;
        const card = document.createElement("div");
        card.className = `product-card ${isAvailable ? "" : "out-of-stock"}`;
        card.dataset.productId = product.id;
        const imageSrc = `images/${product.id}.png`;
        card.innerHTML = `
                <div class="product-image-container">
                    <img src="${imageSrc}" alt="${
          product.name
        }" loading="lazy" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80';">
                </div>
                <div class="product-card-content">
                    <span class="product-category">${product.category}</span>
                    <h3>${product.name}</h3>
                    <p class="product-price">${parseFloat(
                      product.price
                    ).toFixed(0)} Ø´ÙŠÙƒÙ„</p>
                </div>`;
        return card;
      }

      const displayProducts = (productsToDisplay, gridElement) => {
        if (!gridElement) return;
        gridElement.innerHTML = "";
        productsToDisplay.forEach((product) => {
          gridElement.appendChild(createProductCard(product));
        });
      };

      // (Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ø³Ù„Ø© ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ)
      function openModal(product) {
        const isAvailable = product.is_available !== false;
        const imageSrc = `images/${product.id}.png`;
        document.getElementById("modal-img").src = imageSrc;
        document.getElementById("modal-img").onerror = function () {
          this.onerror = null;
          this.src =
            "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80";
        };
        document.getElementById("modal-title").textContent = product.name;
        document.getElementById("modal-price").textContent = `${parseFloat(
          product.price
        ).toFixed(0)} Ø´ÙŠÙƒÙ„`;
        document.getElementById("modal-description").textContent =
          product.description || "";
        const colorSection = document.getElementById("color-section");
        const colorSelect = document.getElementById("modal-color-select");
        colorSelect.innerHTML = "";
        if (product.specs && product.specs.includes("Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†:")) {
          const colors = product.specs
            .replace("Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†:", "")
            .split("ØŒ")
            .map((c) => c.trim())
            .filter(Boolean);
          colors.forEach((color) => {
            const option = document.createElement("option");
            option.value = color;
            option.textContent = color;
            colorSelect.appendChild(option);
          });
          colorSection.style.display = "block";
        } else {
          colorSection.style.display = "none";
        }

        addToCartBtn.dataset.productId = product.id;
        addToCartBtn.disabled = !isAvailable;
        addToCartBtn.textContent = isAvailable
          ? "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©"
          : "ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹";

        document.getElementById("modal-quantity").value = 1;
        modal.classList.add("active");
        body.classList.add("scroll-lock");
      }

      function addToCart(productId, quantity, color) {
        const product = allProducts.find((p) => p.id === productId);
        if (!product || product.is_available === false) return;

        if (!product) return;
        const existingItem = cart.find(
          (item) => item.id === productId && item.color === color
        );
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({
            id: product.id,
            name: product.name,
            price: parseFloat(product.price),
            quantity,
            color,
            image: `images/${product.id}.png`,
          });
        }
        saveCart();
        updateCartBadge();
      }

      quantitySelector.addEventListener("click", (e) => {
        if (e.target.classList.contains("quantity-btn")) {
          const quantityInput = document.getElementById("modal-quantity");
          let currentValue = parseInt(quantityInput.value, 10);
          currentValue += parseInt(e.target.dataset.change, 10);
          if (currentValue < 1) currentValue = 1;
          quantityInput.value = currentValue;
        }
      });

      addToCartBtn.addEventListener("click", (e) => {
        const productId = parseInt(e.currentTarget.dataset.productId, 10);
        const quantity = parseInt(
          document.getElementById("modal-quantity").value,
          10
        );
        const colorSelect = document.getElementById("modal-color-select");
        const color =
          colorSelect.style.display !== "none" ? colorSelect.value : null;
        addToCart(productId, quantity, color);
        closeModal();
        showToast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
      });

      function closeModal() {
        modal.classList.remove("active");
        if (!mobileMenu.classList.contains("active")) {
          body.classList.remove("scroll-lock");
        }
      }

      function handleGridClick(e) {
        const card = e.target.closest(".product-card");
        if (card) {
          const productId = parseInt(card.dataset.productId, 10);
          const product = allProducts.find((p) => p.id === productId);
          if (product) openModal(product);
        }
      }

      function saveCart() {
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
      }

      function loadCart() {
        const storedCart = localStorage.getItem("shoppingCart");
        cart = storedCart ? JSON.parse(storedCart) : [];
      }

      function updateCartBadge() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.toggle("visible", totalItems > 0);
      }

      function showToast(message) {
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // (Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ)
      menuToggle.addEventListener("click", () => {
        mobileMenu.classList.toggle("active");
        body.classList.toggle("scroll-lock");
      });

      // --- ğŸ’¡ (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¥ØµÙ„Ø§Ø­) ---
      // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø§Ù„Overlay)
      mobileMenu.addEventListener("click", (e) => {
        if (e.target === mobileMenu) {
          mobileMenu.classList.remove("active");
          // Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙØªÙˆØ­
          if (!modal.classList.contains("active")) {
            body.classList.remove("scroll-lock");
          }
        }
      });

      // 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø¨Ø¯Ø§Ø®Ù„Ù‡Ø§ (Ù„Ù„ØªÙ†Ù‚Ù„)
      const mobileMenuLinks = document.querySelectorAll(
        "#mobile-menu a.nav-link"
      );
      mobileMenuLinks.forEach((link) => {
        link.addEventListener("click", () => {
          mobileMenu.classList.remove("active");
          if (!modal.classList.contains("active")) {
            body.classList.remove("scroll-lock");
          }
        });
      });
      // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ---

      // (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
      filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
          filterButtons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          const filter = button.dataset.filter;
          const filteredProducts =
            filter === "all"
              ? allProducts
              : allProducts.filter((p) => p.category === filter);
          displayProducts(filteredProducts, productGrid);
        });
      });

      productGrid.addEventListener("click", handleGridClick);
      modalClose.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)
      async function fetchProductsAndRender() {
        try {
          // 1. (Ø¬Ø¯ÙŠØ¯) Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
          const materialsSnapshot = await getDocs(
            collection(db, "raw_materials")
          );
          allRawMaterialsMap.clear();
          materialsSnapshot.docs.forEach((doc) => {
            allRawMaterialsMap.set(doc.id, {
              ...doc.data(),
              current_stock: parseFloat(doc.data().current_stock || 0),
            });
          });

          // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
          const productsSnapshot = await getDocs(collection(db, "products"));
          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          // 3. (Ø¬Ø¯ÙŠØ¯) Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆÙØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© allProducts
          allProducts.forEach((product) => {
            const manualAvailable = product.is_available !== false;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ø£Ø·ÙØ£Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ ÙÙ‡Ùˆ ØºÙŠØ± Ù…ØªÙˆÙØ±.
            if (!manualAvailable) {
              product.is_available = false;
              return;
            }

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ø§ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
            const requiredMats = product.required_materials || [];
            if (requiredMats.length === 0) {
              product.is_available = true; // Ù…ØªØ§Ø­ ÙˆÙ„Ø§ ÙŠØ­ØªØ§Ø¬ Ù…ÙˆØ§Ø¯
              return;
            }

            let materialsAvailable = true;
            for (const reqMat of requiredMats) {
              const material = allRawMaterialsMap.get(reqMat.id);
              if (!material || material.current_stock < reqMat.quantity) {
                materialsAvailable = false; // Ø§Ù„Ù…ÙˆØ§Ø¯ Ù†Ø§Ù‚ØµØ©
                break;
              }
            }
            product.is_available = materialsAvailable; // Ø§Ù„ØªÙˆÙØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯
          });

          // 4. (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„ØªØ± ÙˆØ§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
          const activeFilterBtn = document.querySelector(".filter-btn.active");
          const filter = activeFilterBtn
            ? activeFilterBtn.dataset.filter
            : "all";

          const productsToDisplay =
            filter === "all"
              ? allProducts // Ø³ØªÙ‚ÙˆÙ… Ø¯Ø§Ù„Ø© createProductCard Ø¨Ø§Ù„Ø¨Ø§Ù‚ÙŠ
              : allProducts.filter((p) => p.category === filter);

          displayProducts(productsToDisplay, productGrid);
        } catch (e) {
          console.error("Error fetching products from Firebase: ", e);
          productGrid.innerHTML =
            "<p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>";
        }
      }

      // ====== Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø³ÙƒØ±Ø¨Øª ======
      document.addEventListener("DOMContentLoaded", () => {
        loadCart();
        updateCartBadge();
        fetchProductsAndRender(); // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
      });
    </script>
  </body>
</html>
