<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ù‡Ù…Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶Ù‡Ø§) */
      .status-badge {
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        display: inline-block;
        white-space: nowrap;
        font-size: 0.85rem;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© {
        background-color: #ffeb3b;
        color: #795548;
      }
      .status-badge.Ù…Ù‚Ø¨ÙˆÙ„ {
        background-color: #5bc0de;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„ØªØµÙ†ÙŠØ¹ {
        background-color: #34495e;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ø·Ù„Ø§Ø¡ {
        background-color: #f39c12;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„ØªØºÙ„ÙŠÙ {
        background-color: #c0392b;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ø´Ø­Ù† {
        background-color: #3498db;
        color: white;
      }
      .status-badge.Ù…ÙƒØªÙ…Ù„ {
        background-color: #4caf50;
        color: white;
      }
      .status-badge.ØªÙ…-Ø§Ù„Ø±ÙØ¶ {
        background-color: #e74c3c;
        color: white;
      }
      .status-badge.Ù…Ø¤Ø±Ø´Ù {
        background-color: #95a5a6;
        color: white;
      }
      .status-badge.Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„ {
        background-color: #27ae60;
        color: white;
      }
      .status-badge.Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„ {
        background-color: #c0392b;
        color: white;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
      .orders-section.admin-panel {
        margin-top: 25px;
      }
      .orders-section .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
      .modal-form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      textarea,
      input,
      select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #e6e9ee;
        font-family: "Cairo", sans-serif;
      }
      .orders-table th,
      .orders-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f5f9;
        text-align: right;
        font-size: 0.95rem;
      }

      /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…ÙØ­Ø³Ù† */
      .order-details-group p {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }
      .order-details-group p strong {
        font-weight: 700;
        color: var(--primary-color);
        margin-left: 5px;
      }
      .order-items-list {
        list-style-type: none;
        padding-right: 0;
        margin-top: 10px;
      }
      .order-items-list li {
        padding: 8px 0;
        font-size: 0.95rem;
        border-bottom: 1px dotted #f0f0f0;
        display: flex;
        justify-content: space-between;
      }

      /* ğŸ’¡ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙØ­Ø³Ù†Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
      .actions-buttons .btn-icon {
        background: none;
        border: none;
        color: var(--dark-color);
        padding: 5px 8px;
        cursor: pointer;
        font-size: 1.1rem;
        margin-left: 5px;
        transition: color 0.2s;
      }
      /* Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ØªØºÙŠÙŠØ±/Ø¹Ø±Ø¶) */
      .actions-buttons .btn-icon.btn-manage {
        color: var(--info-color, #5d9cec);
      }
      .actions-buttons .btn-icon.btn-manage:hover {
        color: var(--dark-color);
      }
      /* Ø²Ø± Ø§Ù„Ø­Ø°Ù */
      .actions-buttons .btn-icon.btn-delete {
        color: var(--danger-color, #e74c3c);
      }
      .actions-buttons .btn-icon.btn-delete:hover {
        color: #d32f2f;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© */
      #bulk-actions-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
        min-height: 50px;
        display: none;
      }
      #bulk-actions-container.show {
        display: flex;
      }
      #bulk-actions-container select {
        width: 200px;
        padding: 8px;
        border: 1px solid var(--primary-color);
      }
      #bulk-actions-container .btn {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
      /* ğŸ’¡ Ù†Ù…Ø· Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…Ø®ØµØµ */
      #custom-materials-field {
        background-color: #f7f7f7;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <header class="main-header">
      <div class="logo">Ù…Ù†Ø¬Ø±Ø©</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html" class="active"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
      <div class="orders-section admin-panel">
        <div class="section-header">
          <div class="filters-container" id="filters-container">
            <button class="filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" data-filter="ready">Ø¬Ø§Ù‡Ø²Ø©</button>
            <button class="filter-btn" data-filter="custom">Ù…Ø®ØµØµØ©</button>
            <button class="filter-btn" data-filter="pending">
              Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            </button>
            <button class="filter-btn" data-filter="in-progress">
              Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            </button>
            <button class="filter-btn" data-filter="completed">Ù…ÙƒØªÙ…Ù„Ø©</button>
            <button class="filter-btn" data-filter="archived">Ù…Ø¤Ø±Ø´ÙØ©</button>
          </div>
        </div>

        <div id="bulk-actions-container">
          <label for="bulk-status-select" style="font-weight: 600"
            >ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</label
          >
          <select id="bulk-status-select"></select>
          <button class="btn btn-sm" id="apply-bulk-status">
            <i class="fa-solid fa-check"></i> ØªØ·Ø¨ÙŠÙ‚
          </button>
        </div>

        <div id="orders-table-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
      </div>
    </div>

    <div id="order-details-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>

        <div id="modal-order-details"></div>
        <hr style="margin: 20px 0; border-color: #f0f0f0" />

        <h3><i class="fa-solid fa-list-ul"></i> Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3>

        <div class="modal-form-grid">
          <div class="form-group">
            <label for="modal-status">ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
            <select id="modal-status"></select>
          </div>
        </div>

        <div
          id="custom-materials-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="material-list">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ID:Quantity)</label>
          <p
            style="
              font-size: 0.9rem;
              color: var(--danger-color);
              margin-bottom: 5px;
            "
          >
            âš ï¸ Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„: ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø³Ø¹Ø±
            ÙŠØ¯ÙˆÙŠØ§Ù‹.
          </p>
          <textarea
            id="material-list"
            rows="3"
            placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø®Ø´Ø¨_1:0.5, Ø§Ù„Ø¯Ù‡Ø§Ù†_3:1.0"
          ></textarea>
          <p style="font-size: 0.8rem; color: #777">
            * ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… ID Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©.
          </p>
        </div>

        <div
          id="custom-price-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="modal-price">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø´ÙŠÙƒÙ„)</label>
          <input type="number" id="modal-price" min="0" step="0.01" />
        </div>

        <div
          id="rejection-reason-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="rejection-reason">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</label>
          <textarea id="rejection-reason" rows="3"></textarea>
        </div>

        <button id="save-status-btn" class="btn">
          <i class="fa-solid fa-save"></i> Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        </button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        orderBy,
        query,
        doc,
        updateDoc,
        writeBatch,
        getDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // ØªÙ‡ÙŠØ¦Ø© Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // ğŸ’¡ Ø¥Ø²Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Gemini

      let allOrders = [];
      let currentOrderId = null;
      let currentOrderCollection = null;
      let currentOrderData = null;

      let rawMaterialsMap = new Map();
      // ğŸ’¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
      const statusOptions = [
        "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
        "Ù…Ù‚Ø¨ÙˆÙ„",
        "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
        "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
        "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
        "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
        "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
        "Ù…ÙƒØªÙ…Ù„",
        "ØªÙ… Ø§Ù„Ø±ÙØ¶",
        "Ù…Ø¤Ø±Ø´Ù",
      ];

      // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±)
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal-overlay.active")
            .forEach((modal) => {
              closeModal(modal.id);
            });
        }
      });

      async function fetchRawMaterials() {
        const snapshot = await getDocs(collection(db, "raw_materials"));
        rawMaterialsMap = new Map(
          snapshot.docs.map((d) => [
            d.id,
            {
              id: d.id,
              ...d.data(),
              current_stock: parseFloat(d.data().current_stock || 0),
              total_cost_value: parseFloat(d.data().total_cost_value || 0),
              cost_per_unit: parseFloat(d.data().cost_per_unit || 0),
              unit: d.data().unit || "ÙˆØ­Ø¯Ø©",
              name_ar: d.data().name_ar || d.id,
            },
          ])
        );
      }

      // ÙƒØªÙ„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchRawMaterials();
            fetchOrders();
            setupBulkActions();
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "login.html";
        });

      async function fetchOrders() {
        const readySnap = await getDocs(collection(db, "orders"));
        const customSnap = await getDocs(collection(db, "custom_designs"));

        const readyOrders = readySnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "ready",
        }));

        const customOrders = customSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "custom",
        }));

        allOrders = [...readyOrders, ...customOrders].sort(
          (a, b) => new Date(b.order_date) - new Date(a.order_date)
        );
        const activeFilter =
          document.querySelector(".filter-btn.active")?.dataset.filter || "all";
        applyFilter(activeFilter);
      }

      function applyFilter(filter) {
        let filteredOrders = allOrders;
        if (filter === "ready") {
          filteredOrders = allOrders.filter((o) => o.type === "ready");
        } else if (filter === "custom") {
          filteredOrders = allOrders.filter((o) => o.type === "custom");
        } else if (filter === "pending") {
          filteredOrders = allOrders.filter(
            (o) => o.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" || o.status === "Ù…Ù‚Ø¨ÙˆÙ„"
          );
        } else if (filter === "in-progress") {
          filteredOrders = allOrders.filter((o) =>
            [
              "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
              "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
              "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
              "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
              "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
            ].includes(o.status)
          );
        } else if (filter === "completed") {
          filteredOrders = allOrders.filter((o) => o.status === "Ù…ÙƒØªÙ…Ù„");
        } else if (filter === "archived") {
          filteredOrders = allOrders.filter(
            (o) =>
              o.status === "Ù…Ø¤Ø±Ø´Ù" ||
              o.status === "ØªÙ… Ø§Ù„Ø±ÙØ¶" ||
              o.status === "Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„"
          );
        }
        renderTable(filteredOrders);
      }

      // ... (Ø¯Ø§Ù„Ø© renderTable ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
      function renderTable(orders) {
        const container = document.getElementById("orders-table-container");
        if (!orders.length) {
          container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>";
          document
            .getElementById("bulk-actions-container")
            .classList.remove("show");
          return;
        }
        let html = `<table class="orders-table">
        <thead><tr>
        <th><input type="checkbox" id="select-all-orders"></th>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead><tbody>`;

        orders.forEach((o) => {
          const statusClass = o.status.replace(/\s+/g, "-");
          const typeText = o.type === "ready" ? "Ø¬Ø§Ù‡Ø²" : "Ù…Ø®ØµØµ";
          const total =
            o.type === "ready"
              ? (o.total || 0).toFixed(0)
              : o.final_price
              ? o.final_price.toFixed(0)
              : "---";
          html += `
          <tr data-id="${o.id}" data-collection="${
            o.type === "ready" ? "orders" : "custom_designs"
          }">
          <td><input type="checkbox" class="order-select-checkbox" data-id="${
            o.id
          }"></td>
          <td>${o.name || "---"}</td>
          <td>${typeText}</td>
          <td>${new Date(o.order_date).toLocaleDateString("ar-EG")}</td>
          <td>${total}</td>
          <td><span class="status-badge ${statusClass}">${o.status}</span></td>
          <td class="actions-buttons" style="white-space: nowrap;">
            <button class="edit-btn btn-icon btn-manage" title="Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©"><i class="fa-solid fa-tools"></i></button>
            <button class="delete-btn btn-icon btn-delete" title="Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨" data-id="${
              o.id
            }" data-collection="${
            o.type === "ready" ? "orders" : "custom_designs"
          }"><i class="fa-solid fa-trash"></i></button>
          </td>
          </tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;

        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        document
          .getElementById("select-all-orders")
          .addEventListener("change", toggleAllCheckboxes);
        document.querySelectorAll(".order-select-checkbox").forEach((cb) => {
          cb.addEventListener("change", updateBulkActionsVisibility);
        });
        updateBulkActionsVisibility(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¤ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      }
      // ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„)

      // Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØ­Ø³Ù† (Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±Ø¯ÙŠ)
      document.addEventListener("click", (e) => {
        // ... (Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø­Ø°Ù)

        if (e.target.closest(".edit-btn")) {
          const tr = e.target.closest("tr");
          currentOrderId = tr.dataset.id;
          currentOrderCollection = tr.dataset.collection;
          currentOrderData = allOrders.find((o) => o.id === currentOrderId);

          if (!currentOrderData) return;

          const isCustom = currentOrderData.type === "custom";

          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ§Ù„Ø±ÙØ¶ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
          document.getElementById("modal-price").value = "";
          document.getElementById("rejection-reason").value = "";
          document.getElementById("material-list").value = "";
          document.getElementById("custom-price-field").style.display = "none";
          document.getElementById("rejection-reason-field").style.display =
            "none";
          document.getElementById("custom-materials-field").style.display =
            "none";

          let detailsHTML = `
              <div class="order-details-group">
                  <p><strong><i class="fa-solid fa-user"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${
                    currentOrderData.name || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-phone"></i> Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${
                    currentOrderData.phone || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-map-marker-alt"></i> Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${
                    currentOrderData.address || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-envelope"></i> Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</strong> ${
                    currentOrderData.email || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-receipt"></i> Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${
                    currentOrderData.id
                  }</p>
                  <p><strong><i class="fa-solid fa-calendar-alt"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(
                    currentOrderData.order_date
                  ).toLocaleDateString("ar-EG")}</p>
                  <p><strong><i class="fa-solid fa-list-check"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${
                    currentOrderData.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"
                  }</p>
                  <p><strong><i class="fa-solid fa-tag"></i> Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span class="status-badge ${currentOrderData.status.replace(
                    /\s+/g,
                    "-"
                  )}">${currentOrderData.status}</span></p>
              </div>
          `;

          if (currentOrderData.type === "ready") {
            // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø§Ù‡Ø²
            const total = (currentOrderData.total || 0).toFixed(0);
            detailsHTML += `
                  <h3><i class="fa-solid fa-boxes-stacked"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h3>
                  <ul class="order-items-list">
                      ${currentOrderData.items
                        .map(
                          (item) => `
                      <li>
                          <span>${item.name} (Ø§Ù„Ø¹Ø¯Ø¯: ${item.quantity}) ${
                            item.color ? `| Ø§Ù„Ù„ÙˆÙ†: ${item.color}` : ""
                          }</span>
                          <span>${parseFloat(item.price).toFixed(0)} Ø´ÙŠÙƒÙ„</span>
                      </li>
                      `
                        )
                        .join("")}
                  </ul>
                  <p style="margin-top: 15px; font-size: 1.1rem;"><strong><i class="fa-solid fa-money-bill-wave"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${total} Ø´ÙŠÙƒÙ„</p>
              `;
          } else {
            // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ (Custom Design)
            const priceDisplay = currentOrderData.final_price
              ? currentOrderData.final_price.toFixed(0)
              : currentOrderData.initial_price || "---";

            detailsHTML += `
                  <h3><i class="fa-solid fa-ruler-combined"></i> Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµ:</h3>
                  <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${
                    currentOrderData.title || "---"
                  }</p>
                  <p><strong>ÙˆØµÙ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${
                    currentOrderData.description || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${
                    currentOrderData.type_of_product || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:</strong> ${
                    currentOrderData.dimensions || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${
                    currentOrderData.material || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù„ÙˆÙ†:</strong> ${
                    currentOrderData.color || "---"
                  }</p>
                  <p style="margin-top: 15px;"><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø£ÙˆÙ„ÙŠ):</strong> ${priceDisplay} Ø´ÙŠÙƒÙ„</p>
                  <p style="font-size: 0.9rem; color: #888;">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© (COGS): ${
                    currentOrderData.estimatedCOGS || "---"
                  } Ø´ÙŠÙƒÙ„</p>
              `;

            // ğŸ’¡ Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
            document.getElementById("custom-materials-field").style.display =
              "flex";

            // Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (
              currentOrderData.required_materials_for_custom &&
              currentOrderData.required_materials_for_custom.length > 0
            ) {
              const matList = currentOrderData.required_materials_for_custom
                .map((req) => `${req.id}:${req.quantity}`)
                .join(", ");
              document.getElementById("material-list").value = matList;
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµØ© Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„Ù‡Ø§
            if (
              currentOrderData.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" ||
              currentOrderData.status === "ØªÙ… Ø§Ù„Ø±ÙØ¶"
            ) {
              document.getElementById("custom-price-field").style.display =
                "flex";
              document.getElementById("modal-price").value =
                currentOrderData.final_price || "";
            }
            if (currentOrderData.status === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
              document.getElementById("rejection-reason-field").style.display =
                "flex";
              document.getElementById("rejection-reason").value =
                currentOrderData.rejection_reason || "";
            }
          }

          document.getElementById("modal-order-details").innerHTML =
            detailsHTML;

          // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          const modalStatus = document.getElementById("modal-status");

          // ğŸ’¡ ØªØ­Ø¯ÙŠØ¯ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
          const availableStatusOptions =
            currentOrderData.type === "ready"
              ? statusOptions.filter((s) => s !== "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„")
              : statusOptions; // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©: ÙƒÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ±

          modalStatus.innerHTML = availableStatusOptions
            .map(
              (s) =>
                `<option value="${s}" ${
                  currentOrderData.status === s ? "selected" : ""
                }>${s}</option>`
            )
            .join("");

          openModal("order-details-modal");

          // ÙˆØ¸ÙŠÙØ© Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          document.getElementById("modal-status").onchange = (e) => {
            const newStatus = e.target.value;
            const isCustom = currentOrderData.type === "custom";

            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµØ© Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„Ù‡Ø§
            if (
              isCustom &&
              (newStatus === "Ù…Ù‚Ø¨ÙˆÙ„" || newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶")
            ) {
              document.getElementById("custom-price-field").style.display =
                "flex";
              document.getElementById("modal-price").required = true;
            } else {
              document.getElementById("custom-price-field").style.display =
                "none";
              document.getElementById("modal-price").required = false;
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
            document.getElementById("custom-materials-field").style.display =
              isCustom ? "flex" : "none";

            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶
            if (isCustom && newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
              document.getElementById("rejection-reason-field").style.display =
                "flex";
              document.getElementById("rejection-reason").required = true;
            } else {
              document.getElementById("rejection-reason-field").style.display =
                "none";
              document.getElementById("rejection-reason").required = false;
            }
          };
          // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
          document
            .getElementById("modal-status")
            .dispatchEvent(new Event("change"));
        }

        if (e.target.closest(".modal-close")) {
          e.target.closest(".modal-overlay").classList.remove("active");
        }
      });

      // Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…ÙØ­Ø³Ù†
      document
        .getElementById("save-status-btn")
        .addEventListener("click", async () => {
          const newStatus = document.getElementById("modal-status").value;
          const finalPrice =
            parseFloat(document.getElementById("modal-price").value) || null;
          const rejectionReason =
            document.getElementById("rejection-reason").value || null;
          const materialListText =
            document.getElementById("material-list").value; // ğŸ’¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…

          if (!currentOrderData) return;

          let updatePayload = { status: newStatus };

          // ğŸ’¡ ØªØ­Ø¯ÙŠØ¯ Ø´Ø±ÙˆØ· Ø§Ù„Ø®ØµÙ…: (Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©: Ù…Ù‚Ø¨ÙˆÙ„)ØŒ (Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©: Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„)
          const isReadyOrderForDeduction =
            currentOrderData.type === "ready" && newStatus === "Ù…Ù‚Ø¨ÙˆÙ„";
          const isCustomOrderForDeduction =
            currentOrderData.type === "custom" && newStatus === "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„";

          let requiredMaterialsForCustom = [];

          // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
          if (currentOrderData.type === "custom") {
            if (newStatus === "Ù…Ù‚Ø¨ÙˆÙ„") {
              // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±
              if (!finalPrice || finalPrice <= 0) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ù†Ù‡Ø§Ø¦ÙŠ ØµØ­ÙŠØ­ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ….");
                return;
              }

              // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
              if (!materialListText) {
                alert(
                  "âš ï¸ Ø¥Ù„Ø²Ø§Ù…ÙŠ: Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (ID:Quantity) Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù‚Ø¨ÙˆÙ„)."
                );
                return;
              }

              // 3. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
              const entries = materialListText
                .split(",")
                .map((e) => e.trim())
                .filter((e) => e);

              requiredMaterialsForCustom = entries
                .map((entry) => {
                  const [id, quantityStr] = entry.split(":");
                  const quantity = parseFloat(quantityStr);
                  if (id && !isNaN(quantity) && quantity > 0) {
                    return { id: id.trim(), quantity: quantity };
                  }
                  return null;
                })
                .filter((req) => req !== null);

              if (requiredMaterialsForCustom.length === 0) {
                alert(
                  "âš ï¸ Ø¥Ù„Ø²Ø§Ù…ÙŠ: Ù„Ù… ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø£ÙŠ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (ID:Quantity)."
                );
                return;
              }

              // 4. ØªØ­Ø¯ÙŠØ« Payload Ù„Ù„Ù‚Ø¨ÙˆÙ„
              updatePayload.final_price = finalPrice;
              updatePayload.required_materials_for_custom =
                requiredMaterialsForCustom;
              updatePayload.rejection_reason = null;
            } else if (newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
              if (!rejectionReason) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ù„Ù„Ø±ÙØ¶.");
                return;
              }
              updatePayload.final_price = null;
              updatePayload.rejection_reason = rejectionReason;
            } else {
              // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø³Ø¨Ø¨ ÙÙŠ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªÙ†ÙÙŠØ°/Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
              if (currentOrderData.final_price)
                updatePayload.final_price = currentOrderData.final_price;
              if (currentOrderData.rejection_reason)
                updatePayload.rejection_reason =
                  currentOrderData.rejection_reason;
            }
          }

          // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯
          if (isReadyOrderForDeduction || isCustomOrderForDeduction) {
            const productsSnap = await getDocs(collection(db, "products"));
            const products = productsSnap.docs.map((d) => ({
              id: parseInt(d.id),
              ...d.data(),
            }));
            const batch = writeBatch(db);
            const logCollection = collection(db, "raw_materials_log");
            let insufficient = [];

            let itemsToDeduct = [];

            if (currentOrderData.type === "ready") {
              itemsToDeduct = currentOrderData.items;
            } else if (currentOrderData.type === "custom") {
              // Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
              const materialsForDeduction =
                currentOrderData.required_materials_for_custom || [];

              // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…ÙˆØ§Ø¯ Ù…Ø®Ø²Ù†Ø©ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø© Ù„Ù„ØªÙˆ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¨ÙˆÙ„
              if (materialsForDeduction.length === 0 && newStatus === "Ù…Ù‚Ø¨ÙˆÙ„") {
                materialsForDeduction = requiredMaterialsForCustom;
              }

              if (materialsForDeduction.length === 0) {
                alert(
                  "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø®ØµÙ…: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… Ù…Ø­Ø¯Ø¯Ø© Ù„Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ."
                );
                return;
              }

              itemsToDeduct.push({
                id: currentOrderData.id,
                quantity: 1,
                required_materials: materialsForDeduction,
              });
            }

            for (const item of itemsToDeduct) {
              const itemID = item.id;
              const itemQuantity = item.quantity;

              let requiredMaterialsList = [];

              if (currentOrderData.type === "ready") {
                const product = products.find(
                  (p) => p.id === itemID || p.id === parseInt(itemID)
                );
                if (!product || !product.required_materials) continue;
                requiredMaterialsList = product.required_materials;
              } else if (currentOrderData.type === "custom") {
                requiredMaterialsList = item.required_materials;
              }

              for (const req of requiredMaterialsList) {
                const mat = rawMaterialsMap.get(req.id);
                const need = req.quantity * itemQuantity;

                if (!mat || mat.current_stock < need) {
                  insufficient.push(
                    `${mat ? mat.name_ar : "Ù…Ø§Ø¯Ø©"} (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${need.toFixed(
                      2
                    )}ØŒ Ø§Ù„Ù…ØªØ§Ø­: ${mat ? mat.current_stock.toFixed(2) : 0})`
                  );
                } else {
                  const ref = doc(db, "raw_materials", req.id);
                  const newStock = mat.current_stock - need;

                  const consumedValue = need * mat.cost_per_unit;
                  const newCost = mat.total_cost_value - consumedValue;

                  batch.update(ref, {
                    current_stock: newStock,
                    total_cost_value: newCost > 0 ? newCost : 0,
                  });

                  // Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
                  batch.set(doc(logCollection), {
                    material_id: req.id,
                    material_name: mat.name_ar,
                    change_quantity: -need,
                    change_value: -consumedValue,
                    operation_type: "consumption",
                    order_id: currentOrderId,
                    date: new Date().toISOString(),
                  });

                  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø®ØµÙ… ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¯ÙˆØ±Ø©
                  mat.current_stock = newStock;
                  mat.total_cost_value = newCost;
                }
              }
            }

            if (insufficient.length) {
              alert(
                "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø¨Ø³Ø¨Ø¨ Ù†Ù‚Øµ Ø§Ù„Ù…ÙˆØ§Ø¯:\n" + insufficient.join("\n")
              );
              return;
            }

            const orderRef = doc(db, currentOrderCollection, currentOrderId);
            batch.update(orderRef, updatePayload);

            try {
              await batch.commit();
              alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.");
              closeModal("order-details-modal");
              fetchOrders();
            } catch (e) {
              console.error("Error committing batch:", e);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.");
            }
          } else {
            // ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ· Ù„Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…)
            const orderRef = doc(db, currentOrderCollection, currentOrderId);
            try {
              await updateDoc(orderRef, updatePayload);
              alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
              closeModal("order-details-modal");
              fetchOrders();
            } catch (e) {
              console.error(e);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.");
            }
          }
        });
    </script>
  </body>
</html>
