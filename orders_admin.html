<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
      .status-badge {
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        display: inline-block;
        white-space: nowrap;
        font-size: 0.85rem;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© {
        background-color: #ffeb3b;
        color: #795548;
      }
      .status-badge.Ù…Ù‚Ø¨ÙˆÙ„ {
        background-color: #5bc0de;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„ØªØµÙ†ÙŠØ¹ {
        background-color: #34495e;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ø·Ù„Ø§Ø¡ {
        background-color: #f39c12;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„ØªØºÙ„ÙŠÙ {
        background-color: #c0392b;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ø´Ø­Ù† {
        background-color: #3498db;
        color: white;
      }
      .status-badge.Ù…ÙƒØªÙ…Ù„ {
        background-color: #4caf50;
        color: white;
      }
      .status-badge.ØªÙ…-Ø§Ù„Ø±ÙØ¶ {
        background-color: #e74c3c;
        color: white;
      }
      .status-badge.Ù…Ø¤Ø±Ø´Ù {
        background-color: #95a5a6;
        color: white;
      }
      .status-badge.Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„ {
        background-color: #27ae60;
        color: white;
      }
      .status-badge.Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„ {
        background-color: #c0392b;
        color: white;
      }

      .orders-section.admin-panel {
        margin-top: 25px;
      }
      .orders-section .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 10px;
      }

      .modal-form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      textarea,
      input,
      select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #e6e9ee;
        font-family: "Cairo", sans-serif;
      }
      .orders-table th,
      .orders-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f5f9;
        text-align: right;
        font-size: 0.95rem;
      }

      .order-details-group p {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }
      .order-details-group p strong {
        font-weight: 700;
        color: var(--primary-color);
        margin-left: 5px;
      }
      .order-items-list {
        list-style-type: none;
        padding-right: 0;
        margin-top: 10px;
      }
      .order-items-list li {
        padding: 8px 0;
        font-size: 0.95rem;
        border-bottom: 1px dotted #f0f0f0;
        display: flex;
        justify-content: space-between;
      }

      .actions-buttons .btn-icon {
        background: none;
        border: none;
        color: var(--dark-color);
        padding: 5px 8px;
        cursor: pointer;
        font-size: 1.1rem;
        margin-left: 5px;
        transition: color 0.2s;
      }
      .actions-buttons .btn-icon.btn-manage {
        color: var(--info-color, #5d9cec);
      }
      .actions-buttons .btn-icon.btn-delete {
        color: var(--danger-color, #e74c3c);
      }

      #bulk-actions-container {
        display: none;
        align-items: center;
        gap: 10px;
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
        background-color: var(--light-color);
        border-radius: 8px;
      }
      #bulk-actions-container.show {
        display: flex;
      }
      #bulk-actions-container select {
        width: 200px;
        padding: 8px;
        border: 1px solid var(--primary-color);
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
      #custom-materials-field {
        background-color: #f7f7f7;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid #eee;
      }
      #custom-materials-table {
        width: 100%;
        margin-bottom: 10px;
        background: #fff;
      }
      #custom-materials-table th {
        background: #eee;
        padding: 8px;
      }
      #custom-materials-table td {
        padding: 8px;
        border-bottom: 1px solid #f0f0f0;
      }

      #manufacturing-hours-field {
        background-color: #f0f8ff;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px dashed var(--info-color);
      }
      #manufacturing-hours-field label {
        color: var(--info-color);
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html" class="active"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html"
              ><i class="fa-solid fa-truck-fast"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="strategy_admin.html"
              ><i class="fa-solid fa-lightbulb"></i> Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
      <div class="orders-section admin-panel">
        <div class="section-header">
          <div class="filters-container" id="filters-container">
            <button class="filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" data-filter="pending">
              Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            </button>
            <button class="filter-btn" data-filter="in-progress">
              Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            </button>
            <button class="filter-btn" data-filter="ready">Ø¬Ø§Ù‡Ø²Ø©</button>
            <button class="filter-btn" data-filter="custom">Ù…Ø®ØµØµØ©</button>
            <button class="filter-btn" data-filter="completed">Ù…ÙƒØªÙ…Ù„Ø©</button>
            <button class="filter-btn" data-filter="archived">Ù…Ø¤Ø±Ø´ÙØ©</button>
          </div>
        </div>

        <div id="bulk-actions-container">
          <label for="bulk-status-select" style="font-weight: 600"
            >ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</label
          >
          <select id="bulk-status-select"></select>
          <button class="btn btn-sm" id="apply-bulk-status">
            <i class="fa-solid fa-check"></i> ØªØ·Ø¨ÙŠÙ‚
          </button>
        </div>

        <div id="orders-table-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
      </div>
    </div>

    <div id="order-details-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>

        <div id="modal-order-details"></div>
        <hr style="margin: 20px 0; border-color: #f0f0f0" />

        <h3><i class="fa-solid fa-list-ul"></i> Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3>

        <div class="modal-form-grid">
          <div class="form-group">
            <label for="modal-status">ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
            <select id="modal-status"></select>
          </div>
        </div>

        <div
          id="manufacturing-hours-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="modal-manufacturing-hours"
            ><i class="fa-solid fa-hourglass-half"></i> Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹
            Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©</label
          >
          <input
            type="number"
            id="modal-manufacturing-hours"
            min="1"
            step="1"
          />
        </div>

        <div id="custom-materials-field" style="display: none">
          <label style="font-weight: bold; margin-bottom: 10px; display: block">
            <i class="fa-solid fa-cubes"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„ØªØµÙ†ÙŠØ¹:
          </label>
          <p style="font-size: 0.85rem; color: #777; margin-bottom: 10px">
            * Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙ‡Ø§ Ø¹Ù†Ø¯ ØªØµÙ†ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ.
          </p>

          <table id="custom-materials-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="custom-materials-tbody"></tbody>
          </table>

          <div
            class="modal-form-grid"
            style="
              grid-template-columns: 2fr 1fr auto;
              align-items: end;
              margin-top: 10px;
            "
          >
            <div class="form-group">
              <label for="custom-material-select">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
              <select id="custom-material-select"></select>
            </div>
            <div class="form-group">
              <label for="custom-material-qty">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input
                type="number"
                id="custom-material-qty"
                value="1"
                min="0.01"
                step="0.01"
              />
            </div>
            <button
              type="button"
              class="btn btn-secondary"
              id="add-custom-material-btn"
            >
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>
        </div>

        <div
          id="custom-price-field"
          class="form-group"
          style="display: none; flex-direction: column; margin-top: 15px"
        >
          <label for="modal-price">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø´ÙŠÙƒÙ„)</label>
          <input type="number" id="modal-price" min="0" step="0.01" />
        </div>

        <div
          id="rejection-reason-field"
          class="form-group"
          style="display: none; flex-direction: column; margin-top: 15px"
        >
          <label for="rejection-reason">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</label>
          <textarea id="rejection-reason" rows="3"></textarea>
        </div>

        <button id="save-status-btn" class="btn">
          <i class="fa-solid fa-save"></i> Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        </button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        orderBy,
        query,
        doc,
        updateDoc,
        writeBatch,
        getDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let allOrders = [];
      let currentOrderId = null;
      let currentOrderCollection = null;
      let currentOrderData = null;

      // ğŸ’¡ Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ Ø§Ù„Ø­Ø§Ù„ÙŠ
      let currentCustomOrderMaterials = [];

      let rawMaterialsMap = new Map();
      const statusOptions = [
        "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
        "Ù…Ù‚Ø¨ÙˆÙ„",
        "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
        "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
        "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
        "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
        "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
        "Ù…ÙƒØªÙ…Ù„",
        "ØªÙ… Ø§Ù„Ø±ÙØ¶",
        "Ù…Ø¤Ø±Ø´Ù",
      ];

      const WORK_HOURS_PER_DAY = 8;
      const DEFAULT_HOURS_READY_PRODUCT = 5;
      const DEFAULT_HOURS_CUSTOM_PRODUCT = 20;
      const PROCESSING_BUFFER_DAYS = 2;

      let allProducts = [];

      function getHoursForOrder(order, allProducts) {
        if (
          order.manufacturing_time_override &&
          order.manufacturing_time_override > 0
        ) {
          return parseFloat(order.manufacturing_time_override);
        }
        let totalHours = 0;
        try {
          if (order.type === "ready" && order.items) {
            order.items.forEach((item) => {
              const product = allProducts.find(
                (p) => p.id == item.id || p.id == parseInt(item.id)
              );
              const itemQuantity = item.quantity || 1;
              if (product && product.manufacturing_time_hours > 0) {
                totalHours += product.manufacturing_time_hours * itemQuantity;
              } else {
                totalHours += DEFAULT_HOURS_READY_PRODUCT * itemQuantity;
              }
            });
          } else if (order.type === "custom") {
            totalHours = DEFAULT_HOURS_CUSTOM_PRODUCT;
          }
        } catch (e) {
          totalHours = DEFAULT_HOURS_READY_PRODUCT;
        }
        return totalHours > 0 ? totalHours : DEFAULT_HOURS_READY_PRODUCT;
      }

      function calculateEstimatedCompletionDays(
        targetOrder,
        allOrders,
        allProducts
      ) {
        if (!targetOrder) return { minDays: "---", maxDays: "---" };

        const targetOrderHours = getHoursForOrder(targetOrder, allProducts);
        const IN_QUEUE_STATUSES = [
          "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
        ];
        const PENDING_STATUSES = ["Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", "Ù…Ù‚Ø¨ÙˆÙ„"];

        let acceptedQueueHours = 0;
        let pendingQueueHours = 0;

        allOrders.forEach((order) => {
          if (order.id === targetOrder.id) return;
          const orderHours = getHoursForOrder(order, allProducts);
          if (orderHours === 0) return;

          if (IN_QUEUE_STATUSES.includes(order.status)) {
            acceptedQueueHours += orderHours;
          }
          if (PENDING_STATUSES.includes(order.status)) {
            const orderDate = new Date(order.order_date);
            const targetOrderDate = new Date(targetOrder.order_date);
            if (orderDate < targetOrderDate) {
              pendingQueueHours += orderHours;
            }
          }
        });

        const targetOrderDays = Math.ceil(
          targetOrderHours / WORK_HOURS_PER_DAY
        );
        const acceptedQueueDays = Math.ceil(
          acceptedQueueHours / WORK_HOURS_PER_DAY
        );
        const pendingQueueDays = Math.ceil(
          pendingQueueHours / WORK_HOURS_PER_DAY
        );

        let minTotalDays, maxTotalDays;
        if (IN_QUEUE_STATUSES.includes(targetOrder.status)) {
          const totalQueueHours = acceptedQueueHours + targetOrderHours;
          minTotalDays =
            Math.ceil(totalQueueHours / WORK_HOURS_PER_DAY) +
            PROCESSING_BUFFER_DAYS;
          maxTotalDays = minTotalDays;
        } else {
          minTotalDays =
            acceptedQueueDays + targetOrderDays + PROCESSING_BUFFER_DAYS;
          maxTotalDays =
            acceptedQueueDays +
            pendingQueueDays +
            targetOrderDays +
            PROCESSING_BUFFER_DAYS;
        }
        return {
          minDays: Math.ceil(minTotalDays),
          maxDays: Math.ceil(maxTotalDays),
        };
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape")
          document
            .querySelectorAll(".modal-overlay.active")
            .forEach((m) => closeModal(m.id));
      });

      async function fetchProductsAndMaterials() {
        const [materialsSnap, productsSnap] = await Promise.all([
          getDocs(collection(db, "raw_materials")),
          getDocs(collection(db, "products")),
        ]);

        rawMaterialsMap = new Map(
          materialsSnap.docs.map((d) => [
            d.id,
            {
              id: d.id,
              ...d.data(),
              current_stock: parseFloat(d.data().current_stock || 0),
              cost_per_unit: parseFloat(d.data().cost_per_unit || 0),
              name_ar: d.data().name_ar || d.id,
              unit: d.data().unit || "ÙˆØ­Ø¯Ø©",
            },
          ])
        );

        allProducts = productsSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          manufacturing_time_hours: parseFloat(
            d.data().manufacturing_time_hours || 0
          ),
        }));
      }

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchProductsAndMaterials();
            fetchOrders();
            setupBulkActions();
            fillCustomMaterialSelect(); // ğŸ’¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ù…ÙˆØ§Ø¯
          } else {
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "login.html";
        });

      // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      function fillCustomMaterialSelect() {
        const select = document.getElementById("custom-material-select");
        select.innerHTML =
          '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© --</option>';
        rawMaterialsMap.forEach((mat) => {
          const option = document.createElement("option");
          option.value = mat.id;
          option.textContent = `${mat.name_ar} (${mat.unit})`;
          select.appendChild(option);
        });
      }

      // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ©
      function renderCustomMaterialsTable() {
        const tbody = document.getElementById("custom-materials-tbody");
        tbody.innerHTML = "";
        if (currentCustomOrderMaterials.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='3' style='text-align:center; color:#999;'>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ø¨Ø¹Ø¯</td></tr>";
          return;
        }
        currentCustomOrderMaterials.forEach((item, index) => {
          const matName =
            rawMaterialsMap.get(item.id)?.name_ar || "Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
          const matUnit = rawMaterialsMap.get(item.id)?.unit || "";
          const row = document.createElement("tr");
          row.innerHTML = `
                <td>${matName}</td>
                <td>${item.quantity} ${matUnit}</td>
                <td><button class="btn-icon btn-delete remove-custom-mat-btn" data-index="${index}"><i class="fa-solid fa-trash"></i></button></td>
            `;
          tbody.appendChild(row);
        });

        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø°Ù
        document.querySelectorAll(".remove-custom-mat-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const idx = e.currentTarget.dataset.index;
            currentCustomOrderMaterials.splice(idx, 1);
            renderCustomMaterialsTable();
          });
        });
      }

      // ğŸ’¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
      document
        .getElementById("add-custom-material-btn")
        .addEventListener("click", () => {
          const select = document.getElementById("custom-material-select");
          const qtyInput = document.getElementById("custom-material-qty");
          const matId = select.value;
          const qty = parseFloat(qtyInput.value);

          if (!matId || isNaN(qty) || qty <= 0) {
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©.");
            return;
          }

          const existing = currentCustomOrderMaterials.find(
            (m) => m.id === matId
          );
          if (existing) {
            existing.quantity += qty;
          } else {
            currentCustomOrderMaterials.push({ id: matId, quantity: qty });
          }

          renderCustomMaterialsTable();
          qtyInput.value = 1;
          select.value = "";
        });

      async function attemptStockDeduction(
        orderData,
        requiredMaterialsForCustom,
        newStatus,
        batch,
        logCollection
      ) {
        let itemsToDeduct = [];
        if (orderData.type === "ready") {
          itemsToDeduct = orderData.items;
        } else if (orderData.type === "custom") {
          const materialsList =
            requiredMaterialsForCustom.length > 0
              ? requiredMaterialsForCustom
              : orderData.required_materials_for_custom || [];
          if (materialsList.length === 0) {
            alert("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… Ù„Ù„Ø®ØµÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ.");
            return true;
          }
          itemsToDeduct.push({
            id: orderData.id,
            quantity: 1,
            required_materials: materialsList,
          });
        }

        let insufficient = [];
        for (const item of itemsToDeduct) {
          const itemID = item.id;
          const itemQuantity = item.quantity;
          let requiredMaterialsList = [];

          if (orderData.type === "ready") {
            const product = allProducts.find(
              (p) => p.id == itemID || p.id == parseInt(itemID)
            );
            if (!product || !product.required_materials) continue;
            requiredMaterialsList = product.required_materials;
          } else if (orderData.type === "custom") {
            requiredMaterialsList = item.required_materials;
          }

          for (const req of requiredMaterialsList) {
            const mat = rawMaterialsMap.get(req.id);
            const need = req.quantity * itemQuantity;

            if (!mat || mat.current_stock < need) {
              insufficient.push(
                `${mat ? mat.name_ar : "Ù…Ø¬Ù‡ÙˆÙ„"} (Ù…Ø·Ù„ÙˆØ¨: ${need}, Ù…ØªØ§Ø­: ${
                  mat ? mat.current_stock : 0
                })`
              );
            } else {
              const ref = doc(db, "raw_materials", req.id);
              const newStock = mat.current_stock - need;
              const consumedValue = need * mat.cost_per_unit;
              const newCost = mat.total_cost_value - consumedValue;

              batch.update(ref, {
                current_stock: newStock,
                total_cost_value: newCost > 0 ? newCost : 0,
              });
              batch.set(doc(logCollection), {
                material_id: req.id,
                material_name: mat.name_ar,
                change_quantity: -need,
                change_value: -consumedValue,
                operation_type: "consumption",
                order_id: orderData.id,
                date: new Date().toISOString(),
              });

              mat.current_stock = newStock; // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
            }
          }
        }

        if (insufficient.length) {
          alert("âš ï¸ ØªØ­Ø°ÙŠØ± Ù†Ù‚Øµ Ù…Ø®Ø²ÙˆÙ†:\n" + insufficient.join("\n"));
        }
        return true;
      }

      async function fetchOrders() {
        const readySnap = await getDocs(collection(db, "orders"));
        const customSnap = await getDocs(collection(db, "custom_designs"));
        const readyOrders = readySnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "ready",
        }));
        const customOrders = customSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "custom",
        }));
        allOrders = [...readyOrders, ...customOrders].sort(
          (a, b) => new Date(b.order_date) - new Date(a.order_date)
        );
        const activeFilter =
          document.querySelector(".filter-btn.active")?.dataset.filter || "all";
        applyFilter(activeFilter);
      }

      function applyFilter(filter) {
        let filteredOrders = allOrders;
        if (filter === "ready")
          filteredOrders = allOrders.filter((o) => o.type === "ready");
        else if (filter === "custom")
          filteredOrders = allOrders.filter((o) => o.type === "custom");
        else if (filter === "pending")
          filteredOrders = allOrders.filter(
            (o) => o.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" || o.status === "Ù…Ù‚Ø¨ÙˆÙ„"
          );
        else if (filter === "in-progress")
          filteredOrders = allOrders.filter((o) =>
            [
              "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
              "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
              "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
              "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
              "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
            ].includes(o.status)
          );
        else if (filter === "completed")
          filteredOrders = allOrders.filter((o) => o.status === "Ù…ÙƒØªÙ…Ù„");
        else if (filter === "archived")
          filteredOrders = allOrders.filter((o) =>
            ["Ù…Ø¤Ø±Ø´Ù", "ØªÙ… Ø§Ù„Ø±ÙØ¶", "Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„"].includes(o.status)
          );
        renderTable(filteredOrders);
      }

      document.querySelectorAll(".filter-btn").forEach((button) => {
        button.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          applyFilter(button.dataset.filter);
        });
      });

      function renderTable(orders) {
        const container = document.getElementById("orders-table-container");
        if (!orders.length) {
          container.innerHTML = "<p class='loading-msg'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>";
          document
            .getElementById("bulk-actions-container")
            .classList.remove("show");
          return;
        }
        let html = `<table class="orders-table"><thead><tr>
        <th><input type="checkbox" id="select-all-orders"></th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>`;

        orders.forEach((o) => {
          const statusClass = o.status.replace(/\s+/g, "-");
          const typeText = o.type === "ready" ? "Ø¬Ø§Ù‡Ø²" : "Ù…Ø®ØµØµ";
          const productDisplay =
            o.type === "ready"
              ? `${o.items[0]?.name}`
              : o.type_of_product || "Ù…Ø®ØµØµ";
          const total =
            o.type === "ready"
              ? (o.total || 0).toFixed(0)
              : o.final_price
              ? o.final_price.toFixed(0)
              : "---";
          const estimatedTime = calculateEstimatedCompletionDays(
            o,
            allOrders,
            allProducts
          );
          const timeDisplay =
            o.status === "Ù…ÙƒØªÙ…Ù„" || o.status === "ØªÙ… Ø§Ù„Ø±ÙØ¶"
              ? "---"
              : `${estimatedTime.minDays} - ${estimatedTime.maxDays} ÙŠÙˆÙ…`;

          html += `<tr data-id="${o.id}" data-collection="${
            o.type === "ready" ? "orders" : "custom_designs"
          }">
          <td><input type="checkbox" class="order-select-checkbox" data-id="${
            o.id
          }"></td>
          <td>${
            o.name || "---"
          }</td><td>${productDisplay}</td><td>${typeText}</td>
          <td>${new Date(o.order_date).toLocaleDateString(
            "ar-EG"
          )}</td><td>${total} â‚ª</td>
          <td><span class="status-badge ${statusClass}">${o.status}</span></td>
          <td style="color: var(--info-color); font-weight: bold;">${timeDisplay}</td>
          <td class="actions-buttons"><button class="btn-icon btn-manage edit-btn"><i class="fa-solid fa-tools"></i></button><button class="btn-icon btn-delete delete-btn"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;

        document
          .getElementById("select-all-orders")
          .addEventListener("change", toggleAllCheckboxes);
        document.querySelectorAll(".order-select-checkbox").forEach((cb) => {
          cb.addEventListener("change", updateBulkActionsVisibility);
        });
      }

      function setupBulkActions() {
        const bulkStatusSelect = document.getElementById("bulk-status-select");
        bulkStatusSelect.innerHTML = statusOptions
          .map((s) => `<option value="${s}">${s}</option>`)
          .join("");
        document
          .getElementById("apply-bulk-status")
          .addEventListener("click", handleBulkStatusUpdate);
      }

      function toggleAllCheckboxes(e) {
        document
          .querySelectorAll(".order-select-checkbox")
          .forEach((cb) => (cb.checked = e.target.checked));
        updateBulkActionsVisibility();
      }

      function updateBulkActionsVisibility() {
        const checkedCount = document.querySelectorAll(
          ".order-select-checkbox:checked"
        ).length;
        document
          .getElementById("bulk-actions-container")
          .classList.toggle("show", checkedCount > 0);
      }

      async function handleBulkStatusUpdate() {
        const selectedStatus =
          document.getElementById("bulk-status-select").value;
        const selectedOrders = Array.from(
          document.querySelectorAll(".order-select-checkbox:checked")
        ).map((cb) => allOrders.find((o) => o.id === cb.dataset.id));
        if (selectedOrders.length === 0) return alert("Ø§Ø®ØªØ± Ø·Ù„Ø¨Ø§Øª.");
        if (["Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹", "Ù…Ù‚Ø¨ÙˆÙ„", "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„"].includes(selectedStatus))
          return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø§Øª ØªØªØ·Ù„Ø¨ Ø®ØµÙ… Ø£Ùˆ ØªØ³Ø¹ÙŠØ± Ø¬Ù…Ø§Ø¹ÙŠØ§Ù‹.");
        if (
          !confirm(
            `ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ${selectedOrders.length} Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${selectedStatus}ØŸ`
          )
        )
          return;

        const batch = writeBatch(db);
        selectedOrders.forEach((order) => {
          const col = order.type === "ready" ? "orders" : "custom_designs";
          batch.update(doc(db, col, order.id), { status: selectedStatus });
        });
        await batch.commit();
        alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
        fetchOrders();
      }

      document.addEventListener("click", (e) => {
        if (e.target.closest(".edit-btn")) {
          const tr = e.target.closest("tr");
          currentOrderId = tr.dataset.id;
          currentOrderCollection = tr.dataset.collection;
          currentOrderData = allOrders.find((o) => o.id === currentOrderId);
          if (currentOrderData) openOrderDetailsModal();
        } else if (e.target.closest(".delete-btn")) {
          const tr = e.target.closest("tr");
          if (confirm("Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ"))
            deleteDoc(doc(db, tr.dataset.collection, tr.dataset.id)).then(() =>
              fetchOrders()
            );
        }
      });

      function openOrderDetailsModal() {
        const isCustom = currentOrderData.type === "custom";
        const isReady = currentOrderData.type === "ready";
        const currentStatus = currentOrderData.status;

        document.getElementById("modal-price").value = "";
        document.getElementById("rejection-reason").value = "";
        document.getElementById("custom-price-field").style.display = "none";
        document.getElementById("rejection-reason-field").style.display =
          "none";
        document.getElementById("custom-materials-field").style.display =
          "none";
        document.getElementById("manufacturing-hours-field").style.display =
          "none";

        // ğŸ’¡ ØªÙØ±ÙŠØº Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        currentCustomOrderMaterials = [];

        let detailsHTML = `
              <div class="order-details-group">
                  <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${currentOrderData.name}</p>
                  <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${currentOrderData.phone}</p>
                  <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${currentOrderData.address}</p>
                  <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${currentOrderData.id}</p>
                  <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(
                    currentOrderData.order_date
                  ).toLocaleDateString("ar-EG")}</p>
                  <p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${
                    currentOrderData.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"
                  }</p>
                  <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-badge ${currentStatus.replace(
                    /\s+/g,
                    "-"
                  )}">${currentStatus}</span></p>
              </div>
          `;

        if (isReady) {
          const total = (currentOrderData.total || 0).toFixed(0);
          detailsHTML += `<h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</h3><ul class="order-items-list">${currentOrderData.items
            .map(
              (item) =>
                `<li><span>${item.name} (${
                  item.quantity
                })</span><span>${parseFloat(item.price).toFixed(
                  0
                )} â‚ª</span></li>`
            )
            .join(
              ""
            )}</ul><p style="margin-top:15px;font-weight:bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} â‚ª</p>`;
        } else if (isCustom) {
          const priceDisplay = currentOrderData.final_price
            ? currentOrderData.final_price.toFixed(0)
            : currentOrderData.initial_price || "---";
          detailsHTML += `<h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµÙ…ÙŠÙ…:</h3><p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${currentOrderData.type_of_product}</p><p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${currentOrderData.title}</p><p><strong>Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯:</strong> ${currentOrderData.dimensions}</p><p style="margin-top:15px;"><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${priceDisplay} â‚ª</p>`;

          // ğŸ’¡ Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ
          document.getElementById("custom-materials-field").style.display =
            "block";

          // ğŸ’¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¥Ù† ÙˆØ¬Ø¯Øª
          if (
            currentOrderData.required_materials_for_custom &&
            currentOrderData.required_materials_for_custom.length > 0
          ) {
            currentCustomOrderMaterials =
              currentOrderData.required_materials_for_custom.map((req) => ({
                id: req.id,
                quantity: req.quantity,
              }));
          }
          renderCustomMaterialsTable();

          if (["Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", "ØªÙ… Ø§Ù„Ø±ÙØ¶", "Ù…Ù‚Ø¨ÙˆÙ„"].includes(currentStatus)) {
            document.getElementById("custom-price-field").style.display =
              "flex";
            document.getElementById("modal-price").value =
              currentOrderData.final_price || "";
          }
          if (currentStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
            document.getElementById("rejection-reason-field").style.display =
              "flex";
            document.getElementById("rejection-reason").value =
              currentOrderData.rejection_reason || "";
          }
        }

        const mHoursField = document.getElementById(
          "manufacturing-hours-field"
        );
        const mHoursInput = document.getElementById(
          "modal-manufacturing-hours"
        );
        mHoursInput.value =
          currentOrderData.manufacturing_time_override ||
          getHoursForOrder(currentOrderData, allProducts);
        mHoursField.style.display = "flex";

        document.getElementById("modal-order-details").innerHTML = detailsHTML;

        let availableStatusOptions = [];
        const productionWorkflow = [
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
          "Ù…ÙƒØªÙ…Ù„",
          "Ù…Ø¤Ø±Ø´Ù",
        ];

        if (isReady) {
          if (currentStatus === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©")
            availableStatusOptions = [
              "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
              "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
              "ØªÙ… Ø§Ù„Ø±ÙØ¶",
            ];
          else if (productionWorkflow.includes(currentStatus))
            availableStatusOptions = productionWorkflow.filter(
              (s) =>
                productionWorkflow.indexOf(s) >=
                productionWorkflow.indexOf(currentStatus)
            );
          else if (["ØªÙ… Ø§Ù„Ø±ÙØ¶", "Ù…Ø¤Ø±Ø´Ù"].includes(currentStatus))
            availableStatusOptions = [currentStatus, "Ù…Ø¤Ø±Ø´Ù", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];
        } else if (isCustom) {
          if (currentStatus === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©")
            availableStatusOptions = ["Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", "Ù…Ù‚Ø¨ÙˆÙ„", "ØªÙ… Ø§Ù„Ø±ÙØ¶"];
          else if (currentStatus === "Ù…Ù‚Ø¨ÙˆÙ„")
            availableStatusOptions = ["Ù…Ù‚Ø¨ÙˆÙ„", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];
          else if (currentStatus === "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„")
            availableStatusOptions = ["Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„", "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹"];
          else if (productionWorkflow.includes(currentStatus))
            availableStatusOptions = productionWorkflow.filter(
              (s) =>
                productionWorkflow.indexOf(s) >=
                productionWorkflow.indexOf(currentStatus)
            );
          else if (
            ["ØªÙ… Ø§Ù„Ø±ÙØ¶", "Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„", "Ù…Ø¤Ø±Ø´Ù"].includes(currentStatus)
          )
            availableStatusOptions = [currentStatus, "Ù…Ø¤Ø±Ø´Ù", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];
        }

        const modalStatus = document.getElementById("modal-status");
        modalStatus.innerHTML = [...new Set(availableStatusOptions)]
          .map(
            (s) =>
              `<option value="${s}" ${
                currentStatus === s ? "selected" : ""
              }>${s}</option>`
          )
          .join("");

        openModal("order-details-modal");

        document.getElementById("modal-status").onchange = (e) => {
          const newStatus = e.target.value;
          if (isCustom) {
            document.getElementById("custom-price-field").style.display =
              newStatus === "Ù…Ù‚Ø¨ÙˆÙ„" ? "flex" : "none";
            document.getElementById("rejection-reason-field").style.display =
              newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶" ? "flex" : "none";
          }
        };
      }

      document
        .getElementById("save-status-btn")
        .addEventListener("click", async () => {
          const newStatus = document.getElementById("modal-status").value;
          const finalPrice =
            parseFloat(document.getElementById("modal-price").value) || null;
          const rejectionReason =
            document.getElementById("rejection-reason").value || null;
          const manufacturingHoursOverride =
            parseFloat(
              document.getElementById("modal-manufacturing-hours").value
            ) || null;

          if (!currentOrderData) return;
          const currentStatus = currentOrderData.status;
          const isCustom = currentOrderData.type === "custom";
          let updatePayload = { status: newStatus };
          let requiredMaterialsForCustom = [];

          if (manufacturingHoursOverride)
            updatePayload.manufacturing_time_override =
              manufacturingHoursOverride;

          if (isCustom) {
            // ğŸ’¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            requiredMaterialsForCustom = currentCustomOrderMaterials;

            if (newStatus === "Ù…Ù‚Ø¨ÙˆÙ„") {
              if (!finalPrice || finalPrice <= 0) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±.");
              if (requiredMaterialsForCustom.length === 0)
                return alert("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„.");

              updatePayload.final_price = finalPrice;
              updatePayload.required_materials_for_custom =
                requiredMaterialsForCustom;
              updatePayload.rejection_reason = null;
            } else if (newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
              if (!rejectionReason) return alert("Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶.");
              updatePayload.final_price = null;
              updatePayload.rejection_reason = rejectionReason;
            } else {
              // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù‚Ø¨ÙˆÙ„
              if (currentCustomOrderMaterials.length > 0) {
                updatePayload.required_materials_for_custom =
                  currentCustomOrderMaterials;
              }
            }
          }

          const inProductionStatuses = [
            "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
            "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
            "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
            "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
          ];
          const isMovingToProduction =
            newStatus === "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹" &&
            !inProductionStatuses.includes(currentStatus);

          if (isMovingToProduction) {
            const batch = writeBatch(db);
            const logCollection = collection(db, "raw_materials_log");
            const materialsToDeduct = isCustom
              ? requiredMaterialsForCustom
              : currentOrderData.required_materials_for_custom || [];
            await attemptStockDeduction(
              currentOrderData,
              materialsToDeduct,
              newStatus,
              batch,
              logCollection
            );
            batch.update(
              doc(db, currentOrderCollection, currentOrderId),
              updatePayload
            );
            await batch.commit();
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø®ØµÙ….");
          } else {
            await updateDoc(
              doc(db, currentOrderCollection, currentOrderId),
              updatePayload
            );
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
          }
          closeModal("order-details-modal");
          fetchOrders();
        });
    </script>
  </body>
</html>
