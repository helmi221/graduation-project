<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ù‡Ù…Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶Ù‡Ø§) */
      .status-badge {
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        display: inline-block;
        white-space: nowrap;
        font-size: 0.85rem;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© {
        background-color: #ffeb3b;
        color: #795548;
      }
      .status-badge.Ù…Ù‚Ø¨ÙˆÙ„ {
        background-color: #5bc0de;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„ØªØµÙ†ÙŠØ¹ {
        background-color: #34495e;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ø·Ù„Ø§Ø¡ {
        background-color: #f39c12;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„ØªØºÙ„ÙŠÙ {
        background-color: #c0392b;
        color: white;
      }
      .status-badge.Ù‚ÙŠØ¯-Ø§Ù„Ø´Ø­Ù† {
        background-color: #3498db;
        color: white;
      }
      .status-badge.Ù…ÙƒØªÙ…Ù„ {
        background-color: #4caf50;
        color: white;
      }
      .status-badge.ØªÙ…-Ø§Ù„Ø±ÙØ¶ {
        background-color: #e74c3c;
        color: white;
      }
      .status-badge.Ù…Ø¤Ø±Ø´Ù {
        background-color: #95a5a6;
        color: white;
      }
      .status-badge.Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„ {
        background-color: #27ae60;
        color: white;
      }
      .status-badge.Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„ {
        background-color: #c0392b;
        color: white;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
      .orders-section.admin-panel {
        margin-top: 25px;
      }
      .orders-section .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        /* ğŸ’¡ ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© */
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 10px;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
      .modal-form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      textarea,
      input,
      select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #e6e9ee;
        font-family: "Cairo", sans-serif;
      }
      .orders-table th,
      .orders-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f5f9;
        text-align: right;
        font-size: 0.95rem;
      }

      /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…ÙØ­Ø³Ù† */
      .order-details-group p {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }
      .order-details-group p strong {
        font-weight: 700;
        color: var(--primary-color);
        margin-left: 5px;
      }
      .order-items-list {
        list-style-type: none;
        padding-right: 0;
        margin-top: 10px;
      }
      .order-items-list li {
        padding: 8px 0;
        font-size: 0.95rem;
        border-bottom: 1px dotted #f0f0f0;
        display: flex;
        justify-content: space-between;
      }

      /* ğŸ’¡ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙØ­Ø³Ù†Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
      .actions-buttons .btn-icon {
        background: none;
        border: none;
        color: var(--dark-color);
        padding: 5px 8px;
        cursor: pointer;
        font-size: 1.1rem;
        margin-left: 5px;
        transition: color 0.2s;
      }
      /* Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ØªØºÙŠÙŠØ±/Ø¹Ø±Ø¶) */
      .actions-buttons .btn-icon.btn-manage {
        color: var(--info-color, #5d9cec);
      }
      .actions-buttons .btn-icon.btn-manage:hover {
        color: var(--dark-color);
      }
      /* Ø²Ø± Ø§Ù„Ø­Ø°Ù */
      .actions-buttons .btn-icon.btn-delete {
        color: var(--danger-color, #e74c3c);
      }
      .actions-buttons .btn-icon.btn-delete:hover {
        color: #d32f2f;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© */
      #bulk-actions-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
        min-height: 50px;
        display: none;
        background-color: var(--light-color); /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù„Ù„ØªØ­Ø¯ÙŠØ¯ */
        padding: 15px;
        border-radius: 8px;
      }
      #bulk-actions-container.show {
        display: flex;
      }
      #bulk-actions-container select {
        width: 200px;
        padding: 8px;
        border: 1px solid var(--primary-color);
      }
      #bulk-actions-container .btn {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
      /* ğŸ’¡ Ù†Ù…Ø· Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…Ø®ØµØµ */
      #custom-materials-field {
        background-color: #f7f7f7;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
      }
      /* ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ù†Ù…Ø· Ø­Ù‚Ù„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹ */
      #manufacturing-hours-field {
        background-color: #f0f8ff;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px dashed var(--info-color);
      }
      #manufacturing-hours-field label {
        color: var(--info-color);
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html" class="active"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html"
              ><i class="fa-solid fa-truck-fast"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>
    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
      <div class="orders-section admin-panel">
        <div class="section-header">
          <div class="filters-container" id="filters-container">
            <button class="filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" data-filter="pending">
              Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            </button>
            <button class="filter-btn" data-filter="in-progress">
              Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            </button>
            <button class="filter-btn" data-filter="ready">Ø¬Ø§Ù‡Ø²Ø©</button>
            <button class="filter-btn" data-filter="custom">Ù…Ø®ØµØµØ©</button>
            <button class="filter-btn" data-filter="completed">Ù…ÙƒØªÙ…Ù„Ø©</button>
            <button class="filter-btn" data-filter="archived">Ù…Ø¤Ø±Ø´ÙØ©</button>
          </div>
        </div>

        <div id="bulk-actions-container">
          <label for="bulk-status-select" style="font-weight: 600"
            >ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</label
          >
          <select id="bulk-status-select"></select>
          <button class="btn btn-sm" id="apply-bulk-status">
            <i class="fa-solid fa-check"></i> ØªØ·Ø¨ÙŠÙ‚
          </button>
        </div>

        <div id="orders-table-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
      </div>
    </div>

    <div id="order-details-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>

        <div id="modal-order-details"></div>
        <hr style="margin: 20px 0; border-color: #f0f0f0" />

        <h3><i class="fa-solid fa-list-ul"></i> Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3>

        <div class="modal-form-grid">
          <div class="form-group">
            <label for="modal-status">ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</label>
            <select id="modal-status"></select>
          </div>
        </div>

        <div
          id="manufacturing-hours-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="modal-manufacturing-hours"
            ><i class="fa-solid fa-hourglass-half"></i> Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©
            (Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±)</label
          >
          <input
            type="number"
            id="modal-manufacturing-hours"
            min="1"
            step="1"
          />
          <p style="font-size: 0.8rem; color: #777">
            * Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø¥Ù†ØªØ§Ø¬.
          </p>
        </div>

        <div
          id="custom-materials-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="material-list">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ID:Quantity)</label>
          <p
            style="
              font-size: 0.9rem;
              color: var(--danger-color);
              margin-bottom: 5px;
            "
          >
            âš ï¸ Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„: ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø³Ø¹Ø±
            ÙŠØ¯ÙˆÙŠØ§Ù‹.
          </p>
          <textarea
            id="material-list"
            rows="3"
            placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø®Ø´Ø¨_1:0.5, Ø§Ù„Ø¯Ù‡Ø§Ù†_3:1.0"
          ></textarea>
          <p style="font-size: 0.8rem; color: #777">
            * ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… ID Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©.
          </p>
        </div>

        <div
          id="custom-price-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="modal-price">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø´ÙŠÙƒÙ„)</label>
          <input type="number" id="modal-price" min="0" step="0.01" />
        </div>

        <div
          id="rejection-reason-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="rejection-reason">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</label>
          <textarea id="rejection-reason" rows="3"></textarea>
        </div>

        <button id="save-status-btn" class="btn">
          <i class="fa-solid fa-save"></i> Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        </button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        orderBy,
        query,
        doc,
        updateDoc,
        writeBatch,
        getDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // ØªÙ‡ÙŠØ¦Ø© Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let allOrders = [];
      let currentOrderId = null;
      let currentOrderCollection = null;
      let currentOrderData = null;

      let rawMaterialsMap = new Map();
      const statusOptions = [
        "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
        "Ù…Ù‚Ø¨ÙˆÙ„",
        "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
        "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
        "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
        "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
        "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
        "Ù…ÙƒØªÙ…Ù„",
        "ØªÙ… Ø§Ù„Ø±ÙØ¶",
        "Ù…Ø¤Ø±Ø´Ù",
      ];

      const productCategories = [
        "Ø·Ø§ÙˆÙ„Ø© Ø³ÙØ±Ø©",
        "ÙƒØ±Ø³ÙŠ",
        "Ø·Ù‚Ù… ÙƒÙ†Ø¨",
        "ØºØ±ÙØ© Ù†ÙˆÙ…",
        "Ù…Ø·Ø¨Ø®",
        "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·",
        "Ø®Ø²Ø§Ù†Ø©",
        "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ§Ø²",
      ];
      let allProducts = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ø­Ø³Ø§Ø¨ COGS

      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª
      const WORK_HOURS_PER_DAY = 8; // 8 Ø³Ø§Ø¹Ø§Øª Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…
      const DEFAULT_HOURS_READY_PRODUCT = 5;
      const DEFAULT_HOURS_CUSTOM_PRODUCT = 20;
      const PROCESSING_BUFFER_DAYS = 2;

      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø·Ù„Ø¨
      function getHoursForOrder(order, allProducts) {
        // 1. Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±
        if (
          order.manufacturing_time_override &&
          order.manufacturing_time_override > 0
        ) {
          return parseFloat(order.manufacturing_time_override);
        }

        let totalHours = 0;

        try {
          if (order.type === "ready" && order.items) {
            order.items.forEach((item) => {
              const product = allProducts.find(
                (p) => p.id == item.id || p.id == parseInt(item.id)
              );
              const itemQuantity = item.quantity || 1;

              if (product && product.manufacturing_time_hours > 0) {
                totalHours += product.manufacturing_time_hours * itemQuantity;
              } else {
                totalHours += DEFAULT_HOURS_READY_PRODUCT * itemQuantity;
              }
            });
          } else if (order.type === "custom") {
            // (ØªØ¨Ø³ÙŠØ·) Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø§ Ù„Ù… ÙŠØ¹Ø¯Ù„Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±
            totalHours = DEFAULT_HOURS_CUSTOM_PRODUCT;
          }
        } catch (e) {
          console.error("Error calculating hours for order:", order.id, e);
          totalHours = DEFAULT_HOURS_READY_PRODUCT;
        }

        return totalHours > 0 ? totalHours : DEFAULT_HOURS_READY_PRODUCT;
      }

      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
      function calculateEstimatedCompletionDays(
        targetOrder,
        allOrders,
        allProducts
      ) {
        if (!targetOrder) {
          return { minDays: "---", maxDays: "---" };
        }

        // 1. Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
        const targetOrderHours = getHoursForOrder(targetOrder, allProducts);

        // 2. ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø§Øª Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø¥Ù†ØªØ§Ø¬
        const IN_QUEUE_STATUSES = [
          "Ù…Ù‚Ø¨ÙˆÙ„",
          "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
        ];
        const PENDING_STATUSES = ["Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];

        let acceptedQueueHours = 0; // Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
        let pendingQueueHours = 0; // Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© (Ø§Ù„Ø£Ø³ÙˆØ£)

        // 3. ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        allOrders.forEach((order) => {
          if (order.id === targetOrder.id) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø·Ù„Ø¨ Ù†ÙØ³Ù‡

          const orderHours = getHoursForOrder(order, allProducts);
          if (orderHours === 0) return;

          // 4. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© (Ø§Ù„ØªÙŠ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± ÙØ¹Ù„ÙŠØ§Ù‹)
          if (IN_QUEUE_STATUSES.includes(order.status)) {
            acceptedQueueHours += orderHours;
          }

          // 5. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© (Ø§Ù„ØªÙŠ ØªÙ†ØªØ¸Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ¬Ø§Ø¡Øª Ù‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù)
          if (PENDING_STATUSES.includes(order.status)) {
            const orderDate = new Date(order.order_date);
            const targetOrderDate = new Date(targetOrder.order_date);

            // (ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ "ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨")
            if (orderDate < targetOrderDate) {
              pendingQueueHours += orderHours;
            }
          }
        });

        // 6. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù…
        let minTotalDays, maxTotalDays;

        const targetOrderDays = Math.ceil(
          targetOrderHours / WORK_HOURS_PER_DAY
        );
        const acceptedQueueDays = Math.ceil(
          acceptedQueueHours / WORK_HOURS_PER_DAY
        );
        const pendingQueueDays = Math.ceil(
          pendingQueueHours / WORK_HOURS_PER_DAY
        );

        // (ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ "Ù…Ø±Ø­Ù„ÙŠØ© Ø§Ù„Ø·Ù„Ø¨")
        if (IN_QUEUE_STATUSES.includes(targetOrder.status)) {
          // Ø§Ù„Ø­Ø§Ù„Ø© Ø£: Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ø¨Ø§Ù„ÙØ¹Ù„
          // Ø§Ù„ÙˆÙ‚Øª = (ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±) + (Ø´Ø­Ù†)
          // (Ù…Ù„Ø§Ø­Ø¸Ø©: acceptedQueueHours Ù‡Ù†Ø§ Ù„Ø§ ØªØ´Ù…Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù)
          const totalQueueHours = acceptedQueueHours + targetOrderHours;
          minTotalDays =
            Math.ceil(totalQueueHours / WORK_HOURS_PER_DAY) +
            PROCESSING_BUFFER_DAYS;
          maxTotalDays = minTotalDays; // Ø§Ù„ÙˆÙ‚Øª Ù…Ø¤ÙƒØ¯
        } else {
          // Ø§Ù„Ø­Ø§Ù„Ø© Ø¨: Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"
          // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ = (ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©) + (Ø·Ù„Ø¨Ù‡) + (Ø´Ø­Ù†)
          minTotalDays =
            acceptedQueueDays + targetOrderDays + PROCESSING_BUFFER_DAYS;
          // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ = (ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©) + (ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø§Ù„Ø£Ù‚Ø¯Ù…) + (Ø·Ù„Ø¨Ù‡) + (Ø´Ø­Ù†)
          maxTotalDays =
            acceptedQueueDays +
            pendingQueueDays +
            targetOrderDays +
            PROCESSING_BUFFER_DAYS;
        }

        // 7. Ø¥Ø¹Ø§Ø¯Ø© Ù‚ÙŠÙ…Ø© Ø¯Ù‚ÙŠÙ‚Ø©
        return {
          minDays: Math.ceil(minTotalDays),
          maxDays: Math.ceil(maxTotalDays),
        };
      }

      // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±)
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal-overlay.active")
            .forEach((modal) => {
              closeModal(modal.id);
            });
        }
      });

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª
      async function fetchProductsAndMaterials() {
        const [materialsSnap, productsSnap] = await Promise.all([
          getDocs(collection(db, "raw_materials")),
          getDocs(collection(db, "products")),
        ]);

        rawMaterialsMap = new Map(
          materialsSnap.docs.map((d) => [
            d.id,
            {
              id: d.id,
              ...d.data(),
              current_stock: parseFloat(d.data().current_stock || 0),
              total_cost_value: parseFloat(d.data().total_cost_value || 0),
              cost_per_unit: parseFloat(d.data().cost_per_unit || 0),
              unit: d.data().unit || "ÙˆØ­Ø¯Ø©",
              name_ar: d.data().name_ar || d.id,
            },
          ])
        );

        allProducts = productsSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          price: parseFloat(d.data().price || 0),
          total_cost: parseFloat(d.data().total_cost || 0),
          manufacturing_time_hours: parseFloat(
            d.data().manufacturing_time_hours || 0
          ),
        }));
      }

      // ÙƒØªÙ„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchProductsAndMaterials();
            fetchOrders();
            setupBulkActions();
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "login.html";
        });

      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
      async function attemptStockDeduction(
        orderData,
        requiredMaterialsForCustom,
        newStatus,
        batch,
        logCollection
      ) {
        const products = allProducts;
        let insufficient = [];
        let itemsToDeduct = [];

        // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø®ØµÙ…Ù‡Ø§
        if (orderData.type === "ready") {
          itemsToDeduct = orderData.items;
        } else if (orderData.type === "custom") {
          itemsToDeduct.push({
            id: orderData.id,
            quantity: 1,
            required_materials:
              requiredMaterialsForCustom.length > 0
                ? requiredMaterialsForCustom
                : orderData.required_materials_for_custom || [],
          });
        }

        // 2. ÙØ­Øµ ÙˆØ§Ù„Ø®ØµÙ…
        for (const item of itemsToDeduct) {
          const itemID = item.id;
          const itemQuantity = item.quantity;
          let requiredMaterialsList = [];

          if (orderData.type === "ready") {
            const product = products.find(
              (p) => p.id === itemID || p.id === parseInt(itemID)
            );
            if (!product || !product.required_materials) continue;
            requiredMaterialsList = product.required_materials;
          } else if (orderData.type === "custom") {
            requiredMaterialsList = item.required_materials;
          }

          for (const req of requiredMaterialsList) {
            const mat = rawMaterialsMap.get(req.id);
            const need = req.quantity * itemQuantity;

            if (!mat || mat.current_stock < need) {
              insufficient.push(
                `${
                  mat ? mat.name_ar : "Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"
                } (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${need.toFixed(2)}ØŒ Ø§Ù„Ù…ØªØ§Ø­: ${
                  mat ? mat.current_stock.toFixed(2) : 0
                })`
              );
            } else {
              const ref = doc(db, "raw_materials", req.id);
              const newStock = mat.current_stock - need;
              const consumedValue = need * mat.cost_per_unit;
              const newCost = mat.total_cost_value - consumedValue;

              batch.update(ref, {
                current_stock: newStock,
                total_cost_value: newCost > 0 ? newCost : 0,
              });

              // Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
              batch.set(doc(logCollection), {
                material_id: req.id,
                material_name: mat.name_ar,
                change_quantity: -need,
                change_value: -consumedValue,
                operation_type: "consumption",
                order_id: orderData.id,
                date: new Date().toISOString(),
              });

              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø®ØµÙ… ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¯ÙˆØ±Ø©
              mat.current_stock = newStock;
              mat.total_cost_value = newCost;
            }
          }
        }

        if (insufficient.length) {
          alert(
            "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø®ØµÙ… Ø¨Ø³Ø¨Ø¨ Ù†Ù‚Øµ Ø§Ù„Ù…ÙˆØ§Ø¯:\n" +
              insufficient.join("\n")
          );
          return false;
        }
        return true;
      }

      async function fetchOrders() {
        const readySnap = await getDocs(collection(db, "orders"));
        const customSnap = await getDocs(collection(db, "custom_designs"));

        const readyOrders = readySnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "ready",
        }));

        const customOrders = customSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "custom",
        }));

        allOrders = [...readyOrders, ...customOrders].sort(
          (a, b) => new Date(b.order_date) - new Date(a.order_date)
        );
        const activeFilter =
          document.querySelector(".filter-btn.active")?.dataset.filter || "all";
        applyFilter(activeFilter);
      }

      function applyFilter(filter) {
        let filteredOrders = allOrders;
        if (filter === "ready") {
          filteredOrders = allOrders.filter((o) => o.type === "ready");
        } else if (filter === "custom") {
          filteredOrders = allOrders.filter((o) => o.type === "custom");
        } else if (filter === "pending") {
          filteredOrders = allOrders.filter(
            (o) => o.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" || o.status === "Ù…Ù‚Ø¨ÙˆÙ„"
          );
        } else if (filter === "in-progress") {
          filteredOrders = allOrders.filter((o) =>
            [
              "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
              "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
              "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
              "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
              "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
            ].includes(o.status)
          );
        } else if (filter === "completed") {
          filteredOrders = allOrders.filter((o) => o.status === "Ù…ÙƒØªÙ…Ù„");
        } else if (filter === "archived") {
          filteredOrders = allOrders.filter(
            (o) =>
              o.status === "Ù…Ø¤Ø±Ø´Ù" ||
              o.status === "ØªÙ… Ø§Ù„Ø±ÙØ¶" ||
              o.status === "Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„"
          );
        }
        renderTable(filteredOrders);
      }

      document.querySelectorAll(".filter-btn").forEach((button) => {
        button.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          applyFilter(button.dataset.filter);
        });
      });

      // ğŸ’¡ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      function renderTable(orders) {
        const container = document.getElementById("orders-table-container");
        if (!orders.length) {
          container.innerHTML =
            "<p class='loading-msg'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØµÙÙŠØ©.</p>";
          document
            .getElementById("bulk-actions-container")
            .classList.remove("show");
          return;
        }
        let html = `<table class="orders-table">
        <thead><tr>
        <th><input type="checkbox" id="select-all-orders"></th>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>Ø§Ù„Ù…Ù†ØªØ¬/Ø§Ù„ÙØ¦Ø©</th>
        <th>Ø§Ù„Ù†ÙˆØ¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø± (Ø£ÙŠØ§Ù…)</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead><tbody>`;

        orders.forEach((o) => {
          const statusClass = o.status.replace(/\s+/g, "-");
          const typeText = o.type === "ready" ? "Ø¬Ø§Ù‡Ø²" : "Ù…Ø®ØµØµ";

          const productDisplay =
            o.type === "ready"
              ? `${o.items[0]?.name} (${
                  o.items.length > 1 ? "+" + (o.items.length - 1) : ""
                })`
              : o.type_of_product || "ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ";

          const total =
            o.type === "ready"
              ? (o.total || 0).toFixed(0)
              : o.final_price
              ? o.final_price.toFixed(0)
              : "---";

          // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø± Ù„ÙƒÙ„ Ø·Ù„Ø¨
          const estimatedTime = calculateEstimatedCompletionDays(
            o,
            allOrders,
            allProducts
          );
          const timeDisplay =
            o.status === "Ù…ÙƒØªÙ…Ù„" || o.status === "ØªÙ… Ø§Ù„Ø±ÙØ¶"
              ? "---"
              : `${estimatedTime.minDays} - ${estimatedTime.maxDays} ÙŠÙˆÙ…`;

          html += `
          <tr data-id="${o.id}" data-collection="${
            o.type === "ready" ? "orders" : "custom_designs"
          }">
          <td><input type="checkbox" class="order-select-checkbox" data-id="${
            o.id
          }"></td>
          <td>${o.name || "---"}</td>
          <td>${productDisplay}</td>
          <td>${typeText}</td>
          <td>${new Date(o.order_date).toLocaleDateString("ar-EG")}</td>
          <td>${total} â‚ª</td>
          <td><span class="status-badge ${statusClass}">${o.status}</span></td>
          <td style="font-weight: bold; color: var(--info-color);">${timeDisplay}</td>
          <td class="actions-buttons" style="white-space: nowrap;">
            <button class="edit-btn btn-icon btn-manage" title="Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©"><i class="fa-solid fa-tools"></i></button>
            <button class="delete-btn btn-icon btn-delete" title="Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨" data-id="${
              o.id
            }" data-collection="${
            o.type === "ready" ? "orders" : "custom_designs"
          }"><i class="fa-solid fa-trash"></i></button>
          </td>
          </tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;

        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        document
          .getElementById("select-all-orders")
          .addEventListener("change", toggleAllCheckboxes);
        document.querySelectorAll(".order-select-checkbox").forEach((cb) => {
          cb.addEventListener("change", updateBulkActionsVisibility);
        });
        updateBulkActionsVisibility(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¤ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      }

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© (Bulk Actions)
      // --------------------------------------------------------
      function setupBulkActions() {
        const bulkStatusSelect = document.getElementById("bulk-status-select");
        bulkStatusSelect.innerHTML = statusOptions
          .map((s) => `<option value="${s}">${s}</option>`)
          .join("");

        document
          .getElementById("apply-bulk-status")
          .addEventListener("click", handleBulkStatusUpdate);
      }

      function toggleAllCheckboxes(e) {
        document.querySelectorAll(".order-select-checkbox").forEach((cb) => {
          cb.checked = e.target.checked;
        });
        updateBulkActionsVisibility();
      }

      function updateBulkActionsVisibility() {
        const checkedCount = document.querySelectorAll(
          ".order-select-checkbox:checked"
        ).length;
        const bulkContainer = document.getElementById("bulk-actions-container");
        bulkContainer.classList.toggle("show", checkedCount > 0);
      }

      async function handleBulkStatusUpdate() {
        const selectedStatus =
          document.getElementById("bulk-status-select").value;
        const selectedOrders = Array.from(
          document.querySelectorAll(".order-select-checkbox:checked")
        ).map((cb) => allOrders.find((o) => o.id === cb.dataset.id));

        if (selectedOrders.length === 0)
          return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
        if (
          selectedStatus === "Ù…Ù‚Ø¨ÙˆÙ„" ||
          selectedStatus === "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„" ||
          selectedStatus === "Ù…ÙƒØªÙ…Ù„"
        ) {
          return alert(
            "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© ØªØªØ·Ù„Ø¨ Ø®ØµÙ… Ù…Ø®Ø²ÙˆÙ† (Ù…Ù‚Ø¨ÙˆÙ„ØŒ Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ù…ÙƒØªÙ…Ù„) Ø¨Ø´ÙƒÙ„ Ø¬Ù…Ø§Ø¹ÙŠ. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø§Ø±ØªÙ‡Ø§ ÙØ±Ø¯ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†."
          );
        }

        if (
          !confirm(
            `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ${selectedOrders.length} Ø·Ù„Ø¨ Ø¥Ù„Ù‰: ${selectedStatus}ØŸ`
          )
        )
          return;

        const batch = writeBatch(db);
        let successCount = 0;

        selectedOrders.forEach((order) => {
          const collectionName =
            order.type === "ready" ? "orders" : "custom_designs";
          const orderRef = doc(db, collectionName, order.id);
          batch.update(orderRef, { status: selectedStatus });
          successCount++;
        });

        try {
          await batch.commit();
          alert(
            `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ${successCount} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${selectedStatus}.`
          );
          fetchOrders();
        } catch (e) {
          console.error("Bulk update failed:", e);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
      }

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©
      // --------------------------------------------------------
      document.addEventListener("click", (e) => {
        if (e.target.closest(".edit-btn")) {
          const tr = e.target.closest("tr");
          currentOrderId = tr.dataset.id;
          currentOrderCollection = tr.dataset.collection;
          currentOrderData = allOrders.find((o) => o.id === currentOrderId);
          if (currentOrderData) openOrderDetailsModal();
        } else if (e.target.closest(".delete-btn")) {
          const tr = e.target.closest("tr");
          const id = tr.dataset.id;
          const collection = tr.dataset.collection;
          if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… ${id}ØŸ`)) {
            deleteDoc(doc(db, collection, id))
              .then(() => fetchOrders())
              .catch((e) => console.error(e));
          }
        }
      });

      // ğŸ’¡ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
      function openOrderDetailsModal() {
        const isCustom = currentOrderData.type === "custom";
        const currentStatus = currentOrderData.status;

        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙƒØ¥Ø¹Ø¯Ø§Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
        document.getElementById("modal-price").value = "";
        document.getElementById("rejection-reason").value = "";
        document.getElementById("material-list").value = "";
        document.getElementById("custom-price-field").style.display = "none";
        document.getElementById("rejection-reason-field").style.display =
          "none";
        document.getElementById("custom-materials-field").style.display =
          "none";
        document.getElementById("manufacturing-hours-field").style.display =
          "none"; // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª

        let detailsHTML = `
              <div class="order-details-group">
                  <p><strong><i class="fa-solid fa-user"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${
                    currentOrderData.name || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-phone"></i> Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${
                    currentOrderData.phone || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-map-marker-alt"></i> Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${
                    currentOrderData.address || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-envelope"></i> Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</strong> ${
                    currentOrderData.email || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-receipt"></i> Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${
                    currentOrderData.id
                  }</p>
                  <p><strong><i class="fa-solid fa-calendar-alt"></i> Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(
                    currentOrderData.order_date
                  ).toLocaleDateString("ar-EG")}</p>
                  <p><strong><i class="fa-solid fa-list-check"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${
                    currentOrderData.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯"
                  }</p>
                  <p><strong><i class="fa-solid fa-tag"></i> Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span class="status-badge ${currentStatus.replace(
                    /\s+/g,
                    "-"
                  )}">${currentStatus}</span></p>
              </div>
          `;

        if (currentOrderData.type === "ready") {
          // ... (ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø§Ù‡Ø² - Ù„Ù… ÙŠØªØºÙŠØ±) ...
          const total = (currentOrderData.total || 0).toFixed(0);
          detailsHTML += `
                  <h3><i class="fa-solid fa-boxes-stacked"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h3>
                  <ul class="order-items-list">
                      ${currentOrderData.items
                        .map(
                          (item) => `
                      <li>
                          <span>${item.name} (Ø§Ù„Ø¹Ø¯Ø¯: ${item.quantity}) ${
                            item.color ? `| Ø§Ù„Ù„ÙˆÙ†: ${item.color}` : ""
                          }</span>
                          <span>${parseFloat(item.price).toFixed(0)} Ø´ÙŠÙƒÙ„</span>
                      </li>
                      `
                        )
                        .join("")}
                  </ul>
                  <p style="margin-top: 15px; font-size: 1.1rem;"><strong><i class="fa-solid fa-money-bill-wave"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${total} Ø´ÙŠÙƒÙ„</p>
              `;
        } else {
          // ... (ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ - Ù„Ù… ÙŠØªØºÙŠØ±) ...
          const priceDisplay = currentOrderData.final_price
            ? currentOrderData.final_price.toFixed(0)
            : currentOrderData.initial_price || "---";

          detailsHTML += `
                  <h3><i class="fa-solid fa-ruler-combined"></i> Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµ:</h3>
                  <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${
                    currentOrderData.title || "---"
                  }</p>
                  <p><strong>ÙˆØµÙ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${
                    currentOrderData.description || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${
                    currentOrderData.type_of_product || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:</strong> ${
                    currentOrderData.dimensions || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${
                    currentOrderData.material || "---"
                  }</p>
                  <p><strong>Ø§Ù„Ù„ÙˆÙ†:</strong> ${
                    currentOrderData.color || "---"
                  }</p>
                  <p style="margin-top: 15px;"><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø£ÙˆÙ„ÙŠ):</strong> ${priceDisplay} Ø´ÙŠÙƒÙ„</p>
                  <p style="font-size: 0.9rem; color: #888;">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© (COGS): ${
                    currentOrderData.estimatedCOGS || "---"
                  } Ø´ÙŠÙƒÙ„</p>
              `;

          // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
          document.getElementById("custom-materials-field").style.display =
            "flex";

          if (
            currentOrderData.required_materials_for_custom &&
            currentOrderData.required_materials_for_custom.length > 0
          ) {
            const matList = currentOrderData.required_materials_for_custom
              .map((req) => `${req.id}:${req.quantity}`)
              .join(", ");
            document.getElementById("material-list").value = matList;
          }

          if (
            currentStatus === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" ||
            currentStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶"
          ) {
            document.getElementById("custom-price-field").style.display =
              "flex";
            document.getElementById("modal-price").value =
              currentOrderData.final_price || "";
          }
          if (currentStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
            document.getElementById("rejection-reason-field").style.display =
              "flex";
            document.getElementById("rejection-reason").value =
              currentOrderData.rejection_reason || "";
          }
        }

        // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙˆØªØ¹Ø¨Ø¦ØªÙ‡
        const manufacturingHoursField = document.getElementById(
          "manufacturing-hours-field"
        );
        const manufacturingHoursInput = document.getElementById(
          "modal-manufacturing-hours"
        );

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const calculatedHours = getHoursForOrder(currentOrderData, allProducts);

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Override) Ø¥Ù† ÙˆØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
        manufacturingHoursInput.value =
          currentOrderData.manufacturing_time_override || calculatedHours;
        manufacturingHoursField.style.display = "flex";

        document.getElementById("modal-order-details").innerHTML = detailsHTML;

        // ... (ÙƒÙˆØ¯ Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø© - Ù„Ù… ÙŠØªØºÙŠØ±) ...
        const modalStatus = document.getElementById("modal-status");
        let availableStatusOptions = statusOptions;
        const approvedStatuses = [
          "Ù…Ù‚Ø¨ÙˆÙ„",
          "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
          "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
          "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
          "Ù…ÙƒØªÙ…Ù„",
        ];

        if (approvedStatuses.includes(currentStatus)) {
          availableStatusOptions = statusOptions.filter(
            (s) => s !== "ØªÙ… Ø§Ù„Ø±ÙØ¶"
          );

          if (currentStatus === "Ù…Ù‚Ø¨ÙˆÙ„" && currentOrderData.type === "ready") {
            availableStatusOptions = availableStatusOptions.filter(
              (s) => s !== "Ù…Ù‚Ø¨ÙˆÙ„" && s !== "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"
            );
          }
          if (
            currentStatus === "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„" &&
            currentOrderData.type === "custom"
          ) {
            availableStatusOptions = availableStatusOptions.filter(
              (s) =>
                s !== "Ù…Ù‚Ø¨ÙˆÙ„" && s !== "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" && s !== "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„"
            );
          }
        } else if (
          currentStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶" ||
          currentStatus === "Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„" ||
          currentStatus === "Ù…Ø¤Ø±Ø´Ù"
        ) {
          availableStatusOptions = statusOptions.filter(
            (s) => s === currentStatus || s === "Ù…Ø¤Ø±Ø´Ù"
          );
        }

        modalStatus.innerHTML = availableStatusOptions
          .map(
            (s) =>
              `<option value="${s}" ${
                currentStatus === s ? "selected" : ""
              }>${s}</option>`
          )
          .join("");

        openModal("order-details-modal");

        // ... (ÙƒÙˆØ¯ Ù…ØªØ§Ø¨Ø¹Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ - Ù„Ù… ÙŠØªØºÙŠØ±) ...
        document.getElementById("modal-status").onchange = (e) => {
          const newStatus = e.target.value;
          const isCustom = currentOrderData.type === "custom";

          if (isCustom && (newStatus === "Ù…Ù‚Ø¨ÙˆÙ„" || newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶")) {
            document.getElementById("custom-price-field").style.display =
              "flex";
            document.getElementById("modal-price").required = true;
          } else {
            document.getElementById("custom-price-field").style.display =
              "none";
            document.getElementById("modal-price").required = false;
          }

          document.getElementById("custom-materials-field").style.display =
            isCustom ? "flex" : "none";

          if (isCustom && newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
            document.getElementById("rejection-reason-field").style.display =
              "flex";
            document.getElementById("rejection-reason").required = true;
          } else {
            document.getElementById("rejection-reason-field").style.display =
              "none";
            document.getElementById("rejection-reason").required = false;
          }
        };
        document
          .getElementById("modal-status")
          .dispatchEvent(new Event("change"));
      }

      // ğŸ’¡ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…ÙØ­Ø³Ù†
      document
        .getElementById("save-status-btn")
        .addEventListener("click", async () => {
          const newStatus = document.getElementById("modal-status").value;
          const finalPrice =
            parseFloat(document.getElementById("modal-price").value) || null;
          const rejectionReason =
            document.getElementById("rejection-reason").value || null;
          const materialListText =
            document.getElementById("material-list").value;
          // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ÙØ¹Ø¯Ù„Ø©
          const manufacturingHoursOverride =
            parseFloat(
              document.getElementById("modal-manufacturing-hours").value
            ) || null;

          if (!currentOrderData) return;

          const currentStatus = currentOrderData.status;
          const isCustom = currentOrderData.type === "custom";
          const isReady = currentOrderData.type === "ready";

          let updatePayload = { status: newStatus };

          // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ÙØ¹Ø¯Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©
          if (manufacturingHoursOverride) {
            updatePayload.manufacturing_time_override =
              manufacturingHoursOverride;
          }

          // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ¯ Ø´Ø±ÙˆØ· ØªØ³Ø¬ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
          const isReadyFirstApproval =
            isReady &&
            newStatus === "Ù…Ù‚Ø¨ÙˆÙ„" &&
            currentStatus === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
          const isCustomFirstApproval =
            isCustom &&
            newStatus === "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„" &&
            (currentStatus === "Ù…Ù‚Ø¨ÙˆÙ„" || currentStatus === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");

          if (isReadyFirstApproval || isCustomFirstApproval) {
            // Ù†Ø³Ø¬Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            updatePayload.acceptance_date = new Date().toISOString();
          }

          // ğŸ’¡ ØªØ­Ø¯ÙŠØ¯ Ø´Ø±ÙˆØ· Ø§Ù„Ø®ØµÙ…
          const isReadyOrderForDeduction =
            currentOrderData.type === "ready" && newStatus === "Ù…Ù‚Ø¨ÙˆÙ„";
          const isCustomOrderForDeduction =
            currentOrderData.type === "custom" && newStatus === "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„";

          let requiredMaterialsForCustom = [];

          // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©
          if (currentOrderData.type === "custom") {
            if (newStatus === "Ù…Ù‚Ø¨ÙˆÙ„") {
              if (!finalPrice || finalPrice <= 0) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ù†Ù‡Ø§Ø¦ÙŠ ØµØ­ÙŠØ­ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ….");
                return;
              }
              if (!materialListText) {
                alert(
                  "âš ï¸ Ø¥Ù„Ø²Ø§Ù…ÙŠ: Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (ID:Quantity) Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®ØµØµ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù‚Ø¨ÙˆÙ„)."
                );
                return;
              }

              // ... (ÙƒÙˆØ¯ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… - Ù„Ù… ÙŠØªØºÙŠØ±) ...
              const entries = materialListText
                .split(",")
                .map((e) => e.trim())
                .filter((e) => e);
              requiredMaterialsForCustom = entries
                .map((entry) => {
                  const [id, quantityStr] = entry.split(":");
                  const quantity = parseFloat(quantityStr);
                  if (id && !isNaN(quantity) && quantity > 0) {
                    return { id: id.trim(), quantity: quantity };
                  }
                  return null;
                })
                .filter((req) => req !== null);
              if (requiredMaterialsForCustom.length === 0) {
                alert(
                  "âš ï¸ Ø¥Ù„Ø²Ø§Ù…ÙŠ: Ù„Ù… ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø£ÙŠ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (ID:Quantity)."
                );
                return;
              }

              updatePayload.final_price = finalPrice;
              updatePayload.required_materials_for_custom =
                requiredMaterialsForCustom;
              updatePayload.rejection_reason = null;
            } else if (newStatus === "ØªÙ… Ø§Ù„Ø±ÙØ¶") {
              if (!rejectionReason) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ù„Ù„Ø±ÙØ¶.");
                return;
              }
              updatePayload.final_price = null;
              updatePayload.rejection_reason = rejectionReason;
            } else {
              if (currentOrderData.final_price)
                updatePayload.final_price = currentOrderData.final_price;
              if (currentOrderData.rejection_reason)
                updatePayload.rejection_reason =
                  currentOrderData.rejection_reason;
            }
          }

          // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯
          if (isReadyOrderForDeduction || isCustomOrderForDeduction) {
            const batch = writeBatch(db);
            const logCollection = collection(db, "raw_materials_log");

            const deductionSuccessful = await attemptStockDeduction(
              currentOrderData,
              requiredMaterialsForCustom,
              newStatus,
              batch,
              logCollection
            );

            if (!deductionSuccessful) {
              return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            }

            const orderRef = doc(db, currentOrderCollection, currentOrderId);
            batch.update(orderRef, updatePayload);

            try {
              await batch.commit();
              alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.");
              closeModal("order-details-modal");
              fetchOrders();
            } catch (e) {
              console.error("Error committing batch:", e);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.");
            }
          } else {
            // ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ· Ù„Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…)
            const orderRef = doc(db, currentOrderCollection, currentOrderId);
            try {
              await updateDoc(orderRef, updatePayload);
              alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
              closeModal("order-details-modal");
              fetchOrders();
            } catch (e) {
              console.error(e);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.");
            }
          }
        });
    </script>
  </body>
</html>
