<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | إدارة الطلبات</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* أنماط الشارات الأساسية (مهمة لضمان عرضها) */
      .status-badge {
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        display: inline-block;
        white-space: nowrap;
        font-size: 0.85rem;
      }
      .status-badge.قيد-المراجعة {
        background-color: #ffeb3b;
        color: #795548;
      }
      .status-badge.مقبول {
        background-color: #5bc0de;
        color: white;
      }
      .status-badge.قيد-التصنيع {
        background-color: #34495e;
        color: white;
      }
      .status-badge.قيد-الطلاء {
        background-color: #f39c12;
        color: white;
      }
      .status-badge.قيد-التغليف {
        background-color: #c0392b;
        color: white;
      }
      .status-badge.قيد-الشحن {
        background-color: #3498db;
        color: white;
      }
      .status-badge.مكتمل {
        background-color: #4caf50;
        color: white;
      }
      .status-badge.تم-الرفض {
        background-color: #e74c3c;
        color: white;
      }
      .status-badge.مؤرشف {
        background-color: #95a5a6;
        color: white;
      }
      .status-badge.مقبول-العميل {
        background-color: #27ae60;
        color: white;
      }
      .status-badge.مرفوض-العميل {
        background-color: #c0392b;
        color: white;
      }

      /* تنسيق القسم الرئيسي */
      .orders-section.admin-panel {
        margin-top: 25px;
      }
      .orders-section .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        /* 💡 تحسين عرض أزرار الفلترة */
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 10px;
      }

      /* تنسيق عناصر المودال */
      .modal-form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      textarea,
      input,
      select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #e6e9ee;
        font-family: "Cairo", sans-serif;
      }
      .orders-table th,
      .orders-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f5f9;
        text-align: right;
        font-size: 0.95rem;
      }

      /* تحسين عرض تفاصيل الطلب داخل المودال المُحسن */
      .order-details-group p {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }
      .order-details-group p strong {
        font-weight: 700;
        color: var(--primary-color);
        margin-left: 5px;
      }
      .order-items-list {
        list-style-type: none;
        padding-right: 0;
        margin-top: 10px;
      }
      .order-items-list li {
        padding: 8px 0;
        font-size: 0.95rem;
        border-bottom: 1px dotted #f0f0f0;
        display: flex;
        justify-content: space-between;
      }

      /* 💡 الأنماط المُحسنة للأزرار في الجدول */
      .actions-buttons .btn-icon {
        background: none;
        border: none;
        color: var(--dark-color);
        padding: 5px 8px;
        cursor: pointer;
        font-size: 1.1rem;
        margin-left: 5px;
        transition: color 0.2s;
      }
      /* زر الإدارة (تغيير/عرض) */
      .actions-buttons .btn-icon.btn-manage {
        color: var(--info-color, #5d9cec);
      }
      .actions-buttons .btn-icon.btn-manage:hover {
        color: var(--dark-color);
      }
      /* زر الحذف */
      .actions-buttons .btn-icon.btn-delete {
        color: var(--danger-color, #e74c3c);
      }
      .actions-buttons .btn-icon.btn-delete:hover {
        color: #d32f2f;
      }

      /* تنسيق منطقة الإجراءات الجماعية */
      #bulk-actions-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
        min-height: 50px;
        display: none;
        background-color: var(--light-color); /* خلفية خفيفة للتحديد */
        padding: 15px;
        border-radius: 8px;
      }
      #bulk-actions-container.show {
        display: flex;
      }
      #bulk-actions-container select {
        width: 200px;
        padding: 8px;
        border: 1px solid var(--primary-color);
      }
      #bulk-actions-container .btn {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
      /* 💡 نمط حقل المواد الخام المخصص */
      #custom-materials-field {
        background-color: #f7f7f7;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <header class="main-header">
      <div class="logo">منجرة</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> لوحة التحكم</a
            >
          </li>
          <li>
            <a href="orders_admin.html" class="active"
              ><i class="fa-solid fa-box-open"></i> إدارة الطلبات</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> إدارة المنتجات</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> إدارة المواد الخام</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> التكاليف الثابتة</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> إدارة العملاء</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>إدارة الطلبات</h1>
      <div class="orders-section admin-panel">
        <div class="section-header">
          <div class="filters-container" id="filters-container">
            <button class="filter-btn active" data-filter="all">الكل</button>
            <button class="filter-btn" data-filter="pending">
              قيد المراجعة
            </button>
            <button class="filter-btn" data-filter="in-progress">
              قيد التنفيذ
            </button>
            <button class="filter-btn" data-filter="ready">جاهزة</button>
            <button class="filter-btn" data-filter="custom">مخصصة</button>
            <button class="filter-btn" data-filter="completed">مكتملة</button>
            <button class="filter-btn" data-filter="archived">مؤرشفة</button>
          </div>
        </div>

        <div id="bulk-actions-container">
          <label for="bulk-status-select" style="font-weight: 600"
            >تغيير حالة الطلبات المحددة:</label
          >
          <select id="bulk-status-select"></select>
          <button class="btn btn-sm" id="apply-bulk-status">
            <i class="fa-solid fa-check"></i> تطبيق
          </button>
        </div>

        <div id="orders-table-container">
          <p class="loading-msg">جارٍ تحميل الطلبات...</p>
        </div>
      </div>
    </div>

    <div id="order-details-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>تفاصيل الطلب</h2>

        <div id="modal-order-details"></div>
        <hr style="margin: 20px 0; border-color: #f0f0f0" />

        <h3><i class="fa-solid fa-list-ul"></i> إدارة حالة الطلب</h3>

        <div class="modal-form-grid">
          <div class="form-group">
            <label for="modal-status">تغيير حالة الطلب</label>
            <select id="modal-status"></select>
          </div>
        </div>

        <div
          id="custom-materials-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="material-list">المواد الخام المطلوبة (ID:Quantity)</label>
          <p
            style="
              font-size: 0.9rem;
              color: var(--danger-color);
              margin-bottom: 5px;
            "
          >
            ⚠️ إلزامي للطلبات المخصصة عند القبول: يجب إدخال المواد والسعر
            يدوياً.
          </p>
          <textarea
            id="material-list"
            rows="3"
            placeholder="مثال: الخشب_1:0.5, الدهان_3:1.0"
          ></textarea>
          <p style="font-size: 0.8rem; color: #777">
            * يجب استخدام ID المادة ووحدة القياس المسجلة.
          </p>
        </div>

        <div
          id="custom-price-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="modal-price">السعر النهائي للعميل (شيكل)</label>
          <input type="number" id="modal-price" min="0" step="0.01" />
        </div>

        <div
          id="rejection-reason-field"
          class="form-group"
          style="display: none; flex-direction: column"
        >
          <label for="rejection-reason">سبب الرفض</label>
          <textarea id="rejection-reason" rows="3"></textarea>
        </div>

        <button id="save-status-btn" class="btn">
          <i class="fa-solid fa-save"></i> حفظ وتحديث الحالة
        </button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        orderBy,
        query,
        doc,
        updateDoc,
        writeBatch,
        getDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // تهيئة Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let allOrders = [];
      let currentOrderId = null;
      let currentOrderCollection = null;
      let currentOrderData = null;

      let rawMaterialsMap = new Map();
      // 💡 قائمة الحالات المحدثة
      const statusOptions = [
        "قيد المراجعة",
        "مقبول",
        "مقبول-العميل",
        "قيد التصنيع",
        "قيد الطلاء",
        "قيد التغليف",
        "قيد الشحن",
        "مكتمل",
        "تم الرفض",
        "مؤرشف",
      ];

      // 💡 قائمة الفئات لتبسيط العرض في الجدول
      const productCategories = [
        "طاولة سفرة",
        "كرسي",
        "طقم كنب",
        "غرفة نوم",
        "مطبخ",
        "طاولة وسط",
        "خزانة",
        "طاولة تلفاز",
      ];
      let allProducts = []; // لتخزين المنتجات محلياً لحساب COGS

      // دوال التحكم في المودال (لتقليل التكرار)
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal-overlay.active")
            .forEach((modal) => {
              closeModal(modal.id);
            });
        }
      });

      // 💡 جلب المواد الخام والمنتجات لعمليات الخصم والتحليل
      async function fetchProductsAndMaterials() {
        const [materialsSnap, productsSnap] = await Promise.all([
          getDocs(collection(db, "raw_materials")),
          getDocs(collection(db, "products")),
        ]);

        rawMaterialsMap = new Map(
          materialsSnap.docs.map((d) => [
            d.id,
            {
              id: d.id,
              ...d.data(),
              current_stock: parseFloat(d.data().current_stock || 0),
              total_cost_value: parseFloat(d.data().total_cost_value || 0),
              cost_per_unit: parseFloat(d.data().cost_per_unit || 0),
              unit: d.data().unit || "وحدة",
              name_ar: d.data().name_ar || d.id,
            },
          ])
        );

        allProducts = productsSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          price: parseFloat(d.data().price || 0),
          total_cost: parseFloat(d.data().total_cost || 0), // TCOGS
          manufacturing_time_hours: parseFloat(
            d.data().manufacturing_time_hours || 0
          ), // 💡 جلب وقت التصنيع
        }));
      }

      // كتلة التحقق من الصلاحيات
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchProductsAndMaterials();
            fetchOrders();
            setupBulkActions();
          } else {
            alert("غير مصرح لك بالوصول إلى هذه الصفحة.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "login.html";
        });

      // 💡 منطق الخصم من المخزون (مكرر من orders_admin.html الأصلي)
      async function attemptStockDeduction(
        orderData,
        requiredMaterialsForCustom,
        newStatus,
        batch,
        logCollection
      ) {
        const products = allProducts;
        let insufficient = [];
        let itemsToDeduct = [];

        // 1. تحديد المواد المطلوب خصمها
        if (orderData.type === "ready") {
          itemsToDeduct = orderData.items;
        } else if (orderData.type === "custom") {
          itemsToDeduct.push({
            id: orderData.id,
            quantity: 1,
            required_materials:
              requiredMaterialsForCustom.length > 0
                ? requiredMaterialsForCustom
                : orderData.required_materials_for_custom || [],
          });
        }

        // 2. فحص والخصم
        for (const item of itemsToDeduct) {
          const itemID = item.id;
          const itemQuantity = item.quantity;
          let requiredMaterialsList = [];

          if (orderData.type === "ready") {
            const product = products.find(
              (p) => p.id === itemID || p.id === parseInt(itemID)
            );
            if (!product || !product.required_materials) continue;
            requiredMaterialsList = product.required_materials;
          } else if (orderData.type === "custom") {
            requiredMaterialsList = item.required_materials;
          }

          for (const req of requiredMaterialsList) {
            const mat = rawMaterialsMap.get(req.id);
            const need = req.quantity * itemQuantity;

            if (!mat || mat.current_stock < need) {
              insufficient.push(
                `${
                  mat ? mat.name_ar : "مادة غير معروفة"
                } (المطلوب: ${need.toFixed(2)}، المتاح: ${
                  mat ? mat.current_stock.toFixed(2) : 0
                })`
              );
            } else {
              const ref = doc(db, "raw_materials", req.id);
              const newStock = mat.current_stock - need;
              const consumedValue = need * mat.cost_per_unit;
              const newCost = mat.total_cost_value - consumedValue;

              batch.update(ref, {
                current_stock: newStock,
                total_cost_value: newCost > 0 ? newCost : 0,
              });

              // سجل حركة المواد الخام
              batch.set(doc(logCollection), {
                material_id: req.id,
                material_name: mat.name_ar,
                change_quantity: -need,
                change_value: -consumedValue,
                operation_type: "consumption",
                order_id: orderData.id,
                date: new Date().toISOString(),
              });

              // تحديث الخريطة محلياً لضمان عدم تكرار الخصم في نفس الدورة
              mat.current_stock = newStock;
              mat.total_cost_value = newCost;
            }
          }
        }

        if (insufficient.length) {
          alert(
            "⚠️ لا يمكن إتمام عملية الخصم بسبب نقص المواد:\n" +
              insufficient.join("\n")
          );
          return false;
        }
        return true;
      }

      async function fetchOrders() {
        const readySnap = await getDocs(collection(db, "orders"));
        const customSnap = await getDocs(collection(db, "custom_designs"));

        const readyOrders = readySnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "ready",
        }));

        const customOrders = customSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          type: "custom",
        }));

        allOrders = [...readyOrders, ...customOrders].sort(
          (a, b) => new Date(b.order_date) - new Date(a.order_date)
        );
        const activeFilter =
          document.querySelector(".filter-btn.active")?.dataset.filter || "all";
        applyFilter(activeFilter);
      }

      function applyFilter(filter) {
        let filteredOrders = allOrders;
        if (filter === "ready") {
          filteredOrders = allOrders.filter((o) => o.type === "ready");
        } else if (filter === "custom") {
          filteredOrders = allOrders.filter((o) => o.type === "custom");
        } else if (filter === "pending") {
          filteredOrders = allOrders.filter(
            (o) => o.status === "قيد المراجعة" || o.status === "مقبول"
          );
        } else if (filter === "in-progress") {
          filteredOrders = allOrders.filter((o) =>
            [
              "مقبول-العميل",
              "قيد التصنيع",
              "قيد الطلاء",
              "قيد التغليف",
              "قيد الشحن",
            ].includes(o.status)
          );
        } else if (filter === "completed") {
          filteredOrders = allOrders.filter((o) => o.status === "مكتمل");
        } else if (filter === "archived") {
          filteredOrders = allOrders.filter(
            (o) =>
              o.status === "مؤرشف" ||
              o.status === "تم الرفض" ||
              o.status === "مرفوض-العميل"
          );
        }
        renderTable(filteredOrders);
      }

      document.querySelectorAll(".filter-btn").forEach((button) => {
        button.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          applyFilter(button.dataset.filter);
        });
      });

      function renderTable(orders) {
        const container = document.getElementById("orders-table-container");
        if (!orders.length) {
          container.innerHTML =
            "<p class='loading-msg'>لا توجد طلبات مطابقة لمعايير التصفية.</p>";
          document
            .getElementById("bulk-actions-container")
            .classList.remove("show");
          return;
        }
        let html = `<table class="orders-table">
        <thead><tr>
        <th><input type="checkbox" id="select-all-orders"></th>
        <th>العميل</th>
        <th>المنتج/الفئة</th>
        <th>النوع</th>
        <th>التاريخ</th>
        <th>الإجمالي</th>
        <th>الحالة</th>
        <th>إجراء</th>
        </tr></thead><tbody>`;

        orders.forEach((o) => {
          const statusClass = o.status.replace(/\s+/g, "-");
          const typeText = o.type === "ready" ? "جاهز" : "مخصص";

          const productDisplay =
            o.type === "ready"
              ? `${o.items[0]?.name} (${
                  o.items.length > 1 ? "+" + (o.items.length - 1) : ""
                })`
              : o.type_of_product || "تصميم مخصص";

          const total =
            o.type === "ready"
              ? (o.total || 0).toFixed(0)
              : o.final_price
              ? o.final_price.toFixed(0)
              : "---";

          html += `
          <tr data-id="${o.id}" data-collection="${
            o.type === "ready" ? "orders" : "custom_designs"
          }">
          <td><input type="checkbox" class="order-select-checkbox" data-id="${
            o.id
          }"></td>
          <td>${o.name || "---"}</td>
          <td>${productDisplay}</td>
          <td>${typeText}</td>
          <td>${new Date(o.order_date).toLocaleDateString("ar-EG")}</td>
          <td>${total} ₪</td>
          <td><span class="status-badge ${statusClass}">${o.status}</span></td>
          <td class="actions-buttons" style="white-space: nowrap;">
            <button class="edit-btn btn-icon btn-manage" title="إدارة وتغيير الحالة"><i class="fa-solid fa-tools"></i></button>
            <button class="delete-btn btn-icon btn-delete" title="حذف الطلب" data-id="${
              o.id
            }" data-collection="${
            o.type === "ready" ? "orders" : "custom_designs"
          }"><i class="fa-solid fa-trash"></i></button>
          </td>
          </tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;

        // ربط أحداث التحديد المتعدد بعد عرض الجدول
        document
          .getElementById("select-all-orders")
          .addEventListener("change", toggleAllCheckboxes);
        document.querySelectorAll(".order-select-checkbox").forEach((cb) => {
          cb.addEventListener("change", updateBulkActionsVisibility);
        });
        updateBulkActionsVisibility(); // لتحديث الرؤية عند التحميل
      }

      // --------------------------------------------------------
      // منطق الإجراءات الجماعية (Bulk Actions)
      // --------------------------------------------------------
      function setupBulkActions() {
        const bulkStatusSelect = document.getElementById("bulk-status-select");
        bulkStatusSelect.innerHTML = statusOptions
          .map((s) => `<option value="${s}">${s}</option>`)
          .join("");

        document
          .getElementById("apply-bulk-status")
          .addEventListener("click", handleBulkStatusUpdate);
      }

      function toggleAllCheckboxes(e) {
        document.querySelectorAll(".order-select-checkbox").forEach((cb) => {
          cb.checked = e.target.checked;
        });
        updateBulkActionsVisibility();
      }

      function updateBulkActionsVisibility() {
        const checkedCount = document.querySelectorAll(
          ".order-select-checkbox:checked"
        ).length;
        const bulkContainer = document.getElementById("bulk-actions-container");
        bulkContainer.classList.toggle("show", checkedCount > 0);
      }

      async function handleBulkStatusUpdate() {
        const selectedStatus =
          document.getElementById("bulk-status-select").value;
        const selectedOrders = Array.from(
          document.querySelectorAll(".order-select-checkbox:checked")
        ).map((cb) => allOrders.find((o) => o.id === cb.dataset.id));

        if (selectedOrders.length === 0)
          return alert("الرجاء تحديد طلب واحد على الأقل.");
        if (
          selectedStatus === "مقبول" ||
          selectedStatus === "مقبول-العميل" ||
          selectedStatus === "مكتمل"
        ) {
          return alert(
            "⚠️ لا يمكن تطبيق حالة تتطلب خصم مخزون (مقبول، مقبول-العميل، مكتمل) بشكل جماعي. يرجى إدارتها فردياً لضمان سلامة المخزون."
          );
        }

        if (
          !confirm(
            `هل أنت متأكد من تغيير حالة ${selectedOrders.length} طلب إلى: ${selectedStatus}؟`
          )
        )
          return;

        const batch = writeBatch(db);
        let successCount = 0;

        selectedOrders.forEach((order) => {
          const collectionName =
            order.type === "ready" ? "orders" : "custom_designs";
          const orderRef = doc(db, collectionName, order.id);
          batch.update(orderRef, { status: selectedStatus });
          successCount++;
        });

        try {
          await batch.commit();
          alert(
            `✅ تم تحديث حالة ${successCount} طلب بنجاح إلى: ${selectedStatus}.`
          );
          fetchOrders();
        } catch (e) {
          console.error("Bulk update failed:", e);
          alert("حدث خطأ أثناء التحديث الجماعي. يرجى المحاولة مرة أخرى.");
        }
      }

      // --------------------------------------------------------
      // منطق عرض وتعديل الطلبات الفردية
      // --------------------------------------------------------
      document.addEventListener("click", (e) => {
        if (e.target.closest(".edit-btn")) {
          const tr = e.target.closest("tr");
          currentOrderId = tr.dataset.id;
          currentOrderCollection = tr.dataset.collection;
          currentOrderData = allOrders.find((o) => o.id === currentOrderId);
          if (currentOrderData) openOrderDetailsModal();
        } else if (e.target.closest(".delete-btn")) {
          const tr = e.target.closest("tr");
          const id = tr.dataset.id;
          const collection = tr.dataset.collection;
          if (confirm(`هل أنت متأكد من حذف الطلب رقم ${id}؟`)) {
            deleteDoc(doc(db, collection, id))
              .then(() => fetchOrders())
              .catch((e) => console.error(e));
          }
        }
      });

      function openOrderDetailsModal() {
        const isCustom = currentOrderData.type === "custom";
        const currentStatus = currentOrderData.status; // 💡 الحالة الحالية

        // إعادة تعيين حقول التسعير والرفض والمواد الخام عند الفتح
        document.getElementById("modal-price").value = "";
        document.getElementById("rejection-reason").value = "";
        document.getElementById("material-list").value = "";
        document.getElementById("custom-price-field").style.display = "none";
        document.getElementById("rejection-reason-field").style.display =
          "none";
        document.getElementById("custom-materials-field").style.display =
          "none";

        let detailsHTML = `
              <div class="order-details-group">
                  <p><strong><i class="fa-solid fa-user"></i> العميل:</strong> ${
                    currentOrderData.name || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-phone"></i> الهاتف:</strong> ${
                    currentOrderData.phone || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-map-marker-alt"></i> العنوان:</strong> ${
                    currentOrderData.address || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-envelope"></i> الإيميل:</strong> ${
                    currentOrderData.email || "---"
                  }</p>
                  <p><strong><i class="fa-solid fa-receipt"></i> رقم الطلب:</strong> ${
                    currentOrderData.id
                  }</p>
                  <p><strong><i class="fa-solid fa-calendar-alt"></i> التاريخ:</strong> ${new Date(
                    currentOrderData.order_date
                  ).toLocaleDateString("ar-EG")}</p>
                  <p><strong><i class="fa-solid fa-list-check"></i> ملاحظات العميل:</strong> ${
                    currentOrderData.notes || "لا توجد"
                  }</p>
                  <p><strong><i class="fa-solid fa-tag"></i> الحالة الحالية:</strong> <span class="status-badge ${currentStatus.replace(
                    /\s+/g,
                    "-"
                  )}">${currentStatus}</span></p>
              </div>
          `;

        if (currentOrderData.type === "ready") {
          // تفاصيل الطلب الجاهز
          const total = (currentOrderData.total || 0).toFixed(0);
          detailsHTML += `
                  <h3><i class="fa-solid fa-boxes-stacked"></i> المنتجات المطلوبة:</h3>
                  <ul class="order-items-list">
                      ${currentOrderData.items
                        .map(
                          (item) => `
                      <li>
                          <span>${item.name} (العدد: ${item.quantity}) ${
                            item.color ? `| اللون: ${item.color}` : ""
                          }</span>
                          <span>${parseFloat(item.price).toFixed(0)} شيكل</span>
                      </li>
                      `
                        )
                        .join("")}
                  </ul>
                  <p style="margin-top: 15px; font-size: 1.1rem;"><strong><i class="fa-solid fa-money-bill-wave"></i> الإجمالي المدفوع:</strong> ${total} شيكل</p>
              `;
        } else {
          // تفاصيل الطلب المخصص (Custom Design)
          const priceDisplay = currentOrderData.final_price
            ? currentOrderData.final_price.toFixed(0)
            : currentOrderData.initial_price || "---";

          detailsHTML += `
                  <h3><i class="fa-solid fa-ruler-combined"></i> مواصفات التصميم المخصص:</h3>
                  <p><strong>اسم المنتج المقترح:</strong> ${
                    currentOrderData.title || "---"
                  }</p>
                  <p><strong>وصف العميل:</strong> ${
                    currentOrderData.description || "---"
                  }</p>
                  <p><strong>النوع:</strong> ${
                    currentOrderData.type_of_product || "---"
                  }</p>
                  <p><strong>المقاسات:</strong> ${
                    currentOrderData.dimensions || "---"
                  }</p>
                  <p><strong>المادة:</strong> ${
                    currentOrderData.material || "---"
                  }</p>
                  <p><strong>اللون:</strong> ${
                    currentOrderData.color || "---"
                  }</p>
                  <p style="margin-top: 15px;"><strong>السعر المقترح (أولي):</strong> ${priceDisplay} شيكل</p>
                  <p style="font-size: 0.9rem; color: #888;">تكلفة المواد التقديرية (COGS): ${
                    currentOrderData.estimatedCOGS || "---"
                  } شيكل</p>
              `;

          // 💡 إظهار حقل الإدخال اليدوي للمواد الخام
          document.getElementById("custom-materials-field").style.display =
            "flex";

          // ملء حقل المواد الخام إذا كانت موجودة
          if (
            currentOrderData.required_materials_for_custom &&
            currentOrderData.required_materials_for_custom.length > 0
          ) {
            const matList = currentOrderData.required_materials_for_custom
              .map((req) => `${req.id}:${req.quantity}`)
              .join(", ");
            document.getElementById("material-list").value = matList;
          }

          // إظهار حقل التسعير النهائي لطلبات التصميم المخصصة عند قبولها
          if (
            currentStatus === "قيد المراجعة" ||
            currentStatus === "تم الرفض"
          ) {
            document.getElementById("custom-price-field").style.display =
              "flex";
            document.getElementById("modal-price").value =
              currentOrderData.final_price || "";
          }
          if (currentStatus === "تم الرفض") {
            document.getElementById("rejection-reason-field").style.display =
              "flex";
            document.getElementById("rejection-reason").value =
              currentOrderData.rejection_reason || "";
          }
        }

        document.getElementById("modal-order-details").innerHTML = detailsHTML;

        // ملء قائمة الحالة وتحديد الحالة الحالية
        const modalStatus = document.getElementById("modal-status");

        // 💡 تحديد خيارات الحالة بناءً على نوع الطلب والحالة الحالية (التعديل المطلوب)
        let availableStatusOptions = statusOptions;

        const approvedStatuses = [
          "مقبول",
          "مقبول-العميل",
          "قيد التصنيع",
          "قيد الطلاء",
          "قيد التغليف",
          "قيد الشحن",
          "مكتمل",
        ];

        if (approvedStatuses.includes(currentStatus)) {
          // إذا كانت الحالة الحالية قد تمت الموافقة عليها أو دخلت مرحلة التنفيذ، نحذف خيار "تم الرفض"
          availableStatusOptions = statusOptions.filter(
            (s) => s !== "تم الرفض"
          );

          if (currentStatus === "مقبول" && currentOrderData.type === "ready") {
            // للطلبات الجاهزة المقبولة، يجب إزالة "مقبول" و "قيد المراجعة"
            availableStatusOptions = availableStatusOptions.filter(
              (s) => s !== "مقبول" && s !== "قيد المراجعة"
            );
          }
          if (
            currentStatus === "مقبول-العميل" &&
            currentOrderData.type === "custom"
          ) {
            // للطلبات المخصصة المقبولة من العميل، يجب إزالة "مقبول" و "قيد المراجعة" و "مقبول-العميل"
            availableStatusOptions = availableStatusOptions.filter(
              (s) =>
                s !== "مقبول" && s !== "قيد المراجعة" && s !== "مقبول-العميل"
            );
          }
        } else if (
          currentStatus === "تم الرفض" ||
          currentStatus === "مرفوض-العميل" ||
          currentStatus === "مؤرشف"
        ) {
          // إذا كانت الحالة النهائية (مرفوض/مؤرشف)، لا تسمح بالعودة للقبول أو التنفيذ
          availableStatusOptions = statusOptions.filter(
            (s) => s === currentStatus || s === "مؤرشف"
          );
        }

        modalStatus.innerHTML = availableStatusOptions
          .map(
            (s) =>
              `<option value="${s}" ${
                currentStatus === s ? "selected" : ""
              }>${s}</option>`
          )
          .join("");

        openModal("order-details-modal");

        // وظيفة متابعة لتحديث حالة الحقول بناءً على تغيير الحالة في المودال
        document.getElementById("modal-status").onchange = (e) => {
          const newStatus = e.target.value;
          const isCustom = currentOrderData.type === "custom";

          // إظهار حقل التسعير النهائي لطلبات التصميم المخصصة عند قبولها
          if (isCustom && (newStatus === "مقبول" || newStatus === "تم الرفض")) {
            document.getElementById("custom-price-field").style.display =
              "flex";
            document.getElementById("modal-price").required = true;
          } else {
            document.getElementById("custom-price-field").style.display =
              "none";
            document.getElementById("modal-price").required = false;
          }

          // إظهار حقل المواد الخام
          document.getElementById("custom-materials-field").style.display =
            isCustom ? "flex" : "none";

          // إظهار حقل سبب الرفض عند الرفض
          if (isCustom && newStatus === "تم الرفض") {
            document.getElementById("rejection-reason-field").style.display =
              "flex";
            document.getElementById("rejection-reason").required = true;
          } else {
            document.getElementById("rejection-reason-field").style.display =
              "none";
            document.getElementById("rejection-reason").required = false;
          }
        };
        // تشغيل المنطق لمرة واحدة عند الفتح للتأكد من الحالة الابتدائية
        document
          .getElementById("modal-status")
          .dispatchEvent(new Event("change"));
      }

      // منطق حفظ الحالة والسعر والمواد الخام المُحسن
      document
        .getElementById("save-status-btn")
        .addEventListener("click", async () => {
          const newStatus = document.getElementById("modal-status").value;
          const finalPrice =
            parseFloat(document.getElementById("modal-price").value) || null;
          const rejectionReason =
            document.getElementById("rejection-reason").value || null;
          const materialListText =
            document.getElementById("material-list").value; // 💡 جلب المواد الخام

          if (!currentOrderData) return;

          let updatePayload = { status: newStatus };

          // 💡 تحديد شروط الخصم: (الطلبات الجاهزة: مقبول)، (الطلبات المخصصة: مقبول-العميل)
          const isReadyOrderForDeduction =
            currentOrderData.type === "ready" && newStatus === "مقبول";
          const isCustomOrderForDeduction =
            currentOrderData.type === "custom" && newStatus === "مقبول-العميل";

          let requiredMaterialsForCustom = [];

          // 💡 منطق الطلبات المخصصة: التحقق من الإدخال اليدوي عند القبول
          if (currentOrderData.type === "custom") {
            if (newStatus === "مقبول") {
              // 1. التحقق من السعر
              if (!finalPrice || finalPrice <= 0) {
                alert("الرجاء إدخال سعر نهائي صحيح للموافقة على طلب التصميم.");
                return;
              }

              // 2. التحقق من المواد الخام
              if (!materialListText) {
                alert(
                  "⚠️ إلزامي: الرجاء إدخال قائمة المواد الخام (ID:Quantity) للطلب المخصص قبل إرسال التسعيرة للعميل (قبول)."
                );
                return;
              }

              // 3. تحليل المواد الخام المُدخلة يدوياً
              const entries = materialListText
                .split(",")
                .map((e) => e.trim())
                .filter((e) => e);

              requiredMaterialsForCustom = entries
                .map((entry) => {
                  const [id, quantityStr] = entry.split(":");
                  const quantity = parseFloat(quantityStr);
                  if (id && !isNaN(quantity) && quantity > 0) {
                    return { id: id.trim(), quantity: quantity };
                  }
                  return null;
                })
                .filter((req) => req !== null);

              if (requiredMaterialsForCustom.length === 0) {
                alert(
                  "⚠️ إلزامي: لم يتم تحليل أي مواد خام صالحة من الإدخال. يرجى التأكد من التنسيق (ID:Quantity)."
                );
                return;
              }

              // 4. تحديث Payload للقبول
              updatePayload.final_price = finalPrice;
              updatePayload.required_materials_for_custom =
                requiredMaterialsForCustom;
              updatePayload.rejection_reason = null;
            } else if (newStatus === "تم الرفض") {
              if (!rejectionReason) {
                alert("الرجاء إدخال سبب للرفض.");
                return;
              }
              updatePayload.final_price = null;
              updatePayload.rejection_reason = rejectionReason;
            } else {
              // للحفاظ على السعر والسبب في حالات النقل بين التنفيذ/المراجعة
              if (currentOrderData.final_price)
                updatePayload.final_price = currentOrderData.final_price;
              if (currentOrderData.rejection_reason)
                updatePayload.rejection_reason =
                  currentOrderData.rejection_reason;
            }
          }

          // 💡 منطق خصم المواد الخام الموحد
          if (isReadyOrderForDeduction || isCustomOrderForDeduction) {
            const batch = writeBatch(db);
            const logCollection = collection(db, "raw_materials_log");

            const deductionSuccessful = await attemptStockDeduction(
              currentOrderData,
              requiredMaterialsForCustom,
              newStatus,
              batch,
              logCollection
            );

            if (!deductionSuccessful) {
              return; // إيقاف العملية إذا كان هناك نقص في المخزون
            }

            const orderRef = doc(db, currentOrderCollection, currentOrderId);
            batch.update(orderRef, updatePayload);

            try {
              await batch.commit();
              alert("✅ تم تحديث الحالة وخصم المواد الخام بنجاح.");
              closeModal("order-details-modal");
              fetchOrders();
            } catch (e) {
              console.error("Error committing batch:", e);
              alert("حدث خطأ أثناء حفظ التغييرات.");
            }
          } else {
            // تحديث بسيط للحالة فقط (بدون خصم)
            const orderRef = doc(db, currentOrderCollection, currentOrderId);
            try {
              await updateDoc(orderRef, updatePayload);
              alert("تم تحديث الحالة بنجاح.");
              closeModal("order-details-modal");
              fetchOrders();
            } catch (e) {
              console.error(e);
              alert("حدث خطأ أثناء حفظ التغييرات.");
            }
          }
        });
    </script>
  </body>
</html>
