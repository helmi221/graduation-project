<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø§Øª Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
      .chat-page-container {
        max-width: 900px;
        margin: 5rem auto;
        padding: 30px;
        background-color: var(--white-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: right;
      }
      .chat-container {
        max-width: 900px;
        margin: 2rem auto 0 auto;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow: hidden;
      }
      .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: 50vh;
        overflow-y: auto;
        padding: 20px;
        background-color: var(--light-color); /* ğŸ’¡ (Ù…Ø¹Ø¯Ù„) */
      }
      .chat-message {
        padding: 12px 18px;
        border-radius: var(--border-radius);
        max-width: 75%;
        line-height: 1.6;
        word-wrap: break-word;
      }
      .user-message {
        background-color: var(--primary-color); /* ğŸ’¡ (Ù…Ø¹Ø¯Ù„) */
        color: white;
        align-self: flex-end;
        border-radius: var(--border-radius) var(--border-radius) 0
          var(--border-radius);
      }
      .ai-message {
        background-color: var(--white-color);
        border: 1px solid var(--border-color);
        align-self: flex-start;
        border-radius: var(--border-radius) var(--border-radius)
          var(--border-radius) 0;
      }
      .chat-input {
        display: flex;
        gap: 10px;
        padding: 15px;
        background-color: var(--white-color);
        border-top: 1px solid var(--border-color);
      }
      .chat-input input {
        flex-grow: 1;
        padding: 12px 18px;
        border-radius: 50px; /* ğŸ’¡ (Ù…Ø¹Ø¯Ù„) */
        border: 1px solid var(--border-color);
        font-family: "Cairo", sans-serif;
        font-size: 1rem;
      }
      .chat-input input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.2);
      }
      .chat-input button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        flex-shrink: 0;
      }
      .chat-input button:hover {
        background-color: var(--dark-color);
      }
      .chat-input button svg {
        width: 20px;
        height: 20px;
      }
      .ai-message.typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #aaa;
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .ai-message.typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .ai-message.typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      /* ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªÙ†Ø³ÙŠÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª */
      .product-link {
        background-color: transparent;
        border: none;
        color: var(--primary-color);
        text-decoration: underline;
        font-weight: bold;
        cursor: pointer;
        padding: 0;
        font-size: inherit;
        font-family: inherit;
      }
      .product-link:hover {
        color: var(--dark-color);
      }
      /* (Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ØªØ£ØªÙŠ Ù…Ù† style.css) */
      .price-container {
        display: flex;
        align-items: baseline;
        gap: 10px;
        margin-bottom: 20px;
      }
      .new-price {
        color: var(--primary-color);
        font-size: 1.8rem;
        font-weight: 700;
      }
      .old-price {
        text-decoration: line-through;
        color: var(--accent-color);
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="index.html" class="logo">FurnAI</a>
        <div class="nav-items">
          <ul class="desktop-nav">
            <li>
              <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </li>
            <li>
              <a href="products.html" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
            </li>
            <li><a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a></li>
            <li>
              <a href="recommendation.html" class="nav-link active"
                >Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</a
              >
            </li>
            <li><a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a></li>
          </ul>

          <div class="auth-nav">
            <a href="cart.html" class="cart-icon-wrapper">
              <i class="fa-solid fa-bag-shopping" id="cart-icon"></i>
              <span id="cart-count-badge">0</span>
            </a>
            <div class="profile-dropdown" id="profile-dropdown">
              <div class="profile-icon">
                <i class="fa-solid fa-user"></i>
              </div>
              <div class="dropdown-menu">
                <div class="dropdown-header">
                  <span id="user-display-name">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</span>
                  <p id="user-email">Ø²Ø§Ø¦Ø±</p>
                </div>
                <a href="login.html" id="auth-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                <a href="#" id="logout-link" style="display: none"
                  >ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
                >
              </div>
            </div>
          </div>

          <button class="menu-toggle" id="menu-toggle">
            <div class="hamburger-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </nav>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="products.html" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</a>
      <a href="order-status.html" class="nav-link">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</a>
      <a href="recommendation.html" class="nav-link">Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</a>
      <a href="design.html" class="nav-link">ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ</a>
    </div>

    <main>
      <div class="container chat-page-container">
        <div class="section-title-wrapper" style="margin-bottom: 1rem">
          <h2>Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</h2>
        </div>
        <p
          style="
            text-align: center;
            color: #777;
            max-width: 600px;
            margin: 0 auto;
          "
        >
          Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ØµÙ Ù„ÙŠ Ù…Ø§ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡ØŒ ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø·Ø¹Ø© Ø§Ù„Ø£Ø«Ø§Ø«
          Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©.
        </p>
        <div class="chat-container" id="chat-box">
          <div class="chat-messages" id="chat-messages">
            <div
              id="typing-indicator"
              class="chat-message ai-message typing-indicator"
              style="display: none"
            >
              <span></span><span></span><span></span>
            </div>
          </div>
          <form class="chat-input" id="chat-form">
            <input
              type="text"
              id="chat-input"
              placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
              autofocus
            />
            <button type="submit">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="white"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
                />
              </svg>
            </button>
          </form>
        </div>
      </div>
    </main>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div class="modal-body">
          <div class="modal-image-col">
            <img id="modal-img" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" />
          </div>
          <div class="modal-details-col">
            <h2 id="modal-title"></h2>
            <div class="price-container">
              <span id="modal-new-price" class="new-price"></span>
              <span id="modal-old-price" class="old-price"></span>
            </div>
            <p id="modal-description"></p>
            <hr class="modal-options-separator" />
            <div class="modal-options">
              <div id="color-section">
                <label for="modal-color-select">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†</label>
                <select id="modal-color-select"></select>
              </div>
              <div>
                <label for="modal-quantity">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <div id="modal-quantity-selector" class="quantity-selector">
                  <button
                    class="quantity-btn quantity-btn-plus"
                    data-change="1"
                  >
                    +
                  </button>
                  <input
                    type="number"
                    id="modal-quantity"
                    value="1"
                    min="1"
                    readonly
                  />
                  <button
                    class="quantity-btn quantity-btn-minus"
                    data-change="-1"
                  >
                    -
                  </button>
                </div>
              </div>
            </div>
            <button class="btn" id="add-to-cart-btn">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

      // (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙƒÙ…Ø§ Ù‡ÙŠ)
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Gemini ÙƒÙ…Ø§ Ù‡ÙŠ)
      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

      let allProducts = [];

      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      const userDisplayName = document.getElementById("user-display-name");
      const userEmail = document.getElementById("user-email");
      const authLink = document.getElementById("auth-link");
      const logoutLink = document.getElementById("logout-link");

      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatMessages = document.getElementById("chat-messages");
      const typingIndicator = document.getElementById("typing-indicator");
      const modal = document.getElementById("product-modal");
      const modalClose = document.querySelector(".modal-close");
      const modalTitle = document.getElementById("modal-title");
      const modalImg = document.getElementById("modal-img");
      const modalNewPrice = document.getElementById("modal-new-price");
      const modalOldPrice = document.getElementById("modal-old-price");
      const modalDesc = document.getElementById("modal-description");
      // ğŸ’¡ (Ø­Ø°Ù) ØªÙ… Ø­Ø°Ù modalSpecs
      const addToCartBtn = document.getElementById("add-to-cart-btn");
      const cartCountBadge = document.getElementById("cart-count-badge");

      let cart = JSON.parse(localStorage.getItem("shoppingCart")) || [];
      let chatHistory = [];
      let currentProduct = null;
      let currentDiscountPrice = null;
      let discountSteps = {};

      const updateCartBadge = () => {
        const totalItems = cart.reduce((s, i) => s + i.quantity, 0);
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.toggle("visible", totalItems > 0);
      };

      const showToast = (message) => {
        const toast = document.getElementById("toast-notification");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      };

      const appendMessage = (sender, text, isHtml = false) => {
        typingIndicator.style.display = "none";
        const el = document.createElement("div");
        el.className = `chat-message ${sender}-message`;
        if (isHtml) {
          el.innerHTML = text;
        } else {
          el.textContent = text;
        }

        if (sender === "ai") {
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = el.innerHTML;

          const availableProducts = allProducts.filter(
            (p) => p.is_available !== false
          );

          availableProducts.forEach((p) => {
            const regex = new RegExp(p.name, "g");
            const link = `<button class="product-link" data-id="${p.id}">
              ${p.name}
              </button>`;
            tempDiv.innerHTML = tempDiv.innerHTML.replace(regex, link);
          });
          el.innerHTML = tempDiv.innerHTML;
        }

        chatMessages.insertBefore(el, typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      const openProductModal = (product) => {
        currentProduct = product;
        const isAvailable = product.is_available !== false;
        addToCartBtn.disabled = !isAvailable;
        addToCartBtn.textContent = isAvailable
          ? "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©"
          : "ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹";

        let priceToUse = product.price;
        if (discountSteps[product.id]) {
          const discountPercentage = discountSteps[product.id];
          priceToUse =
            parseFloat(product.price) * (1 - discountPercentage / 100);
          currentDiscountPrice = priceToUse;
        } else {
          currentDiscountPrice = null;
        }

        modalTitle.textContent = product.name;
        modalImg.src = `images/${product.id}.png`;
        modalImg.onerror = function () {
          this.onerror = null;
          this.src =
            "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&q=80";
        };
        modalDesc.textContent = product.description;

        // (ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙƒÙ…Ø§ Ù‡ÙŠ)
        const colorSection = document.getElementById("color-section");
        const colorSelect = document.getElementById("modal-color-select");
        colorSelect.innerHTML = "";
        if (product.specs && product.specs.includes("Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†:")) {
          const colors = product.specs
            .replace("Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†:", "")
            .split("ØŒ")
            .map((c) => c.trim())
            .filter(Boolean);
          colors.forEach((color) => {
            const option = document.createElement("option");
            option.value = color;
            option.textContent = color;
            colorSelect.appendChild(option);
          });
          colorSection.style.display = "block";
        } else {
          colorSection.style.display = "none";
        }

        // (ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯/Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        if (currentDiscountPrice) {
          modalNewPrice.textContent = `${parseFloat(
            currentDiscountPrice
          ).toFixed(0)} Ø´ÙŠÙƒÙ„`;
          modalOldPrice.textContent = `${parseFloat(product.price).toFixed(
            0
          )} Ø´ÙŠÙƒÙ„`;
          modalOldPrice.style.display = "inline";
        } else {
          modalNewPrice.textContent = `${parseFloat(product.price).toFixed(
            0
          )} Ø´ÙŠÙƒÙ„`;
          modalOldPrice.style.display = "none";
        }

        modal.classList.add("active");
        document.body.classList.add("scroll-lock");
      };

      chatMessages.addEventListener("click", (e) => {
        if (e.target.classList.contains("product-link")) {
          const productId = e.target.dataset.id;
          const product = allProducts.find((p) => p.id == productId);
          if (product) {
            openProductModal(product);
          }
        }
      });

      addToCartBtn.addEventListener("click", () => {
        if (!currentProduct || currentProduct.is_available === false) return;
        const quantity = parseInt(
          document.getElementById("modal-quantity").value,
          10
        );
        const colorSelect = document.getElementById("modal-color-select");
        const color =
          colorSelect.style.display !== "none" ? colorSelect.value : null;

        const priceToUse = currentDiscountPrice || currentProduct.price;
        const existing = cart.find(
          (i) => i.id === currentProduct.id && i.color === color
        );
        if (existing) {
          existing.quantity += quantity;
          existing.price = priceToUse;
        } else {
          const newItem = {
            id: currentProduct.id,
            name: currentProduct.name,
            price: parseFloat(priceToUse),
            originalPrice: currentDiscountPrice ? currentProduct.price : null,
            quantity: quantity,
            color: color,
            image: `images/${currentProduct.id}.png`,
          };
          cart.push(newItem);
        }
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        currentDiscountPrice = null;
        delete discountSteps[currentProduct.id];
        updateCartBadge();
        showToast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        modal.classList.remove("active");
      });

      modalClose.addEventListener("click", () => {
        modal.classList.remove("active");
      });

      const initializeChat = (productsString) => {
        const msg = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹ Ø®Ø¨Ø±Ù†ÙŠ Ø´Ùˆ Ø¨Ø¯ÙƒØŒ ÙˆØ£Ù†Ø§ Ø¨Ø³Ø§Ø¹Ø¯Ùƒ ØªØ®ØªØ§Ø± Ø§Ù„Ø£Ù†Ø³Ø¨ ğŸ˜‰";
        appendMessage("ai", msg);
        chatHistory.push({ role: "model", parts: [{ text: msg }] });
      };

      async function fetchProductsAndStartChat() {
        try {
          const productsSnapshot = await getDocs(collection(db, "products"));
          allProducts = productsSnapshot.docs.map((doc) => ({
            id: parseInt(doc.id),
            ...doc.data(),
            price: parseFloat(doc.data().price),
          }));

          const availableProducts = allProducts.filter(
            (p) => p.is_available !== false
          );
          const productsString = availableProducts
            .map(
              (p) =>
                `${p.name} (Ø§Ù„ÙØ¦Ø©: ${p.category}, Ø§Ù„Ø³Ø¹Ø±: ${p.price}, Ø§Ù„ÙˆØµÙ: ${
                  p.description
                }, Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹: ${p.manufacturing_time_hours || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"})`
            )
            .join(", ");

          initializeChat(productsString);
        } catch (e) {
          console.error("Error fetching products from Firebase: ", e);
          const msg =
            "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.";
          appendMessage("ai", msg);
          chatInput.disabled = true;
          return;
        }
      }

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (allProducts.length === 0) return;

        const availableProducts = allProducts.filter(
          (p) => p.is_available !== false
        );
        const productsString = availableProducts
          .map(
            (p) =>
              `${p.name} (Ø§Ù„ÙØ¦Ø©: ${p.category}, Ø§Ù„Ø³Ø¹Ø±: ${p.price}, Ø§Ù„ÙˆØµÙ: ${
                p.description
              }, Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹: ${p.manufacturing_time_hours || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"})`
          )
          .join(", ");

        const userMsg = chatInput.value.trim();
        if (!userMsg) return;
        appendMessage("user", userMsg);
        chatInput.value = "";
        typingIndicator.style.display = "flex";
        chatHistory.push({ role: "user", parts: [{ text: userMsg }] });

        const discountPrompts = [
          {
            query: "ØºØ§Ù„ÙŠ|Ø§Ù„Ø³Ø¹Ø± Ù…Ø±ØªÙØ¹|Ù…Ø§ Ù…Ø¹ÙŠ|ØªØ®ÙÙŠØ¶|Ø®ØµÙ…",
            discount: 5,
            minPrice: 1000,
          },
          {
            query: "Ø²ÙŠØ§Ø¯Ø© Ø®ØµÙ…|ÙƒÙ…Ø§Ù† Ø®ØµÙ…|Ø®ØµÙ… Ø¥Ø¶Ø§ÙÙŠ|Ø¨ØªÙ‚Ø¯Ø± Ø£ÙƒØ«Ø±",
            discount: 10,
            minPrice: 1000,
          },
          {
            query: "Ø§Ø®Ø± Ø³Ø¹Ø±|Ù…Ø§ÙƒØ³ Ø®ØµÙ…|Ø£ÙƒØ¨Ø± Ø®ØµÙ…",
            discount: 15,
            minPrice: 1000,
          },
        ];

        let aiResponse = "";
        let isDiscountApplied = false;

        for (const prompt of discountPrompts) {
          if (userMsg.match(new RegExp(prompt.query, "i"))) {
            const lastProductMessage = chatHistory
              .slice(-2)
              .find(
                (h) =>
                  h.role === "model" &&
                  h.parts[0].text.includes("ÙŠØ³Ø¹Ø¯Ù†ÙŠ Ø£Ù† Ø£Ù‚Ø¯Ù… Ù„Ùƒ")
              );
            if (lastProductMessage) {
              const lastProductName = availableProducts.find((p) =>
                lastProductMessage.parts[0].text.includes(p.name)
              );
              if (
                lastProductName &&
                lastProductName.price > prompt.minPrice &&
                (!discountSteps[lastProductName.id] ||
                  discountSteps[lastProductName.id] < prompt.discount)
              ) {
                const newPrice =
                  lastProductName.price * (1 - prompt.discount / 100);
                discountSteps[lastProductName.id] = prompt.discount;
                aiResponse = `[Ø¹Ø±Ø¶-Ø®Ø§Øµ: ${lastProductName.name} | ${newPrice}]`;
                isDiscountApplied = true;
                break;
              }
            }
          }
        }

        if (!isDiscountApplied) {
          const chatPrompt = `
              Ø£Ù†Øª "Ø§Ù„Ù†Ø¬Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ"ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ¯ÙˆØ¯ Ù„Ù…ØªØ¬Ø± "FurnAI".
              - ÙƒÙ† ÙˆØ¯ÙˆØ¯Ù‹Ø§ ÙˆÙ…Ø±Ù†Ù‹Ø§ ÙÙŠ Ø§Ù„Ø­ÙˆØ§Ø±.
              - Ø§Ù‚ØªØ±Ø­ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: ${productsString}.
              - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø± Ø¹Ø§Ù„ÙŠÙ‹Ø§ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø®ØµÙ… ÙŠØµÙ„ Ø­ØªÙ‰ 15%.
              - Ù„Ø§ ØªÙ‚Ø¯Ù… Ø§Ù„Ø®ØµÙ… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙØ§ÙˆØ¶ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ (5% Ø«Ù… 10% Ø«Ù… 15% ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰).
              - Ù„Ø§ ØªÙ‚Ø¯Ù… Ø®ØµÙ…Ù‹Ø§ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø³Ø¹Ø±Ù‡ Ø¹Ù† 1000 Ø´ÙŠÙƒÙ„.
              - **Ø¹Ù†Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¯Ù‚Ø©: [Ø¹Ø±Ø¶-Ø®Ø§Øµ: <Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬> | <Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯>]**
              - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø§ ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø£ÙŠ Ù…Ù†ØªØ¬ Ù…Ù† Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ØŒ Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡Ù‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© "ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ" Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø±Ø¶ Ø£Ù‚Ø±Ø¨ Ù…Ù†ØªØ¬):
              "ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø·Ù„Ø¨Ùƒ Ù…Ù…ÙŠØ² Ø¬Ø¯Ø§Ù‹! ğŸ¤© ÙŠÙ…ÙƒÙ†Ù†Ø§ ØµÙ†Ø§Ø¹Ø© Ù…Ù†ØªØ¬ Ø®ØµÙŠØµØ§Ù‹ Ù„Ùƒ. ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© "ØµÙ…Ù… Ù…Ù†ØªØ¬Ùƒ" Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…ÙˆØ§ØµÙØ§ØªÙƒ."
              
              Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:
              ${chatHistory
                .map((h) => `${h.role}: ${h.parts[0].text}`)
                .join("\n")}
            `;

          try {
            const result = await model.generateContent(chatPrompt);
            aiResponse = result.response.text();
          } catch (error) {
            console.error("AI Response Error:", error);
            aiResponse = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¯ ğŸ˜… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.";
          }
        }

        let displayResponse = aiResponse;
        const offerRegex = /\[Ø¹Ø±Ø¶-Ø®Ø§Øµ:\s*(.*?)\s*\|\s*([\d.]+)\s*\]/;
        const offerMatch = aiResponse.match(offerRegex);

        if (offerMatch && offerMatch[1] && offerMatch[2]) {
          const productName = offerMatch[1].trim();
          const newPrice = parseFloat(offerMatch[2]);
          const product = allProducts.find((p) => p.name === productName);

          if (product && !isNaN(newPrice)) {
            currentDiscountPrice = newPrice;
            discountSteps[product.id] = parseFloat(
              ((product.price - newPrice) / product.price) * 100
            ).toFixed(0);
            const discountPercentage = discountSteps[product.id];

            displayResponse = `
                <p>${aiResponse.replace(offerMatch[0], "").trim()}</p>
                <p>ÙŠØ³Ø¹Ø¯Ù†ÙŠ Ø£Ù† Ø£Ù‚Ø¯Ù… Ù„Ùƒ **Ø®ØµÙ…Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§** Ø¹Ù„Ù‰ ${product.name}! âœ¨</p>
                <p>Ø§Ù„Ø®ØµÙ…: **${discountPercentage}%**</p>
                <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯: **${newPrice.toFixed(0)} Ø´ÙŠÙƒÙ„**</p>
              `;
          } else {
            console.error("Product not found or new price is invalid.");
            displayResponse = `<p>${aiResponse}</p>`;
          }
        }

        appendMessage("ai", displayResponse, true);
        chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
        typingIndicator.style.display = "none";
      });

      // ====== Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø³ÙƒØ±Ø¨Øª ======
      document.addEventListener("DOMContentLoaded", () => {
        // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            let userName = "Ù…Ø³ØªØ®Ø¯Ù…";
            if (userDocSnap.exists()) {
              userName = userDocSnap.data().name || userName;
            }
            userDisplayName.textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + userName;
            userEmail.textContent = user.email;
            authLink.style.display = "none";
            logoutLink.style.display = "block";
            logoutLink.onclick = async (e) => {
              e.preventDefault();
              await signOut(auth);
              window.location.href = "index.html";
            };
          } else {
            userDisplayName.textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ";
            userEmail.textContent = "Ø²Ø§Ø¦Ø±";
            authLink.style.display = "block";
            logoutLink.style.display = "none";
          }
        });
        updateCartBadge();
        fetchProductsAndStartChat();

        // (Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ)
        const menuToggle = document.getElementById("menu-toggle");
        const mobileMenu = document.getElementById("mobile-menu");
        const body = document.body;
        menuToggle.addEventListener("click", () => {
          mobileMenu.classList.toggle("active");
          body.classList.toggle("scroll-lock");
        });
      });
    </script>
  </body>
</html>
