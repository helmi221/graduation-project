<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ููุฌุฑุฉ | ููุญุฉ ุงููุฏูุฑ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      /* ุชูุณูู ุฎุงุต ููุฑุณูู ุงูุจูุงููุฉ */
      .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 30px;
      }
      .chart-card {
        background-color: var(--white-color);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }
      .chart-card h3 {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: var(--dark-color);
        text-align: right;
      }
      @media (max-width: 900px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">ููุฌุฑุฉ</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html" class="active"
              ><i class="fa-solid fa-gauge-high"></i> ููุญุฉ ุงูุชุญูู</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> ุฅุฏุงุฑุฉ ุงูููุงุฏ ุงูุฎุงู</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> ุงูุชูุงููู ุงูุซุงุจุชุฉ</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> ุฅุฏุงุฑุฉ ุงูุนููุงุก</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>ูุฑุญุจุงู ุจู ูู ููุญุฉ ุงููุฏูุฑ</h1>

      <div class="dashboard-stats">
        <div class="stat-card new-orders">
          <div class="stat-icon"><i class="fa-solid fa-receipt"></i></div>
          <div class="stat-info">
            <h3><span id="new-orders-count">0</span></h3>
            <p>ุทูุจุงุช ุฌุฏูุฏุฉ ููุฏ ุงููุฑุงุฌุนุฉ</p>
          </div>
        </div>
        <div class="stat-card in-progress">
          <div class="stat-icon"><i class="fa-solid fa-gears"></i></div>
          <div class="stat-info">
            <h3><span id="in-progress-count">0</span></h3>
            <p>ุทูุจุงุช ููุฏ ุงูุนูู</p>
          </div>
        </div>
        <div class="stat-card completed">
          <div class="stat-icon"><i class="fa-solid fa-dollar-sign"></i></div>
          <div class="stat-info">
            <h3><span id="inventory-value">0</span> โช</h3>
            <p>ุงููููุฉ ุงูุฅุฌูุงููุฉ ูููุฎุฒูู</p>
          </div>
        </div>
        <div class="stat-card" style="border-left-color: var(--danger-color)">
          <div class="stat-icon" style="color: var(--danger-color)">
            <i class="fa-solid fa-boxes-stacked"></i>
          </div>
          <div class="stat-info">
            <h3><span id="low-stock-count">0</span></h3>
            <p>ุงูููุงุฏ ุงูุฎุงู ุงูููุฎูุถุฉ</p>
          </div>
        </div>
      </div>

      <div class="admin-panel quick-links-section" style="padding-bottom: 30px">
        <h2 style="text-align: right; margin-bottom: 20px">
          ููุฎุต ุงูุฃุฏุงุก ูุงูุชุญููู
        </h2>

        <div class="charts-grid">
          <div class="chart-card">
            <h3><i class="fa-solid fa-chart-pie"></i> ุชูุฒูุน ุญุงูุงุช ุงูุทูุจุงุช</h3>
            <canvas id="orderStatusChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>
              <i class="fa-solid fa-chart-bar"></i> ุงูุฑุจุญ ุงูุฅุฌูุงูู ุญุณุจ ุงููุฆุฉ
            </h3>
            <canvas id="categoryProfitChart"></canvas>
          </div>
        </div>
      </div>

      <div class="admin-panel quick-links-section" style="margin-top: 30px">
        <h2 style="margin-bottom: 20px">ุฑูุงุจุท ุณุฑูุนุฉ ูุชุญูู</h2>
        <div class="quick-links-grid">
          <a href="orders_admin.html" class="quick-link-card">
            <i class="fa-solid fa-box-open"></i>
            <h3>ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</h3>
          </a>
          <a
            href="inventory.html"
            class="quick-link-card"
            style="background-color: var(--success-color)"
          >
            <i class="fa-solid fa-warehouse"></i>
            <h3>ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</h3>
          </a>
          <a
            href="raw_materials_admin.html"
            class="quick-link-card"
            style="background-color: var(--warning-color)"
          >
            <i class="fa-solid fa-hammer"></i>
            <h3>ุฅุฏุงุฑุฉ ุงูููุงุฏ ุงูุฎุงู</h3>
          </a>
          <a
            href="fixed_costs_admin.html"
            class="quick-link-card"
            style="background-color: var(--accent-1)"
          >
            <i class="fa-solid fa-calculator"></i>
            <h3>ุงูุชูุงููู ุงูุซุงุจุชุฉ</h3>
          </a>
          <a
            href="customers_admin.html"
            class="quick-link-card"
            style="background-color: var(--primary-color)"
          >
            <i class="fa-solid fa-users"></i>
            <h3>ุฅุฏุงุฑุฉ ุงูุนููุงุก</h3>
          </a>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        query,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // ๐ ุฅุนุฏุงุฏุงุช Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let rawMaterialsMap = new Map(); // ูุชุฎุฒูู ุงูููุงุฏ ุงูุฎุงู ูุญููุงู
      let allProducts = []; // ูุชุฎุฒูู ุงูููุชุฌุงุช ูุญููุงู

      // --------------------------------------------------------
      // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุงูุชุญููู
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === "admin") {
              await fetchProductsAndMaterials();
              fetchStats();
            } else {
              alert("ุบูุฑ ูุตุฑุญ ูู ุจุงููุตูู ุฅูู ูุฐู ุงูุตูุญุฉ.");
              window.location.href = "login.html";
            }
          } catch (e) {
            console.error("Error checking role:", e);
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      // --------------------------------------------------------
      // ุฏุงูุฉ ูุณุงุนุฏุฉ: ุฌูุจ ุงูููุงุฏ ุงูุฎุงู ูุงูููุชุฌุงุช (ูุชุญููู ุงูุฑุจุญูุฉ)
      // --------------------------------------------------------
      async function fetchProductsAndMaterials() {
        const [materialsSnap, productsSnap] = await Promise.all([
          getDocs(collection(db, "raw_materials")),
          getDocs(collection(db, "products")),
        ]);

        rawMaterialsMap.clear();
        materialsSnap.docs.forEach((d) => {
          rawMaterialsMap.set(d.id, {
            ...d.data(),
            cost_per_unit: parseFloat(d.data().cost_per_unit || 0),
            total_cost_value: parseFloat(d.data().total_cost_value || 0),
          });
        });

        allProducts = productsSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
          price: parseFloat(d.data().price || 0),
          total_cost: parseFloat(d.data().total_cost || 0), // TCOGS
          // Total cost (TCOGS) is calculated/stored in inventory.html
        }));
      }

      // --------------------------------------------------------
      // ูุธููุฉ ุฌูุจ ุงูุฅุญุตุงุฆูุงุช ูุจูุงุก ุงูุฑุณูู ุงูุจูุงููุฉ
      // --------------------------------------------------------
      async function fetchStats() {
        const newOrdersCount = document.getElementById("new-orders-count");
        const inProgressCount = document.getElementById("in-progress-count");
        const lowStockCount = document.getElementById("low-stock-count");
        const inventoryValueDisplay =
          document.getElementById("inventory-value");

        try {
          // 1. ุฅุญุตุงุฆูุงุช ุงูุทูุจุงุช
          const ordersCollection = collection(db, "orders");
          const customDesignsCollection = collection(db, "custom_designs");

          const [ordersSnapshot, customDesignsSnapshot] = await Promise.all([
            getDocs(ordersCollection),
            getDocs(customDesignsCollection),
          ]);

          const allOrders = [
            ...ordersSnapshot.docs.map((doc) => doc.data()),
            ...customDesignsSnapshot.docs.map((doc) => doc.data()),
          ];

          let newOrders = 0;
          let inProgress = 0;
          let completed = 0;
          let rejected = 0;
          let totalOrders = allOrders.length;

          let categoryProfits = {}; // ูุชุฌููุน ุงูุฑุจุญ ุญุณุจ ุงููุฆุฉ

          allOrders.forEach((o) => {
            const status = o.status;

            // ุญุณุงุจ ุญุงูุงุช ุงูุทูุจุงุช
            if (status === "ููุฏ ุงููุฑุงุฌุนุฉ" || status === "ููุจูู") {
              newOrders++;
            } else if (
              [
                "ููุจูู-ุงูุนููู",
                "ููุฏ ุงูุชุตููุน",
                "ููุฏ ุงูุทูุงุก",
                "ููุฏ ุงูุชุบููู",
                "ููุฏ ุงูุดุญู",
              ].includes(status)
            ) {
              inProgress++;
            } else if (status === "ููุชูู") {
              completed++;
            } else if (
              status === "ุชู ุงูุฑูุถ" ||
              status === "ูุฑููุถ-ุงูุนููู" ||
              status === "ูุคุฑุดู"
            ) {
              rejected++;
            }

            // ุญุณุงุจ ุงูุฑุจุญ (ููุทูุจุงุช ุงูููุชููุฉ)
            if (status === "ููุชูู") {
              const totalRevenue = parseFloat(o.total || o.final_price || 0); // ุงูุฅูุฑุงุฏ

              // ุงูุจุญุซ ุนู ุชูููุฉ ุงูููุชุฌ ุฃู ุงูููุงุฏ (ุชุญุชุงุฌ ููุทู ุฏููู ููุถู ุฃู ูููู ูู ูุซููุฉ ุงูุทูุจ)
              let totalCOGS = 0;

              if (o.type === "ready" && o.items) {
                o.items.forEach((item) => {
                  const productData = allProducts.find((p) => p.id == item.id);
                  if (productData) {
                    totalCOGS +=
                      (productData.total_cost || 0) * (item.quantity || 1);
                  }
                });

                const category = o.items[0]?.category || "ุบูุฑ ูุญุฏุฏ";
                const profit = totalRevenue - totalCOGS;

                if (!categoryProfits[category]) categoryProfits[category] = 0;
                categoryProfits[category] += profit;
              } else if (o.type === "custom" && o.final_price) {
                // ููุทูุจุงุช ุงููุฎุตุตุฉ ูุณุชุฎุฏู ูุงูุด ุฑุจุญ ุชูุฏูุฑู ุฃู ูููุฉ TCOGS ุงููุฎุฒูุฉ ุฅุฐุง ูุงูุช ูุชููุฑุฉ
                // ูุซุงู: ุงูุชุฑุงุถ ุฃู 25% ูู ุงูุณุนุฑ ุงูููุงุฆู ูู ูุงูุด ุฑุจุญ ุชุดุบููู
                // ูุฐุง ูุซุงู ุชุจุณูุทูุ ููุถู ุญูุธ ุงูู TCOGS ูู ูุซููุฉ ุงูุทูุจ ุงููุฎุตุต ุจุนุฏ ูุจููู
                const estimatedProfit = totalRevenue * 0.25;
                const category = o.type_of_product || "ุชุตููู ูุฎุตุต";

                if (!categoryProfits[category]) categoryProfits[category] = 0;
                categoryProfits[category] += estimatedProfit;
              }
            }
          });

          newOrdersCount.textContent = newOrders;
          inProgressCount.textContent = inProgress;

          // 2. ุฅุญุตุงุฆูุงุช ุงูููุงุฏ ุงูุฎุงู
          const materialsSnapshot = await getDocs(
            collection(db, "raw_materials")
          );
          let lowStock = 0;
          let totalInventoryValue = 0;

          materialsSnapshot.docs.forEach((doc) => {
            const data = doc.data();
            const currentStock = parseFloat(data.current_stock || 0);
            const reorderPoint = parseFloat(data.reorder_point || 0);
            const totalCostValue = parseFloat(data.total_cost_value || 0);

            if (currentStock <= reorderPoint) {
              lowStock++;
            }
            totalInventoryValue += totalCostValue;
          });

          lowStockCount.textContent = lowStock;
          inventoryValueDisplay.textContent = totalInventoryValue
            .toFixed(0)
            .replace(/\B(?=(\d{3})+(?!\d))/g, ","); // ุชูุณูู ุงูุนููุฉ

          // 3. ุจูุงุก ุงูุฑุณูู ุงูุจูุงููุฉ
          renderOrderStatusChart(newOrders, inProgress, completed, rejected);
          renderCategoryProfitChart(categoryProfits);
        } catch (e) {
          console.error("Error fetching stats:", e);
          newOrdersCount.textContent =
            inProgressCount.textContent =
            lowStockCount.textContent =
            inventoryValueDisplay.textContent =
              "ุฎุทุฃ";
        }
      }

      // --------------------------------------------------------
      // ุจูุงุก ูุฎุทุท ุญุงูุฉ ุงูุทูุจุงุช (ุงูุฏุงุฆุฑู)
      // --------------------------------------------------------
      function renderOrderStatusChart(
        newOrders,
        inProgress,
        completed,
        rejected
      ) {
        const ctx = document.getElementById("orderStatusChart");

        const data = {
          labels: ["ููุฏ ุงููุฑุงุฌุนุฉ/ููุจูู", "ููุฏ ุงูุชูููุฐ", "ููุชูู", "ูุฑููุถ/ูุคุฑุดู"],
          datasets: [
            {
              data: [newOrders, inProgress, completed, rejected],
              backgroundColor: [
                "#ffc107", // Warning (ููุฏ ุงููุฑุงุฌุนุฉ)
                "#0d6efd", // Info (ููุฏ ุงูุชูููุฐ)
                "#198754", // Success (ููุชูู)
                "#dc3545", // Danger (ูุฑููุถ)
              ],
              hoverOffset: 4,
            },
          ],
        };

        new Chart(ctx, {
          type: "pie",
          data: data,
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
                labels: {
                  font: {
                    family: "Cairo",
                  },
                },
              },
              title: {
                display: false,
              },
            },
          },
        });
      }

      // --------------------------------------------------------
      // ุจูุงุก ูุฎุทุท ุฑุจุญูุฉ ูุฆุงุช ุงูููุชุฌุงุช (ุงูุนููุฏู)
      // --------------------------------------------------------
      function renderCategoryProfitChart(categoryProfits) {
        const ctx = document.getElementById("categoryProfitChart");
        const categories = Object.keys(categoryProfits);
        const profits = Object.values(categoryProfits);

        const data = {
          labels: categories,
          datasets: [
            {
              label: "ุฅุฌูุงูู ุงูุฑุจุญ (โช)",
              data: profits,
              backgroundColor: "#8d6e63", // ููู ุจูู ุฏุงูู (Primary color)
              borderColor: "#795548",
              borderWidth: 1,
            },
          ],
        };

        new Chart(ctx, {
          type: "bar",
          data: data,
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "ูููุฉ ุงูุฑุจุญ (ุดููู)",
                  font: {
                    family: "Cairo",
                  },
                },
                ticks: {
                  font: {
                    family: "Cairo",
                  },
                },
              },
              x: {
                ticks: {
                  font: {
                    family: "Cairo",
                  },
                },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
