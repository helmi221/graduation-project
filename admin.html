<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      /* (Ù†ÙØ³ ÙƒÙˆØ¯ ×”-CSS Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ - Ù„Ù… ÙŠØªØºÙŠØ±) */
      .stat-card .stat-info h3 {
        font-size: 2rem;
      }
      .smart-alert {
        padding: 20px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .smart-alert i {
        font-size: 2rem;
      }
      .smart-alert.success {
        background-color: #e8f5e9;
        border: 2px solid var(--success-color);
        color: #2e7d32;
      }
      .smart-alert.warning {
        background-color: #fff8e1;
        border: 2px solid var(--warning-color);
        color: #f57f17;
      }
      .smart-alert.danger {
        background-color: #fbe9e7;
        border: 2px solid var(--danger-color);
        color: #c62828;
      }
      .smart-alert p {
        margin: 0;
      }
      .smart-alert strong {
        font-weight: 800;
      }
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 20px;
      }
      .grid-span-2 {
        grid-column: span 2;
      }
      .grid-span-1 {
        grid-column: span 1;
      }
      .data-card {
        background-color: var(--white-color);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
      }
      .data-card h3 {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: var(--dark-color);
        text-align: right;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .tasks-list {
        list-style: none;
        padding: 0;
      }
      .tasks-list li {
        margin-bottom: 15px;
      }
      .tasks-list a {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #fdfcfb;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        transition: all 0.2s ease;
      }
      .tasks-list a:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        border-color: var(--primary-color);
      }
      .tasks-list .task-text i {
        margin-left: 10px;
        color: var(--primary-color);
      }
      .tasks-list .task-count {
        background-color: var(--danger-color);
        color: white;
        font-size: 1rem;
        font-weight: 700;
        padding: 2px 10px;
        border-radius: 20px;
      }
      .tasks-list a[href*="raw_materials"] .task-count,
      .tasks-list a[href*="suppliers"] .task-count {
        background-color: var(--warning-color);
      }
      .data-list {
        list-style: none;
        padding: 0;
      }
      .data-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
        padding: 10px 0;
        border-bottom: 1px dashed #eee;
      }
      .data-list li:last-child {
        border-bottom: none;
      }
      .data-list .item-name {
        font-weight: 600;
      }
      .data-list .item-value {
        font-weight: 700;
        color: var(--primary-color);
      }
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        .grid-span-1,
        .grid-span-2 {
          grid-column: span 1;
        }
      }
      #forecast-card .btn {
        width: 100%;
      }
      #forecast-results {
        margin-top: 15px;
        background-color: #f7f5f2;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        min-height: 100px;
      }
      #forecast-factors-container h4 {
        color: var(--dark-color);
        margin-bottom: 10px;
      }
      #forecast-factors {
        list-style: none;
        padding-right: 15px;
        font-size: 0.95rem;
        color: #333;
      }
      #forecast-factors li {
        margin-bottom: 8px;
        line-height: 1.6;
      }
      #forecast-factors li i {
        margin-left: 8px;
        color: var(--info-color);
      }
      #forecast-summary {
        font-weight: 600;
        border-top: 1px dashed var(--primary-color);
        padding-top: 15px;
        margin-top: 15px;
        line-height: 1.7;
        color: var(--dark-color);
      }
      #forecast-summary strong {
        color: var(--primary-color);
      }

      /* (Ø¬Ø¯ÙŠØ¯) Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ù„Ù…Ø­Ù„Ù„ */
      .ai-fab {
        position: fixed;
        bottom: 30px;
        left: 30px;
        width: 60px;
        height: 60px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        z-index: 1900;
        transition: all 0.3s ease;
      }
      .ai-fab:hover {
        background-color: var(--dark-color);
        transform: scale(1.1);
      }
      #ai-analyst-modal .modal-content {
        max-width: 700px;
        height: 70vh;
        display: flex;
        flex-direction: column;
        padding: 0;
      }
      #ai-analyst-modal h2 {
        text-align: right;
        padding: 20px 30px;
        margin: 0;
        font-size: 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }
      #ai-analyst-modal .modal-close {
        top: 20px;
        left: 25px;
        right: auto;
      }
      .ai-chat-messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background-color: #f7f5f2;
      }
      .ai-chat-message {
        padding: 10px 15px;
        border-radius: 12px;
        max-width: 85%;
        line-height: 1.6;
        word-wrap: break-word;
      }
      .ai-chat-message.user-message {
        background-color: var(--info-color);
        color: white;
        align-self: flex-end;
      }
      .ai-chat-message.ai-message {
        background-color: var(--white-color);
        border: 1px solid #ddd;
        align-self: flex-start;
      }
      .ai-chat-message.ai-message ul {
        padding-right: 20px;
        margin-top: 10px;
      }
      .ai-chat-message.ai-message strong {
        color: var(--primary-color);
      }
      .ai-chat-message.typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #aaa;
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .ai-chat-message.typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .ai-chat-message.typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      .ai-chat-input {
        display: flex;
        gap: 10px;
        padding: 20px;
        border-top: 1px solid var(--border-color);
      }
      .ai-chat-input input {
        flex-grow: 1;
        padding: 12px;
        border-radius: 25px;
        border: 1px solid #ccc;
        font-family: "Cairo", sans-serif;
        font-size: 1rem;
      }
      .ai-chat-input button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
      }
      .ai-chat-input button svg {
        width: 20px;
        height: 20px;
      }

      /* ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙÙ„ØªØ± ÙˆØ§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ† */
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 1.5rem;
      }
      .dashboard-header h1 {
        margin-bottom: 0;
      }
      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .filter-group label {
        font-weight: 600;
        font-size: 1.1rem;
      }
      #period-filter {
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        background-color: var(--white-color);
        font-family: "Cairo", sans-serif;
      }
      .log-toggle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background-color: var(--white-color);
        padding: 15px 20px;
        border-radius: 8px;
        margin-top: 30px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
      }
      .log-toggle-header h2 {
        margin: 0;
        font-size: 1.4rem;
        text-align: right;
        color: var(--primary-color);
      }
      .log-content-wrapper {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        /* (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ© ÙˆØ­Ø¯ÙˆØ¯ Ù„Ù„ØªÙ…ÙŠÙŠØ² */
        background-color: #fcfcfc;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 0 20px;
      }
      .log-content-wrapper.active {
        display: block;
        max-height: 5000px; /* Ù‚ÙŠÙ…Ø© ÙƒØ¨ÙŠØ±Ø© Ø¨Ù…Ø§ ÙŠÙƒÙÙŠ */
        transition: max-height 0.6s ease-in;
        padding: 20px 20px;
      }
      .log-toggle-icon {
        transition: transform 0.3s;
        font-size: 1.2rem;
      }
      .log-toggle-header[aria-expanded="true"] .log-toggle-icon {
        transform: rotate(90deg);
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html" class="active"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html"
              ><i class="fa-solid fa-truck-fast"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="strategy_admin.html"
              ><i class="fa-solid fa-lightbulb"></i> Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <div class="dashboard-header">
        <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ°ÙƒØ§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</h1>
        <div class="filter-group">
          <label for="period-filter">
            <i class="fa-solid fa-calendar-days"></i> Ø¹Ø±Ø¶ Ù…Ù‚Ø§ÙŠÙŠØ³:
          </label>
          <select id="period-filter">
            <option value="monthly" selected>Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
            <option value="quarterly">Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹</option>
            <option value="all">ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
          </select>
        </div>
      </div>

      <div class="smart-alert" id="smart-alert-box" style="display: none">
        <i class="fa-solid fa-circle-info" id="smart-alert-icon"></i>
        <p id="smart-alert-message">Ø¬Ø§Ø±Ù ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ...</p>
      </div>

      <div class="dashboard-stats">
        <div class="stat-card" style="border-left-color: var(--success-color)">
          <div class="stat-icon" style="color: var(--success-color)">
            <i class="fa-solid fa-chart-line"></i>
          </div>
          <div class="stat-info">
            <h3><span id="total-revenue">0</span> â‚ª</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©)</p>
          </div>
        </div>
        <div class="stat-card" style="border-left-color: var(--warning-color)">
          <div class="stat-icon" style="color: var(--warning-color)">
            <i class="fa-solid fa-boxes-stacked"></i>
          </div>
          <div class="stat-info">
            <h3><span id="total-cogs">0</span> â‚ª</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (COGS)</p>
          </div>
        </div>
        <div class="stat-card" style="border-left-color: var(--primary-color)">
          <div class="stat-icon" style="color: var(--primary-color)">
            <i class="fa-solid fa-percent"></i>
          </div>
          <div class="stat-info">
            <h3><span id="gross-profit">0</span> â‚ª</h3>
            <p>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª - COGS)</p>
          </div>
        </div>
        <div
          class="stat-card"
          style="border-left-color: var(--info-color)"
          id="net-profit-container"
        >
          <div class="stat-icon" style="color: var(--info-color)">
            <i class="fa-solid fa-money-bill-trend-up"></i>
          </div>
          <div class="stat-info">
            <h3><span id="net-profit">0</span> â‚ª</h3>
            <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ (Ø¨Ø¹Ø¯ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©)</p>
          </div>
        </div>
      </div>

      <div class="dashboard-grid" style="grid-template-columns: 1fr">
        <div class="grid-span-1">
          <div class="data-card" id="tasks-card">
            <h3><i class="fa-solid fa-triangle-exclamation"></i> Ù…Ù‡Ø§Ù… Ø¹Ø§Ø¬Ù„Ø©</h3>
            <ul class="tasks-list">
              <li>
                <a href="orders_admin.html">
                  <span class="task-text"
                    ><i class="fa-solid fa-receipt"></i> Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù‚ÙŠØ¯
                    Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span
                  >
                  <span class="task-count" id="pending-orders-count">0</span>
                </a>
              </li>
              <li>
                <a href="raw_materials_admin.html">
                  <span class="task-text"
                    ><i class="fa-solid fa-warehouse"></i> Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… ÙˆØµÙ„Øª Ù„Ù†Ù‚Ø·Ø©
                    Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</span
                  >
                  <span class="task-count" id="low-stock-count">0</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div
        class="log-toggle-header"
        id="analytics-toggle-header"
        aria-expanded="false"
      >
        <h2>
          <i class="fa-solid fa-chart-pie"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© ÙˆØ§Ù„Ø±Ø³ÙˆÙ…
          Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        </h2>
        <i class="fa-solid fa-chevron-left log-toggle-icon"></i>
      </div>
      <div
        id="analytics-content-wrapper"
        class="log-content-wrapper"
        aria-expanded="false"
      >
        <div class="dashboard-grid">
          <div class="grid-span-2">
            <div class="data-card" id="forecast-card">
              <h3>
                <i class="fa-solid fa-brain"></i> ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ù‚Ø§Ø¯Ù…)
              </h3>
              <p style="color: #555; margin-bottom: 15px">
                Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ØŒ
                Ø§Ù„Ø³ÙŠØ§Ø³Ø©ØŒ Ø§Ù„Ù…ÙˆØ§Ø³Ù…) ÙˆØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø£Ø±Ø¨Ø§Ø­Ùƒ.
              </p>
              <button class="btn btn-secondary" id="run-forecast-btn">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„
                Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª
              </button>
              <div id="forecast-results" style="display: none">
                <p class="loading-msg" id="forecast-loading">
                  <i class="fa-solid fa-spinner fa-spin"></i>
                  Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„...
                </p>
                <div id="forecast-content" style="display: none"></div>
              </div>
            </div>
          </div>

          <div class="grid-span-1">
            <div class="data-card">
              <h3><i class="fa-solid fa-star"></i> Ø£ÙØ¶Ù„ 5 Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3>
              <ul class="data-list" id="top-products-list"></ul>
            </div>
            <div class="data-card">
              <h3><i class="fa-solid fa-user-check"></i> Ø£ÙØ¶Ù„ 5 Ø¹Ù…Ù„Ø§Ø¡</h3>
              <ul class="data-list" id="top-customers-list"></ul>
            </div>

            <div class="data-card">
              <h3><i class="fa-solid fa-chart-pie"></i> ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
              <canvas id="orderStatusChart"></canvas>
            </div>
            <div class="data-card">
              <h3>
                <i class="fa-solid fa-chart-bar"></i> Ø§Ù„Ø±Ø¨Ø­ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (Ù…ÙƒØªÙ…Ù„)
              </h3>
              <canvas id="categoryProfitChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button class="ai-fab" id="ai-analyst-fab" title="Ø§Ø³Ø£Ù„ Ù…Ø­Ù„Ù„ Ø§Ù„FurnAI">
      <i class="fa-solid fa-brain"></i>
    </button>

    <div id="ai-analyst-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close" id="ai-analyst-close"
          ><i class="fa-solid fa-xmark"></i
        ></span>
        <h2><i class="fa-solid fa-brain"></i> Ù…Ø­Ù„Ù„ Ø§Ù„FurnAI</h2>
        <div class="ai-chat-messages" id="ai-analyst-messages"></div>
        <form class="ai-chat-input" id="ai-analyst-form">
          <input
            type="text"
            id="ai-analyst-input"
            placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (Ù…Ø«Ø§Ù„: Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ø±Ø¨Ø­ÙŠØ©ØŸ)"
            autofocus
          />
          <button type="submit" id="ai-analyst-submit-btn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="white"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
              />
            </svg>
          </button>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        query,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

      // ğŸ›‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      // ğŸ›‘ ğŸ’¡ (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹) Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø®Ø§Øµ
      const API_KEY = "AIzaSyBcFkJsomDYhm1uGqoq3-8mHr0LTu-mZ9s"; // âš ï¸âš ï¸âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§
      const genAI = new GoogleGenerativeAI(API_KEY);

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
      const forecastAiModel = genAI.getGenerativeModel({
        model: "gemini-2.5-flash",
        tools: {
          googleSearch: {},
        },
      });
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¹Ø§Ù… ÙˆÙ„ÙˆØ¬ Ù„Ù„ÙˆÙŠØ¨
      const analystAiModel = genAI.getGenerativeModel({
        model: "gemini-2.5-flash",
        tools: {
          googleSearch: {},
        },
      });

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let allProductsMap = new Map();
      let allCustomersMap = new Map();
      let allRawMaterials = [];

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ù„ÙˆØ¨Ø§Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      let currentTotalRevenue = 0;
      let currentGrossProfit = 0;
      let currentNetProfit = 0;
      let currentFixedCosts = 0;
      let currentTotalCOGS = 0; // ğŸ’¡ (Ø¥ØµÙ„Ø§Ø­) Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù†Ø§Ù‚Øµ
      let currentPendingOrders = 0;
      let currentLowStock = 0;
      let currentTopProducts = [];
      let currentTopCustomers = [];
      let aiAnalystChatHistory = [];

      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙÙ„ØªØ± ÙˆØ§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ†
      const periodFilter = document.getElementById("period-filter");
      const analyticsToggleHeader = document.getElementById(
        "analytics-toggle-header"
      );
      const analyticsContentWrapper = document.getElementById(
        "analytics-content-wrapper"
      );

      // --------------------------------------------------------
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === "admin") {
              if (API_KEY === "YOUR_REAL_API_KEY_HERE") {
                alert(
                  "ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Gemini ÙÙŠ Ù…Ù„Ù admin.html (Ø§Ù„Ø³Ø·Ø± 321) Ù„ÙƒÙŠ ØªØ¹Ù…Ù„ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ."
                );
              }
              await fetchCoreData();
              // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
              fetchStats(periodFilter.value);
              // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª
              setupListeners();
            } else {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
              window.location.href = "login.html";
            }
          } catch (e) {
            console.error("Error checking role:", e);
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª
      function setupListeners() {
        // Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ÙÙ„ØªØ±
        periodFilter.addEventListener("change", (e) => {
          fetchStats(e.target.value);
        });

        // Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ†
        analyticsToggleHeader.addEventListener("click", () => {
          const isExpanded =
            analyticsToggleHeader.getAttribute("aria-expanded") === "true";
          analyticsToggleHeader.setAttribute("aria-expanded", !isExpanded);
          analyticsContentWrapper.classList.toggle("active");
        });

        // (Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
        document
          .getElementById("run-forecast-btn")
          .addEventListener("click", runProfitForecast);
        setupAiAnalyst();
      }

      // --------------------------------------------------------
      // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ÙƒÙ…Ø§ Ù‡ÙŠ)
      // --------------------------------------------------------
      async function fetchCoreData() {
        const [materialsSnap, productsSnap, customersSnap] = await Promise.all([
          getDocs(collection(db, "raw_materials")),
          getDocs(collection(db, "products")),
          getDocs(collection(db, "users")),
        ]);
        allRawMaterials = materialsSnap.docs.map((d) => ({
          ...d.data(),
          current_stock: parseFloat(d.data().current_stock || 0),
          reorder_point: parseFloat(d.data().reorder_point || 0),
        }));
        allProductsMap.clear();
        productsSnap.docs.forEach((d) => {
          allProductsMap.set(d.id, {
            id: d.id,
            ...d.data(),
            price: parseFloat(d.data().price || 0),
            total_cost: parseFloat(d.data().total_cost || 0),
          });
        });
        allCustomersMap.clear();
        customersSnap.docs.forEach((d) => {
          allCustomersMap.set(d.id, d.data());
        });
      }

      async function fetchFixedCosts() {
        try {
          const costsSnapshot = await getDocs(collection(db, "fixed_costs"));
          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„
          currentFixedCosts = costsSnapshot.docs.reduce(
            (sum, doc) => sum + parseFloat(doc.data().amount || 0),
            0
          );
          return currentFixedCosts;
        } catch (e) {
          console.error("Error fetching fixed costs: ", e);
          return 0;
        }
      }

      // --------------------------------------------------------
      // (Ù…Ø¹Ø¯Ù„) ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©
      // --------------------------------------------------------
      async function fetchStats(filterPeriod = "monthly") {
        const totalRevenueDisplay = document.getElementById("total-revenue");
        const totalCogsDisplay = document.getElementById("total-cogs");
        const grossProfitDisplay = document.getElementById("gross-profit");
        const netProfitDisplay = document.getElementById("net-profit");
        const netProfitContainer = document.getElementById(
          "net-profit-container"
        ); // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯)
        const pendingOrdersCount = document.getElementById(
          "pending-orders-count"
        );
        const lowStockCount = document.getElementById("low-stock-count");
        const topProductsList = document.getElementById("top-products-list");
        const topCustomersList = document.getElementById("top-customers-list");
        const smartAlertBox = document.getElementById("smart-alert-box");
        const smartAlertIcon = document.getElementById("smart-alert-icon");
        const smartAlertMessage = document.getElementById(
          "smart-alert-message"
        );

        try {
          // Ø¬Ù„Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø´Ù‡Ø±ÙŠØ©)
          const monthlyFixedCosts = await fetchFixedCosts();
          let periodFixedCosts = 0;
          let fixedCostMultiplier = 1;

          // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù„Ù„ÙØªØ±Ø©
          if (filterPeriod === "monthly") {
            periodFixedCosts = monthlyFixedCosts;
          } else if (filterPeriod === "quarterly") {
            fixedCostMultiplier = 3;
            periodFixedCosts = monthlyFixedCosts * fixedCostMultiplier;
          } else {
            // "all"
            periodFixedCosts = 0; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
          }

          const ordersCollection = collection(db, "orders");
          const customDesignsCollection = collection(db, "custom_designs");

          const [ordersSnapshot, customDesignsSnapshot] = await Promise.all([
            getDocs(ordersCollection),
            getDocs(customDesignsCollection),
          ]);

          const allOrders = [
            ...ordersSnapshot.docs.map((doc) => doc.data()),
            ...customDesignsSnapshot.docs.map((doc) => doc.data()),
          ];

          // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„ÙÙ„ØªØ±
          const now = new Date();
          let startDate,
            endDate = new Date(
              now.getFullYear(),
              now.getMonth(),
              now.getDate(),
              23,
              59,
              59
            );

          if (filterPeriod === "monthly") {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          } else if (filterPeriod === "quarterly") {
            const currentQuarter = Math.floor(now.getMonth() / 3);
            startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
          } else {
            // "all"
            startDate = new Date(0); // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø²Ù…Ù†
          }

          let pendingReviewCount = 0;
          let inProgressCount = 0;
          let completedCount = 0;
          let rejectedCount = 0;
          let totalRevenue = 0;
          let totalCOGS = 0;
          let categoryProfits = {};
          let productSalesMap = new Map();
          let customerSpendingMap = new Map();

          allOrders.forEach((o) => {
            const status = o.status;
            // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø¬Ù„Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ÙÙ„ØªØ±Ø©
            const orderDate = o.order_date ? new Date(o.order_date) : null;

            // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© (Ø¯Ø§Ø¦Ù…Ø§Ù‹ real-timeØŒ Ù„Ø§ ØªØ®Ø¶Ø¹ Ù„Ù„ÙÙ„ØªØ±)
            if (status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" || status === "Ù…Ù‚Ø¨ÙˆÙ„") {
              pendingReviewCount++;
            }

            // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© (ÙŠØ®Ø¶Ø¹ Ù„Ù„ÙÙ„ØªØ±)
            if (orderDate && orderDate >= startDate && orderDate <= endDate) {
              if (
                [
                  "Ù…Ù‚Ø¨ÙˆÙ„-Ø§Ù„Ø¹Ù…ÙŠÙ„",
                  "Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠØ¹",
                  "Ù‚ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¡",
                  "Ù‚ÙŠØ¯ Ø§Ù„ØªØºÙ„ÙŠÙ",
                  "Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†",
                ].includes(status)
              ) {
                inProgressCount++;
              } else if (status === "Ù…ÙƒØªÙ…Ù„") {
                completedCount++;
              } else if (
                status === "ØªÙ… Ø§Ù„Ø±ÙØ¶" ||
                status === "Ù…Ø±ÙÙˆØ¶-Ø§Ù„Ø¹Ù…ÙŠÙ„" ||
                status === "Ù…Ø¤Ø±Ø´Ù"
              ) {
                rejectedCount++;
              }
            }

            // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ø§Ù„ÙŠØ© (ÙŠØ®Ø¶Ø¹ Ù„Ù„ÙÙ„ØªØ±)
            if (
              status === "Ù…ÙƒØªÙ…Ù„" &&
              orderDate &&
              orderDate >= startDate &&
              orderDate <= endDate
            ) {
              const orderRevenue = parseFloat(o.total || o.final_price || 0);
              totalRevenue += orderRevenue;
              let orderCOGS = 0;
              let orderCategory = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
              const customerId = o.customer_uid;
              if (customerId) {
                const currentSpending =
                  customerSpendingMap.get(customerId) || 0;
                customerSpendingMap.set(
                  customerId,
                  currentSpending + orderRevenue
                );
              }
              if (o.type === "ready" && o.items) {
                o.items.forEach((item) => {
                  const productData = allProductsMap.get(item.id.toString());
                  if (productData) {
                    orderCOGS +=
                      (productData.total_cost || 0) * (item.quantity || 1);
                    const currentSales = productSalesMap.get(item.id) || 0;
                    productSalesMap.set(item.id, currentSales + item.quantity);
                  }
                });
                orderCategory = o.items[0]?.category || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
              } else if (o.type === "custom" && o.final_price) {
                orderCOGS = parseFloat(o.estimatedCOGS || orderRevenue * 0.75);
                orderCategory = o.type_of_product || "ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ";
              }
              totalCOGS += orderCOGS;
              const profit = orderRevenue - orderCOGS;
              if (!categoryProfits[orderCategory])
                categoryProfits[orderCategory] = 0;
              categoryProfits[orderCategory] += profit;
            }
          });

          const grossProfit = totalRevenue - totalCOGS;
          let netProfit = 0;

          // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ
          if (filterPeriod === "all") {
            netProfitContainer.style.display = "none";
          } else {
            netProfit = grossProfit - periodFixedCosts;
            netProfitContainer.style.display = "block";
          }

          // ğŸ’¡ (Ø¥ØµÙ„Ø§Ø­) ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
          currentTotalRevenue = totalRevenue;
          currentGrossProfit = grossProfit;
          currentTotalCOGS = totalCOGS; // ğŸ’¡ (Ø¥ØµÙ„Ø§Ø­)
          currentNetProfit = netProfit;
          // currentFixedCosts ØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ø¨Ù€ fetchFixedCosts()
          currentPendingOrders = pendingReviewCount;
          currentLowStock = allRawMaterials.filter(
            (m) => m.current_stock <= m.reorder_point && m.reorder_point > 0
          ).length;
          currentTopProducts = [...productSalesMap.entries()]
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map((p) => ({
              id: p[0],
              name: allProductsMap.get(p[0].toString())?.name || "Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ",
              quantity: p[1],
            }));
          currentTopCustomers = [...customerSpendingMap.entries()]
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map((c) => ({
              id: c[0],
              name: allCustomersMap.get(c[0])?.name || "Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø°ÙˆÙ",
              spending: c[1],
            }));

          // (ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
          totalRevenueDisplay.textContent = totalRevenue.toFixed(0);
          totalCogsDisplay.textContent = totalCOGS.toFixed(0);
          grossProfitDisplay.textContent = grossProfit.toFixed(0);
          netProfitDisplay.textContent = netProfit.toFixed(0);

          smartAlertBox.style.display = "flex";
          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠ
          if (filterPeriod === "all") {
            smartAlertBox.className = "smart-alert info";
            smartAlertIcon.className = "fa-solid fa-circle-info";
            smartAlertMessage.innerHTML = `<strong>Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª:</strong> ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆÙ‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ. (Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶).`;
          } else if (netProfit < 0) {
            const breakeven = Math.abs(netProfit);
            if (grossProfit <= 0 && totalRevenue > 0) {
              smartAlertBox.className = "smart-alert danger";
              smartAlertIcon.className = "fa-solid fa-circle-xmark";
              smartAlertMessage.innerHTML = `<strong>ØªØ­Ø°ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø­Ø±Ø¬ (Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©):</strong> Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (COGS) Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø¥ÙŠØ±Ø§Ø¯Ø§ØªÙƒ. <strong>Ø£Ù†Øª ØªØ¨ÙŠØ¹ Ø¨Ø®Ø³Ø§Ø±Ø©!</strong>`;
            } else if (totalRevenue === 0) {
              smartAlertBox.className = "smart-alert warning";
              smartAlertIcon.className = "fa-solid fa-triangle-exclamation";
              smartAlertMessage.innerHTML = `<strong>ØªÙ†Ø¨ÙŠÙ‡ (Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©):</strong> Ù„Ù… ØªØ³Ø¬Ù„ Ø£ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©) Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ Ø³Ø§Ù„Ø¨ Ø¨Ø³Ø¨Ø¨ ÙˆØ¬ÙˆØ¯ ØªÙƒØ§Ù„ÙŠÙ Ø«Ø§Ø¨ØªØ© Ø¨Ù‚ÙŠÙ…Ø© <strong>${periodFixedCosts.toFixed(
                0
              )} Ø´ÙŠÙƒÙ„</strong>.`;
            } else {
              smartAlertBox.className = "smart-alert warning";
              smartAlertIcon.className = "fa-solid fa-circle-info";
              smartAlertMessage.innerHTML = `<strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ø¯Ø§Ø¡ (Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©):</strong> Ù‡Ø§Ù…Ø´ Ø±Ø¨Ø­Ùƒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØŒ Ù„ÙƒÙ†Ù‡ Ù„Ø§ ÙŠØºØ·ÙŠ ØªÙƒØ§Ù„ÙŠÙÙƒ Ø§Ù„Ø«Ø§Ø¨ØªØ©. ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø±Ø¨Ø­ Ø¥Ø¶Ø§ÙÙŠ Ø¨Ù‚ÙŠÙ…Ø© <strong>${breakeven.toFixed(
                0
              )} Ø´ÙŠÙƒÙ„</strong> Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„.`;
            }
          } else {
            smartAlertBox.className = "smart-alert success";
            smartAlertIcon.className = "fa-solid fa-circle-check";
            smartAlertMessage.innerHTML = `<strong>Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø² (Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©):</strong> ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£Ø±Ø¨Ø§Ø­Ùƒ Ø§Ù„ØµØ§ÙÙŠØ© ${netProfit.toFixed(
              0
            )} Ø´ÙŠÙƒÙ„ ØªØºØ·ÙŠ Ø¬Ù…ÙŠØ¹ ØªÙƒØ§Ù„ÙŠÙÙƒ.`;
          }

          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© (Ø¯Ø§Ø¦Ù…Ø§Ù‹ real-time)
          pendingOrdersCount.textContent = currentPendingOrders;
          lowStockCount.textContent = currentLowStock;

          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø±Ø³ÙˆÙ… (ØªØ®Ø¶Ø¹ Ù„Ù„ÙÙ„ØªØ±)
          topProductsList.innerHTML = "";
          currentTopProducts.forEach((p, i) => {
            topProductsList.innerHTML += `
                <li>
                  <span class="item-name">${i + 1}. ${p.name}</span>
                  <span class="item-value">${p.quantity} Ù‚Ø·Ø¹Ø©</span>
                </li>`;
          });
          if (currentTopProducts.length === 0) {
            topProductsList.innerHTML =
              '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</p>';
          }

          topCustomersList.innerHTML = "";
          currentTopCustomers.forEach((c, i) => {
            topCustomersList.innerHTML += `
                <li>
                  <span class="item-name">${i + 1}. ${c.name}</span>
                  <span class="item-value">${c.spending.toFixed(0)} Ø´ÙŠÙƒÙ„</span>
                </li>`;
          });
          if (currentTopCustomers.length === 0) {
            topCustomersList.innerHTML =
              '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</p>';
          }

          renderOrderStatusChart(
            pendingReviewCount, // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
            inProgressCount,
            completedCount,
            rejectedCount
          );
          renderCategoryProfitChart(categoryProfits);
        } catch (e) {
          console.error("Error fetching stats:", e);
          smartAlertBox.style.display = "flex";
          smartAlertBox.className = "smart-alert danger";
          smartAlertIcon.className = "fa-solid fa-circle-xmark";
          smartAlertMessage.innerHTML = `<strong>Ø®Ø·Ø£ ÙØ§Ø¯Ø­:</strong> ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ${e.message}`;
        }
      }

      // --------------------------------------------------------
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Web Search)
      // --------------------------------------------------------
      async function runProfitForecast() {
        const resultsContainer = document.getElementById("forecast-results");
        const loadingEl = document.getElementById("forecast-loading");
        const contentEl = document.getElementById("forecast-content");
        const button = document.getElementById("run-forecast-btn");

        resultsContainer.style.display = "block";
        contentEl.style.display = "none";
        loadingEl.style.display = "block";
        button.disabled = true;
        button.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„...';

        try {
          const searchQueries = [
            "economic outlook Palestine next quarter 2025",
            "political situation West Bank 2025",
            "social events and holidays Palestine winter 2025",
            "furniture market trends Palestine 2025",
          ];

          // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          const currentPeriodText =
            periodFilter.options[periodFilter.selectedIndex].text;

          const prompt = `
            Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± Ù…Ø§Ù„ÙŠ Ø®Ø¨ÙŠØ± Ù„FurnAI Ø£Ø«Ø§Ø« ØªÙ‚Ø¹ ÙÙŠ ÙÙ„Ø³Ø·ÙŠÙ†.
            Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„ÙØªØ±Ø©: ${currentPeriodText}) Ù‡ÙŠ: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©): ${currentTotalRevenue.toFixed(
            0
          )} Ø´ÙŠÙƒÙ„ØŒ ÙˆÙ‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${currentGrossProfit.toFixed(0)} Ø´ÙŠÙƒÙ„.
            
            Ù…Ù‡Ù…ØªÙƒ:
            1.  Ù‚Ù… Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆÙŠØ¨ ("google_search") Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª: ${JSON.stringify(
              searchQueries
            )}
            2.  Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø«ØŒ Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„ØªÙ„Ø®ÙŠØµ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:
                * Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ù…Ø«Ø§Ù„: Ù†Ù…ÙˆØŒ Ø±ÙƒÙˆØ¯ØŒ ØªØ¶Ø®Ù…).
                * Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø³ÙŠØ© (Ù…Ø«Ø§Ù„: Ù…Ø³ØªÙ‚Ø±Ø©ØŒ Ù…ØªÙˆØªØ±Ø©ØŒ Ø£Ø­Ø¯Ø§Ø« Ù…Ø¹ÙŠÙ†Ø©).
                * Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ³Ù…ÙŠØ© (Ù…Ø«Ø§Ù„: Ø£Ø¹ÙŠØ§Ø¯ Ù‚Ø§Ø¯Ù…Ø©ØŒ Ø¹Ø·Ù„Ø§ØªØŒ Ù…ÙˆØ§Ø³Ù… Ø²ÙˆØ§Ø¬).
            3.  Ù‚Ù… Ø¨Ø¥Ø®Ø±Ø§Ø¬ Ø¥Ø¬Ø§Ø¨ØªÙƒ **ÙÙ‚Ø·** Ø¨ØµÙŠØºØ© HTML Ù…Ù‚Ø³Ù…Ø© Ø¥Ù„Ù‰ Ø¬Ø²Ø£ÙŠÙ†:
                * Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªÙŠ ÙˆØ¬Ø¯ØªÙ‡Ø§ (ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª Ù…Ù†Ùƒ).
                * Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù…Ù„Ø®Øµ ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù„Ù„Ø±Ø¨Ø¹ Ø§Ù„Ù‚Ø§Ø¯Ù… (3-4 Ø£Ø³Ø·Ø±) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„.

            Ø§Ø³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚ HTML Ø§Ù„ØªØ§Ù„ÙŠ **Ø¨Ø¯Ù‚Ø©**:

            <div id="forecast-factors-container">
              <h4><i class="fa-solid fa-magnifying-glass-chart"></i> Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø§Ù„Ù…Ø¤Ø«Ø±Ø© (Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ù‚Ø§Ø¯Ù…):</h4>
              <ul id="forecast-factors">
                <li><i class="fa-solid fa-money-bill-wave"></i> <strong>Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯:</strong> [Ù…Ù„Ø®Øµ ØªØ­Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù‡Ù†Ø§]</li>
                <li><i class="fa-solid fa-flag"></i> <strong>Ø§Ù„Ø³ÙŠØ§Ø³Ø©:</strong> [Ù…Ù„Ø®Øµ ØªØ­Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø³ÙŠØ§Ø³ÙŠ Ù‡Ù†Ø§]</li>
                <li><i class="fa-solid fa-users"></i> <strong>Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ ÙˆØ§Ù„Ù…ÙˆØ§Ø³Ù…:</strong> [Ù…Ù„Ø®Øµ ØªØ­Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù…ÙˆØ³Ù…ÙŠ Ù‡Ù†Ø§]</li>
              </ul>
            </div>
            <p id="forecast-summary">
              <strong><i class="fa-solid fa-chart-line"></i> Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª:</strong>
              [Ø§ÙƒØªØ¨ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ù‡Ù†Ø§. Ø§Ø´Ø±Ø­ "Ù„Ù…Ø§Ø°Ø§" Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªÙŠ ÙˆØ¬Ø¯ØªÙ‡Ø§ ÙˆÙƒÙŠÙ Ø³ØªØ¤Ø«Ø± (Ø¥ÙŠØ¬Ø§Ø¨Ø§Ù‹ Ø£Ùˆ Ø³Ù„Ø¨Ø§Ù‹) Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ.]
            </p>
          `;

          // ğŸ’¡ (Ø¥ØµÙ„Ø§Ø­) Ø§Ø³ØªØ®Ø¯Ø§Ù… .startChat() Ùˆ .sendMessage() Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª
          const chat = forecastAiModel.startChat();
          const result = await chat.sendMessage(prompt);
          const response = result.response;
          let htmlContent = response.text().trim();

          // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
          if (htmlContent.startsWith("```html")) {
            htmlContent = htmlContent.substring(7);
          }
          if (htmlContent.endsWith("```")) {
            htmlContent = htmlContent.substring(0, htmlContent.length - 3);
          }

          contentEl.innerHTML = htmlContent;
          loadingEl.style.display = "none";
          contentEl.style.display = "block";
        } catch (error) {
          console.error("AI Forecast Error:", error);
          loadingEl.style.display = "none";
          contentEl.innerHTML = `<p style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ø³Ø·Ø± 321.</p><p style="color: #999; text-align: left; direction: ltr; font-size: 0.8rem;">${error.message}</p>`;
          contentEl.style.display = "block";
        } finally {
          button.disabled = false;
          button.innerHTML =
            '<i class="fa-solid fa-wand-magic-sparkles"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª';
        }
      }

      // --------------------------------------------------------
      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¯ÙˆØ§Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ (Chat with Data)
      // --------------------------------------------------------
      function setupAiAnalyst() {
        const fab = document.getElementById("ai-analyst-fab");
        const modal = document.getElementById("ai-analyst-modal");
        const closeBtn = document.getElementById("ai-analyst-close");
        const form = document.getElementById("ai-analyst-form");
        const input = document.getElementById("ai-analyst-input");

        fab.addEventListener("click", () => {
          modal.classList.add("active");
          input.focus();
          if (aiAnalystChatHistory.length === 0) {
            appendAiAnalystMessage(
              "ai",
              "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…Ø¯ÙŠØ±! Ø£Ù†Ø§ 'Ù…Ø­Ù„Ù„ Ø§Ù„FurnAI'. Ù„Ø¯ÙŠ Ø§Ø·Ù„Ø§Ø¹ ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆÙŠØ¨. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡."
            );
          }
        });

        closeBtn.addEventListener("click", () =>
          modal.classList.remove("active")
        );
        modal.addEventListener("click", (e) => {
          if (e.target === modal) modal.classList.remove("active");
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const userQuery = input.value.trim();
          if (!userQuery) return;
          appendAiAnalystMessage("user", userQuery);
          input.value = "";
          runAiAnalystQuery(userQuery);
        });
      }

      function appendAiAnalystMessage(sender, text, isHtml = false) {
        const messagesContainer = document.getElementById(
          "ai-analyst-messages"
        );
        const msgEl = document.createElement("div");
        msgEl.className = `ai-chat-message ${sender}-message`;
        if (isHtml) {
          msgEl.innerHTML = text;
        } else {
          msgEl.textContent = text;
        }
        messagesContainer.appendChild(msgEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return msgEl;
      }

      // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø­Ø«
      async function runAiAnalystQuery(userQuery) {
        const typingIndicator = appendAiAnalystMessage(
          "ai",
          '<div class="typing-indicator"><span></span><span></span><span></span></div>',
          true
        );

        // 1. ØªØ¬Ù…ÙŠØ¹ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø³ÙŠØ§Ù‚)
        // ğŸ’¡ (Ù…Ø¹Ø¯Ù„) Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const currentPeriodText =
          periodFilter.options[periodFilter.selectedIndex].text;
        const netProfitText =
          periodFilter.value === "all"
            ? "ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨ (Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª)"
            : `${currentNetProfit.toFixed(0)} Ø´ÙŠÙƒÙ„`;

        const dataSnapshot = `
          - **Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ (Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: ${currentPeriodText}):**
            - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©): ${currentTotalRevenue.toFixed(
              0
            )} Ø´ÙŠÙƒÙ„
            - Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© (COGS): ${currentTotalCOGS.toFixed(0)} Ø´ÙŠÙƒÙ„
            - Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${currentGrossProfit.toFixed(0)} Ø´ÙŠÙƒÙ„
            - Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù„Ù„ÙØªØ±Ø©): ${
              periodFilter.value === "all"
                ? "N/A"
                : (
                    currentFixedCosts *
                    (periodFilter.value === "quarterly" ? 3 : 1)
                  ).toFixed(0)
            } Ø´ÙŠÙƒÙ„
            - Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ: ${netProfitText}
          - **Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© (Real-time):**
            - Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: ${currentPendingOrders}
            - Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨: ${currentLowStock}
          - **Ø§Ù„Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡Ù‹ (Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: ${currentPeriodText}):**
            - Ø£ÙØ¶Ù„ 5 Ù…Ù†ØªØ¬Ø§Øª (Ø¨Ø§Ù„ÙƒÙ…ÙŠØ©): ${
              currentTopProducts.length > 0
                ? currentTopProducts
                    .map((p) => `${p.name} (${p.quantity} Ù‚Ø·Ø¹Ø©)`)
                    .join("ØŒ ")
                : "Ù„Ø§ ØªÙˆØ¬Ø¯"
            }
            - Ø£ÙØ¶Ù„ 5 Ø¹Ù…Ù„Ø§Ø¡ (Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø©): ${
              currentTopCustomers.length > 0
                ? currentTopCustomers
                    .map((c) => `${c.name} (${c.spending.toFixed(0)} Ø´ÙŠÙƒÙ„)`)
                    .join("ØŒ ")
                : "Ù„Ø§ ÙŠÙˆØ¬Ø¯"
            }
        `;

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ Prompt (Ù…Ø¹Ø¯Ù„)
        const prompt = `
          Ø£Ù†Øª "Ù…Ø­Ù„Ù„ Ø§Ù„FurnAI"ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø®Ø¨ÙŠØ±. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙŠ ÙˆØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„.
          Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ù„Ù…Ø²ÙˆØ¯Ø© Ø£Ø¯Ù†Ø§Ù‡) ÙˆÙ„Ø¯ÙŠÙƒ Ø£ÙŠØ¶Ø§Ù‹ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆÙŠØ¨ ("google_search") Ø¹Ù† Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© Ù‚Ø¯ ØªØ­ØªØ§Ø¬Ù‡Ø§.

          **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹:**
          1.  Ø£Ø¬Ø¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ **Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹** (Ø§Ù„ØªÙŠ ØªØºØ·ÙŠ Ø§Ù„ÙØªØ±Ø©: ${currentPeriodText}).
          2.  Ø§Ø³ØªØ®Ø¯Ù… "google_search" **ÙÙ‚Ø·** Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØªØ·Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© (Ù…Ø«Ù„: "Ù…Ø§ Ù‡ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø®Ø´Ø¨ Ø§Ù„ÙŠÙˆÙ…ØŸ" Ø£Ùˆ "Ù…Ø§ Ù‡ÙŠ Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ ÙÙ„Ø³Ø·ÙŠÙ†ØŸ").
          3.  Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ (Ù…Ø«Ù„: "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ø±Ø¨Ø­ÙŠØ©ØŸ")ØŒ Ø£Ø¬Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆÙ„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø«.
          4.  Ù‚Ù… Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… HTML (Ù…Ø«Ù„ <ul>, <li>, <strong>) Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ø³Ù‡Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.

          --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„ÙØªØ±Ø©: ${currentPeriodText}) ---
          ${dataSnapshot}
          --- Ù†Ù‡Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ---

          --- Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
          ${aiAnalystChatHistory
            .map((msg) => `${msg.role}: ${msg.parts[0].text}`)
            .join("\n")}
          --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø¬Ù„ ---

          **Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±:** ${userQuery}
        `;

        try {
          // ğŸ’¡ (Ø¥ØµÙ„Ø§Ø­) Ø§Ø³ØªØ®Ø¯Ø§Ù… .startChat() Ùˆ .sendMessage() Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª
          const chat = analystAiModel.startChat();
          const result = await chat.sendMessage(prompt);
          const response = result.response;
          const aiText = response.text().trim();

          // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
          typingIndicator.remove();
          appendAiAnalystMessage("ai", aiText, true); // ğŸ’¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTML

          // 4. Ø­ÙØ¸ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
          aiAnalystChatHistory.push({
            role: "user",
            parts: [{ text: userQuery }],
          });
          aiAnalystChatHistory.push({
            role: "model",
            parts: [{ text: aiText }],
          });
        } catch (error) {
          console.error("AI Analyst Error:", error);
          typingIndicator.remove();
          appendAiAnalystMessage(
            "ai",
            `<p style="color: red;">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ø³Ø·Ø± 321.</p><p style="color: #999; text-align: left; direction: ltr; font-size: 0.8rem;">${error.message}</p>`,
            true
          );
        }
      }

      // --------------------------------------------------------
      // Ø¯ÙˆØ§Ù„ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª (Charts)
      // --------------------------------------------------------
      function renderOrderStatusChart(
        newOrders,
        inProgress,
        completed,
        rejected
      ) {
        const ctx = document.getElementById("orderStatusChart");
        // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (Chart.getChart(ctx)) {
          Chart.getChart(ctx).destroy();
        }
        const data = {
          labels: ["Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©/Ù…Ù‚Ø¨ÙˆÙ„", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°", "Ù…ÙƒØªÙ…Ù„", "Ù…Ø±ÙÙˆØ¶/Ù…Ø¤Ø±Ø´Ù"],
          datasets: [
            {
              data: [newOrders, inProgress, completed, rejected],
              backgroundColor: ["#ffc107", "#0d6efd", "#198754", "#dc3545"],
              hoverOffset: 4,
            },
          ],
        };
        new Chart(ctx, {
          type: "pie",
          data: data,
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
                labels: {
                  font: {
                    family: "Cairo",
                  },
                },
              },
            },
          },
        });
      }

      function renderCategoryProfitChart(categoryProfits) {
        const ctx = document.getElementById("categoryProfitChart");
        // ğŸ’¡ (Ø¬Ø¯ÙŠØ¯) ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (Chart.getChart(ctx)) {
          Chart.getChart(ctx).destroy();
        }
        const categories = Object.keys(categoryProfits);
        const profits = Object.values(categoryProfits);
        const data = {
          labels: categories,
          datasets: [
            {
              label: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ (â‚ª)",
              data: profits,
              backgroundColor: "#8d6e63",
              borderColor: "#795548",
              borderWidth: 1,
            },
          ],
        };
        new Chart(ctx, {
          type: "bar",
          data: data,
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ø¨Ø­ (Ø´ÙŠÙƒÙ„)",
                  font: {
                    family: "Cairo",
                  },
                },
                ticks: {
                  font: {
                    family: "Cairo",
                  },
                },
              },
              x: {
                ticks: {
                  font: {
                    family: "Cairo",
                  },
                },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
