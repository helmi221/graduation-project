<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ููุฌุฑุฉ | ููุญุฉ ุงููุฏูุฑ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <header class="main-header">
      <div class="logo">ููุฌุฑุฉ</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html" class="active"
              ><i class="fa-solid fa-gauge-high"></i> ููุญุฉ ุงูุชุญูู</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> ุฅุฏุงุฑุฉ ุงูููุงุฏ ุงูุฎุงู</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> ุงูุชูุงููู ุงูุซุงุจุชุฉ</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>ูุฑุญุจุงู ุจู ูู ููุญุฉ ุงููุฏูุฑ</h1>

      <div class="quick-links">
        <a href="orders_admin.html" class="quick-link-card">
          <i class="fa-solid fa-receipt"></i>
          <h3>ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ</h3>
          <p id="new-orders-count">0</p>
        </a>
        <a href="orders_admin.html" class="quick-link-card">
          <i class="fa-solid fa-gears"></i>
          <h3>ุทูุจุงุช ููุฏ ุงูุนูู</h3>
          <p id="in-progress-count">0</p>
        </a>
        <a href="inventory.html" class="quick-link-card">
          <i class="fa-solid fa-warehouse"></i>
          <h3>ุฅุฌูุงูู ุงูููุชุฌุงุช</h3>
          <p id="total-products-count">0</p>
        </a>
        <a href="raw_materials_admin.html" class="quick-link-card">
          <i class="fa-solid fa-boxes-stacked"></i>
          <h3>ุงูููุงุฏ ุงูุฎุงู ุงูููุฎูุถุฉ</h3>
          <p id="low-stock-count">0</p>
        </a>
      </div>

      <div class="admin-panel">
        <h2 style="text-align: right">ููุฎุต ุงูุฃุฏุงุก</h2>
        <p style="text-align: center; color: #777; padding: 50px">
          ูุฐุง ุงููุณู ูุฎุตุต ููุฑุณูู ุงูุจูุงููุฉ ูุงููุคุดุฑุงุช ุงูุฑุฆูุณูุฉ (KPIs).
        </p>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // ๐ ุชุฃูุฏ ูู ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ุงูุชุงููุฉ ูุชูุงุณุจ ูุดุฑูุนู ุงููุนูู ูู Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // --------------------------------------------------------
      // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุงูุชุญููู
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchStats();
          } else {
            alert("ุบูุฑ ูุตุฑุญ ูู ุจุงููุตูู ุฅูู ูุฐู ุงูุตูุญุฉ.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      // --------------------------------------------------------
      // ูุธููุฉ ุฌูุจ ุงูุฅุญุตุงุฆูุงุช ูู Firebase
      // --------------------------------------------------------
      async function fetchStats() {
        const newOrdersCount = document.getElementById("new-orders-count");
        const inProgressCount = document.getElementById("in-progress-count");
        const completedCount = document.getElementById("completed-count");
        const totalProductsCount = document.getElementById(
          "total-products-count"
        );
        const lowStockCount = document.getElementById("low-stock-count");

        try {
          // 1. ุฅุญุตุงุฆูุงุช ุงูุทูุจุงุช
          const ordersCollection = collection(db, "orders");
          const customDesignsCollection = collection(db, "custom_designs");

          const [ordersSnapshot, customDesignsSnapshot] = await Promise.all([
            getDocs(ordersCollection),
            getDocs(customDesignsCollection),
          ]);

          const allOrders = [
            ...ordersSnapshot.docs.map((doc) => doc.data()),
            ...customDesignsSnapshot.docs.map((doc) => doc.data()),
          ];

          let newOrders = 0;
          let inProgress = 0;
          let completed = 0;

          allOrders.forEach((o) => {
            const status = o.status;
            if (status === "ููุฏ ุงููุฑุงุฌุนุฉ" || status === "ููุจูู") {
              newOrders++;
            } else if (
              [
                "ููุจูู-ุงูุนููู",
                "ููุฏ ุงูุชุตููุน",
                "ููุฏ ุงูุทูุงุก",
                "ููุฏ ุงูุชุบููู",
                "ููุฏ ุงูุดุญู",
              ].includes(status)
            ) {
              inProgress++;
            } else if (status === "ููุชูู") {
              completed++;
            }
          });

          newOrdersCount.textContent = newOrders;
          inProgressCount.textContent = inProgress;
          // Note: total orders stat is replaced by total products.

          // 2. ุฅุญุตุงุฆูุงุช ุงูููุชุฌุงุช
          const productsSnapshot = await getDocs(collection(db, "products"));
          totalProductsCount.textContent = productsSnapshot.size;

          // 3. ุฅุญุตุงุฆูุงุช ุงูููุงุฏ ุงูุฎุงู
          const materialsSnapshot = await getDocs(
            collection(db, "raw_materials")
          );
          let lowStock = 0;
          materialsSnapshot.docs.forEach((doc) => {
            const data = doc.data();
            if (data.current_stock <= data.min_stock_level) {
              lowStock++;
            }
          });
          lowStockCount.textContent = lowStock;
        } catch (e) {
          console.error("Error fetching stats: ", e);
          newOrdersCount.textContent =
            inProgressCount.textContent =
            totalProductsCount.textContent =
            lowStockCount.textContent =
              "ุฎุทุฃ";
        }
      }
    </script>
  </body>
</html>
