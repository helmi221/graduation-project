<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | لوحة المدير</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <header class="main-header">
      <div class="logo">منجرة</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html" class="active"
              ><i class="fa-solid fa-gauge-high"></i> لوحة التحكم</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> إدارة الطلبات</a
            >
          </li>
          <li>
            <a href="inventory.html"
              ><i class="fa-solid fa-warehouse"></i> إدارة المنتجات</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> إدارة المواد الخام</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>ملخص لوحة التحكم</h1>

      <div class="dashboard-stats">
        <div class="stat-card new-orders">
          <div class="stat-info">
            <h3 id="new-orders-count">0</h3>
            <p>طلبات جديدة (مراجعة)</p>
          </div>
          <i class="fa-solid fa-bell stat-icon"></i>
        </div>
        <div class="stat-card in-progress">
          <div class="stat-info">
            <h3 id="in-progress-count">0</h3>
            <p>طلبات قيد التنفيذ</p>
          </div>
          <i class="fa-solid fa-truck-fast stat-icon"></i>
        </div>
        <div class="stat-card completed">
          <div class="stat-info">
            <h3 id="completed-count">0</h3>
            <p>طلبات مكتملة</p>
          </div>
          <i class="fa-solid fa-check-circle stat-icon"></i>
        </div>
      </div>

      <div class="quick-links-section admin-panel">
        <h2><i class="fa-solid fa-th-large"></i> صفحات الإدارة السريعة</h2>
        <div class="quick-links-grid">
          <a
            href="orders_admin.html"
            class="quick-link-card"
            style="background-color: var(--info-color)"
          >
            <i class="fa-solid fa-box-open"></i>
            <h3>إدارة الطلبات</h3>
          </a>
          <a
            href="inventory.html"
            class="quick-link-card"
            style="background-color: var(--success-color)"
          >
            <i class="fa-solid fa-warehouse"></i>
            <h3>إدارة المنتجات</h3>
          </a>
          <a
            href="raw_materials_admin.html"
            class="quick-link-card"
            style="background-color: var(--warning-color)"
          >
            <i class="fa-solid fa-hammer"></i>
            <h3>إدارة المواد الخام</h3>
          </a>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const newOrdersCount = document.getElementById("new-orders-count");
      const inProgressCount = document.getElementById("in-progress-count");
      const completedCount = document.getElementById("completed-count");

      // التحقق من صلاحيات المدير
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            fetchStats();
          } else {
            alert("غير مصرح لك بالوصول إلى هذه الصفحة.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      async function fetchStats() {
        try {
          const ordersCollection = collection(db, "orders");
          const customDesignsCollection = collection(db, "custom_designs");

          const [ordersSnapshot, customDesignsSnapshot] = await Promise.all([
            getDocs(ordersCollection),
            getDocs(customDesignsCollection),
          ]);

          const allOrders = [
            ...ordersSnapshot.docs.map((doc) => doc.data()),
            ...customDesignsSnapshot.docs.map((doc) => doc.data()),
          ];

          let newOrders = 0;
          let inProgress = 0;
          let completed = 0;

          allOrders.forEach((o) => {
            const status = o.status;
            if (status === "قيد المراجعة" || status === "مقبول") {
              newOrders++;
            } else if (
              [
                "مقبول-العميل",
                "قيد التصنيع",
                "قيد الطلاء",
                "قيد التغليف",
                "قيد الشحن",
              ].includes(status)
            ) {
              inProgress++;
            } else if (status === "مكتمل") {
              completed++;
            }
          });

          newOrdersCount.textContent = newOrders;
          inProgressCount.textContent = inProgress;
          completedCount.textContent = completed;
        } catch (e) {
          console.error("Error fetching stats: ", e);
          newOrdersCount.textContent =
            inProgressCount.textContent =
            completedCount.textContent =
              "خطأ";
        }
      }
    </script>
  </body>
</html>
