<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ù†Ø¬Ø±Ø© | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* Status Colors & Display (ÙƒÙ…Ø§ ÙƒØ§Ù†Øª) */
      .product-status-available {
        color: var(--success-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .product-status-unavailable-auto {
        color: var(--danger-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .product-status-unavailable-manual {
        color: var(--warning-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      /* ğŸ’¡ Ù†Ù…Ø· Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ù†Ù‚Øµ Ø§Ù„Ù…ÙˆØ§Ø¯ */
      .missing-materials-alert {
        color: var(--danger-color);
        margin-right: 8px;
        cursor: pointer;
        font-size: 1.1em;
        transition: transform 0.2s;
      }
      .missing-materials-alert:hover {
        transform: scale(1.2);
      }
      /* ğŸ’¡ ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© */
      #missing-materials-table {
        width: 100%;
        margin-top: 15px;
      }
      #missing-materials-table th {
        background-color: #ffebee;
        color: var(--danger-color);
      }
      #missing-materials-table td {
        font-weight: 500;
      }
      /* ğŸ’¡ Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
      .pricing-calculation {
        background-color: #f0f8ff;
        border: 1px dashed var(--info-color);
        padding: 15px;
        border-radius: 8px;
      }
      .pricing-calculation p {
        margin: 5px 0;
      }
      #suggested-final-price {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--info-color);
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">Ù…Ù†Ø¬Ø±Ø©</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html" class="active"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

      <div class="admin-panel">
        <div class="section-header">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
          <div>
            <button class="btn" id="add-product-btn">
              <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
            </button>
          </div>
        </div>
        <div id="products-table-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
        </div>
      </div>
    </div>

    <div id="missing-materials-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 650px">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>
          <i class="fa-solid fa-triangle-exclamation"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© Ù„Ù€:
          <span id="missing-product-name">---</span>
        </h2>
        <p style="color: var(--danger-color); margin: 10px 0">
          Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØµÙ†ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù†Ù‚Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØªØ§Ù„ÙŠ:
        </p>
        <div id="missing-materials-report-body"></div>
        <p
          style="
            text-align: right;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #777;
          "
        >
          ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© ØµÙØ­Ø©
          <a
            href="raw_materials_admin.html"
            style="color: var(--info-color); font-weight: bold"
            >Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a
          >
          Ù„Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ§Øª.
        </p>
      </div>
    </div>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="product-modal-title"></h2>
        <form id="product-form">
          <input type="hidden" id="product-id" />

          <div class="modal-form-grid">
            <div class="form-group">
              <label for="product-name">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
              <input type="text" id="product-name" required />
            </div>

            <div class="form-group">
              <label for="product-category">Ø§Ù„ÙØ¦Ø©</label>
              <select id="product-category" required></select>
            </div>

            <div class="form-group">
              <label for="product-price">Ø§Ù„Ø³Ø¹Ø± (Ø´ÙŠÙƒÙ„)</label>
              <input
                type="number"
                id="product-price"
                min="1"
                step="0.01"
                required
              />
            </div>

            <div class="form-group">
              <label for="manufacturing-hours"
                >Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ© (Ù„ÙƒÙ„ Ù‚Ø·Ø¹Ø©)</label
              >
              <input
                type="number"
                id="manufacturing-hours"
                min="0.5"
                step="0.5"
                value="1"
                required
              />
            </div>

            <div class="form-group">
              <label for="product-is-available">Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select id="product-is-available" required>
                <option value="true">Ù…ØªÙˆÙØ± Ù„Ù„Ø¨ÙŠØ¹ (ÙŠØ¯ÙˆÙŠ)</option>
                <option value="false">ØºÙŠØ± Ù…ØªÙˆÙØ± (ÙŠØ¯ÙˆÙŠ)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="product-specs">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <textarea id="product-specs" rows="1"></textarea>
            </div>
          </div>

          <div class="form-group">
            <label for="product-description">Ø§Ù„ÙˆØµÙ</label>
            <textarea id="product-description" rows="3"></textarea>
          </div>

          <h3>
            <i class="fa-solid fa-calculator"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ (Ù„ÙƒÙ„ Ù‚Ø·Ø¹Ø©)
          </h3>
          <div
            style="
              background-color: var(--light-color);
              padding: 15px;
              border-radius: 8px;
              border: 1px dashed var(--border-color);
              margin-bottom: 20px;
            "
          >
            <p>
              <strong>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªØºÙŠØ±Ø© (Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…):</strong>
              <span
                id="variable-cost-display"
                style="color: var(--info-color); font-weight: 700"
                >---</span
              >
              Ø´ÙŠÙƒÙ„
            </p>
            <p>
              <strong>ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø¹Ø¨Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© (Overhead):</strong>
              <span
                id="overhead-cost-display"
                style="color: var(--danger-color); font-weight: 700"
                >---</span
              >
              Ø´ÙŠÙƒÙ„
            </p>
            <p>
              <strong>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (TCOGS):</strong>
              <span
                id="total-cost-display"
                style="
                  font-size: 1.2rem;
                  color: var(--primary-color);
                  font-weight: 800;
                "
                >---</span
              >
              Ø´ÙŠÙƒÙ„
            </p>
          </div>

          <h3><i class="fa-solid fa-percent"></i> Ø­Ø§Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­</h3>
          <div class="pricing-calculation">
            <div class="form-group">
              <label for="profit-margin-input"
                >Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ·Ø¨ÙŠÙ‚Ù‡ (%)</label
              >
              <input
                type="number"
                id="profit-margin-input"
                min="0"
                step="1"
                value="30"
                required
              />
            </div>
            <p style="border-top: 1px dashed #ccc; padding-top: 10px">
              <strong>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong>
              <span id="suggested-final-price">---</span> Ø´ÙŠÙƒÙ„
            </p>
            <button
              type="button"
              class="btn btn-sm"
              id="calculate-price-btn"
              style="background-color: var(--info-color); margin-top: 10px"
            >
              <i class="fa-solid fa-calculator"></i> Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±
            </button>
            <button
              type="button"
              class="btn btn-sm btn-secondary"
              id="apply-calculated-price-btn"
              disabled
              style="margin-top: 10px"
            >
              <i class="fa-solid fa-arrow-down"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­
            </button>
          </div>

          <div style="margin-top: 20px">
            <h3><i class="fa-solid fa-gears"></i> Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù„Ø§Ø²Ù…Ø©</h3>
            <div id="materials-table-wrapper" style="margin-bottom: 20px">
              <table class="orders-table" id="required-materials-table">
                <thead>
                  <tr>
                    <th><i class="fa-solid fa-ruler-combined"></i> Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th><i class="fa-solid fa-box"></i> Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                    <th><i class="fa-solid fa-hashtag"></i> Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
                    <th><i class="fa-solid fa-trash"></i></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div
              class="modal-form-grid"
              style="grid-template-columns: 2fr 1fr 1fr"
            >
              <div class="form-group">
                <label for="material-select">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§</label>
                <select id="material-select"></select>
              </div>
              <div class="form-group">
                <label for="quantity-input">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input
                  type="number"
                  id="quantity-input"
                  min="0.01"
                  step="0.01"
                  value="1"
                />
              </div>
              <div class="form-group" style="align-self: end">
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="add-material-btn"
                >
                  <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                </button>
              </div>
            </div>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn">
              <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="confirm-title"></h2>
        <p id="confirm-message" style="margin-bottom: 20px"></p>
        <div class="btn-group">
          <button class="btn btn-danger" id="confirm-action-btn">ØªØ£ÙƒÙŠØ¯</button>
          <button
            class="btn btn-secondary"
            onclick="closeModal('confirmation-modal')"
          >
            Ø¥Ù„ØºØ§Ø¡
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      // ğŸ’¡ Ø¥Ø²Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Gemini

      // ğŸ›‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
      let allProducts = [];
      let allRawMaterials = [];
      let rawMaterialsMap = new Map();
      let currentRequiredMaterials = [];
      const productForm = document.getElementById("product-form");
      const requiredMaterialsTableBody = document.querySelector(
        "#required-materials-table tbody"
      );
      const materialSelect = document.getElementById("material-select");
      const calculatePriceBtn = document.getElementById("calculate-price-btn");
      const applyCalculatedPriceBtn = document.getElementById(
        "apply-calculated-price-btn"
      );
      const profitMarginInput = document.getElementById("profit-margin-input");
      const suggestedFinalPrice = document.getElementById(
        "suggested-final-price"
      );

      // ğŸ’¡ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©
      let totalMonthlyFixedCost = 0;
      let totalMonthlyManufacturingHours = 0;
      let overheadCostPerHour = 0;

      // ğŸ’¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©)
      const productCategories = [
        "Ø·Ø§ÙˆÙ„Ø© Ø³ÙØ±Ø©",
        "ÙƒØ±Ø³ÙŠ",
        "Ø·Ù‚Ù… ÙƒÙ†Ø¨",
        "ØºØ±ÙØ© Ù†ÙˆÙ…",
        "Ù…Ø·Ø¨Ø®",
        "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·",
        "Ø®Ø²Ø§Ù†Ø©",
        "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ§Ø²",
      ];

      // --------------------------------------------------------
      // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      // --------------------------------------------------------
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });

      // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© Ù„Ù…Ù†ØªØ¬ Ù…Ø­Ø¯Ø¯ (Ù…ØªØ§Ø­Ø© Ù„Ù„Ù€ window)
      window.showMissingMaterials = function (productId, productName) {
        // ğŸ’¡ Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ ID Ø¥Ù„Ù‰ String Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¢Ù…Ù†Ø©
        const productIdString = productId.toString();
        // ğŸ’¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†ØµÙŠØ©
        const product = allProducts.find(
          (p) => p.id.toString() === productIdString
        );

        // ğŸ’¡ ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!product || !product.missing_materials) {
          console.error(
            "Product data not found or missing materials data is unavailable."
          );
          return;
        }

        document.getElementById("missing-product-name").textContent =
          productName;
        const reportBody = document.getElementById(
          "missing-materials-report-body"
        );
        const missingList = product.missing_materials;

        if (missingList.length === 0) {
          reportBody.innerHTML = `<p style="text-align: center; color: var(--success-color); font-weight: 600;">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„ØªØµÙ†ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬.</p>`;
        } else {
          let tableHtml = `
                  <table class="orders-table" id="missing-materials-table">
                      <thead>
                          <tr>
                              <th><i class="fa-solid fa-list-check"></i> Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                              <th><i class="fa-solid fa-hashtag"></i> Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
                              <th><i class="fa-solid fa-box-open"></i> Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</th>
                              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                          </tr>
                      </thead>
                      <tbody>
              `;
          missingList.forEach((item) => {
            tableHtml += `
                      <tr>
                          <td>${item.name}</td>
                          <td>${item.required.toFixed(2)}</td>
                          <td style="color: var(--danger-color);">${item.available.toFixed(
                            2
                          )}</td>
                          <td>${item.unit}</td>
                      </tr>
                  `;
          });
          tableHtml += `</tbody></table>`;
          reportBody.innerHTML = tableHtml;
        }

        openModal("missing-materials-modal");
      };

      // --------------------------------------------------------
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchRawMaterials();
            await fetchFixedCostsAndHours();
            fetchAndRenderProducts();
            fillCategoriesDropdown(); // ğŸ’¡ Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª

            // ğŸ’¡ Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ³Ø¹ÙŠØ±
            calculatePriceBtn.addEventListener("click", handlePriceCalculation);
            applyCalculatedPriceBtn.addEventListener(
              "click",
              handleApplyCalculatedPrice
            );
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      // --------------------------------------------------------
      // Ø¯Ø§Ù„Ø© Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ÙØ¦Ø§Øª (Ø§Ù„Ù…ÙØµÙ„Ø­Ø©)
      // --------------------------------------------------------
      function fillCategoriesDropdown() {
        const select = document.getElementById("product-category");
        select.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©

        productCategories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        });
      }

      // --------------------------------------------------------
      // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ø³Ø§Ø¹Ø©
      // --------------------------------------------------------
      async function fetchFixedCostsAndHours() {
        try {
          const costsSnapshot = await getDocs(collection(db, "fixed_costs"));
          totalMonthlyFixedCost = costsSnapshot.docs.reduce(
            (sum, doc) => sum + parseFloat(doc.data().amount || 0),
            0
          );
          // Ø§ÙØªØ±Ø§Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ù…Ø«Ø§Ù„: 3 Ù…ÙˆØ¸ÙÙŠÙ† * 160 Ø³Ø§Ø¹Ø©/Ù…ÙˆØ¸Ù)
          totalMonthlyManufacturingHours = 160 * 3;

          if (totalMonthlyManufacturingHours > 0) {
            overheadCostPerHour =
              totalMonthlyFixedCost / totalMonthlyManufacturingHours;
          } else {
            overheadCostPerHour = 0;
          }

          // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø¹Ø¨Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          document.getElementById("overhead-cost-display").textContent =
            overheadCostPerHour.toFixed(2);
        } catch (e) {
          console.error("Error fetching fixed costs: ", e);
        }
      }

      /**
       * ØªØ­Ø³Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØªØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù….
       * @param {object} product - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬.
       * @returns {object} - ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ùˆ availabilityCheck.
       */
      function calculateProductCosts(product) {
        let variableCost = 0;
        const hours = parseFloat(product.manufacturing_time_hours) || 0;
        const materialsToCalculate =
          product.required_materials || currentRequiredMaterials;
        let isAvailable = true;
        let missingMaterialsCount = 0;
        // ğŸ’¡ Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© Ø¨Ø§Ù„ØªÙØµÙŠÙ„
        let detailedMissingMaterials = [];

        if (materialsToCalculate && materialsToCalculate.length > 0) {
          for (const requiredMat of materialsToCalculate) {
            const material = rawMaterialsMap.get(requiredMat.id);
            if (material) {
              variableCost += requiredMat.quantity * material.cost_per_unit;

              // ÙØ­Øµ Ø§Ù„ØªÙˆÙØ±
              if (
                material.current_stock < requiredMat.quantity ||
                requiredMat.quantity === 0
              ) {
                isAvailable = false;
                missingMaterialsCount++;
                detailedMissingMaterials.push({
                  id: requiredMat.id,
                  name: material.name_ar,
                  required: requiredMat.quantity,
                  available: material.current_stock,
                  unit: material.unit,
                });
              }
            }
          }
        }

        const fixedCost = hours * overheadCostPerHour;
        const totalCost = variableCost + fixedCost;

        return {
          variable_cost: variableCost,
          fixed_cost: fixedCost,
          total_cost: totalCost,
          overhead_rate: overheadCostPerHour,
          // ğŸ’¡ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ± Ø§Ù„Ø¢Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…
          availabilityCheck: isAvailable ? "Available" : "Unavailable_Auto",
          detailedMissingMaterials: detailedMissingMaterials, // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        };
      }

      // --------------------------------------------------------
      // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ù„Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø°ÙƒÙŠ)
      // --------------------------------------------------------
      function updateCostDisplay() {
        let productData;

        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ù„Ø­Ø³Ø§Ø¨
        productData = {
          required_materials: currentRequiredMaterials,
          manufacturing_time_hours:
            parseFloat(document.getElementById("manufacturing-hours").value) ||
            0,
        };

        const costs = calculateProductCosts(productData);

        document.getElementById("variable-cost-display").textContent =
          costs.variable_cost.toFixed(2);
        // ğŸ’¡ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ù„ÙŠØ¹ÙƒØ³ ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø¹Ø¨Ø§Ø¡ ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…Ø¹Ø¯Ù„
        document.getElementById("overhead-cost-display").textContent =
          costs.fixed_cost.toFixed(2);
        document.getElementById("total-cost-display").textContent =
          costs.total_cost.toFixed(2);

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø³Ø¹Ø±
        suggestedFinalPrice.textContent = "---";
        applyCalculatedPriceBtn.disabled = true;
      }

      // --------------------------------------------------------
      // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§Ù…Ø´
      // --------------------------------------------------------
      function handlePriceCalculation() {
        const tCOGS = parseFloat(
          document.getElementById("total-cost-display").textContent
        );
        const marginPercent = parseFloat(profitMarginInput.value);

        if (isNaN(tCOGS) || tCOGS <= 0) {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… ÙˆØ³Ø§Ø¹Ø§Øª ØªØµÙ†ÙŠØ¹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø£ÙˆÙ„Ø§Ù‹.");
          return;
        }
        if (isNaN(marginPercent) || marginPercent < 0) {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‡Ø§Ù…Ø´ Ø±Ø¨Ø­ ØµØ­ÙŠØ­.");
          return;
        }

        const multiplier = 1 + marginPercent / 100;
        const calculatedPrice = tCOGS * multiplier;

        suggestedFinalPrice.textContent = calculatedPrice.toFixed(2);
        applyCalculatedPriceBtn.disabled = false;
      }

      function handleApplyCalculatedPrice() {
        const price = parseFloat(suggestedFinalPrice.textContent);
        if (isNaN(price)) return;

        document.getElementById("product-price").value = price.toFixed(2);
        alert(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${price.toFixed(2)} Ø´ÙŠÙƒÙ„.`);
      }

      // --------------------------------------------------------
      // ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      // --------------------------------------------------------
      async function fetchRawMaterials() {
        try {
          const snapshot = await getDocs(collection(db, "raw_materials"));
          allRawMaterials = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0), // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            reorder_point: parseFloat(doc.data().reorder_point || 0), // Ø¬Ù„Ø¨ Ù†Ù‚Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨
          }));
          rawMaterialsMap.clear();
          allRawMaterials.forEach((mat) => rawMaterialsMap.set(mat.id, mat));
          fillMaterialSelect();
        } catch (e) {
          console.error("Error fetching raw materials: ", e);
        }
      }

      async function fetchAndRenderProducts() {
        const container = document.getElementById("products-table-container");
        container.innerHTML =
          '<p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>';
        try {
          const snapshot = await getDocs(collection(db, "products"));
          allProducts = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            price: parseFloat(doc.data().price || 0),
            is_available: doc.data().is_available !== false,
            manufacturing_time_hours: parseFloat(
              doc.data().manufacturing_time_hours || 0
            ),
          }));

          allProducts = allProducts.map((product) => {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            const costs = calculateProductCosts(product);
            product.availabilityCheck = costs.availabilityCheck;
            // ğŸ’¡ Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
            product.missing_materials = costs.detailedMissingMaterials;
            return product;
          });

          renderProductsTable(allProducts);
        } catch (e) {
          console.error("Error fetching products: ", e);
          container.innerHTML =
            '<p class="loading-msg" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.</p>';
        }
      }

      function renderProductsTable(products) {
        const container = document.getElementById("products-table-container");
        if (products.length === 0) {
          container.innerHTML =
            '<p class="loading-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</p>';
          return;
        }

        let tableHtml = `
          <table class="orders-table">
            <thead>
              <tr>
                <th><i class="fa-solid fa-tag"></i> Ø§Ù„Ù€ ID</th>
                <th><i class="fa-solid fa-chair"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th><i class="fa-solid fa-list-ul"></i> Ø§Ù„ÙØ¦Ø©</th>
                <th><i class="fa-solid fa-money-bill"></i> Ø§Ù„Ø³Ø¹Ø± (Ø´ÙŠÙƒÙ„)</th>
                <th><i class="fa-solid fa-dollar-sign"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (TCOGS)</th>
                <th><i class="fa-solid fa-info-circle"></i> Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th><i class="fa-solid fa-tools"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
        `;
        products.forEach((product) => {
          const costs = calculateProductCosts(product); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ø¹Ø±Ø¶

          let statusClass;
          let statusContent;
          const check = product.availabilityCheck;
          const actionButtons = `
            <button class="btn btn-secondary btn-sm edit-product-btn" data-id="${product.id}">
                <i class="fa-solid fa-pencil"></i> ØªØ¹Ø¯ÙŠÙ„
            </button>
            <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product.id}">
                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
            </button>
          `;

          let alertIcon = "";
          // ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰:
          if (check === "Unavailable_Auto") {
            statusClass = "product-status-unavailable-auto";
            statusContent = `Ù†Ù‚Øµ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…`;
            // ğŸ’¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙŠ ØªÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (ØªÙ… Ø¥Ø²Ø§Ù„Ø© onClick)
            alertIcon = `<i class="fa-solid fa-bell missing-materials-alert" 
                           data-id="${product.id}" 
                           data-name="${product.name}"
                           title="Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ©"
                        ></i>`;
          } else if (product.is_available === false) {
            // ØºÙŠØ± Ù…ØªÙˆÙØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ø­ØªÙ‰ Ù„Ùˆ ØªÙˆÙØ±Øª Ø§Ù„Ù…ÙˆØ§Ø¯)
            statusClass = "product-status-unavailable-manual";
            statusContent = "ØºÙŠØ± Ù…ØªÙˆÙØ± ÙŠØ¯ÙˆÙŠØ§Ù‹";
          } else {
            statusClass = "product-status-available";
            statusContent = `Ù…ØªÙˆÙØ±`;
          }

          tableHtml += `
            <tr data-id="${product.id}">
              <td>${product.id}</td>
              <td>${product.name}</td>
              <td>${product.category}</td>
              <td>${product.price.toFixed(2)}</td>
              <td>${costs.total_cost.toFixed(2)}</td> 
              <td>
                <div class="${statusClass}">
                    ${statusContent}
                    ${alertIcon}
                </div>
              </td>
              <td class="actions-buttons">${actionButtons}</td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        container.innerHTML = tableHtml;

        document.querySelectorAll(".edit-product-btn").forEach((btn) => {
          btn.addEventListener("click", handleEditProduct);
        });
        document.querySelectorAll(".delete-product-btn").forEach((btn) => {
          btn.addEventListener("click", handleDeleteClick);
        });

        // ğŸ’¡ NEW: Ø¥Ø¶Ø§ÙØ© Ù…ÙØ³ØªÙ…Ø¹ÙŠ Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© CSP)
        document
          .querySelectorAll(".missing-materials-alert")
          .forEach((icon) => {
            icon.addEventListener("click", (e) => {
              const id = e.currentTarget.dataset.id;
              const name = e.currentTarget.dataset.name;
              // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙÙŠ Ù†Ø·Ø§Ù‚ window
              window.showMissingMaterials(id, name);
            });
          });
      } // Ù†Ù‡Ø§ÙŠØ© Ø¯Ø§Ù„Ø© renderProductsTable

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ø­Ø¯Ø«)
      // --------------------------------------------------------
      document
        .getElementById("add-product-btn")
        .addEventListener("click", () => {
          document.getElementById("product-modal-title").textContent =
            "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
          productForm.reset();
          document.getElementById("product-id").value = "";
          currentRequiredMaterials = [];
          renderRequiredMaterials();
          openModal("product-modal");
          updateCostDisplay();
        });

      function handleEditProduct(e) {
        const id = e.currentTarget.dataset.id;
        const product = allProducts.find((p) => p.id == id);

        if (product) {
          document.getElementById(
            "product-modal-title"
          ).textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: ${product.name}`;
          document.getElementById("product-id").value = product.id;
          document.getElementById("product-name").value = product.name;
          document.getElementById("product-category").value = product.category;
          document.getElementById("product-price").value = product.price;
          document.getElementById("manufacturing-hours").value =
            product.manufacturing_time_hours || 1;
          document.getElementById("product-description").value =
            product.description || "";
          document.getElementById("product-specs").value = product.specs || "";
          // ğŸ’¡ Ù†Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„Ø© is_available Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          document.getElementById("product-is-available").value =
            product.is_available ? "true" : "false";

          currentRequiredMaterials = (product.required_materials || []).map(
            (req) => {
              const mat = rawMaterialsMap.get(req.id);
              return {
                ...req,
                name: mat ? mat.name_ar : "Ù…Ø§Ø¯Ø© Ù…ÙÙ‚ÙˆØ¯Ø©",
                unit: mat ? mat.unit : "ÙˆØ­Ø¯Ø©",
              };
            }
          );

          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø³Ø¹Ø±
          suggestedFinalPrice.textContent = "---";
          applyCalculatedPriceBtn.disabled = true;

          renderRequiredMaterials();
          openModal("product-modal");
          updateCostDisplay();
        }
      }

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…Ù†ØªØ¬
      // --------------------------------------------------------
      function fillMaterialSelect() {
        const select = document.getElementById("material-select");
        select.innerHTML =
          '<option value="" disabled selected>Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø©</option>';
        allRawMaterials.forEach((mat) => {
          const option = document.createElement("option");
          option.value = mat.id;
          option.textContent = `${mat.name_ar} (${mat.unit})`;
          select.appendChild(option);
        });
      }

      document
        .getElementById("add-material-btn")
        .addEventListener("click", () => {
          const materialId = materialSelect.value;
          const quantityInput = document.getElementById("quantity-input");
          const quantity = parseFloat(quantityInput.value);
          const material = rawMaterialsMap.get(materialId);

          if (!materialId || isNaN(quantity) || quantity <= 0) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©.");
            return;
          }

          const existingIndex = currentRequiredMaterials.findIndex(
            (item) => item.id === materialId
          );

          const newMaterial = {
            id: materialId,
            name: material.name_ar,
            unit: material.unit,
            quantity: quantity,
          };

          if (existingIndex > -1) {
            currentRequiredMaterials[existingIndex].quantity = quantity;
          } else {
            currentRequiredMaterials.push(newMaterial);
          }

          renderRequiredMaterials();
          quantityInput.value = 1;
          materialSelect.value = "";
        });

      requiredMaterialsTableBody.addEventListener("click", (e) => {
        if (e.target.closest(".remove-material-btn")) {
          const idToRemove = e.target.closest("tr").dataset.id;
          currentRequiredMaterials = currentRequiredMaterials.filter(
            (item) => item.id !== idToRemove
          );
          renderRequiredMaterials();
        }
      });

      function renderRequiredMaterials() {
        requiredMaterialsTableBody.innerHTML = "";
        currentRequiredMaterials.forEach((item) => {
          const row = requiredMaterialsTableBody.insertRow();
          row.dataset.id = item.id;

          row.innerHTML = `
            <td>${item.name || "Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"}</td> 
            <td>${item.unit || "---"}</td>
            <td><input type="number" value="${
              item.quantity
            }" min="0.01" step="0.01" data-id="${
            item.id
          }" class="quantity-update-input" style="width: 80px; text-align: center;"></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-material-btn"><i class="fa-solid fa-xmark"></i></button></td>
          `;
        });

        updateCostDisplay();
      }

      // Ø±Ø¨Ø· Ø­Ù‚Ù„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹ Ø¨Ù€ updateCostDisplay
      document
        .getElementById("manufacturing-hours")
        .addEventListener("change", updateCostDisplay);

      // --------------------------------------------------------
      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø­Ø°Ù (Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
      // --------------------------------------------------------
      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const isNew = document.getElementById("product-id").value === "";
        const id =
          document.getElementById("product-id").value ||
          doc(collection(db, "products")).id;

        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù€ ID Ø±Ù‚Ù…ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
        const idNumber = isNew
          ? (allProducts.length > 0
              ? Math.max(...allProducts.map((p) => parseInt(p.id)))
              : 0) + 1
          : id;

        const requiredMaterials = currentRequiredMaterials.map((item) => ({
          id: item.id,
          quantity: item.quantity,
        }));

        // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆÙØ­Øµ Ø§Ù„ØªÙˆÙØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const productDataForCheck = {
          required_materials: requiredMaterials,
          manufacturing_time_hours:
            parseFloat(document.getElementById("manufacturing-hours").value) ||
            0,
        };
        const costs = calculateProductCosts(productDataForCheck);
        const checkedAvailability = costs.availabilityCheck;

        // 2. ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„ÙˆØ«ÙŠÙ‚Ø©
        let finalAvailabilityStatus;
        const manualStatusInput =
          document.getElementById("product-is-available").value === "true";

        // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§
        const existingProduct = isNew
          ? null
          : allProducts.find((p) => p.id == id);

        // ğŸ’¡ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: Ù‡Ù„ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù…Ù‡Ù… Ù„ØªØ­Ø¯ÙŠØ¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©)
        const wasPreviouslyManualUnavailable =
          existingProduct &&
          existingProduct.is_available === false &&
          checkedAvailability === "Available";

        if (checkedAvailability === "Unavailable_Auto") {
          // âš ï¸ Ù†Ù‚Øµ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…: ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹ Ø¥Ù„Ù‰ ØºÙŠØ± Ù…ØªÙˆÙØ± (false)
          finalAvailabilityStatus = false;
          if (manualStatusInput) {
            alert(
              "âš ï¸ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ 'ØºÙŠØ± Ù…ØªÙˆÙØ±' ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù†Ù‚Øµ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…. ÙŠØ±Ø¬Ù‰ ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†."
            );
          }
        } else {
          // âœ… ØªÙˆÙØ±Øª Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (Available):

          if (manualStatusInput === false) {
            // ğŸ’¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ø®ØªØ§Ø± 'ØºÙŠØ± Ù…ØªÙˆÙØ±' ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ (Manual Override)
            finalAvailabilityStatus = false;
          } else {
            // ğŸ’¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…ØªÙˆÙØ±Ø©ØŒ ÙˆØ§Ù„Ù…Ø¯ÙŠØ± Ù„Ù… ÙŠØ®ØªØ± 'ØºÙŠØ± Ù…ØªÙˆÙØ±' ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ù„Ø°Ø§ ÙŠÙƒÙˆÙ† 'Ù…ØªÙˆÙØ±'
            finalAvailabilityStatus = true;
          }
        }

        const productData = {
          id: idNumber,
          name: document.getElementById("product-name").value,
          category: document.getElementById("product-category").value,
          price: parseFloat(document.getElementById("product-price").value),
          manufacturing_time_hours: parseFloat(
            document.getElementById("manufacturing-hours").value
          ),
          description:
            document.getElementById("product-description").value || null,
          specs: document.getElementById("product-specs").value || null,
          // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
          is_available: finalAvailabilityStatus,
          required_materials: requiredMaterials,
          // Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø£ÙŠØ¶Ø§Ù‹ (Ù„Ù„Ø³Ø±Ø¹Ø©)
          total_cost: costs.total_cost,
        };

        try {
          // Ù†Ø­ÙØ¸ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ID Ø§Ù„Ø±Ù‚Ù…ÙŠ ÙƒÙ€ string
          await setDoc(doc(db, "products", idNumber.toString()), productData);
          closeModal("product-modal");
          await fetchAndRenderProducts();
          alert(
            `ØªÙ… ${isNew ? "Ø¥Ø¶Ø§ÙØ©" : "ØªØ­Ø¯ÙŠØ«"} Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ±Ø¨Ø· Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.`
          );
        } catch (error) {
          console.error("Error saving product: ", error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬.");
        }
      });

      function handleDeleteClick(e) {
        const id = e.currentTarget.dataset.id;
        showConfirmationModal(
          "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",
          `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø°Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù ${id}ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`,
          () => deleteProduct(id)
        );
      }

      async function deleteProduct(id) {
        try {
          await deleteDoc(doc(db, "products", id.toString()));
          closeModal("confirmation-modal");
          fetchAndRenderProducts();
          alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.");
        } catch (e) {
          console.error("Error deleting product: ", e);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.");
        }
      }

      function showConfirmationModal(title, message, callback) {
        const confirmActionBtn = document.getElementById("confirm-action-btn");
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        confirmActionBtn.onclick = () => {
          callback();
          closeModal("confirmation-modal");
        };
        openModal("confirmation-modal");
      }
    </script>
  </body>
</html>
