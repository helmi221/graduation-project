<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | إدارة المنتجات</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      .product-status-available {
        color: var(--success-color);
        font-weight: 700;
      }
      .product-status-unavailable {
        color: var(--danger-color);
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">منجرة</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> لوحة التحكم</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> إدارة الطلبات</a
            >
          </li>
          <li>
            <a href="inventory.html" class="active"
              ><i class="fa-solid fa-warehouse"></i> إدارة المنتجات</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> إدارة المواد الخام</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>إدارة المنتجات</h1>

      <div class="inventory-section admin-panel">
        <div class="section-header">
          <button class="btn" id="add-product-btn">
            <i class="fa-solid fa-plus"></i> إضافة منتج جديد
          </button>
        </div>
        <div id="products-table-container">
          <p class="loading-msg">جارٍ تحميل المنتجات...</p>
        </div>
      </div>
    </div>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 800px">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="product-modal-title"></h2>
        <form id="product-form">
          <input type="hidden" id="product-id" />

          <div class="form-group">
            <label for="product-name">اسم المنتج</label>
            <input type="text" id="product-name" required />
          </div>

          <div class="modal-form-grid">
            <div class="form-group">
              <label for="product-category">الفئة</label>
              <select id="product-category" required></select>
            </div>
            <div class="form-group">
              <label for="product-price">السعر (شيكل)</label>
              <input
                type="number"
                id="product-price"
                min="1"
                step="0.01"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="product-description">الوصف</label>
            <textarea id="product-description" rows="3"></textarea>
          </div>

          <div class="modal-form-grid">
            <div class="form-group">
              <label for="product-is-available">الحالة</label>
              <select id="product-is-available" required>
                <option value="true">متوفر</option>
                <option value="false">غير متوفر</option>
              </select>
            </div>
            <div class="form-group">
              <label for="product-specs">المواصفات وخيارات الألوان</label>
              <input
                type="text"
                id="product-specs"
                placeholder="مثال: بني غامق، أبيض"
              />
            </div>
          </div>

          <h3><i class="fa-solid fa-gears"></i> ربط المواد الخام اللازمة</h3>
          <p style="font-size: 0.9rem; color: #777; margin-bottom: 15px">
            اختر المادة ثم اضغط "إضافة" لتعيين الكمية المطلوبة لتصنيع قطعة
            واحدة.
          </p>

          <div id="add-material-controls">
            <select id="materials-select-simple" style="width: 100%">
              <option value="">-- جارٍ التحميل --</option>
            </select>
            <button
              type="button"
              class="btn btn-sm"
              id="add-material-row-btn"
              disabled
            >
              إضافة
            </button>
          </div>

          <div id="materials-list-container">
            <table
              class="required-materials-table"
              id="required-materials-table"
            >
              <thead>
                <tr>
                  <th>المادة</th>
                  <th>وحدة القياس</th>
                  <th>الكمية المطلوبة (لكل قطعة)</th>
                  <th>حذف</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn" id="save-product-btn">
              <i class="fa-solid fa-save"></i> حفظ المنتج
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="confirm-title"></h2>
        <p
          id="confirm-message"
          style="text-align: center; margin-bottom: 2rem"
        ></p>
        <div class="btn-group">
          <button id="confirm-action-btn" class="btn btn-danger">تأكيد</button>
          <button class="btn btn-secondary modal-close">إلغاء</button>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // تهيئة Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // الدوال المساعدة لفتح وإغلاق المودال
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target.classList.contains("modal-overlay")) {
            closeModal(modal.id);
          }
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal-overlay.active")
            .forEach((modal) => {
              closeModal(modal.id);
            });
        }
      });

      // عناصر الواجهة
      const productsTableContainer = document.getElementById(
        "products-table-container"
      );
      const productForm = document.getElementById("product-form");
      const productIdInput = document.getElementById("product-id");
      const productCategorySelect = document.getElementById("product-category");
      const materialsSelectSimple = document.getElementById(
        "materials-select-simple"
      );
      const addMaterialRowBtn = document.getElementById("add-material-row-btn");
      const requiredMaterialsTableBody = document.querySelector(
        "#required-materials-table tbody"
      );
      const confirmActionBtn = document.getElementById("confirm-action-btn");
      const productModalTitleEl = document.getElementById(
        "product-modal-title"
      );

      let allProducts = [];
      let allRawMaterials = [];
      const productCategories = [
        "طاولة سفرة",
        "كرسي",
        "طقم كنب",
        "غرفة نوم",
        "مطبخ",
        "طاولة وسط",
        "خزانة",
        "طاولة تلفاز",
      ];

      // التحقق من صلاحيات المدير
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchRawMaterials();
            fetchAndRenderProducts();
            fillCategoriesDropdown();
          } else {
            alert("غير مصرح لك بالوصول إلى هذه الصفحة.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      function fillCategoriesDropdown() {
        productCategorySelect.innerHTML = productCategories
          .map((cat) => `<option value="${cat}">${cat}</option>`)
          .join("");
      }

      async function fetchRawMaterials() {
        try {
          const snapshot = await getDocs(collection(db, "raw_materials"));
          allRawMaterials = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            unit: doc.data().unit || "---",
          }));

          // ⚠️ [الإصلاح هنا]: ملء القائمة المنسدلة بالمواد الخام بعد جلبها ⚠️
          materialsSelectSimple.innerHTML =
            '<option value="">-- اختر مادة خام --</option>' +
            allRawMaterials
              .map(
                (m) =>
                  `<option value="${m.id}" data-unit="${m.unit}">${m.name_ar} (${m.unit})</option>`
              )
              .join("");
        } catch (e) {
          console.error("Error fetching raw materials: ", e);
          materialsSelectSimple.innerHTML =
            '<option value="">-- فشل تحميل المواد الخام --</option>';
        }
      }

      // --------------------------------------------------------
      // المنطق الجديد لإدارة المواد الخام داخل المودال
      // --------------------------------------------------------
      materialsSelectSimple.addEventListener("change", () => {
        addMaterialRowBtn.disabled = !materialsSelectSimple.value;
      });

      addMaterialRowBtn.addEventListener("click", () => {
        const materialId = materialsSelectSimple.value;
        if (!materialId) return;

        const material = allRawMaterials.find((m) => m.id === materialId);
        if (material) {
          addMaterialRow(material, 1);
          materialsSelectSimple.querySelector(
            `option[value="${materialId}"]`
          ).style.display = "none";
          materialsSelectSimple.value = "";
          addMaterialRowBtn.disabled = true;
        }
      });

      function addMaterialRow(material, quantity = 1) {
        if (
          requiredMaterialsTableBody.querySelector(
            `tr[data-id="${material.id}"]`
          )
        ) {
          return;
        }

        const row = document.createElement("tr");
        row.dataset.id = material.id;
        row.innerHTML = `
            <td>${material.name_ar}</td>
            <td>${material.unit}</td>
            <td>
                <input type="number" class="required-quantity" min="0.001" step="any" value="${quantity}" required />
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm remove-material-btn" data-id="${material.id}"><i class="fa-solid fa-trash"></i></button>
            </td>
        `;
        requiredMaterialsTableBody.appendChild(row);
      }

      requiredMaterialsTableBody.addEventListener("click", (e) => {
        if (e.target.closest(".remove-material-btn")) {
          const button = e.target.closest(".remove-material-btn");
          const row = button.closest("tr");
          const materialId = row.dataset.id;

          const option = materialsSelectSimple.querySelector(
            `option[value="${materialId}"]`
          );
          if (option) {
            option.style.display = "block";
          }
          row.remove();
        }
      });
      // --------------------------------------------------------

      async function fetchAndRenderProducts() {
        productsTableContainer.innerHTML =
          '<p class="loading-msg">جارٍ تحميل المنتجات...</p>';
        try {
          const snapshot = await getDocs(collection(db, "products"));
          allProducts = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            price: parseFloat(doc.data().price || 0),
            is_available: doc.data().is_available !== false,
          }));

          renderProductsTable(allProducts);
        } catch (e) {
          console.error("Error fetching products: ", e);
          productsTableContainer.innerHTML =
            '<p class="loading-msg" style="color: red;">حدث خطأ في جلب المنتجات.</p>';
        }
      }

      function renderProductsTable(products) {
        if (products.length === 0) {
          productsTableContainer.innerHTML =
            '<p class="loading-msg">لا توجد منتجات مسجلة.</p>';
          return;
        }

        let tableHtml = `
          <table class="orders-table">
            <thead>
              <tr>
                <th><i class="fa-solid fa-tag"></i> الـ ID</th>
                <th><i class="fa-solid fa-chair"></i> اسم المنتج</th>
                <th><i class="fa-solid fa-list-ul"></i> الفئة</th>
                <th><i class="fa-solid fa-money-bill"></i> السعر (شيكل)</th>
                <th><i class="fa-solid fa-info-circle"></i> الحالة</th>
                <th><i class="fa-solid fa-tools"></i> الإجراءات</th>
              </tr>
            </thead>
            <tbody>
        `;
        products.forEach((product) => {
          const statusClass = product.is_available
            ? "product-status-available"
            : "product-status-unavailable";
          const statusText = product.is_available ? "متوفر" : "غير متوفر";

          tableHtml += `
            <tr data-id="${product.id}">
              <td>${product.id}</td>
              <td>${product.name}</td>
              <td>${product.category}</td>
              <td>${product.price.toFixed(2)}</td>
              <td><span class="${statusClass}">${statusText}</span></td>
              <td class="actions-buttons">
                <button class="btn btn-secondary btn-sm edit-product-btn" data-id="${
                  product.id
                }"><i class="fa-solid fa-pencil"></i> تعديل</button>
                <button class="btn btn-danger btn-sm delete-product-btn" data-id="${
                  product.id
                }"><i class="fa-solid fa-trash"></i> حذف</button>
              </td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        productsTableContainer.innerHTML = tableHtml;
      }

      document
        .getElementById("add-product-btn")
        .addEventListener("click", () => {
          productModalTitleEl.textContent = "إضافة منتج جديد";
          productForm.reset();
          productIdInput.value = "";
          requiredMaterialsTableBody.innerHTML = "";

          Array.from(materialsSelectSimple.options).forEach((option) => {
            option.style.display = "block";
          });
          materialsSelectSimple.value = "";
          addMaterialRowBtn.disabled = true;

          document.getElementById("product-is-available").value = "true";
          openModal("product-modal");
        });

      productsTableContainer.addEventListener("click", (e) => {
        if (e.target.closest(".edit-product-btn")) {
          const id = e.target.closest(".edit-product-btn").dataset.id;
          const product = allProducts.find((p) => p.id == id);
          if (product) {
            productModalTitleEl.textContent = `تعديل المنتج: ${product.name}`;
            productIdInput.value = product.id;
            document.getElementById("product-name").value = product.name;
            productCategorySelect.value = product.category;
            document.getElementById("product-price").value = product.price;
            document.getElementById("product-description").value =
              product.description || "";
            document.getElementById("product-specs").value =
              product.specs || "";
            document.getElementById("product-is-available").value =
              product.is_available ? "true" : "false";

            requiredMaterialsTableBody.innerHTML = "";

            Array.from(materialsSelectSimple.options).forEach((option) => {
              option.style.display = "block";
            });
            materialsSelectSimple.value = "";
            addMaterialRowBtn.disabled = true;

            if (
              product.required_materials &&
              Array.isArray(product.required_materials)
            ) {
              product.required_materials.forEach((req) => {
                const material = allRawMaterials.find((m) => m.id === req.id);
                if (material) {
                  addMaterialRow(material, req.quantity);
                  const option = materialsSelectSimple.querySelector(
                    `option[value="${req.id}"]`
                  );
                  if (option) {
                    option.style.display = "none";
                  }
                }
              });
            }

            openModal("product-modal");
          }
        } else if (e.target.closest(".delete-product-btn")) {
          const id = e.target.closest(".delete-product-btn").dataset.id;
          showConfirmationModal(
            "حذف المنتج",
            "هل أنت متأكد من حذف هذا المنتج نهائياً؟",
            () => deleteProduct(id)
          );
        }
      });

      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const isNew = !productIdInput.value;
        const newIdNumber = isNew
          ? allProducts.length > 0
            ? Math.max(...allProducts.map((p) => parseInt(p.id))) + 1
            : 1
          : parseInt(productIdInput.value);
        const id = newIdNumber.toString();

        const requiredMaterials = Array.from(
          requiredMaterialsTableBody.querySelectorAll("tr")
        )
          .map((row) => {
            const materialId = row.dataset.id;
            const quantity = parseFloat(
              row.querySelector(".required-quantity").value
            );
            return { id: materialId, quantity: quantity };
          })
          .filter((req) => req.quantity > 0);

        const productData = {
          id: newIdNumber,
          name: document.getElementById("product-name").value,
          category: productCategorySelect.value,
          price: parseFloat(document.getElementById("product-price").value),
          description:
            document.getElementById("product-description").value || null,
          specs: document.getElementById("product-specs").value || null,
          is_available:
            document.getElementById("product-is-available").value === "true",
          required_materials: requiredMaterials,
        };

        try {
          await setDoc(doc(db, "products", id), productData);
          closeModal("product-modal");
          fetchAndRenderProducts();
          alert(
            `تم ${isNew ? "إضافة" : "تحديث"} المنتج وربط المواد الخام بنجاح.`
          );
        } catch (error) {
          console.error("Error saving product: ", error);
          alert("حدث خطأ أثناء حفظ المنتج.");
        }
      });

      async function deleteProduct(id) {
        try {
          await deleteDoc(doc(db, "products", id.toString()));
          closeModal("confirmation-modal");
          fetchAndRenderProducts();
          alert("تم حذف المنتج بنجاح.");
        } catch (e) {
          console.error("Error deleting product: ", e);
          alert("حدث خطأ أثناء حذف المنتج.");
        }
      }

      function showConfirmationModal(title, message, callback) {
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        confirmActionBtn.onclick = () => {
          callback();
          closeModal("confirmation-modal");
        };
        openModal("confirmation-modal");
      }
    </script>
  </body>
</html>
