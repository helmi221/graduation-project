<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FurnAI | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø­Ø§Ù„Ø© */
      .product-status-available {
        color: var(--success-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: #e8f5e9;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
      }
      .product-status-unavailable {
        color: var(--danger-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: #ffebee;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
      }

      /* Ø£Ù†Ù…Ø§Ø· Ø²Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
      .missing-materials-btn {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        font-size: 1.1rem;
        padding: 5px;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .missing-materials-btn:hover {
        transform: scale(1.2);
        background-color: rgba(231, 76, 60, 0.1);
        border-radius: 50%;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© */
      #missing-materials-table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
      }
      #missing-materials-table th {
        background-color: #ffebee;
        color: var(--danger-color);
        padding: 10px;
        border-bottom: 2px solid #ffcdd2;
      }
      #missing-materials-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }

      /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ³Ø¹ÙŠØ± */
      .pricing-calculation {
        background-color: #f0f8ff;
        border: 1px dashed var(--info-color);
        padding: 15px;
        border-radius: 8px;
      }
      .pricing-calculation p {
        margin: 5px 0;
      }
      #suggested-final-price {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--info-color);
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">FurnAI</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a
            >
          </li>
          <li>
            <a href="inventory.html" class="active"
              ><i class="fa-solid fa-warehouse"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</a
            >
          </li>
          <li>
            <a href="suppliers_admin.html"
              ><i class="fa-solid fa-truck-fast"></i> Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a
            >
          </li>
          <li>
            <a href="strategy_admin.html"
              ><i class="fa-solid fa-lightbulb"></i> Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

      <div class="admin-panel">
        <div class="section-header">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
          <div style="display: flex; gap: 10px">
            <button class="btn" id="add-product-btn">
              <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
            </button>
            <button
              class="btn"
              id="update-all-costs-btn"
              style="
                background-color: var(--accent-1);
                color: var(--dark-color);
              "
            >
              <i class="fa-solid fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ
            </button>
          </div>
        </div>
        <p style="color: #777; font-size: 0.9rem; margin-bottom: 15px">
          <i class="fa-solid fa-circle-info"></i> <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø­Ø§Ù„Ø©
          ØªÙˆÙØ± Ø§Ù„Ù…Ù†ØªØ¬ "ØªÙ„Ù‚Ø§Ø¦ÙŠØ©" Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø¥Ø°Ø§ Ù†Ù‚ØµØª Ø£ÙŠ Ù…Ø§Ø¯Ø© Ø®Ø§Ù…ØŒ Ø³ÙŠØªØ­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰
          "ØºÙŠØ± Ù…ØªÙˆÙØ±" ÙÙˆØ±Ø§Ù‹.
        </p>
        <div id="products-table-container">
          <p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
        </div>
      </div>
    </div>

    <div id="missing-materials-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 650px">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 style="color: var(--danger-color)">
          <i class="fa-solid fa-triangle-exclamation"></i> ØªÙ‚Ø±ÙŠØ± Ù†Ù‚Øµ Ø§Ù„Ù…ÙˆØ§Ø¯
        </h2>
        <p style="font-size: 1.1rem; margin-bottom: 10px">
          Ø§Ù„Ù…Ù†ØªØ¬: <strong><span id="missing-product-name">---</span></strong>
        </p>
        <p style="color: #666; margin-bottom: 20px">
          Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØµÙ†ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¥Ø¹Ø§Ø¯Ø©
          ØªÙØ¹ÙŠÙ„Ù‡:
        </p>

        <div id="missing-materials-report-body"></div>

        <div
          style="
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span style="font-size: 0.9rem; color: #888"
            >Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ù…ØªÙˆÙ‚Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span
          >
          <a href="raw_materials_admin.html" class="btn btn-sm">
            <i class="fa-solid fa-cubes"></i> Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
          </a>
        </div>
      </div>
    </div>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="product-modal-title"></h2>
        <form id="product-form">
          <input type="hidden" id="product-id" />

          <div class="modal-form-grid">
            <div class="form-group">
              <label for="product-name">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
              <input type="text" id="product-name" required />
            </div>

            <div class="form-group">
              <label for="product-category">Ø§Ù„ÙØ¦Ø©</label>
              <select id="product-category" required></select>
            </div>

            <div class="form-group">
              <label for="product-price">Ø§Ù„Ø³Ø¹Ø± (Ø´ÙŠÙƒÙ„)</label>
              <input
                type="number"
                id="product-price"
                min="1"
                step="0.01"
                required
              />
            </div>

            <div class="form-group">
              <label for="manufacturing-hours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹ (Ù„ÙƒÙ„ Ù‚Ø·Ø¹Ø©)</label>
              <input
                type="number"
                id="manufacturing-hours"
                min="0.5"
                step="0.5"
                value="1"
                required
              />
            </div>

            <div class="form-group" style="grid-column: 1 / -1">
              <label for="product-description">Ø§Ù„ÙˆØµÙ</label>
              <textarea id="product-description" rows="2"></textarea>
            </div>

            <div class="form-group" style="grid-column: 1 / -1">
              <label for="product-specs">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <textarea id="product-specs" rows="1"></textarea>
            </div>
          </div>

          <h3>
            <i class="fa-solid fa-calculator"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)
          </h3>
          <div
            style="
              background-color: var(--light-color);
              padding: 15px;
              border-radius: 8px;
              border: 1px dashed var(--border-color);
              margin-bottom: 20px;
              font-size: 0.95rem;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
              "
            >
              <span>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªØºÙŠØ±Ø© (Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…):</span>
              <span id="variable-cost-display" style="font-weight: 700"
                >---</span
              >
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
              "
            >
              <span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø¹Ø¨Ø§Ø¡ (Overhead):</span>
              <span id="overhead-cost-display" style="font-weight: 700"
                >---</span
              >
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                border-top: 1px solid #ddd;
                padding-top: 5px;
                margin-top: 5px;
              "
            >
              <strong>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (TCOGS):</strong>
              <span
                id="total-cost-display"
                style="color: var(--primary-color); font-weight: 800"
                >---</span
              >
            </div>
          </div>

          <h3><i class="fa-solid fa-percent"></i> Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØªØ³Ø¹ÙŠØ±</h3>
          <div class="pricing-calculation">
            <div class="form-group" style="margin-bottom: 10px">
              <label for="profit-margin-input">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (%)</label>
              <div style="display: flex; gap: 10px">
                <input
                  type="number"
                  id="profit-margin-input"
                  min="0"
                  step="1"
                  value="30"
                  style="width: 100px"
                />
                <button
                  type="button"
                  class="btn btn-sm btn-secondary"
                  id="calculate-price-btn"
                >
                  <i class="fa-solid fa-calculator"></i> Ø§Ø­Ø³Ø¨
                </button>
              </div>
            </div>
            <p>
              <strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong>
              <span id="suggested-final-price">---</span> Ø´ÙŠÙƒÙ„
            </p>
            <button
              type="button"
              class="btn btn-sm"
              id="apply-calculated-price-btn"
              disabled
              style="margin-top: 10px; width: 100%; justify-content: center"
            >
              <i class="fa-solid fa-check"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­
            </button>
          </div>

          <div style="margin-top: 20px">
            <h3>
              <i class="fa-solid fa-layer-group"></i> Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ù…ÙˆØ§Ø¯
              Ø§Ù„Ø®Ø§Ù…)
            </h3>
            <div id="materials-table-wrapper" style="margin-bottom: 15px">
              <table
                class="orders-table"
                id="required-materials-table"
                style="margin-top: 5px"
              >
                <thead>
                  <tr>
                    <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø­Ø°Ù</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div
              class="modal-form-grid"
              style="grid-template-columns: 2fr 1fr auto; align-items: end"
            >
              <div class="form-group">
                <label for="material-select">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</label>
                <select id="material-select"></select>
              </div>
              <div class="form-group">
                <label for="quantity-input">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input
                  type="number"
                  id="quantity-input"
                  min="0.01"
                  step="0.01"
                  value="1"
                />
              </div>
              <div class="form-group">
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="add-material-btn"
                  style="margin-bottom: 2px"
                >
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="btn-group">
            <button
              type="submit"
              class="btn"
              style="width: 100%; justify-content: center"
            >
              <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 400px; text-align: center">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="confirm-title" style="justify-content: center"></h2>
        <p id="confirm-message" style="margin-bottom: 20px"></p>
        <div class="btn-group" style="justify-content: center">
          <button class="btn btn-danger" id="confirm-action-btn">
            Ù†Ø¹Ù…ØŒ ØªØ£ÙƒÙŠØ¯
          </button>
          <button
            class="btn btn-secondary"
            onclick="closeModal('confirmation-modal')"
          >
            Ø¥Ù„ØºØ§Ø¡
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let allProducts = [];
      let allRawMaterials = [];
      let rawMaterialsMap = new Map();
      let currentRequiredMaterials = [];
      const productForm = document.getElementById("product-form");
      const requiredMaterialsTableBody = document.querySelector(
        "#required-materials-table tbody"
      );
      const materialSelect = document.getElementById("material-select");
      const calculatePriceBtn = document.getElementById("calculate-price-btn");
      const applyCalculatedPriceBtn = document.getElementById(
        "apply-calculated-price-btn"
      );
      const profitMarginInput = document.getElementById("profit-margin-input");
      const suggestedFinalPrice = document.getElementById(
        "suggested-final-price"
      );
      const updateAllCostsBtn = document.getElementById("update-all-costs-btn");

      let totalMonthlyFixedCost = 0;
      let totalMonthlyManufacturingHours = 0;
      let overheadCostPerHour = 0;

      const productCategories = [
        "Ø·Ø§ÙˆÙ„Ø© Ø³ÙØ±Ø©",
        "ÙƒØ±Ø³ÙŠ",
        "Ø·Ù‚Ù… ÙƒÙ†Ø¨",
        "ØºØ±ÙØ© Ù†ÙˆÙ…",
        "Ù…Ø·Ø¨Ø®",
        "Ø·Ø§ÙˆÙ„Ø© ÙˆØ³Ø·",
        "Ø®Ø²Ø§Ù†Ø©",
        "Ø·Ø§ÙˆÙ„Ø© ØªÙ„ÙØ§Ø²",
      ];

      // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ---
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });

      // --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ© (Global) ---
      window.showMissingMaterials = function (productId, productName) {
        const productIdString = productId.toString();
        const product = allProducts.find(
          (p) => p.id.toString() === productIdString
        );

        if (!product || !product.missing_materials) {
          return;
        }

        document.getElementById("missing-product-name").textContent =
          productName;
        const reportBody = document.getElementById(
          "missing-materials-report-body"
        );
        const missingList = product.missing_materials;

        if (missingList.length === 0) {
          reportBody.innerHTML = `<p style="text-align: center; color: var(--success-color);">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`;
        } else {
          let tableHtml = `
              <table id="missing-materials-table">
                  <thead>
                      <tr>
                          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                          <th>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>
                          <th>Ø§Ù„Ù…ØªÙˆÙØ±</th>
                          <th>Ø§Ù„Ù†Ù‚Øµ</th>
                      </tr>
                  </thead>
                  <tbody>
          `;
          missingList.forEach((item) => {
            const shortage = item.required - item.available;
            tableHtml += `
                  <tr>
                      <td>${item.name}</td>
                      <td>${item.required.toFixed(2)} ${item.unit}</td>
                      <td style="color: #e67e22;">${item.available.toFixed(
                        2
                      )} ${item.unit}</td>
                      <td style="color: var(--danger-color); font-weight: bold;">-${shortage.toFixed(
                        2
                      )} ${item.unit}</td>
                  </tr>
              `;
          });
          tableHtml += `</tbody></table>`;
          reportBody.innerHTML = tableHtml;
        }
        openModal("missing-materials-modal");
      };

      // --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ ---
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchRawMaterials();
            await fetchFixedCostsAndHours();
            fetchAndRenderProducts();
            fillCategoriesDropdown();

            calculatePriceBtn.addEventListener("click", handlePriceCalculation);
            applyCalculatedPriceBtn.addEventListener(
              "click",
              handleApplyCalculatedPrice
            );
            updateAllCostsBtn.addEventListener("click", updateAllProductCosts);
          } else {
            alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });

      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "login.html";
        });

      function fillCategoriesDropdown() {
        const select = document.getElementById("product-category");
        select.innerHTML = "";
        productCategories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        });
      }

      async function fetchFixedCostsAndHours() {
        try {
          const costsSnapshot = await getDocs(collection(db, "fixed_costs"));
          totalMonthlyFixedCost = costsSnapshot.docs.reduce(
            (sum, doc) => sum + parseFloat(doc.data().amount || 0),
            0
          );
          totalMonthlyManufacturingHours = 160 * 3;
          if (totalMonthlyManufacturingHours > 0) {
            overheadCostPerHour =
              totalMonthlyFixedCost / totalMonthlyManufacturingHours;
          }
          document.getElementById("overhead-cost-display").textContent =
            overheadCostPerHour.toFixed(2);
        } catch (e) {
          console.error("Error fetching costs:", e);
        }
      }

      // --- ğŸ’¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ± ---
      function calculateProductCosts(product) {
        let variableCost = 0;
        const hours = parseFloat(product.manufacturing_time_hours) || 0;
        const materialsToCalculate =
          product.required_materials || currentRequiredMaterials;

        let isAvailable = true;
        let detailedMissingMaterials = [];

        if (materialsToCalculate && materialsToCalculate.length > 0) {
          for (const requiredMat of materialsToCalculate) {
            const material = rawMaterialsMap.get(requiredMat.id);
            if (material) {
              variableCost += requiredMat.quantity * material.cost_per_unit;

              // ğŸ’¡ Ø´Ø±Ø· Ø§Ù„ØªÙˆÙØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
              if (material.current_stock < requiredMat.quantity) {
                isAvailable = false;
                detailedMissingMaterials.push({
                  id: requiredMat.id,
                  name: material.name_ar,
                  required: requiredMat.quantity,
                  available: material.current_stock,
                  unit: material.unit,
                });
              }
            } else {
              // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø­Ø°ÙˆÙØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              isAvailable = false;
              detailedMissingMaterials.push({
                id: requiredMat.id,
                name: "Ù…Ø§Ø¯Ø© Ù…Ø­Ø°ÙˆÙØ©",
                required: requiredMat.quantity,
                available: 0,
                unit: "??",
              });
            }
          }
        }

        const fixedCost = hours * overheadCostPerHour;
        const totalCost = variableCost + fixedCost;

        return {
          variable_cost: variableCost,
          fixed_cost: fixedCost,
          total_cost: totalCost,
          overhead_rate: overheadCostPerHour,
          isAvailable: isAvailable, // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø­Ø§Ù„Ø©
          detailedMissingMaterials: detailedMissingMaterials,
        };
      }

      function updateCostDisplay() {
        let productData = {
          required_materials: currentRequiredMaterials,
          manufacturing_time_hours:
            parseFloat(document.getElementById("manufacturing-hours").value) ||
            0,
        };
        const costs = calculateProductCosts(productData);
        document.getElementById("variable-cost-display").textContent =
          costs.variable_cost.toFixed(2);
        document.getElementById("overhead-cost-display").textContent =
          costs.fixed_cost.toFixed(2);
        document.getElementById("total-cost-display").textContent =
          costs.total_cost.toFixed(2);
        suggestedFinalPrice.textContent = "---";
        applyCalculatedPriceBtn.disabled = true;
      }

      function handlePriceCalculation() {
        const tCOGS = parseFloat(
          document.getElementById("total-cost-display").textContent
        );
        const marginPercent = parseFloat(profitMarginInput.value);
        if (isNaN(tCOGS) || tCOGS <= 0 || isNaN(marginPercent)) return;
        const multiplier = 1 + marginPercent / 100;
        const calculatedPrice = tCOGS * multiplier;
        suggestedFinalPrice.textContent = calculatedPrice.toFixed(2);
        applyCalculatedPriceBtn.disabled = false;
      }

      function handleApplyCalculatedPrice() {
        const price = parseFloat(suggestedFinalPrice.textContent);
        if (!isNaN(price)) {
          document.getElementById("product-price").value = price.toFixed(2);
        }
      }

      async function fetchRawMaterials() {
        try {
          const snapshot = await getDocs(collection(db, "raw_materials"));
          allRawMaterials = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0),
          }));
          rawMaterialsMap.clear();
          allRawMaterials.forEach((mat) => rawMaterialsMap.set(mat.id, mat));
          fillMaterialSelect();
        } catch (e) {
          console.error(e);
        }
      }

      async function fetchAndRenderProducts() {
        const container = document.getElementById("products-table-container");
        container.innerHTML =
          '<p class="loading-msg">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>';
        try {
          const snapshot = await getDocs(collection(db, "products"));
          allProducts = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            price: parseFloat(doc.data().price || 0),
            manufacturing_time_hours: parseFloat(
              doc.data().manufacturing_time_hours || 0
            ),
          }));

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶
          allProducts = allProducts.map((product) => {
            const costs = calculateProductCosts(product);
            product.is_available = costs.isAvailable; // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ù„ÙŠ
            product.missing_materials = costs.detailedMissingMaterials;
            return product;
          });

          renderProductsTable(allProducts);
        } catch (e) {
          container.innerHTML =
            '<p class="loading-msg" style="color: red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>';
        }
      }

      function renderProductsTable(products) {
        const container = document.getElementById("products-table-container");
        if (products.length === 0) {
          container.innerHTML = '<p class="loading-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª.</p>';
          return;
        }

        let tableHtml = `
          <table class="orders-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>Ø§Ù„ÙØ¦Ø©</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
        `;
        products.forEach((product) => {
          const costs = calculateProductCosts(product); // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨

          let statusHtml = "";
          if (costs.isAvailable) {
            statusHtml = `<div class="product-status-available"><i class="fa-solid fa-check-circle"></i> Ù…ØªÙˆÙØ±</div>`;
          } else {
            // ğŸ’¡ Ø²Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ØªÙˆÙØ±
            statusHtml = `
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div class="product-status-unavailable"><i class="fa-solid fa-xmark-circle"></i> Ù†Ù‚Øµ Ù…ÙˆØ§Ø¯</div>
                    <button class="missing-materials-btn" title="Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Øµ" 
                        onclick="window.showMissingMaterials('${product.id}', '${product.name}')">
                        <i class="fa-solid fa-bell"></i>
                    </button>
                </div>`;
          }

          tableHtml += `
            <tr data-id="${product.id}">
              <td>${product.name}</td>
              <td>${product.category}</td>
              <td>${product.price.toFixed(2)}</td>
              <td>${costs.total_cost.toFixed(2)}</td> 
              <td>${statusHtml}</td>
              <td class="actions-buttons" style="white-space: nowrap;">
                <button class="btn btn-secondary btn-sm edit-product-btn" data-id="${
                  product.id
                }"><i class="fa-solid fa-pencil"></i></button>
                <button class="btn btn-danger btn-sm delete-product-btn" data-id="${
                  product.id
                }"><i class="fa-solid fa-trash"></i></button>
              </td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        container.innerHTML = tableHtml;

        document.querySelectorAll(".edit-product-btn").forEach((btn) => {
          btn.addEventListener("click", handleEditProduct);
        });
        document.querySelectorAll(".delete-product-btn").forEach((btn) => {
          btn.addEventListener("click", handleDeleteClick);
        });
      }

      document
        .getElementById("add-product-btn")
        .addEventListener("click", () => {
          document.getElementById("product-modal-title").textContent =
            "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
          productForm.reset();
          document.getElementById("product-id").value = "";
          currentRequiredMaterials = [];
          renderRequiredMaterials();
          openModal("product-modal");
          updateCostDisplay();
        });

      function handleEditProduct(e) {
        const id = e.currentTarget.dataset.id;
        const product = allProducts.find((p) => p.id == id);
        if (product) {
          document.getElementById(
            "product-modal-title"
          ).textContent = `ØªØ¹Ø¯ÙŠÙ„: ${product.name}`;
          document.getElementById("product-id").value = product.id;
          document.getElementById("product-name").value = product.name;
          document.getElementById("product-category").value = product.category;
          document.getElementById("product-price").value = product.price;
          document.getElementById("manufacturing-hours").value =
            product.manufacturing_time_hours || 1;
          document.getElementById("product-description").value =
            product.description || "";
          document.getElementById("product-specs").value = product.specs || "";

          // ğŸ’¡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¨Ø¦Ø© Ù„Ø­Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù„Ø£Ù†Ù‡ ØªÙ… Ø­Ø°ÙÙ‡

          currentRequiredMaterials = (product.required_materials || []).map(
            (req) => {
              const mat = rawMaterialsMap.get(req.id);
              return {
                ...req,
                name: mat ? mat.name_ar : "Ù…Ø§Ø¯Ø© Ù…ÙÙ‚ÙˆØ¯Ø©",
                unit: mat ? mat.unit : "",
              };
            }
          );

          suggestedFinalPrice.textContent = "---";
          applyCalculatedPriceBtn.disabled = true;
          renderRequiredMaterials();
          openModal("product-modal");
          updateCostDisplay();
        }
      }

      function fillMaterialSelect() {
        const select = document.getElementById("material-select");
        select.innerHTML =
          '<option value="" disabled selected>Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø©</option>';
        allRawMaterials.forEach((mat) => {
          const option = document.createElement("option");
          option.value = mat.id;
          option.textContent = `${mat.name_ar} (${mat.unit})`;
          select.appendChild(option);
        });
      }

      document
        .getElementById("add-material-btn")
        .addEventListener("click", () => {
          const materialId = materialSelect.value;
          const quantity = parseFloat(
            document.getElementById("quantity-input").value
          );
          const material = rawMaterialsMap.get(materialId);

          if (!materialId || isNaN(quantity) || quantity <= 0) {
            alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
            return;
          }

          const existingIndex = currentRequiredMaterials.findIndex(
            (item) => item.id === materialId
          );
          if (existingIndex > -1) {
            currentRequiredMaterials[existingIndex].quantity = quantity;
          } else {
            currentRequiredMaterials.push({
              id: materialId,
              name: material.name_ar,
              unit: material.unit,
              quantity: quantity,
            });
          }
          renderRequiredMaterials();
          document.getElementById("quantity-input").value = 1;
          materialSelect.value = "";
        });

      requiredMaterialsTableBody.addEventListener("click", (e) => {
        if (e.target.closest(".remove-material-btn")) {
          const idToRemove = e.target.closest("tr").dataset.id;
          currentRequiredMaterials = currentRequiredMaterials.filter(
            (item) => item.id !== idToRemove
          );
          renderRequiredMaterials();
        }
      });

      function renderRequiredMaterials() {
        requiredMaterialsTableBody.innerHTML = "";
        currentRequiredMaterials.forEach((item) => {
          const row = requiredMaterialsTableBody.insertRow();
          row.dataset.id = item.id;
          row.innerHTML = `
            <td>${item.name}</td> 
            <td><input type="number" value="${item.quantity}" min="0.01" step="0.01" data-id="${item.id}" class="quantity-update-input" style="width: 80px;"> ${item.unit}</td>
            <td><button type="button" class="btn btn-danger btn-sm remove-material-btn"><i class="fa-solid fa-xmark"></i></button></td>
          `;
        });
        document.querySelectorAll(".quantity-update-input").forEach((input) => {
          input.addEventListener("change", (e) => {
            const id = e.target.dataset.id;
            const val = parseFloat(e.target.value);
            const item = currentRequiredMaterials.find((i) => i.id === id);
            if (item && val > 0) {
              item.quantity = val;
              updateCostDisplay();
            }
          });
        });
        updateCostDisplay();
      }

      document
        .getElementById("manufacturing-hours")
        .addEventListener("change", updateCostDisplay);

      // --- ğŸ’¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©) ---
      async function updateAllProductCosts() {
        if (!confirm(`ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŸ`)) return;
        const loadingMsg = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
        document.getElementById(
          "products-table-container"
        ).innerHTML = `<p class="loading-msg">${loadingMsg}</p>`;

        const batch = writeBatch(db);
        let count = 0;

        try {
          for (const product of allProducts) {
            const costs = calculateProductCosts(product);
            const ref = doc(db, "products", product.id.toString());
            batch.update(ref, {
              total_cost: costs.total_cost,
              is_available: costs.isAvailable, // ğŸ’¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            });
            count++;
          }
          await batch.commit();
          alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${count} Ù…Ù†ØªØ¬.`);
          fetchAndRenderProducts();
        } catch (e) {
          alert("Ø®Ø·Ø£: " + e.message);
          fetchAndRenderProducts();
        }
      }

      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const isNew = document.getElementById("product-id").value === "";
        const idVal = document.getElementById("product-id").value;
        const idNumber = isNew
          ? (allProducts.length > 0
              ? Math.max(...allProducts.map((p) => parseInt(p.id)))
              : 0) + 1
          : idVal;

        const requiredMaterials = currentRequiredMaterials.map((item) => ({
          id: item.id,
          quantity: item.quantity,
        }));

        const productDataForCheck = {
          required_materials: requiredMaterials,
          manufacturing_time_hours:
            parseFloat(document.getElementById("manufacturing-hours").value) ||
            0,
        };

        // ğŸ’¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
        const costs = calculateProductCosts(productDataForCheck);

        const productData = {
          id: idNumber,
          name: document.getElementById("product-name").value,
          category: document.getElementById("product-category").value,
          price: parseFloat(document.getElementById("product-price").value),
          manufacturing_time_hours: parseFloat(
            document.getElementById("manufacturing-hours").value
          ),
          description:
            document.getElementById("product-description").value || null,
          specs: document.getElementById("product-specs").value || null,
          required_materials: requiredMaterials,
          total_cost: costs.total_cost,
          is_available: costs.isAvailable, // ğŸ’¡ Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙ‚Ø·
        };

        try {
          await setDoc(doc(db, "products", idNumber.toString()), productData);
          closeModal("product-modal");
          await fetchAndRenderProducts();

          if (!costs.isAvailable) {
            alert(
              `âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ØŒ ÙˆÙ„ÙƒÙ†Ù‡ "ØºÙŠØ± Ù…ØªÙˆÙØ±" Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù….`
            );
          } else {
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.");
          }
        } catch (error) {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£.");
        }
      });

      function handleDeleteClick(e) {
        const id = e.currentTarget.dataset.id;
        showConfirmationModal("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", `Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ ${id}ØŸ`, () =>
          deleteProduct(id)
        );
      }

      async function deleteProduct(id) {
        try {
          await deleteDoc(doc(db, "products", id.toString()));
          closeModal("confirmation-modal");
          fetchAndRenderProducts();
          alert("ØªÙ… Ø§Ù„Ø­Ø°Ù.");
        } catch (e) {
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù.");
        }
      }

      function showConfirmationModal(title, message, callback) {
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        document.getElementById("confirm-action-btn").onclick = () => {
          callback();
          closeModal("confirmation-modal");
        };
        openModal("confirmation-modal");
      }
    </script>
  </body>
</html>
