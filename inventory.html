<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منجرة | إدارة المنتجات</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="admin.css" />
    <style>
      /* Status Colors & Display (كما كانت) */
      .product-status-available {
        color: var(--success-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .product-status-unavailable-auto {
        color: var(--danger-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .product-status-unavailable-manual {
        color: var(--warning-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      /* 💡 نمط أيقونة التنبيه بنقص المواد */
      .missing-materials-alert {
        color: var(--danger-color);
        margin-right: 8px;
        cursor: pointer;
        font-size: 1.1em;
        transition: transform 0.2s;
      }
      .missing-materials-alert:hover {
        transform: scale(1.2);
      }
      /* 💡 تنسيق جدول المواد الناقصة */
      #missing-materials-table {
        width: 100%;
        margin-top: 15px;
      }
      #missing-materials-table th {
        background-color: #ffebee;
        color: var(--danger-color);
      }
      #missing-materials-table td {
        font-weight: 500;
      }
      /* 💡 أنماط التسعير الجديدة */
      .pricing-calculation {
        background-color: #f0f8ff;
        border: 1px dashed var(--info-color);
        padding: 15px;
        border-radius: 8px;
      }
      .pricing-calculation p {
        margin: 5px 0;
      }
      #suggested-final-price {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--info-color);
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">منجرة</div>
      <nav>
        <ul>
          <li>
            <a href="admin.html"
              ><i class="fa-solid fa-gauge-high"></i> لوحة التحكم</a
            >
          </li>
          <li>
            <a href="orders_admin.html"
              ><i class="fa-solid fa-box-open"></i> إدارة الطلبات</a
            >
          </li>
          <li>
            <a href="inventory.html" class="active"
              ><i class="fa-solid fa-warehouse"></i> إدارة المنتجات</a
            >
          </li>
          <li>
            <a href="raw_materials_admin.html"
              ><i class="fa-solid fa-hammer"></i> إدارة المواد الخام</a
            >
          </li>
          <li>
            <a href="fixed_costs_admin.html"
              ><i class="fa-solid fa-calculator"></i> التكاليف الثابتة</a
            >
          </li>
          <li>
            <a href="customers_admin.html"
              ><i class="fa-solid fa-users"></i> إدارة العملاء</a
            >
          </li>
          <li>
            <a href="#" id="logout-btn"
              ><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="main-content container-fluid">
      <h1>إدارة المنتجات</h1>

      <div class="admin-panel">
        <div class="section-header">
          <h2>قائمة المنتجات</h2>
          <div>
            <button class="btn" id="add-product-btn">
              <i class="fa-solid fa-plus"></i> إضافة منتج جديد
            </button>
          </div>
        </div>
        <div id="products-table-container">
          <p class="loading-msg">جارٍ تحميل المنتجات...</p>
        </div>
      </div>
    </div>

    <div id="missing-materials-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 650px">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2>
          <i class="fa-solid fa-triangle-exclamation"></i> المواد الناقصة لـ:
          <span id="missing-product-name">---</span>
        </h2>
        <p style="color: var(--danger-color); margin: 10px 0">
          لا يمكن تصنيع هذا المنتج حالياً بسبب نقص المخزون التالي:
        </p>
        <div id="missing-materials-report-body"></div>
        <p
          style="
            text-align: right;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #777;
          "
        >
          يرجى مراجعة صفحة
          <a
            href="raw_materials_admin.html"
            style="color: var(--info-color); font-weight: bold"
            >إدارة المخزون</a
          >
          لإضافة كميات.
        </p>
      </div>
    </div>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="product-modal-title"></h2>
        <form id="product-form">
          <input type="hidden" id="product-id" />

          <div class="modal-form-grid">
            <div class="form-group">
              <label for="product-name">اسم المنتج</label>
              <input type="text" id="product-name" required />
            </div>

            <div class="form-group">
              <label for="product-category">الفئة</label>
              <select id="product-category" required></select>
            </div>

            <div class="form-group">
              <label for="product-price">السعر (شيكل)</label>
              <input
                type="number"
                id="product-price"
                min="1"
                step="0.01"
                required
              />
            </div>

            <div class="form-group">
              <label for="manufacturing-hours"
                >ساعات التصنيع التقريبية (لكل قطعة)</label
              >
              <input
                type="number"
                id="manufacturing-hours"
                min="0.5"
                step="0.5"
                value="1"
                required
              />
            </div>

            <div class="form-group">
              <label for="product-is-available">الحالة</label>
              <select id="product-is-available" required>
                <option value="true">متوفر للبيع (يدوي)</option>
                <option value="false">غير متوفر (يدوي)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="product-specs">المواصفات (اختياري)</label>
              <textarea id="product-specs" rows="1"></textarea>
            </div>
          </div>

          <div class="form-group">
            <label for="product-description">الوصف</label>
            <textarea id="product-description" rows="3"></textarea>
          </div>

          <h3>
            <i class="fa-solid fa-calculator"></i> تحليل التكاليف (لكل قطعة)
          </h3>
          <div
            style="
              background-color: var(--light-color);
              padding: 15px;
              border-radius: 8px;
              border: 1px dashed var(--border-color);
              margin-bottom: 20px;
            "
          >
            <p>
              <strong>التكلفة المتغيرة (المواد الخام):</strong>
              <span
                id="variable-cost-display"
                style="color: var(--info-color); font-weight: 700"
                >---</span
              >
              شيكل
            </p>
            <p>
              <strong>تكلفة الأعباء التشغيلية (Overhead):</strong>
              <span
                id="overhead-cost-display"
                style="color: var(--danger-color); font-weight: 700"
                >---</span
              >
              شيكل
            </p>
            <p>
              <strong>التكلفة الإجمالية (TCOGS):</strong>
              <span
                id="total-cost-display"
                style="
                  font-size: 1.2rem;
                  color: var(--primary-color);
                  font-weight: 800;
                "
                >---</span
              >
              شيكل
            </p>
          </div>

          <h3><i class="fa-solid fa-percent"></i> حاسبة هامش الربح</h3>
          <div class="pricing-calculation">
            <div class="form-group">
              <label for="profit-margin-input"
                >هامش الربح المراد تطبيقه (%)</label
              >
              <input
                type="number"
                id="profit-margin-input"
                min="0"
                step="1"
                value="30"
                required
              />
            </div>
            <p style="border-top: 1px dashed #ccc; padding-top: 10px">
              <strong>سعر البيع المقترح:</strong>
              <span id="suggested-final-price">---</span> شيكل
            </p>
            <button
              type="button"
              class="btn btn-sm"
              id="calculate-price-btn"
              style="background-color: var(--info-color); margin-top: 10px"
            >
              <i class="fa-solid fa-calculator"></i> احسب السعر
            </button>
            <button
              type="button"
              class="btn btn-sm btn-secondary"
              id="apply-calculated-price-btn"
              disabled
              style="margin-top: 10px"
            >
              <i class="fa-solid fa-arrow-down"></i> تطبيق السعر المقترح
            </button>
          </div>

          <div style="margin-top: 20px">
            <h3><i class="fa-solid fa-gears"></i> ربط المواد الخام اللازمة</h3>
            <div id="materials-table-wrapper" style="margin-bottom: 20px">
              <table class="orders-table" id="required-materials-table">
                <thead>
                  <tr>
                    <th><i class="fa-solid fa-ruler-combined"></i> المادة</th>
                    <th><i class="fa-solid fa-box"></i> الوحدة</th>
                    <th><i class="fa-solid fa-hashtag"></i> الكمية المطلوبة</th>
                    <th><i class="fa-solid fa-trash"></i></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div
              class="modal-form-grid"
              style="grid-template-columns: 2fr 1fr 1fr"
            >
              <div class="form-group">
                <label for="material-select">اختر المادة لإضافتها</label>
                <select id="material-select"></select>
              </div>
              <div class="form-group">
                <label for="quantity-input">الكمية</label>
                <input
                  type="number"
                  id="quantity-input"
                  min="0.01"
                  step="0.01"
                  value="1"
                />
              </div>
              <div class="form-group" style="align-self: end">
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="add-material-btn"
                >
                  <i class="fa-solid fa-plus"></i> إضافة
                </button>
              </div>
            </div>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn">
              <i class="fa-solid fa-save"></i> حفظ المنتج
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
        <h2 id="confirm-title"></h2>
        <p id="confirm-message" style="margin-bottom: 20px"></p>
        <div class="btn-group">
          <button class="btn btn-danger" id="confirm-action-btn">تأكيد</button>
          <button
            class="btn btn-secondary"
            onclick="closeModal('confirmation-modal')"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      // 💡 إزالة استيراد Gemini

      // 🛑 إعدادات Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBL7MOIEE8K1UgZTG_j-6-VM0JzlD_7BS0",
        authDomain: "ecomers-dd329.firebaseapp.com",
        projectId: "ecomers-dd329",
        storageBucket: "ecomers-dd329.firebasestorage.app",
        messagingSenderId: "190646144215",
        appId: "1:190646144215:web:d55f24091a920f92b6b492",
        measurementId: "G-NVYK3DZR00",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // المتغيرات العامة
      let allProducts = [];
      let allRawMaterials = [];
      let rawMaterialsMap = new Map();
      let currentRequiredMaterials = [];
      const productForm = document.getElementById("product-form");
      const requiredMaterialsTableBody = document.querySelector(
        "#required-materials-table tbody"
      );
      const materialSelect = document.getElementById("material-select");
      const calculatePriceBtn = document.getElementById("calculate-price-btn");
      const applyCalculatedPriceBtn = document.getElementById(
        "apply-calculated-price-btn"
      );
      const profitMarginInput = document.getElementById("profit-margin-input");
      const suggestedFinalPrice = document.getElementById(
        "suggested-final-price"
      );

      // 💡 متغيرات التكاليف الثابتة
      let totalMonthlyFixedCost = 0;
      let totalMonthlyManufacturingHours = 0;
      let overheadCostPerHour = 0;

      // 💡 قائمة الفئات الثابتة (لحل مشكلة القائمة المنسدلة)
      const productCategories = [
        "طاولة سفرة",
        "كرسي",
        "طقم كنب",
        "غرفة نوم",
        "مطبخ",
        "طاولة وسط",
        "خزانة",
        "طاولة تلفاز",
      ];

      // --------------------------------------------------------
      // الدوال المساعدة لفتح وإغلاق المودال
      // --------------------------------------------------------
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("active");
        document.body.classList.add("scroll-lock");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
        document.body.classList.remove("scroll-lock");
      }
      document.querySelectorAll(".modal-overlay").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (
            e.target.closest(".modal-close") ||
            e.target.classList.contains("modal-overlay")
          ) {
            closeModal(modal.id);
          }
        });
      });

      // 💡 دالة عرض المواد الناقصة لمنتج محدد (متاحة للـ window)
      window.showMissingMaterials = function (productId, productName) {
        // 💡 التصحيح: تحويل الـ ID إلى String للمقارنة الآمنة
        const productIdString = productId.toString();
        // 💡 البحث عن المنتج باستخدام المقارنة النصية
        const product = allProducts.find(
          (p) => p.id.toString() === productIdString
        );

        // 💡 تم تحسين التحقق من البيانات
        if (!product || !product.missing_materials) {
          console.error(
            "Product data not found or missing materials data is unavailable."
          );
          return;
        }

        document.getElementById("missing-product-name").textContent =
          productName;
        const reportBody = document.getElementById(
          "missing-materials-report-body"
        );
        const missingList = product.missing_materials;

        if (missingList.length === 0) {
          reportBody.innerHTML = `<p style="text-align: center; color: var(--success-color); font-weight: 600;">✅ لا يوجد نقص في المواد الخام حالياً لتصنيع هذا المنتج.</p>`;
        } else {
          let tableHtml = `
                  <table class="orders-table" id="missing-materials-table">
                      <thead>
                          <tr>
                              <th><i class="fa-solid fa-list-check"></i> المادة</th>
                              <th><i class="fa-solid fa-hashtag"></i> الكمية المطلوبة</th>
                              <th><i class="fa-solid fa-box-open"></i> الكمية المتاحة</th>
                              <th>الوحدة</th>
                          </tr>
                      </thead>
                      <tbody>
              `;
          missingList.forEach((item) => {
            tableHtml += `
                      <tr>
                          <td>${item.name}</td>
                          <td>${item.required.toFixed(2)}</td>
                          <td style="color: var(--danger-color);">${item.available.toFixed(
                            2
                          )}</td>
                          <td>${item.unit}</td>
                      </tr>
                  `;
          });
          tableHtml += `</tbody></table>`;
          reportBody.innerHTML = tableHtml;
        }

        openModal("missing-materials-modal");
      };

      // --------------------------------------------------------
      // التحقق من الصلاحيات والتحميل
      // --------------------------------------------------------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().role === "admin") {
            await fetchRawMaterials();
            await fetchFixedCostsAndHours();
            fetchAndRenderProducts();
            fillCategoriesDropdown(); // 💡 ملء قائمة الفئات

            // 💡 ربط أحداث التسعير
            calculatePriceBtn.addEventListener("click", handlePriceCalculation);
            applyCalculatedPriceBtn.addEventListener(
              "click",
              handleApplyCalculatedPrice
            );
          } else {
            alert("غير مصرح لك بالوصول إلى هذه الصفحة.");
            window.location.href = "login.html";
          }
        } else {
          window.location.href = "login.html";
        }
      });
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });

      // --------------------------------------------------------
      // دالة ملء القائمة المنسدلة للفئات (المُصلحة)
      // --------------------------------------------------------
      function fillCategoriesDropdown() {
        const select = document.getElementById("product-category");
        select.innerHTML = ""; // تفريغ الخيارات الحالية

        productCategories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        });
      }

      // --------------------------------------------------------
      // دالة جلب التكاليف الثابتة وحساب تكلفة الساعة
      // --------------------------------------------------------
      async function fetchFixedCostsAndHours() {
        try {
          const costsSnapshot = await getDocs(collection(db, "fixed_costs"));
          totalMonthlyFixedCost = costsSnapshot.docs.reduce(
            (sum, doc) => sum + parseFloat(doc.data().amount || 0),
            0
          );
          // افتراض إجمالي ساعات العمل الشهرية (مثال: 3 موظفين * 160 ساعة/موظف)
          totalMonthlyManufacturingHours = 160 * 3;

          if (totalMonthlyManufacturingHours > 0) {
            overheadCostPerHour =
              totalMonthlyFixedCost / totalMonthlyManufacturingHours;
          } else {
            overheadCostPerHour = 0;
          }

          // تحديث عرض تكلفة الأعباء التشغيلية في المودال
          document.getElementById("overhead-cost-display").textContent =
            overheadCostPerHour.toFixed(2);
        } catch (e) {
          console.error("Error fetching fixed costs: ", e);
        }
      }

      /**
       * تحسب تكلفة المنتج وتتحقق من توفر المواد الخام.
       * @param {object} product - بيانات المنتج.
       * @returns {object} - يحتوي على التكاليف و availabilityCheck.
       */
      function calculateProductCosts(product) {
        let variableCost = 0;
        const hours = parseFloat(product.manufacturing_time_hours) || 0;
        const materialsToCalculate =
          product.required_materials || currentRequiredMaterials;
        let isAvailable = true;
        let missingMaterialsCount = 0;
        // 💡 قائمة لتخزين المواد الناقصة بالتفصيل
        let detailedMissingMaterials = [];

        if (materialsToCalculate && materialsToCalculate.length > 0) {
          for (const requiredMat of materialsToCalculate) {
            const material = rawMaterialsMap.get(requiredMat.id);
            if (material) {
              variableCost += requiredMat.quantity * material.cost_per_unit;

              // فحص التوفر
              if (
                material.current_stock < requiredMat.quantity ||
                requiredMat.quantity === 0
              ) {
                isAvailable = false;
                missingMaterialsCount++;
                detailedMissingMaterials.push({
                  id: requiredMat.id,
                  name: material.name_ar,
                  required: requiredMat.quantity,
                  available: material.current_stock,
                  unit: material.unit,
                });
              }
            }
          }
        }

        const fixedCost = hours * overheadCostPerHour;
        const totalCost = variableCost + fixedCost;

        return {
          variable_cost: variableCost,
          fixed_cost: fixedCost,
          total_cost: totalCost,
          overhead_rate: overheadCostPerHour,
          // 💡 تحديد حالة التوفر الآلي بناءً على المواد الخام
          availabilityCheck: isAvailable ? "Available" : "Unavailable_Auto",
          detailedMissingMaterials: detailedMissingMaterials, // إرجاع القائمة
        };
      }

      // --------------------------------------------------------
      // دالة تحديث عرض التكاليف في المودال (للتكاليف والحساب الذكي)
      // --------------------------------------------------------
      function updateCostDisplay() {
        let productData;

        // نستخدم البيانات الحالية في المودال للحساب
        productData = {
          required_materials: currentRequiredMaterials,
          manufacturing_time_hours:
            parseFloat(document.getElementById("manufacturing-hours").value) ||
            0,
        };

        const costs = calculateProductCosts(productData);

        document.getElementById("variable-cost-display").textContent =
          costs.variable_cost.toFixed(2);
        // 💡 تم تحديث هذا ليعكس تكلفة الأعباء وليس المعدل
        document.getElementById("overhead-cost-display").textContent =
          costs.fixed_cost.toFixed(2);
        document.getElementById("total-cost-display").textContent =
          costs.total_cost.toFixed(2);

        // إعادة تعيين حاسبة السعر
        suggestedFinalPrice.textContent = "---";
        applyCalculatedPriceBtn.disabled = true;
      }

      // --------------------------------------------------------
      // 💡 منطق حساب سعر البيع بناءً على الهامش
      // --------------------------------------------------------
      function handlePriceCalculation() {
        const tCOGS = parseFloat(
          document.getElementById("total-cost-display").textContent
        );
        const marginPercent = parseFloat(profitMarginInput.value);

        if (isNaN(tCOGS) || tCOGS <= 0) {
          alert("الرجاء إدخال مواد خام وساعات تصنيع لحساب التكلفة أولاً.");
          return;
        }
        if (isNaN(marginPercent) || marginPercent < 0) {
          alert("الرجاء إدخال هامش ربح صحيح.");
          return;
        }

        const multiplier = 1 + marginPercent / 100;
        const calculatedPrice = tCOGS * multiplier;

        suggestedFinalPrice.textContent = calculatedPrice.toFixed(2);
        applyCalculatedPriceBtn.disabled = false;
      }

      function handleApplyCalculatedPrice() {
        const price = parseFloat(suggestedFinalPrice.textContent);
        if (isNaN(price)) return;

        document.getElementById("product-price").value = price.toFixed(2);
        alert(`تم تطبيق السعر المقترح: ${price.toFixed(2)} شيكل.`);
      }

      // --------------------------------------------------------
      // وظائف جلب وعرض المنتجات
      // --------------------------------------------------------
      async function fetchRawMaterials() {
        try {
          const snapshot = await getDocs(collection(db, "raw_materials"));
          allRawMaterials = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            cost_per_unit: parseFloat(doc.data().cost_per_unit || 0),
            current_stock: parseFloat(doc.data().current_stock || 0), // جلب المخزون
            reorder_point: parseFloat(doc.data().reorder_point || 0), // جلب نقطة إعادة الطلب
          }));
          rawMaterialsMap.clear();
          allRawMaterials.forEach((mat) => rawMaterialsMap.set(mat.id, mat));
          fillMaterialSelect();
        } catch (e) {
          console.error("Error fetching raw materials: ", e);
        }
      }

      async function fetchAndRenderProducts() {
        const container = document.getElementById("products-table-container");
        container.innerHTML =
          '<p class="loading-msg">جارٍ تحميل المنتجات...</p>';
        try {
          const snapshot = await getDocs(collection(db, "products"));
          allProducts = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
            price: parseFloat(doc.data().price || 0),
            is_available: doc.data().is_available !== false,
            manufacturing_time_hours: parseFloat(
              doc.data().manufacturing_time_hours || 0
            ),
          }));

          allProducts = allProducts.map((product) => {
            // إعادة حساب الحالة عند جلب المنتجات
            const costs = calculateProductCosts(product);
            product.availabilityCheck = costs.availabilityCheck;
            // 💡 إضافة قائمة المواد الناقصة إلى بيانات المنتج
            product.missing_materials = costs.detailedMissingMaterials;
            return product;
          });

          renderProductsTable(allProducts);
        } catch (e) {
          console.error("Error fetching products: ", e);
          container.innerHTML =
            '<p class="loading-msg" style="color: red;">حدث خطأ في جلب المنتجات.</p>';
        }
      }

      function renderProductsTable(products) {
        const container = document.getElementById("products-table-container");
        if (products.length === 0) {
          container.innerHTML =
            '<p class="loading-msg">لا توجد منتجات مسجلة.</p>';
          return;
        }

        let tableHtml = `
          <table class="orders-table">
            <thead>
              <tr>
                <th><i class="fa-solid fa-tag"></i> الـ ID</th>
                <th><i class="fa-solid fa-chair"></i> اسم المنتج</th>
                <th><i class="fa-solid fa-list-ul"></i> الفئة</th>
                <th><i class="fa-solid fa-money-bill"></i> السعر (شيكل)</th>
                <th><i class="fa-solid fa-dollar-sign"></i> إجمالي التكلفة (TCOGS)</th>
                <th><i class="fa-solid fa-info-circle"></i> الحالة</th>
                <th><i class="fa-solid fa-tools"></i> الإجراءات</th>
              </tr>
            </thead>
            <tbody>
        `;
        products.forEach((product) => {
          const costs = calculateProductCosts(product); // إعادة الحساب للعرض

          let statusClass;
          let statusContent;
          const check = product.availabilityCheck;
          const actionButtons = `
            <button class="btn btn-secondary btn-sm edit-product-btn" data-id="${product.id}">
                <i class="fa-solid fa-pencil"></i> تعديل
            </button>
            <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product.id}">
                <i class="fa-solid fa-trash"></i> حذف
            </button>
          `;

          let alertIcon = "";
          // يتم تحديد الحالة المرئية بناءً على:
          if (check === "Unavailable_Auto") {
            statusClass = "product-status-unavailable-auto";
            statusContent = `نقص مواد خام`;
            // 💡 أيقونة التنبيه التي تفتح المودال (تم إزالة onClick)
            alertIcon = `<i class="fa-solid fa-bell missing-materials-alert" 
                           data-id="${product.id}" 
                           data-name="${product.name}"
                           title="عرض المواد الناقصة"
                        ></i>`;
          } else if (product.is_available === false) {
            // غير متوفر يدوياً (حتى لو توفرت المواد)
            statusClass = "product-status-unavailable-manual";
            statusContent = "غير متوفر يدوياً";
          } else {
            statusClass = "product-status-available";
            statusContent = `متوفر`;
          }

          tableHtml += `
            <tr data-id="${product.id}">
              <td>${product.id}</td>
              <td>${product.name}</td>
              <td>${product.category}</td>
              <td>${product.price.toFixed(2)}</td>
              <td>${costs.total_cost.toFixed(2)}</td> 
              <td>
                <div class="${statusClass}">
                    ${statusContent}
                    ${alertIcon}
                </div>
              </td>
              <td class="actions-buttons">${actionButtons}</td>
            </tr>
          `;
        });
        tableHtml += "</tbody></table>";
        container.innerHTML = tableHtml;

        document.querySelectorAll(".edit-product-btn").forEach((btn) => {
          btn.addEventListener("click", handleEditProduct);
        });
        document.querySelectorAll(".delete-product-btn").forEach((btn) => {
          btn.addEventListener("click", handleDeleteClick);
        });

        // 💡 NEW: إضافة مُستمعي حدث النقر لأيقونات التنبيه (لحل مشكلة CSP)
        document
          .querySelectorAll(".missing-materials-alert")
          .forEach((icon) => {
            icon.addEventListener("click", (e) => {
              const id = e.currentTarget.dataset.id;
              const name = e.currentTarget.dataset.name;
              // استدعاء الدالة المعرفة في نطاق window
              window.showMissingMaterials(id, name);
            });
          });
      } // نهاية دالة renderProductsTable

      // --------------------------------------------------------
      // منطق إضافة/تعديل المنتجات (محدث)
      // --------------------------------------------------------
      document
        .getElementById("add-product-btn")
        .addEventListener("click", () => {
          document.getElementById("product-modal-title").textContent =
            "إضافة منتج جديد";
          productForm.reset();
          document.getElementById("product-id").value = "";
          currentRequiredMaterials = [];
          renderRequiredMaterials();
          openModal("product-modal");
          updateCostDisplay();
        });

      function handleEditProduct(e) {
        const id = e.currentTarget.dataset.id;
        const product = allProducts.find((p) => p.id == id);

        if (product) {
          document.getElementById(
            "product-modal-title"
          ).textContent = `تعديل المنتج: ${product.name}`;
          document.getElementById("product-id").value = product.id;
          document.getElementById("product-name").value = product.name;
          document.getElementById("product-category").value = product.category;
          document.getElementById("product-price").value = product.price;
          document.getElementById("manufacturing-hours").value =
            product.manufacturing_time_hours || 1;
          document.getElementById("product-description").value =
            product.description || "";
          document.getElementById("product-specs").value = product.specs || "";
          // 💡 نستخدم حالة is_available المخزنة في قاعدة البيانات
          document.getElementById("product-is-available").value =
            product.is_available ? "true" : "false";

          currentRequiredMaterials = (product.required_materials || []).map(
            (req) => {
              const mat = rawMaterialsMap.get(req.id);
              return {
                ...req,
                name: mat ? mat.name_ar : "مادة مفقودة",
                unit: mat ? mat.unit : "وحدة",
              };
            }
          );

          // إعادة تعيين حاسبة السعر
          suggestedFinalPrice.textContent = "---";
          applyCalculatedPriceBtn.disabled = true;

          renderRequiredMaterials();
          openModal("product-modal");
          updateCostDisplay();
        }
      }

      // --------------------------------------------------------
      // منطق إدارة المواد الخام المطلوبة للمنتج
      // --------------------------------------------------------
      function fillMaterialSelect() {
        const select = document.getElementById("material-select");
        select.innerHTML =
          '<option value="" disabled selected>اختر مادة</option>';
        allRawMaterials.forEach((mat) => {
          const option = document.createElement("option");
          option.value = mat.id;
          option.textContent = `${mat.name_ar} (${mat.unit})`;
          select.appendChild(option);
        });
      }

      document
        .getElementById("add-material-btn")
        .addEventListener("click", () => {
          const materialId = materialSelect.value;
          const quantityInput = document.getElementById("quantity-input");
          const quantity = parseFloat(quantityInput.value);
          const material = rawMaterialsMap.get(materialId);

          if (!materialId || isNaN(quantity) || quantity <= 0) {
            alert("يرجى اختيار مادة وإدخال كمية صحيحة.");
            return;
          }

          const existingIndex = currentRequiredMaterials.findIndex(
            (item) => item.id === materialId
          );

          const newMaterial = {
            id: materialId,
            name: material.name_ar,
            unit: material.unit,
            quantity: quantity,
          };

          if (existingIndex > -1) {
            currentRequiredMaterials[existingIndex].quantity = quantity;
          } else {
            currentRequiredMaterials.push(newMaterial);
          }

          renderRequiredMaterials();
          quantityInput.value = 1;
          materialSelect.value = "";
        });

      requiredMaterialsTableBody.addEventListener("click", (e) => {
        if (e.target.closest(".remove-material-btn")) {
          const idToRemove = e.target.closest("tr").dataset.id;
          currentRequiredMaterials = currentRequiredMaterials.filter(
            (item) => item.id !== idToRemove
          );
          renderRequiredMaterials();
        }
      });

      function renderRequiredMaterials() {
        requiredMaterialsTableBody.innerHTML = "";
        currentRequiredMaterials.forEach((item) => {
          const row = requiredMaterialsTableBody.insertRow();
          row.dataset.id = item.id;

          row.innerHTML = `
            <td>${item.name || "مادة غير معروفة"}</td> 
            <td>${item.unit || "---"}</td>
            <td><input type="number" value="${
              item.quantity
            }" min="0.01" step="0.01" data-id="${
            item.id
          }" class="quantity-update-input" style="width: 80px; text-align: center;"></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-material-btn"><i class="fa-solid fa-xmark"></i></button></td>
          `;
        });

        updateCostDisplay();
      }

      // ربط حقل ساعات التصنيع بـ updateCostDisplay
      document
        .getElementById("manufacturing-hours")
        .addEventListener("change", updateCostDisplay);

      // --------------------------------------------------------
      // منطق الحفظ والحذف (مع التعديل المطلوب)
      // --------------------------------------------------------
      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const isNew = document.getElementById("product-id").value === "";
        const id =
          document.getElementById("product-id").value ||
          doc(collection(db, "products")).id;

        // يجب أن يكون الـ ID رقمي إذا لم يكن موجودًا بالفعل
        const idNumber = isNew
          ? (allProducts.length > 0
              ? Math.max(...allProducts.map((p) => parseInt(p.id)))
              : 0) + 1
          : id;

        const requiredMaterials = currentRequiredMaterials.map((item) => ({
          id: item.id,
          quantity: item.quantity,
        }));

        // 1. حساب التكاليف وفحص التوفر بناءً على المواد المطلوبة الحالية
        const productDataForCheck = {
          required_materials: requiredMaterials,
          manufacturing_time_hours:
            parseFloat(document.getElementById("manufacturing-hours").value) ||
            0,
        };
        const costs = calculateProductCosts(productDataForCheck);
        const checkedAvailability = costs.availabilityCheck;

        // 2. تحديد حالة التوفر النهائية للوثيقة
        let finalAvailabilityStatus;
        const manualStatusInput =
          document.getElementById("product-is-available").value === "true";

        // جلب الحالة المخزنة مسبقًا
        const existingProduct = isNew
          ? null
          : allProducts.find((p) => p.id == id);

        // 💡 الحالة السابقة: هل كان المنتج غير متوفر يدوياً (مهم لتحديد تجاوز الإلزامية)
        const wasPreviouslyManualUnavailable =
          existingProduct &&
          existingProduct.is_available === false &&
          checkedAvailability === "Available";

        if (checkedAvailability === "Unavailable_Auto") {
          // ⚠️ نقص مواد خام: يتم تحويله إجبارياً إلى غير متوفر (false)
          finalAvailabilityStatus = false;
          if (manualStatusInput) {
            alert(
              "⚠️ تم تعيين حالة المنتج إلى 'غير متوفر' تلقائياً بسبب نقص المواد الخام. يرجى توفير المخزون."
            );
          }
        } else {
          // ✅ توفرت المواد الخام (Available):

          if (manualStatusInput === false) {
            // 💡 المدير اختار 'غير متوفر' يدوياً في المودال الحالي (Manual Override)
            finalAvailabilityStatus = false;
          } else {
            // 💡 المواد متوفرة، والمدير لم يختر 'غير متوفر' يدوياً، لذا يكون 'متوفر'
            finalAvailabilityStatus = true;
          }
        }

        const productData = {
          id: idNumber,
          name: document.getElementById("product-name").value,
          category: document.getElementById("product-category").value,
          price: parseFloat(document.getElementById("product-price").value),
          manufacturing_time_hours: parseFloat(
            document.getElementById("manufacturing-hours").value
          ),
          description:
            document.getElementById("product-description").value || null,
          specs: document.getElementById("product-specs").value || null,
          // 💡 استخدام الحالة المحسوبة
          is_available: finalAvailabilityStatus,
          required_materials: requiredMaterials,
          // حفظ التكلفة أيضاً (للسرعة)
          total_cost: costs.total_cost,
        };

        try {
          // نحفظ باستخدام ID الرقمي كـ string
          await setDoc(doc(db, "products", idNumber.toString()), productData);
          closeModal("product-modal");
          await fetchAndRenderProducts();
          alert(
            `تم ${isNew ? "إضافة" : "تحديث"} المنتج وربط المواد الخام بنجاح.`
          );
        } catch (error) {
          console.error("Error saving product: ", error);
          alert("حدث خطأ أثناء حفظ المنتج.");
        }
      });

      function handleDeleteClick(e) {
        const id = e.currentTarget.dataset.id;
        showConfirmationModal(
          "تأكيد الحذف",
          `هل أنت متأكد من حذف المنتج ذو المعرف ${id}؟ لا يمكن التراجع عن هذا الإجراء.`,
          () => deleteProduct(id)
        );
      }

      async function deleteProduct(id) {
        try {
          await deleteDoc(doc(db, "products", id.toString()));
          closeModal("confirmation-modal");
          fetchAndRenderProducts();
          alert("تم حذف المنتج بنجاح.");
        } catch (e) {
          console.error("Error deleting product: ", e);
          alert("حدث خطأ أثناء حذف المنتج.");
        }
      }

      function showConfirmationModal(title, message, callback) {
        const confirmActionBtn = document.getElementById("confirm-action-btn");
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        confirmActionBtn.onclick = () => {
          callback();
          closeModal("confirmation-modal");
        };
        openModal("confirmation-modal");
      }
    </script>
  </body>
</html>
